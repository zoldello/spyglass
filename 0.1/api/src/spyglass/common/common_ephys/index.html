
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Spyglass Documentation">
      
      
        <meta name="author" content="CBroz1">
      
      
        <link rel="canonical" href="https://lorenfranklab.github.io/spyglass/latest/api/src/spyglass/common/common_ephys/">
      
      
        <link rel="prev" href="../common_dio/">
      
      
        <link rel="next" href="../common_filter/">
      
      <link rel="icon" href="../../../../../images/Spyglass.svg">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.17">
    
    
      
        <title>common_ephys.py - Spyglass</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="auto" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#src.spyglass.common.common_ephys" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="Spyglass" class="md-header__button md-logo" aria-label="Spyglass" data-md-component="logo">
      
  <img src="../../../../../images/FrankLab.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Spyglass
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              common_ephys.py
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="auto" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: slate)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/LorenFrankLab/spyglass" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Spyglass" class="md-nav__button md-logo" aria-label="Spyglass" data-md-component="logo">
      
  <img src="../../../../../images/FrankLab.png" alt="logo">

    </a>
    Spyglass
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/LorenFrankLab/spyglass" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../installation/" class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../installation/local/" class="md-nav__link">
        Local
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../installation/production/" class="md-nav__link">
        Productions
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/00_intro/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/01_spikesorting/" class="md-nav__link">
        Spike Sorting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/02_curation/" class="md-nav__link">
        Curation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/03_lfp/" class="md-nav__link">
        LFP
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_5" >
      
      
      
        <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
          Position
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_5">
          <span class="md-nav__icon md-icon"></span>
          Position
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/4_position_info/" class="md-nav__link">
        Information
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/04_Trodes_position/" class="md-nav__link">
        Pipeline
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/05_DLC_from_scratch/" class="md-nav__link">
        From Scratch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/06_DLC_from_dir/" class="md-nav__link">
        From Pre-Trained
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/07_linearization/" class="md-nav__link">
        Linearization Pipeline
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/08_Extract_Mark_indicators/" class="md-nav__link">
        Mark Indicators
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/09_Decoding_with_GPUs_on_the_GPU_cluster/" class="md-nav__link">
        GPU
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/10_1D_Clusterless_Decoding/" class="md-nav__link">
        1D Clusterless Decoding
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/11_2D_Clusterless_Decoding/" class="md-nav__link">
        2D Clusterless Decoding
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/12_Ripple_Detection/" class="md-nav__link">
        Ripple Detection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/docker_mysql_tutorial/" class="md-nav__link">
        Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/Spyglass_kachery_setup/" class="md-nav__link">
        Spyglass Kachery Setup
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          API Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          API Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
          src
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          src
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_1" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1" id="__nav_4_1_1_label" tabindex="0">
          spyglass
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_1_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4_1_1">
          <span class="md-nav__icon md-icon"></span>
          spyglass
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_version/" class="md-nav__link">
        _version.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_2" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_2" id="__nav_4_1_1_2_label" tabindex="0">
          cli
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_2">
          <span class="md-nav__icon md-icon"></span>
          cli
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/cli/" class="md-nav__link">
        cli.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_1_3" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_3" id="__nav_4_1_1_3_label" tabindex="0">
          common
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_3_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4_1_1_3">
          <span class="md-nav__icon md-icon"></span>
          common
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common_backup/" class="md-nav__link">
        common_backup.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common_behav/" class="md-nav__link">
        common_behav.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common_device/" class="md-nav__link">
        common_device.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common_dio/" class="md-nav__link">
        common_dio.py
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          common_ephys.py
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        common_ephys.py
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys" class="md-nav__link">
    src.spyglass.common.common_ephys
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.BrainRegion" class="md-nav__link">
    BrainRegion
  </a>
  
    <nav class="md-nav" aria-label="BrainRegion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_region.BrainRegion.fetch_add" class="md-nav__link">
    fetch_add()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.IntervalList" class="md-nav__link">
    IntervalList
  </a>
  
    <nav class="md-nav" aria-label="IntervalList">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_interval.IntervalList.insert_from_nwbfile" class="md-nav__link">
    insert_from_nwbfile()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.get_nwb_file" class="md-nav__link">
    get_nwb_file()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.FirFilterParameters" class="md-nav__link">
    FirFilterParameters
  </a>
  
    <nav class="md-nav" aria-label="FirFilterParameters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_filter.FirFilterParameters.filter_data_nwb" class="md-nav__link">
    filter_data_nwb()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_filter.FirFilterParameters.filter_data" class="md-nav__link">
    filter_data()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_filter.FirFilterParameters.calc_filter_delay" class="md-nav__link">
    calc_filter_delay()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_filter.FirFilterParameters.create_standard_filters" class="md-nav__link">
    create_standard_filters()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.Nwbfile" class="md-nav__link">
    Nwbfile
  </a>
  
    <nav class="md-nav" aria-label="Nwbfile">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.Nwbfile.insert_from_relative_file_name" class="md-nav__link">
    insert_from_relative_file_name()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.Nwbfile.get_abs_path" class="md-nav__link">
    get_abs_path()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.Nwbfile.add_to_lock" class="md-nav__link">
    add_to_lock()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.Nwbfile.cleanup" class="md-nav__link">
    cleanup()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.fetch_nwb" class="md-nav__link">
    fetch_nwb()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.get_config" class="md-nav__link">
    get_config()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.Electrode" class="md-nav__link">
    Electrode
  </a>
  
    <nav class="md-nav" aria-label="Electrode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.Electrode.create_from_config" class="md-nav__link">
    create_from_config()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.get_data_interface" class="md-nav__link">
    get_data_interface()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.AnalysisNwbfile" class="md-nav__link">
    AnalysisNwbfile
  </a>
  
    <nav class="md-nav" aria-label="AnalysisNwbfile">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.create" class="md-nav__link">
    create()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.copy" class="md-nav__link">
    copy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add" class="md-nav__link">
    add()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.get_abs_path" class="md-nav__link">
    get_abs_path()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_nwb_object" class="md-nav__link">
    add_nwb_object()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units" class="md-nav__link">
    add_units()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units_waveforms" class="md-nav__link">
    add_units_waveforms()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units_metrics" class="md-nav__link">
    add_units_metrics()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.get_electrode_indices" class="md-nav__link">
    get_electrode_indices()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.cleanup" class="md-nav__link">
    cleanup()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.interval_list_contains_ind" class="md-nav__link">
    interval_list_contains_ind()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.estimate_sampling_rate" class="md-nav__link">
    estimate_sampling_rate()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.get_valid_intervals" class="md-nav__link">
    get_valid_intervals()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.interval_list_intersect" class="md-nav__link">
    interval_list_intersect()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.get_electrode_indices" class="md-nav__link">
    get_electrode_indices()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.LFPSelection" class="md-nav__link">
    LFPSelection
  </a>
  
    <nav class="md-nav" aria-label="LFPSelection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.LFPSelection.set_lfp_electrodes" class="md-nav__link">
    set_lfp_electrodes()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.Probe" class="md-nav__link">
    Probe
  </a>
  
    <nav class="md-nav" aria-label="Probe">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_device.Probe.insert_from_nwbfile" class="md-nav__link">
    insert_from_nwbfile()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_device.Probe.get_all_probe_names" class="md-nav__link">
    get_all_probe_names()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_device.Probe.create_from_nwbfile" class="md-nav__link">
    create_from_nwbfile()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.interval_list_censor" class="md-nav__link">
    interval_list_censor()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.LFPBandSelection" class="md-nav__link">
    LFPBandSelection
  </a>
  
    <nav class="md-nav" aria-label="LFPBandSelection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_ephys.LFPBandSelection.set_lfp_band_electrodes" class="md-nav__link">
    set_lfp_band_electrodes()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common_filter/" class="md-nav__link">
        common_filter.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common_interval/" class="md-nav__link">
        common_interval.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common_lab/" class="md-nav__link">
        common_lab.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common_nwbfile/" class="md-nav__link">
        common_nwbfile.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common_position/" class="md-nav__link">
        common_position.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common_region/" class="md-nav__link">
        common_region.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common_ripple/" class="md-nav__link">
        common_ripple.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common_sensors/" class="md-nav__link">
        common_sensors.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common_session/" class="md-nav__link">
        common_session.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common_subject/" class="md-nav__link">
        common_subject.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common_task/" class="md-nav__link">
        common_task.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../errors/" class="md-nav__link">
        errors.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../populate_all_common/" class="md-nav__link">
        populate_all_common.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_3_19" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_3_19" id="__nav_4_1_1_3_19_label" tabindex="0">
          prepopulate
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_4_1_1_3_19_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_3_19">
          <span class="md-nav__icon md-icon"></span>
          prepopulate
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../prepopulate/prepopulate/" class="md-nav__link">
        prepopulate.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../signal_processing/" class="md-nav__link">
        signal_processing.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_4" id="__nav_4_1_1_4_label" tabindex="0">
          data_import
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_4">
          <span class="md-nav__icon md-icon"></span>
          data_import
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../data_import/insert_sessions/" class="md-nav__link">
        insert_sessions.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../data_import/storage_dirs/" class="md-nav__link">
        storage_dirs.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_5" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_5" id="__nav_4_1_1_5_label" tabindex="0">
          decoding
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_5">
          <span class="md-nav__icon md-icon"></span>
          decoding
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../decoding/clusterless/" class="md-nav__link">
        clusterless.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../decoding/core/" class="md-nav__link">
        core.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../decoding/dj_decoder_conversion/" class="md-nav__link">
        dj_decoder_conversion.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../decoding/sorted_spikes/" class="md-nav__link">
        sorted_spikes.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../decoding/visualization/" class="md-nav__link">
        visualization.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../decoding/visualization_1D_view/" class="md-nav__link">
        visualization_1D_view.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../decoding/visualization_2D_view/" class="md-nav__link">
        visualization_2D_view.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_6" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_6" id="__nav_4_1_1_6_label" tabindex="0">
          figurl_views
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_6">
          <span class="md-nav__icon md-icon"></span>
          figurl_views
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../figurl_views/SpikeSortingRecordingView/" class="md-nav__link">
        SpikeSortingRecordingView.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../figurl_views/SpikeSortingView/" class="md-nav__link">
        SpikeSortingView.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../figurl_views/prepare_spikesortingview_data/" class="md-nav__link">
        prepare_spikesortingview_data.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_7" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_7" id="__nav_4_1_1_7_label" tabindex="0">
          lfp
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_7">
          <span class="md-nav__icon md-icon"></span>
          lfp
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lfp/lfp_merge/" class="md-nav__link">
        lfp_merge.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_7_2" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_7_2" id="__nav_4_1_1_7_2_label" tabindex="0">
          v1
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_4_1_1_7_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_7_2">
          <span class="md-nav__icon md-icon"></span>
          v1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lfp/v1/lfp/" class="md-nav__link">
        lfp.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lfp/v1/lfp_artifact/" class="md-nav__link">
        lfp_artifact.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lfp/v1/lfp_artifact_MAD_detection/" class="md-nav__link">
        lfp_artifact_MAD_detection.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lfp/v1/lfp_artifact_difference_detection/" class="md-nav__link">
        lfp_artifact_difference_detection.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_8" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_8" id="__nav_4_1_1_8_label" tabindex="0">
          lfp_band
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_8">
          <span class="md-nav__icon md-icon"></span>
          lfp_band
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lfp_band/lfp_band_merge/" class="md-nav__link">
        lfp_band_merge.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_8_2" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_8_2" id="__nav_4_1_1_8_2_label" tabindex="0">
          v1
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_4_1_1_8_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_8_2">
          <span class="md-nav__icon md-icon"></span>
          v1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lfp_band/v1/lfp_band/" class="md-nav__link">
        lfp_band.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_9" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_9" id="__nav_4_1_1_9_label" tabindex="0">
          lock
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_9">
          <span class="md-nav__icon md-icon"></span>
          lock
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lock/file_lock/" class="md-nav__link">
        file_lock.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_10" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_10" id="__nav_4_1_1_10_label" tabindex="0">
          position
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_10">
          <span class="md-nav__icon md-icon"></span>
          position
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/position_merge/" class="md-nav__link">
        position_merge.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_10_2" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_10_2" id="__nav_4_1_1_10_2_label" tabindex="0">
          v1
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_4_1_1_10_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_10_2">
          <span class="md-nav__icon md-icon"></span>
          v1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/dlc_decorators/" class="md-nav__link">
        dlc_decorators.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/dlc_reader/" class="md-nav__link">
        dlc_reader.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/dlc_utils/" class="md-nav__link">
        dlc_utils.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_dlc_centroid/" class="md-nav__link">
        position_dlc_centroid.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_dlc_cohort/" class="md-nav__link">
        position_dlc_cohort.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_dlc_model/" class="md-nav__link">
        position_dlc_model.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_dlc_orient/" class="md-nav__link">
        position_dlc_orient.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_dlc_pose_estimation/" class="md-nav__link">
        position_dlc_pose_estimation.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_dlc_position/" class="md-nav__link">
        position_dlc_position.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_dlc_project/" class="md-nav__link">
        position_dlc_project.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_dlc_selection/" class="md-nav__link">
        position_dlc_selection.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_dlc_training/" class="md-nav__link">
        position_dlc_training.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_trodes_position/" class="md-nav__link">
        position_trodes_position.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../settings/" class="md-nav__link">
        settings.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_12" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_12" id="__nav_4_1_1_12_label" tabindex="0">
          sharing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_12_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_12">
          <span class="md-nav__icon md-icon"></span>
          sharing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../sharing/sharing_kachery/" class="md-nav__link">
        sharing_kachery.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_13" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_13" id="__nav_4_1_1_13_label" tabindex="0">
          spikesorting
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_13_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_13">
          <span class="md-nav__icon md-icon"></span>
          spikesorting
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spikesorting/curation_figurl/" class="md-nav__link">
        curation_figurl.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spikesorting/merged_sorting_extractor/" class="md-nav__link">
        merged_sorting_extractor.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spikesorting/sortingview/" class="md-nav__link">
        sortingview.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spikesorting/sortingview_helper_fn/" class="md-nav__link">
        sortingview_helper_fn.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spikesorting/spikesorting_artifact/" class="md-nav__link">
        spikesorting_artifact.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spikesorting/spikesorting_curation/" class="md-nav__link">
        spikesorting_curation.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spikesorting/spikesorting_recording/" class="md-nav__link">
        spikesorting_recording.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spikesorting/spikesorting_sorting/" class="md-nav__link">
        spikesorting_sorting.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_14" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_14" id="__nav_4_1_1_14_label" tabindex="0">
          utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_14_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_14">
          <span class="md-nav__icon md-icon"></span>
          utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/dj_helper_fn/" class="md-nav__link">
        dj_helper_fn.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/dj_merge_tables/" class="md-nav__link">
        dj_merge_tables.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/nwb_helper_fn/" class="md-nav__link">
        nwb_helper_fn.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../../contribute/" class="md-nav__link">
        How to Contribute
      </a>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Miscellaneous
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Miscellaneous
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/figurl_views/" class="md-nav__link">
        FigURL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/session_groups/" class="md-nav__link">
        Session Groups
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/insert_data/" class="md-nav__link">
        Insert Data
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../../CHANGELOG/" class="md-nav__link">
        Change Log
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../../LICENSE/" class="md-nav__link">
        Copyright
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>common_ephys.py</h1>

<div class="doc doc-object doc-module">


<a id="src.spyglass.common.common_ephys"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">







<div class="doc doc-object doc-class">



<h2 id="src.spyglass.common.common_ephys.BrainRegion" class="doc doc-heading">
        <code>BrainRegion</code>


<a href="#src.spyglass.common.common_ephys.BrainRegion" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Lookup">Lookup</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/common/common_region.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">BrainRegion</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Lookup</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    region_id: smallint auto_increment</span>
<span class="s2">    ---</span>
<span class="s2">    region_name: varchar(200)             # the name of the brain region</span>
<span class="s2">    subregion_name=NULL: varchar(200)     # subregion name</span>
<span class="s2">    subsubregion_name=NULL: varchar(200)  # subregion within subregion</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO consider making (region_name, subregion_name, subsubregion_name) a primary key</span>
    <span class="c1"># subregion_name=&#39;&#39; and subsubregion_name=&#39;&#39; will be necessary but that seems OK</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fetch_add</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="n">subregion_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subsubregion_name</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the region ID for the given names, and if no match exists, first add it to the BrainRegion table.</span>

<span class="sd">        The combination of (region_name, subregion_name, subsubregion_name) is effectively unique, then.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        region_name : str</span>
<span class="sd">            The name of the brain region.</span>
<span class="sd">        subregion_name : str, optional</span>
<span class="sd">            The name of the subregion within the brain region.</span>
<span class="sd">        subsubregion_name : str, optional</span>
<span class="sd">            The name of the subregion within the subregion.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        region_id : int</span>
<span class="sd">            The index of the region in the BrainRegion table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;region_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_name</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;subregion_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subregion_name</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;subsubregion_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subsubregion_name</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">BrainRegion</span> <span class="o">&amp;</span> <span class="n">key</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">BrainRegion</span> <span class="o">&amp;</span> <span class="n">key</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;region_id&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_region.BrainRegion.fetch_add" class="doc doc-heading">
<code class="highlight language-python"><span class="n">fetch_add</span><span class="p">(</span><span class="n">region_name</span><span class="p">,</span> <span class="n">subregion_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subsubregion_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_region.BrainRegion.fetch_add" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Return the region ID for the given names, and if no match exists, first add it to the BrainRegion table.</p>
<p>The combination of (region_name, subregion_name, subsubregion_name) is effectively unique, then.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>region_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the brain region.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>subregion_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the subregion within the brain region.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>subsubregion_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the subregion within the subregion.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>region_id</code></td>          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The index of the region in the BrainRegion table.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_region.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">fetch_add</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="n">subregion_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subsubregion_name</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the region ID for the given names, and if no match exists, first add it to the BrainRegion table.</span>

<span class="sd">    The combination of (region_name, subregion_name, subsubregion_name) is effectively unique, then.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    region_name : str</span>
<span class="sd">        The name of the brain region.</span>
<span class="sd">    subregion_name : str, optional</span>
<span class="sd">        The name of the subregion within the brain region.</span>
<span class="sd">    subsubregion_name : str, optional</span>
<span class="sd">        The name of the subregion within the subregion.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    region_id : int</span>
<span class="sd">        The index of the region in the BrainRegion table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;region_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_name</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;subregion_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subregion_name</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;subsubregion_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subsubregion_name</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">BrainRegion</span> <span class="o">&amp;</span> <span class="n">key</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">BrainRegion</span> <span class="o">&amp;</span> <span class="n">key</span>
    <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;region_id&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.common.common_ephys.IntervalList" class="doc doc-heading">
        <code>IntervalList</code>


<a href="#src.spyglass.common.common_ephys.IntervalList" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Manual">Manual</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/common/common_interval.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">IntervalList</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # Time intervals used for analysis</span>
<span class="s2">    -&gt; Session</span>
<span class="s2">    interval_list_name: varchar(200)  # descriptive name of this interval list</span>
<span class="s2">    ---</span>
<span class="s2">    valid_times: longblob  # numpy array with start and end times for each interval</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">insert_from_nwbfile</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add each entry in the NWB file epochs table to the IntervalList table.</span>

<span class="sd">        The interval list name for each epoch is set to the first tag for the epoch.</span>
<span class="sd">        If the epoch has no tags, then &#39;interval_x&#39; will be used as the interval list name, where x is the index</span>
<span class="sd">        (0-indexed) of the epoch in the epochs table.</span>
<span class="sd">        The start time and stop time of the epoch are stored in the valid_times field as a numpy array of</span>
<span class="sd">        [start time, stop time] for each epoch.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nwbf : pynwb.NWBFile</span>
<span class="sd">            The source NWB file object.</span>
<span class="sd">        nwb_file_name : str</span>
<span class="sd">            The file name of the NWB file, used as a primary key to the Session table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">epochs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No epochs found in NWB file.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">epochs</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">epochs</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">epoch_index</span><span class="p">,</span> <span class="n">epoch_data</span> <span class="ow">in</span> <span class="n">epochs</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">epoch_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">epoch_dict</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_file_name</span>
            <span class="k">if</span> <span class="n">epoch_data</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">epoch_dict</span><span class="p">[</span><span class="s2">&quot;interval_list_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_data</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epoch_dict</span><span class="p">[</span><span class="s2">&quot;interval_list_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;interval_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="n">epoch_index</span>
                <span class="p">)</span>
            <span class="n">epoch_dict</span><span class="p">[</span><span class="s2">&quot;valid_times&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">epoch_data</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">epoch_data</span><span class="o">.</span><span class="n">stop_time</span><span class="p">]]</span>
            <span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">epoch_dict</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">)):</span>
        <span class="n">interval_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">interval_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">interval_list</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">valid_times</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="p">[</span><span class="n">interval_count</span><span class="p">,</span> <span class="n">interval_count</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">interval</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">interval_count</span><span class="p">,</span> <span class="n">interval_count</span><span class="p">],</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">interval_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">interval_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">interval_list</span><span class="o">.</span><span class="n">interval_list_name</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [s]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_epoch_pos_raw_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">)):</span>
        <span class="n">interval_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="n">raw_data_valid_times</span> <span class="o">=</span> <span class="n">interval_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">interval_list</span><span class="o">.</span><span class="n">interval_list_name</span> <span class="o">==</span> <span class="s2">&quot;raw data valid times&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">valid_times</span>
        <span class="n">interval_y</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">raw_data_valid_times</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="p">[</span><span class="n">interval_y</span><span class="p">,</span> <span class="n">interval_y</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="p">[</span><span class="n">interval_y</span><span class="p">,</span> <span class="n">interval_y</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">epoch_valid_times</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">interval_list</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;interval_list_name&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;^[0-9]&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="o">.</span><span class="n">valid_times</span>
        <span class="p">)</span>
        <span class="n">interval_y</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">valid_times</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">epoch_valid_times</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">epoch_valid_times</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">valid_times</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="p">[</span><span class="n">interval_y</span><span class="p">,</span> <span class="n">interval_y</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">interval</span><span class="p">,</span> <span class="p">[</span><span class="n">interval_y</span><span class="p">,</span> <span class="n">interval_y</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">interval</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">interval_y</span><span class="p">,</span>
                    <span class="n">epoch</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">pos_valid_times</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">interval_list</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;interval_list_name&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;^pos \d+ valid times$&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="o">.</span><span class="n">valid_times</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">index</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">index</span><span class="p">])</span>
        <span class="n">interval_y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">valid_times</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pos_valid_times</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pos_valid_times</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">valid_times</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="p">[</span><span class="n">interval_y</span><span class="p">,</span> <span class="n">interval_y</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">interval</span><span class="p">,</span> <span class="p">[</span><span class="n">interval_y</span><span class="p">,</span> <span class="n">interval_y</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">interval</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">interval_y</span><span class="p">,</span>
                    <span class="n">epoch</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; valid times&quot;</span><span class="p">),</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">2.25</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;pos valid times&quot;</span><span class="p">,</span> <span class="s2">&quot;raw data valid times&quot;</span><span class="p">,</span> <span class="s2">&quot;epoch&quot;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [s]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_interval.IntervalList.insert_from_nwbfile" class="doc doc-heading">
<code class="highlight language-python"><span class="n">insert_from_nwbfile</span><span class="p">(</span><span class="n">nwbf</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_interval.IntervalList.insert_from_nwbfile" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add each entry in the NWB file epochs table to the IntervalList table.</p>
<p>The interval list name for each epoch is set to the first tag for the epoch.
If the epoch has no tags, then 'interval_x' will be used as the interval list name, where x is the index
(0-indexed) of the epoch in the epochs table.
The start time and stop time of the epoch are stored in the valid_times field as a numpy array of
[start time, stop time] for each epoch.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwbf</code></td>
          <td>
                <code>pynwb.<span title="pynwb.NWBFile">NWBFile</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The source NWB file object.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The file name of the NWB file, used as a primary key to the Session table.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_interval.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">insert_from_nwbfile</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add each entry in the NWB file epochs table to the IntervalList table.</span>

<span class="sd">    The interval list name for each epoch is set to the first tag for the epoch.</span>
<span class="sd">    If the epoch has no tags, then &#39;interval_x&#39; will be used as the interval list name, where x is the index</span>
<span class="sd">    (0-indexed) of the epoch in the epochs table.</span>
<span class="sd">    The start time and stop time of the epoch are stored in the valid_times field as a numpy array of</span>
<span class="sd">    [start time, stop time] for each epoch.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwbf : pynwb.NWBFile</span>
<span class="sd">        The source NWB file object.</span>
<span class="sd">    nwb_file_name : str</span>
<span class="sd">        The file name of the NWB file, used as a primary key to the Session table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">epochs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No epochs found in NWB file.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">epochs</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">epoch_index</span><span class="p">,</span> <span class="n">epoch_data</span> <span class="ow">in</span> <span class="n">epochs</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">epoch_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">epoch_dict</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_file_name</span>
        <span class="k">if</span> <span class="n">epoch_data</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">epoch_dict</span><span class="p">[</span><span class="s2">&quot;interval_list_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_data</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">epoch_dict</span><span class="p">[</span><span class="s2">&quot;interval_list_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;interval_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">epoch_index</span>
            <span class="p">)</span>
        <span class="n">epoch_dict</span><span class="p">[</span><span class="s2">&quot;valid_times&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">epoch_data</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">epoch_data</span><span class="o">.</span><span class="n">stop_time</span><span class="p">]]</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">epoch_dict</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-function">



<h2 id="src.spyglass.common.common_ephys.get_nwb_file" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_nwb_file</span><span class="p">(</span><span class="n">nwb_file_path</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_ephys.get_nwb_file" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Return an NWBFile object with the given file path in read mode.
   If the file is not found locally, this will check if it has been shared with kachery and if so, download it and open it.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwb_file_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Path to the NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>nwbfile</code></td>          <td>
                <code>pynwb.<span title="pynwb.NWBFile">NWBFile</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>NWB file object for the given path opened in read mode.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/utils/nwb_helper_fn.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_nwb_file</span><span class="p">(</span><span class="n">nwb_file_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return an NWBFile object with the given file path in read mode.</span>
<span class="sd">       If the file is not found locally, this will check if it has been shared with kachery and if so, download it and open it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwb_file_path : str</span>
<span class="sd">        Path to the NWB file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nwbfile : pynwb.NWBFile</span>
<span class="sd">        NWB file object for the given path opened in read mode.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">nwbfile</span> <span class="o">=</span> <span class="n">__open_nwb_files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nwb_file_path</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="n">nwb_uri</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nwb_raw_uri</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">nwbfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># check to see if the file exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">nwb_file_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;NWB file </span><span class="si">{</span><span class="n">nwb_file_path</span><span class="si">}</span><span class="s2"> does not exist locally; checking kachery&quot;</span>
            <span class="p">)</span>
            <span class="c1"># first try the analysis files</span>
            <span class="kn">from</span> <span class="nn">..sharing.sharing_kachery</span> <span class="kn">import</span> <span class="n">AnalysisNwbfileKachery</span>

            <span class="c1"># the download functions assume just the filename, so we need to get that from the path</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">AnalysisNwbfileKachery</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">nwb_file_path</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># now open the file</span>
        <span class="n">io</span> <span class="o">=</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">nwb_file_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>  <span class="c1"># keep file open</span>
        <span class="n">nwbfile</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">__open_nwb_files</span><span class="p">[</span><span class="n">nwb_file_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">nwbfile</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nwbfile</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.common.common_ephys.FirFilterParameters" class="doc doc-heading">
        <code>FirFilterParameters</code>


<a href="#src.spyglass.common.common_ephys.FirFilterParameters" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Manual">Manual</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/common/common_filter.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">FirFilterParameters</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    filter_name: varchar(80)           # descriptive name of this filter</span>
<span class="s2">    filter_sampling_rate: int          # sampling rate for this filter</span>
<span class="s2">    ---</span>
<span class="s2">    filter_type: enum(&quot;lowpass&quot;, &quot;highpass&quot;, &quot;bandpass&quot;)</span>
<span class="s2">    filter_low_stop = 0: float         # lowest frequency for stop band for low frequency side of filter</span>
<span class="s2">    filter_low_pass = 0: float         # lowest frequency for pass band of low frequency side of filter</span>
<span class="s2">    filter_high_pass = 0: float        # highest frequency for pass band for high frequency side of filter</span>
<span class="s2">    filter_high_stop = 0: float        # highest frequency for stop band of high frequency side of filter</span>
<span class="s2">    filter_comments: varchar(2000)     # comments about the filter</span>
<span class="s2">    filter_band_edges: blob            # numpy array containing the filter bands (redundant with individual parameters)</span>
<span class="s2">    filter_coeff: longblob             # numpy array containing the filter coefficients</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">add_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">filter_type</span><span class="p">,</span> <span class="n">band_edges</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">gsp</span> <span class="o">=</span> <span class="n">_import_ghostipy</span><span class="p">()</span>

        <span class="c1"># add an FIR bandpass filter of the specified type (&#39;lowpass&#39;, &#39;highpass&#39;, or &#39;bandpass&#39;).</span>
        <span class="c1"># band_edges should be as follows:</span>
        <span class="c1">#   low pass filter: [high_pass high_stop]</span>
        <span class="c1">#   high pass filter: [low stop low pass]</span>
        <span class="c1">#   band pass filter: [low_stop low_pass high_pass high_stop].</span>
        <span class="k">if</span> <span class="n">filter_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;lowpass&quot;</span><span class="p">,</span> <span class="s2">&quot;highpass&quot;</span><span class="p">,</span> <span class="s2">&quot;bandpass&quot;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Error in Filter.add_filter: filter type </span><span class="si">{}</span><span class="s2"> is not &quot;</span>
                <span class="s2">&quot;lowpass&quot;</span>
                <span class="s2">&quot;, &quot;</span>
                <span class="s2">&quot;highpass&quot;</span>
                <span class="s2">&quot; or &quot;</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;bandpass&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filter_type</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">p</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># transition spline will be quadratic</span>
        <span class="k">if</span> <span class="n">filter_type</span> <span class="o">==</span> <span class="s2">&quot;lowpass&quot;</span> <span class="ow">or</span> <span class="n">filter_type</span> <span class="o">==</span> <span class="s2">&quot;highpass&quot;</span><span class="p">:</span>
            <span class="c1"># check that two frequencies were passed in and that they are in the right order</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">band_edges</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Error in Filter.add_filter: lowpass and highpass filter requires two band_frequencies&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">tw</span> <span class="o">=</span> <span class="n">band_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">band_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">filter_type</span> <span class="o">==</span> <span class="s2">&quot;bandpass&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">band_edges</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Error in Filter.add_filter: bandpass filter requires four band_frequencies.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="c1"># the transition width is the mean of the widths of left and right transition regions</span>
            <span class="n">tw</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">band_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">band_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">band_edges</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">band_edges</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected filter type: </span><span class="si">{</span><span class="n">filter_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">numtaps</span> <span class="o">=</span> <span class="n">gsp</span><span class="o">.</span><span class="n">estimate_taps</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">tw</span><span class="p">)</span>
        <span class="n">filterdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">filterdict</span><span class="p">[</span><span class="s2">&quot;filter_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_name</span>
        <span class="n">filterdict</span><span class="p">[</span><span class="s2">&quot;filter_sampling_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs</span>
        <span class="n">filterdict</span><span class="p">[</span><span class="s2">&quot;filter_comments&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comments</span>

        <span class="c1"># set the desired frequency response</span>
        <span class="k">if</span> <span class="n">filter_type</span> <span class="o">==</span> <span class="s2">&quot;lowpass&quot;</span><span class="p">:</span>
            <span class="n">desired</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">filterdict</span><span class="p">[</span><span class="s2">&quot;filter_low_stop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">filterdict</span><span class="p">[</span><span class="s2">&quot;filter_low_pass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">filterdict</span><span class="p">[</span><span class="s2">&quot;filter_high_pass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">filterdict</span><span class="p">[</span><span class="s2">&quot;filter_high_stop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">filter_type</span> <span class="o">==</span> <span class="s2">&quot;highpass&quot;</span><span class="p">:</span>
            <span class="n">desired</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">filterdict</span><span class="p">[</span><span class="s2">&quot;filter_low_stop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">filterdict</span><span class="p">[</span><span class="s2">&quot;filter_low_pass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">filterdict</span><span class="p">[</span><span class="s2">&quot;filter_high_pass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">filterdict</span><span class="p">[</span><span class="s2">&quot;filter_high_stop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">desired</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">filterdict</span><span class="p">[</span><span class="s2">&quot;filter_low_stop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">filterdict</span><span class="p">[</span><span class="s2">&quot;filter_low_pass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">filterdict</span><span class="p">[</span><span class="s2">&quot;filter_high_pass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_edges</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">filterdict</span><span class="p">[</span><span class="s2">&quot;filter_high_stop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_edges</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">filterdict</span><span class="p">[</span><span class="s2">&quot;filter_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_type</span>
        <span class="n">filterdict</span><span class="p">[</span><span class="s2">&quot;filter_band_edges&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">band_edges</span><span class="p">)</span>
        <span class="c1"># create 1d array for coefficients</span>
        <span class="n">filterdict</span><span class="p">[</span><span class="s2">&quot;filter_coeff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">gsp</span><span class="o">.</span><span class="n">firdesign</span><span class="p">(</span><span class="n">numtaps</span><span class="p">,</span> <span class="n">band_edges</span><span class="p">,</span> <span class="n">desired</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">),</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="c1"># add this filter to the table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">filterdict</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_magnitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">,</span> <span class="n">fs</span><span class="p">):</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;filter_name&quot;</span><span class="p">:</span> <span class="n">filter_name</span><span class="p">}</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;filter_sampling_rate&quot;</span><span class="p">:</span> <span class="n">fs</span><span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">as_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">freqz</span><span class="p">(</span><span class="nb">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;filter_coeff&quot;</span><span class="p">],</span> <span class="n">worN</span><span class="o">=</span><span class="mi">65536</span><span class="p">)</span>
        <span class="n">magnitude</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">fs</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">magnitude</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Frequency (Hz)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Magnitude&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Frequency Response&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;filter_coeffand_edges&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">magnitude</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">magnitude</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_fir_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">,</span> <span class="n">fs</span><span class="p">):</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;filter_name&quot;</span><span class="p">:</span> <span class="n">filter_name</span><span class="p">}</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;filter_sampling_rate&quot;</span><span class="p">:</span> <span class="n">fs</span><span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">as_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;filter_coeff&quot;</span><span class="p">],</span> <span class="s2">&quot;k&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Coefficient&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Magnitude&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Filter Taps&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">filter_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">,</span> <span class="n">fs</span><span class="p">):</span>
        <span class="c1"># return the filter delay</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;filter_name&quot;</span><span class="p">:</span> <span class="n">filter_name</span><span class="p">}</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;filter_sampling_rate&quot;</span><span class="p">:</span> <span class="n">fs</span><span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">as_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_filter_delay</span><span class="p">(</span><span class="nb">filter</span><span class="p">[</span><span class="s2">&quot;filter_coeff&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">filter_data_nwb</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">analysis_file_abs_path</span><span class="p">,</span>
        <span class="n">eseries</span><span class="p">,</span>
        <span class="n">filter_coeff</span><span class="p">,</span>
        <span class="n">valid_times</span><span class="p">,</span>
        <span class="n">electrode_ids</span><span class="p">,</span>
        <span class="n">decimation</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;filtered data&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param analysis_nwb_file_name: str   full path to previously created analysis nwb file where filtered data</span>
<span class="sd">        should be stored. This also has the name of the original NWB file where the data will be taken from</span>
<span class="sd">        :param eseries: electrical series with data to be filtered</span>
<span class="sd">        :param filter_coeff: numpy array with filter coefficients for FIR filter</span>
<span class="sd">        :param valid_times: 2D numpy array with start and stop times of intervals to be filtered</span>
<span class="sd">        :param electrode_ids: list of electrode_ids to filter</span>
<span class="sd">        :param decimation: int decimation factor</span>
<span class="sd">        :return: The NWB object id of the filtered data (str), list containing first and last timestamp</span>

<span class="sd">        This function takes data and timestamps from an NWB electrical series and filters them using the ghostipy</span>
<span class="sd">        package, saving the result as a new electricalseries in the nwb_file_name, which should have previously been</span>
<span class="sd">        created and linked to the original NWB file using common_session.AnalysisNwbfile.create()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gsp</span> <span class="o">=</span> <span class="n">_import_ghostipy</span><span class="p">()</span>

        <span class="n">data_on_disk</span> <span class="o">=</span> <span class="n">eseries</span><span class="o">.</span><span class="n">data</span>
        <span class="n">timestamps_on_disk</span> <span class="o">=</span> <span class="n">eseries</span><span class="o">.</span><span class="n">timestamps</span>
        <span class="n">n_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_on_disk</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">timestamps_on_disk</span><span class="p">)</span>
        <span class="c1"># find the</span>
        <span class="n">time_axis</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">data_on_disk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">n_samples</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">electrode_axis</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">time_axis</span>
        <span class="n">n_electrodes</span> <span class="o">=</span> <span class="n">data_on_disk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">electrode_axis</span><span class="p">]</span>
        <span class="n">input_dim_restrictions</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_dim</span>

        <span class="c1"># to get the input dimension restrictions we need to look at the electrode table for the eseries and get</span>
        <span class="c1"># the indices from that</span>
        <span class="n">input_dim_restrictions</span><span class="p">[</span><span class="n">electrode_axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span>
            <span class="n">get_electrode_indices</span><span class="p">(</span><span class="n">eseries</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output_shape_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_dim</span>
        <span class="n">output_shape_list</span><span class="p">[</span><span class="n">electrode_axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">electrode_ids</span><span class="p">)</span>
        <span class="n">output_offsets</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">timestamp_size</span> <span class="o">=</span> <span class="n">timestamps_on_disk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="n">timestamp_dtype</span> <span class="o">=</span> <span class="n">timestamps_on_disk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
        <span class="n">data_size</span> <span class="o">=</span> <span class="n">data_on_disk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="n">data_dtype</span> <span class="o">=</span> <span class="n">data_on_disk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>

        <span class="n">filter_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_filter_delay</span><span class="p">(</span><span class="n">filter_coeff</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a_start</span><span class="p">,</span> <span class="n">a_stop</span> <span class="ow">in</span> <span class="n">valid_times</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a_start</span> <span class="o">&lt;</span> <span class="n">timestamps_on_disk</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Interval start time </span><span class="si">{</span><span class="n">a_start</span><span class="si">}</span><span class="s2"> is smaller than first timestamp </span><span class="si">{</span><span class="n">timestamps_on_disk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="s2">&quot;using first timestamp instead&quot;</span>
                <span class="p">)</span>
                <span class="n">a_start</span> <span class="o">=</span> <span class="n">timestamps_on_disk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">a_stop</span> <span class="o">&gt;</span> <span class="n">timestamps_on_disk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Interval stop time </span><span class="si">{</span><span class="n">a_stop</span><span class="si">}</span><span class="s2"> is larger than last timestamp </span><span class="si">{</span><span class="n">timestamps_on_disk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="s2">&quot;using last timestamp instead&quot;</span>
                <span class="p">)</span>
                <span class="n">a_stop</span> <span class="o">=</span> <span class="n">timestamps_on_disk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">frm</span><span class="p">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">timestamps_on_disk</span><span class="p">,</span> <span class="p">(</span><span class="n">a_start</span><span class="p">,</span> <span class="n">a_stop</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">to</span> <span class="o">&gt;</span> <span class="n">n_samples</span><span class="p">:</span>
                <span class="n">to</span> <span class="o">=</span> <span class="n">n_samples</span>
            <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">frm</span><span class="p">,</span> <span class="n">to</span><span class="p">))</span>
            <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">gsp</span><span class="o">.</span><span class="n">filter_data_fir</span><span class="p">(</span>
                <span class="n">data_on_disk</span><span class="p">,</span>
                <span class="n">filter_coeff</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="n">time_axis</span><span class="p">,</span>
                <span class="n">input_index_bounds</span><span class="o">=</span><span class="p">[</span><span class="n">frm</span><span class="p">,</span> <span class="n">to</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">output_index_bounds</span><span class="o">=</span><span class="p">[</span><span class="n">filter_delay</span><span class="p">,</span> <span class="n">filter_delay</span> <span class="o">+</span> <span class="n">to</span> <span class="o">-</span> <span class="n">frm</span><span class="p">],</span>
                <span class="n">describe_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">ds</span><span class="o">=</span><span class="n">decimation</span><span class="p">,</span>
                <span class="n">input_dim_restrictions</span><span class="o">=</span><span class="n">input_dim_restrictions</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">output_offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_offsets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="n">time_axis</span><span class="p">])</span>
            <span class="n">output_shape_list</span><span class="p">[</span><span class="n">time_axis</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shape</span><span class="p">[</span><span class="n">time_axis</span><span class="p">]</span>

        <span class="c1"># open the nwb file to create the dynamic table region and electrode series, then write and close the file</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="c1"># get the indices of the electrodes in the electrode table</span>
            <span class="n">elect_ind</span> <span class="o">=</span> <span class="n">get_electrode_indices</span><span class="p">(</span><span class="n">nwbf</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">)</span>

            <span class="n">electrode_table_region</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">create_electrode_table_region</span><span class="p">(</span>
                <span class="n">elect_ind</span><span class="p">,</span> <span class="s2">&quot;filtered electrode table&quot;</span>
            <span class="p">)</span>
            <span class="n">eseries_name</span> <span class="o">=</span> <span class="s2">&quot;filtered data&quot;</span>
            <span class="n">es</span> <span class="o">=</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">ecephys</span><span class="o">.</span><span class="n">ElectricalSeries</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">eseries_name</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">output_shape_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data_dtype</span><span class="p">),</span>
                <span class="n">electrodes</span><span class="o">=</span><span class="n">electrode_table_region</span><span class="p">,</span>
                <span class="n">timestamps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">output_shape_list</span><span class="p">[</span><span class="n">time_axis</span><span class="p">]),</span>
                <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;LFP&quot;</span><span class="p">:</span>
                <span class="n">lfp</span> <span class="o">=</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">ecephys</span><span class="o">.</span><span class="n">LFP</span><span class="p">(</span><span class="n">electrical_series</span><span class="o">=</span><span class="n">es</span><span class="p">)</span>
                <span class="n">ecephys_module</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">create_processing_module</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ecephys&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span>
                <span class="p">)</span>
                <span class="n">ecephys_module</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lfp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span><span class="n">es</span><span class="p">)</span>
            <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>

            <span class="c1"># reload the NWB file to get the h5py objects for the data and the timestamps</span>
            <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
                <span class="n">path</span><span class="o">=</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
                <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">es</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="n">es</span><span class="o">.</span><span class="n">object_id</span><span class="p">]</span>
                <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">data</span>
                <span class="n">new_timestamps</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">timestamps</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1"># Filter and write the output dataset</span>
                <span class="n">ts_offset</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Filtering data&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
                    <span class="c1"># calculate the size of the timestamps and the data and determine whether they</span>
                    <span class="c1"># can be loaded into &lt; 90% of available RAM</span>
                    <span class="n">mem</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span>
                    <span class="n">interval_samples</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">interval_samples</span>
                        <span class="o">*</span> <span class="p">(</span><span class="n">timestamp_size</span> <span class="o">+</span> <span class="n">n_electrodes</span> <span class="o">*</span> <span class="n">data_size</span><span class="p">)</span>
                        <span class="o">&lt;</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">mem</span><span class="o">.</span><span class="n">available</span>
                    <span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interval </span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s2">: loading data into memory&quot;</span><span class="p">)</span>
                        <span class="n">timestamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                            <span class="n">timestamps_on_disk</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">],</span>
                            <span class="n">dtype</span><span class="o">=</span><span class="n">timestamp_dtype</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">time_axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                                <span class="n">data_on_disk</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data_dtype</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                                <span class="n">data_on_disk</span><span class="p">[:,</span> <span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data_dtype</span>
                            <span class="p">)</span>
                        <span class="n">extracted_ts</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">decimation</span><span class="p">]</span>
                        <span class="n">new_timestamps</span><span class="p">[</span>
                            <span class="n">ts_offset</span> <span class="p">:</span> <span class="n">ts_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">extracted_ts</span><span class="p">)</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">extracted_ts</span>
                        <span class="n">ts_offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">extracted_ts</span><span class="p">)</span>
                        <span class="c1"># filter the data</span>
                        <span class="n">gsp</span><span class="o">.</span><span class="n">filter_data_fir</span><span class="p">(</span>
                            <span class="n">data</span><span class="p">,</span>
                            <span class="n">filter_coeff</span><span class="p">,</span>
                            <span class="n">axis</span><span class="o">=</span><span class="n">time_axis</span><span class="p">,</span>
                            <span class="n">input_index_bounds</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">interval_samples</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                            <span class="n">output_index_bounds</span><span class="o">=</span><span class="p">[</span>
                                <span class="n">filter_delay</span><span class="p">,</span>
                                <span class="n">filter_delay</span> <span class="o">+</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span>
                            <span class="p">],</span>
                            <span class="n">ds</span><span class="o">=</span><span class="n">decimation</span><span class="p">,</span>
                            <span class="n">input_dim_restrictions</span><span class="o">=</span><span class="n">input_dim_restrictions</span><span class="p">,</span>
                            <span class="n">outarray</span><span class="o">=</span><span class="n">filtered_data</span><span class="p">,</span>
                            <span class="n">output_offset</span><span class="o">=</span><span class="n">output_offsets</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interval </span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s2">: leaving data on disk&quot;</span><span class="p">)</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">data_on_disk</span>
                        <span class="n">timestamps</span> <span class="o">=</span> <span class="n">timestamps_on_disk</span>
                        <span class="n">extracted_ts</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">decimation</span><span class="p">]</span>
                        <span class="n">new_timestamps</span><span class="p">[</span>
                            <span class="n">ts_offset</span> <span class="p">:</span> <span class="n">ts_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">extracted_ts</span><span class="p">)</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">extracted_ts</span>
                        <span class="n">ts_offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">extracted_ts</span><span class="p">)</span>
                        <span class="c1"># filter the data</span>
                        <span class="n">gsp</span><span class="o">.</span><span class="n">filter_data_fir</span><span class="p">(</span>
                            <span class="n">data</span><span class="p">,</span>
                            <span class="n">filter_coeff</span><span class="p">,</span>
                            <span class="n">axis</span><span class="o">=</span><span class="n">time_axis</span><span class="p">,</span>
                            <span class="n">input_index_bounds</span><span class="o">=</span><span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">],</span>
                            <span class="n">output_index_bounds</span><span class="o">=</span><span class="p">[</span>
                                <span class="n">filter_delay</span><span class="p">,</span>
                                <span class="n">filter_delay</span> <span class="o">+</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span>
                            <span class="p">],</span>
                            <span class="n">ds</span><span class="o">=</span><span class="n">decimation</span><span class="p">,</span>
                            <span class="n">input_dim_restrictions</span><span class="o">=</span><span class="n">input_dim_restrictions</span><span class="p">,</span>
                            <span class="n">outarray</span><span class="o">=</span><span class="n">filtered_data</span><span class="p">,</span>
                            <span class="n">output_offset</span><span class="o">=</span><span class="n">output_offsets</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                        <span class="p">)</span>

                <span class="n">start_end</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_timestamps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

                <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">es</span><span class="o">.</span><span class="n">object_id</span><span class="p">,</span> <span class="n">start_end</span>

    <span class="k">def</span> <span class="nf">filter_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">timestamps</span><span class="p">,</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">filter_coeff</span><span class="p">,</span>
        <span class="n">valid_times</span><span class="p">,</span>
        <span class="n">electrodes</span><span class="p">,</span>
        <span class="n">decimation</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param timestamps: numpy array with list of timestamps for data</span>
<span class="sd">        :param data: original data array</span>
<span class="sd">        :param filter_coeff: numpy array with filter coefficients for FIR filter</span>
<span class="sd">        :param valid_times: 2D numpy array with start and stop times of intervals to be filtered</span>
<span class="sd">        :param electrodes: list of electrodes to filter</span>
<span class="sd">        :param decimation: decimation factor</span>
<span class="sd">        :return: filtered_data, timestamps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gsp</span> <span class="o">=</span> <span class="n">_import_ghostipy</span><span class="p">()</span>

        <span class="n">n_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span>
        <span class="n">time_axis</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">n_samples</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">electrode_axis</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">time_axis</span>
        <span class="n">input_dim_restrictions</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_dim</span>
        <span class="n">input_dim_restrictions</span><span class="p">[</span><span class="n">electrode_axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="n">electrodes</span><span class="p">]</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output_shape_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_dim</span>
        <span class="n">output_shape_list</span><span class="p">[</span><span class="n">electrode_axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">electrodes</span><span class="p">)</span>
        <span class="n">output_offsets</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">filter_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_filter_delay</span><span class="p">(</span><span class="n">filter_coeff</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a_start</span><span class="p">,</span> <span class="n">a_stop</span> <span class="ow">in</span> <span class="n">valid_times</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a_start</span> <span class="o">&lt;</span> <span class="n">timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Interval start time </span><span class="si">{</span><span class="n">a_start</span><span class="si">}</span><span class="s2"> is smaller than first timestamp &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, using first timestamp instead&quot;</span>
                <span class="p">)</span>
                <span class="n">a_start</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">a_stop</span> <span class="o">&gt;</span> <span class="n">timestamps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Interval stop time </span><span class="si">{</span><span class="n">a_stop</span><span class="si">}</span><span class="s2"> is larger than last timestamp &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, using last timestamp instead&quot;</span>
                <span class="p">)</span>
                <span class="n">a_stop</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">frm</span><span class="p">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="p">(</span><span class="n">a_start</span><span class="p">,</span> <span class="n">a_stop</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">to</span> <span class="o">&gt;</span> <span class="n">n_samples</span><span class="p">:</span>
                <span class="n">to</span> <span class="o">=</span> <span class="n">n_samples</span>

            <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">frm</span><span class="p">,</span> <span class="n">to</span><span class="p">))</span>
            <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">gsp</span><span class="o">.</span><span class="n">filter_data_fir</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">filter_coeff</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="n">time_axis</span><span class="p">,</span>
                <span class="n">input_index_bounds</span><span class="o">=</span><span class="p">[</span><span class="n">frm</span><span class="p">,</span> <span class="n">to</span><span class="p">],</span>
                <span class="n">output_index_bounds</span><span class="o">=</span><span class="p">[</span><span class="n">filter_delay</span><span class="p">,</span> <span class="n">filter_delay</span> <span class="o">+</span> <span class="n">to</span> <span class="o">-</span> <span class="n">frm</span><span class="p">],</span>
                <span class="n">describe_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">ds</span><span class="o">=</span><span class="n">decimation</span><span class="p">,</span>
                <span class="n">input_dim_restrictions</span><span class="o">=</span><span class="n">input_dim_restrictions</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">output_offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_offsets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="n">time_axis</span><span class="p">])</span>
            <span class="n">output_shape_list</span><span class="p">[</span><span class="n">time_axis</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shape</span><span class="p">[</span><span class="n">time_axis</span><span class="p">]</span>

        <span class="c1"># create the dataset and the timestamps array</span>
        <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">output_shape_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="n">new_timestamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
            <span class="p">(</span><span class="n">output_shape_list</span><span class="p">[</span><span class="n">time_axis</span><span class="p">],),</span> <span class="n">timestamps</span><span class="o">.</span><span class="n">dtype</span>
        <span class="p">)</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Filter  the output dataset</span>
        <span class="n">ts_offset</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
            <span class="n">extracted_ts</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">decimation</span><span class="p">]</span>

            <span class="c1"># print(f&quot;Diffs {np.diff(extracted_ts)}&quot;)</span>
            <span class="n">new_timestamps</span><span class="p">[</span>
                <span class="n">ts_offset</span> <span class="p">:</span> <span class="n">ts_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">extracted_ts</span><span class="p">)</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">extracted_ts</span>
            <span class="n">ts_offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">extracted_ts</span><span class="p">)</span>

            <span class="c1"># finally ready to filter data!</span>
            <span class="n">gsp</span><span class="o">.</span><span class="n">filter_data_fir</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">filter_coeff</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="n">time_axis</span><span class="p">,</span>
                <span class="n">input_index_bounds</span><span class="o">=</span><span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">],</span>
                <span class="n">output_index_bounds</span><span class="o">=</span><span class="p">[</span><span class="n">filter_delay</span><span class="p">,</span> <span class="n">filter_delay</span> <span class="o">+</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">],</span>
                <span class="n">ds</span><span class="o">=</span><span class="n">decimation</span><span class="p">,</span>
                <span class="n">input_dim_restrictions</span><span class="o">=</span><span class="n">input_dim_restrictions</span><span class="p">,</span>
                <span class="n">outarray</span><span class="o">=</span><span class="n">filtered_data</span><span class="p">,</span>
                <span class="n">output_offset</span><span class="o">=</span><span class="n">output_offsets</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">filtered_data</span><span class="p">,</span> <span class="n">new_timestamps</span>

    <span class="k">def</span> <span class="nf">calc_filter_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_coeff</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param filter_coeff:</span>
<span class="sd">        :return: filter delay</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filter_coeff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">create_standard_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add standard filters to the Filter table including</span>
<span class="sd">        0-400 Hz low pass for continuous raw data -&gt; LFP</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span>
            <span class="s2">&quot;LFP 0-400 Hz&quot;</span><span class="p">,</span>
            <span class="mi">20000</span><span class="p">,</span>
            <span class="s2">&quot;lowpass&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="mi">400</span><span class="p">,</span> <span class="mi">425</span><span class="p">],</span>
            <span class="s2">&quot;standard LFP filter for 20 KHz data&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span>
            <span class="s2">&quot;LFP 0-400 Hz&quot;</span><span class="p">,</span>
            <span class="mi">30000</span><span class="p">,</span>
            <span class="s2">&quot;lowpass&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="mi">400</span><span class="p">,</span> <span class="mi">425</span><span class="p">],</span>
            <span class="s2">&quot;standard LFP filter for 30 KHz data&quot;</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_filter.FirFilterParameters.filter_data_nwb" class="doc doc-heading">
<code class="highlight language-python"><span class="n">filter_data_nwb</span><span class="p">(</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">eseries</span><span class="p">,</span> <span class="n">filter_coeff</span><span class="p">,</span> <span class="n">valid_times</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">,</span> <span class="n">decimation</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;filtered data&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_filter.FirFilterParameters.filter_data_nwb" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>:param analysis_nwb_file_name: str   full path to previously created analysis nwb file where filtered data
should be stored. This also has the name of the original NWB file where the data will be taken from
:param eseries: electrical series with data to be filtered
:param filter_coeff: numpy array with filter coefficients for FIR filter
:param valid_times: 2D numpy array with start and stop times of intervals to be filtered
:param electrode_ids: list of electrode_ids to filter
:param decimation: int decimation factor
:return: The NWB object id of the filtered data (str), list containing first and last timestamp</p>
<p>This function takes data and timestamps from an NWB electrical series and filters them using the ghostipy
package, saving the result as a new electricalseries in the nwb_file_name, which should have previously been
created and linked to the original NWB file using common_session.AnalysisNwbfile.create()</p>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_filter.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">filter_data_nwb</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">analysis_file_abs_path</span><span class="p">,</span>
    <span class="n">eseries</span><span class="p">,</span>
    <span class="n">filter_coeff</span><span class="p">,</span>
    <span class="n">valid_times</span><span class="p">,</span>
    <span class="n">electrode_ids</span><span class="p">,</span>
    <span class="n">decimation</span><span class="p">,</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;filtered data&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param analysis_nwb_file_name: str   full path to previously created analysis nwb file where filtered data</span>
<span class="sd">    should be stored. This also has the name of the original NWB file where the data will be taken from</span>
<span class="sd">    :param eseries: electrical series with data to be filtered</span>
<span class="sd">    :param filter_coeff: numpy array with filter coefficients for FIR filter</span>
<span class="sd">    :param valid_times: 2D numpy array with start and stop times of intervals to be filtered</span>
<span class="sd">    :param electrode_ids: list of electrode_ids to filter</span>
<span class="sd">    :param decimation: int decimation factor</span>
<span class="sd">    :return: The NWB object id of the filtered data (str), list containing first and last timestamp</span>

<span class="sd">    This function takes data and timestamps from an NWB electrical series and filters them using the ghostipy</span>
<span class="sd">    package, saving the result as a new electricalseries in the nwb_file_name, which should have previously been</span>
<span class="sd">    created and linked to the original NWB file using common_session.AnalysisNwbfile.create()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gsp</span> <span class="o">=</span> <span class="n">_import_ghostipy</span><span class="p">()</span>

    <span class="n">data_on_disk</span> <span class="o">=</span> <span class="n">eseries</span><span class="o">.</span><span class="n">data</span>
    <span class="n">timestamps_on_disk</span> <span class="o">=</span> <span class="n">eseries</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="n">n_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_on_disk</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">timestamps_on_disk</span><span class="p">)</span>
    <span class="c1"># find the</span>
    <span class="n">time_axis</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">data_on_disk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">n_samples</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">electrode_axis</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">time_axis</span>
    <span class="n">n_electrodes</span> <span class="o">=</span> <span class="n">data_on_disk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">electrode_axis</span><span class="p">]</span>
    <span class="n">input_dim_restrictions</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_dim</span>

    <span class="c1"># to get the input dimension restrictions we need to look at the electrode table for the eseries and get</span>
    <span class="c1"># the indices from that</span>
    <span class="n">input_dim_restrictions</span><span class="p">[</span><span class="n">electrode_axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span>
        <span class="n">get_electrode_indices</span><span class="p">(</span><span class="n">eseries</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">output_shape_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_dim</span>
    <span class="n">output_shape_list</span><span class="p">[</span><span class="n">electrode_axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">electrode_ids</span><span class="p">)</span>
    <span class="n">output_offsets</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">timestamp_size</span> <span class="o">=</span> <span class="n">timestamps_on_disk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">itemsize</span>
    <span class="n">timestamp_dtype</span> <span class="o">=</span> <span class="n">timestamps_on_disk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
    <span class="n">data_size</span> <span class="o">=</span> <span class="n">data_on_disk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">itemsize</span>
    <span class="n">data_dtype</span> <span class="o">=</span> <span class="n">data_on_disk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>

    <span class="n">filter_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_filter_delay</span><span class="p">(</span><span class="n">filter_coeff</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a_start</span><span class="p">,</span> <span class="n">a_stop</span> <span class="ow">in</span> <span class="n">valid_times</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a_start</span> <span class="o">&lt;</span> <span class="n">timestamps_on_disk</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Interval start time </span><span class="si">{</span><span class="n">a_start</span><span class="si">}</span><span class="s2"> is smaller than first timestamp </span><span class="si">{</span><span class="n">timestamps_on_disk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="s2">&quot;using first timestamp instead&quot;</span>
            <span class="p">)</span>
            <span class="n">a_start</span> <span class="o">=</span> <span class="n">timestamps_on_disk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">a_stop</span> <span class="o">&gt;</span> <span class="n">timestamps_on_disk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Interval stop time </span><span class="si">{</span><span class="n">a_stop</span><span class="si">}</span><span class="s2"> is larger than last timestamp </span><span class="si">{</span><span class="n">timestamps_on_disk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="s2">&quot;using last timestamp instead&quot;</span>
            <span class="p">)</span>
            <span class="n">a_stop</span> <span class="o">=</span> <span class="n">timestamps_on_disk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">frm</span><span class="p">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">timestamps_on_disk</span><span class="p">,</span> <span class="p">(</span><span class="n">a_start</span><span class="p">,</span> <span class="n">a_stop</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">to</span> <span class="o">&gt;</span> <span class="n">n_samples</span><span class="p">:</span>
            <span class="n">to</span> <span class="o">=</span> <span class="n">n_samples</span>
        <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">frm</span><span class="p">,</span> <span class="n">to</span><span class="p">))</span>
        <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">gsp</span><span class="o">.</span><span class="n">filter_data_fir</span><span class="p">(</span>
            <span class="n">data_on_disk</span><span class="p">,</span>
            <span class="n">filter_coeff</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="n">time_axis</span><span class="p">,</span>
            <span class="n">input_index_bounds</span><span class="o">=</span><span class="p">[</span><span class="n">frm</span><span class="p">,</span> <span class="n">to</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">output_index_bounds</span><span class="o">=</span><span class="p">[</span><span class="n">filter_delay</span><span class="p">,</span> <span class="n">filter_delay</span> <span class="o">+</span> <span class="n">to</span> <span class="o">-</span> <span class="n">frm</span><span class="p">],</span>
            <span class="n">describe_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ds</span><span class="o">=</span><span class="n">decimation</span><span class="p">,</span>
            <span class="n">input_dim_restrictions</span><span class="o">=</span><span class="n">input_dim_restrictions</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">output_offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_offsets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="n">time_axis</span><span class="p">])</span>
        <span class="n">output_shape_list</span><span class="p">[</span><span class="n">time_axis</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shape</span><span class="p">[</span><span class="n">time_axis</span><span class="p">]</span>

    <span class="c1"># open the nwb file to create the dynamic table region and electrode series, then write and close the file</span>
    <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1"># get the indices of the electrodes in the electrode table</span>
        <span class="n">elect_ind</span> <span class="o">=</span> <span class="n">get_electrode_indices</span><span class="p">(</span><span class="n">nwbf</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">)</span>

        <span class="n">electrode_table_region</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">create_electrode_table_region</span><span class="p">(</span>
            <span class="n">elect_ind</span><span class="p">,</span> <span class="s2">&quot;filtered electrode table&quot;</span>
        <span class="p">)</span>
        <span class="n">eseries_name</span> <span class="o">=</span> <span class="s2">&quot;filtered data&quot;</span>
        <span class="n">es</span> <span class="o">=</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">ecephys</span><span class="o">.</span><span class="n">ElectricalSeries</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">eseries_name</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">output_shape_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data_dtype</span><span class="p">),</span>
            <span class="n">electrodes</span><span class="o">=</span><span class="n">electrode_table_region</span><span class="p">,</span>
            <span class="n">timestamps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">output_shape_list</span><span class="p">[</span><span class="n">time_axis</span><span class="p">]),</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;LFP&quot;</span><span class="p">:</span>
            <span class="n">lfp</span> <span class="o">=</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">ecephys</span><span class="o">.</span><span class="n">LFP</span><span class="p">(</span><span class="n">electrical_series</span><span class="o">=</span><span class="n">es</span><span class="p">)</span>
            <span class="n">ecephys_module</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">create_processing_module</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ecephys&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span>
            <span class="p">)</span>
            <span class="n">ecephys_module</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lfp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span><span class="n">es</span><span class="p">)</span>
        <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>

        <span class="c1"># reload the NWB file to get the h5py objects for the data and the timestamps</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">es</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="n">es</span><span class="o">.</span><span class="n">object_id</span><span class="p">]</span>
            <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">data</span>
            <span class="n">new_timestamps</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">timestamps</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># Filter and write the output dataset</span>
            <span class="n">ts_offset</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Filtering data&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
                <span class="c1"># calculate the size of the timestamps and the data and determine whether they</span>
                <span class="c1"># can be loaded into &lt; 90% of available RAM</span>
                <span class="n">mem</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span>
                <span class="n">interval_samples</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">interval_samples</span>
                    <span class="o">*</span> <span class="p">(</span><span class="n">timestamp_size</span> <span class="o">+</span> <span class="n">n_electrodes</span> <span class="o">*</span> <span class="n">data_size</span><span class="p">)</span>
                    <span class="o">&lt;</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">mem</span><span class="o">.</span><span class="n">available</span>
                <span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interval </span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s2">: loading data into memory&quot;</span><span class="p">)</span>
                    <span class="n">timestamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                        <span class="n">timestamps_on_disk</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">],</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="n">timestamp_dtype</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">time_axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                            <span class="n">data_on_disk</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data_dtype</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                            <span class="n">data_on_disk</span><span class="p">[:,</span> <span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data_dtype</span>
                        <span class="p">)</span>
                    <span class="n">extracted_ts</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">decimation</span><span class="p">]</span>
                    <span class="n">new_timestamps</span><span class="p">[</span>
                        <span class="n">ts_offset</span> <span class="p">:</span> <span class="n">ts_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">extracted_ts</span><span class="p">)</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">extracted_ts</span>
                    <span class="n">ts_offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">extracted_ts</span><span class="p">)</span>
                    <span class="c1"># filter the data</span>
                    <span class="n">gsp</span><span class="o">.</span><span class="n">filter_data_fir</span><span class="p">(</span>
                        <span class="n">data</span><span class="p">,</span>
                        <span class="n">filter_coeff</span><span class="p">,</span>
                        <span class="n">axis</span><span class="o">=</span><span class="n">time_axis</span><span class="p">,</span>
                        <span class="n">input_index_bounds</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">interval_samples</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="n">output_index_bounds</span><span class="o">=</span><span class="p">[</span>
                            <span class="n">filter_delay</span><span class="p">,</span>
                            <span class="n">filter_delay</span> <span class="o">+</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span>
                        <span class="p">],</span>
                        <span class="n">ds</span><span class="o">=</span><span class="n">decimation</span><span class="p">,</span>
                        <span class="n">input_dim_restrictions</span><span class="o">=</span><span class="n">input_dim_restrictions</span><span class="p">,</span>
                        <span class="n">outarray</span><span class="o">=</span><span class="n">filtered_data</span><span class="p">,</span>
                        <span class="n">output_offset</span><span class="o">=</span><span class="n">output_offsets</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interval </span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s2">: leaving data on disk&quot;</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data_on_disk</span>
                    <span class="n">timestamps</span> <span class="o">=</span> <span class="n">timestamps_on_disk</span>
                    <span class="n">extracted_ts</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">decimation</span><span class="p">]</span>
                    <span class="n">new_timestamps</span><span class="p">[</span>
                        <span class="n">ts_offset</span> <span class="p">:</span> <span class="n">ts_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">extracted_ts</span><span class="p">)</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">extracted_ts</span>
                    <span class="n">ts_offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">extracted_ts</span><span class="p">)</span>
                    <span class="c1"># filter the data</span>
                    <span class="n">gsp</span><span class="o">.</span><span class="n">filter_data_fir</span><span class="p">(</span>
                        <span class="n">data</span><span class="p">,</span>
                        <span class="n">filter_coeff</span><span class="p">,</span>
                        <span class="n">axis</span><span class="o">=</span><span class="n">time_axis</span><span class="p">,</span>
                        <span class="n">input_index_bounds</span><span class="o">=</span><span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">],</span>
                        <span class="n">output_index_bounds</span><span class="o">=</span><span class="p">[</span>
                            <span class="n">filter_delay</span><span class="p">,</span>
                            <span class="n">filter_delay</span> <span class="o">+</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span>
                        <span class="p">],</span>
                        <span class="n">ds</span><span class="o">=</span><span class="n">decimation</span><span class="p">,</span>
                        <span class="n">input_dim_restrictions</span><span class="o">=</span><span class="n">input_dim_restrictions</span><span class="p">,</span>
                        <span class="n">outarray</span><span class="o">=</span><span class="n">filtered_data</span><span class="p">,</span>
                        <span class="n">output_offset</span><span class="o">=</span><span class="n">output_offsets</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                    <span class="p">)</span>

            <span class="n">start_end</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_timestamps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

            <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">es</span><span class="o">.</span><span class="n">object_id</span><span class="p">,</span> <span class="n">start_end</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_filter.FirFilterParameters.filter_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">filter_data</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">filter_coeff</span><span class="p">,</span> <span class="n">valid_times</span><span class="p">,</span> <span class="n">electrodes</span><span class="p">,</span> <span class="n">decimation</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_filter.FirFilterParameters.filter_data" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>:param timestamps: numpy array with list of timestamps for data
:param data: original data array
:param filter_coeff: numpy array with filter coefficients for FIR filter
:param valid_times: 2D numpy array with start and stop times of intervals to be filtered
:param electrodes: list of electrodes to filter
:param decimation: decimation factor
:return: filtered_data, timestamps</p>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_filter.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">filter_data</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">timestamps</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">filter_coeff</span><span class="p">,</span>
    <span class="n">valid_times</span><span class="p">,</span>
    <span class="n">electrodes</span><span class="p">,</span>
    <span class="n">decimation</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param timestamps: numpy array with list of timestamps for data</span>
<span class="sd">    :param data: original data array</span>
<span class="sd">    :param filter_coeff: numpy array with filter coefficients for FIR filter</span>
<span class="sd">    :param valid_times: 2D numpy array with start and stop times of intervals to be filtered</span>
<span class="sd">    :param electrodes: list of electrodes to filter</span>
<span class="sd">    :param decimation: decimation factor</span>
<span class="sd">    :return: filtered_data, timestamps</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gsp</span> <span class="o">=</span> <span class="n">_import_ghostipy</span><span class="p">()</span>

    <span class="n">n_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span>
    <span class="n">time_axis</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">n_samples</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">electrode_axis</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">time_axis</span>
    <span class="n">input_dim_restrictions</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_dim</span>
    <span class="n">input_dim_restrictions</span><span class="p">[</span><span class="n">electrode_axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="n">electrodes</span><span class="p">]</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">output_shape_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_dim</span>
    <span class="n">output_shape_list</span><span class="p">[</span><span class="n">electrode_axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">electrodes</span><span class="p">)</span>
    <span class="n">output_offsets</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">filter_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_filter_delay</span><span class="p">(</span><span class="n">filter_coeff</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a_start</span><span class="p">,</span> <span class="n">a_stop</span> <span class="ow">in</span> <span class="n">valid_times</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a_start</span> <span class="o">&lt;</span> <span class="n">timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Interval start time </span><span class="si">{</span><span class="n">a_start</span><span class="si">}</span><span class="s2"> is smaller than first timestamp &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, using first timestamp instead&quot;</span>
            <span class="p">)</span>
            <span class="n">a_start</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">a_stop</span> <span class="o">&gt;</span> <span class="n">timestamps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Interval stop time </span><span class="si">{</span><span class="n">a_stop</span><span class="si">}</span><span class="s2"> is larger than last timestamp &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, using last timestamp instead&quot;</span>
            <span class="p">)</span>
            <span class="n">a_stop</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">frm</span><span class="p">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="p">(</span><span class="n">a_start</span><span class="p">,</span> <span class="n">a_stop</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">to</span> <span class="o">&gt;</span> <span class="n">n_samples</span><span class="p">:</span>
            <span class="n">to</span> <span class="o">=</span> <span class="n">n_samples</span>

        <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">frm</span><span class="p">,</span> <span class="n">to</span><span class="p">))</span>
        <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">gsp</span><span class="o">.</span><span class="n">filter_data_fir</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">filter_coeff</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="n">time_axis</span><span class="p">,</span>
            <span class="n">input_index_bounds</span><span class="o">=</span><span class="p">[</span><span class="n">frm</span><span class="p">,</span> <span class="n">to</span><span class="p">],</span>
            <span class="n">output_index_bounds</span><span class="o">=</span><span class="p">[</span><span class="n">filter_delay</span><span class="p">,</span> <span class="n">filter_delay</span> <span class="o">+</span> <span class="n">to</span> <span class="o">-</span> <span class="n">frm</span><span class="p">],</span>
            <span class="n">describe_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ds</span><span class="o">=</span><span class="n">decimation</span><span class="p">,</span>
            <span class="n">input_dim_restrictions</span><span class="o">=</span><span class="n">input_dim_restrictions</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">output_offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_offsets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="n">time_axis</span><span class="p">])</span>
        <span class="n">output_shape_list</span><span class="p">[</span><span class="n">time_axis</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shape</span><span class="p">[</span><span class="n">time_axis</span><span class="p">]</span>

    <span class="c1"># create the dataset and the timestamps array</span>
    <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">output_shape_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">new_timestamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
        <span class="p">(</span><span class="n">output_shape_list</span><span class="p">[</span><span class="n">time_axis</span><span class="p">],),</span> <span class="n">timestamps</span><span class="o">.</span><span class="n">dtype</span>
    <span class="p">)</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Filter  the output dataset</span>
    <span class="n">ts_offset</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
        <span class="n">extracted_ts</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">decimation</span><span class="p">]</span>

        <span class="c1"># print(f&quot;Diffs {np.diff(extracted_ts)}&quot;)</span>
        <span class="n">new_timestamps</span><span class="p">[</span>
            <span class="n">ts_offset</span> <span class="p">:</span> <span class="n">ts_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">extracted_ts</span><span class="p">)</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">extracted_ts</span>
        <span class="n">ts_offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">extracted_ts</span><span class="p">)</span>

        <span class="c1"># finally ready to filter data!</span>
        <span class="n">gsp</span><span class="o">.</span><span class="n">filter_data_fir</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">filter_coeff</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="n">time_axis</span><span class="p">,</span>
            <span class="n">input_index_bounds</span><span class="o">=</span><span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">],</span>
            <span class="n">output_index_bounds</span><span class="o">=</span><span class="p">[</span><span class="n">filter_delay</span><span class="p">,</span> <span class="n">filter_delay</span> <span class="o">+</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">],</span>
            <span class="n">ds</span><span class="o">=</span><span class="n">decimation</span><span class="p">,</span>
            <span class="n">input_dim_restrictions</span><span class="o">=</span><span class="n">input_dim_restrictions</span><span class="p">,</span>
            <span class="n">outarray</span><span class="o">=</span><span class="n">filtered_data</span><span class="p">,</span>
            <span class="n">output_offset</span><span class="o">=</span><span class="n">output_offsets</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">filtered_data</span><span class="p">,</span> <span class="n">new_timestamps</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_filter.FirFilterParameters.calc_filter_delay" class="doc doc-heading">
<code class="highlight language-python"><span class="n">calc_filter_delay</span><span class="p">(</span><span class="n">filter_coeff</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_filter.FirFilterParameters.calc_filter_delay" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>:param filter_coeff:
:return: filter delay</p>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_filter.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">calc_filter_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_coeff</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param filter_coeff:</span>
<span class="sd">    :return: filter delay</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filter_coeff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_filter.FirFilterParameters.create_standard_filters" class="doc doc-heading">
<code class="highlight language-python"><span class="n">create_standard_filters</span><span class="p">()</span></code>

<a href="#src.spyglass.common.common_filter.FirFilterParameters.create_standard_filters" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add standard filters to the Filter table including
0-400 Hz low pass for continuous raw data -&gt; LFP</p>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_filter.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_standard_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add standard filters to the Filter table including</span>
<span class="sd">    0-400 Hz low pass for continuous raw data -&gt; LFP</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span>
        <span class="s2">&quot;LFP 0-400 Hz&quot;</span><span class="p">,</span>
        <span class="mi">20000</span><span class="p">,</span>
        <span class="s2">&quot;lowpass&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="mi">400</span><span class="p">,</span> <span class="mi">425</span><span class="p">],</span>
        <span class="s2">&quot;standard LFP filter for 20 KHz data&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span>
        <span class="s2">&quot;LFP 0-400 Hz&quot;</span><span class="p">,</span>
        <span class="mi">30000</span><span class="p">,</span>
        <span class="s2">&quot;lowpass&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="mi">400</span><span class="p">,</span> <span class="mi">425</span><span class="p">],</span>
        <span class="s2">&quot;standard LFP filter for 30 KHz data&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.common.common_ephys.Nwbfile" class="doc doc-heading">
        <code>Nwbfile</code>


<a href="#src.spyglass.common.common_ephys.Nwbfile" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Manual">Manual</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">Nwbfile</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # Table for holding the NWB files.</span>
<span class="s2">    nwb_file_name: varchar(255)   # name of the NWB file</span>
<span class="s2">    ---</span>
<span class="s2">    nwb_file_abs_path: filepath@raw</span>
<span class="s2">    INDEX (nwb_file_abs_path)</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="c1"># NOTE the INDEX above is implicit from filepath@... above but needs to be explicit</span>
    <span class="c1"># so that alter() can work</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">insert_from_relative_file_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Insert a new session from an existing NWB file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nwb_file_name : str</span>
<span class="sd">            The relative path to the NWB file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nwb_file_abs_path</span> <span class="o">=</span> <span class="n">Nwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
            <span class="n">nwb_file_abs_path</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;File does not exist: </span><span class="si">{</span><span class="n">nwb_file_abs_path</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">key</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_file_name</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_abs_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_file_abs_path</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the absolute path for a stored raw NWB file given just the file name.</span>

<span class="sd">        The SPYGLASS_BASE_DIR environment variable must be set.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nwb_file_name : str</span>
<span class="sd">            The name of an NWB file that has been inserted into the Nwbfile() schema.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        nwb_file_abspath : str</span>
<span class="sd">            The absolute path for the given file name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SPYGLASS_BASE_DIR&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;You must set SPYGLASS_BASE_DIR or provide the base_dir argument&quot;</span>

        <span class="n">nwb_file_abspath</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;raw&quot;</span> <span class="o">/</span> <span class="n">nwb_file_name</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">nwb_file_abspath</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add_to_lock</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the specified NWB file to the file with the list of NWB files to be locked.</span>

<span class="sd">        The NWB_LOCK_FILE environment variable must be set.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nwb_file_name : str</span>
<span class="sd">            The name of an NWB file that has been inserted into the Nwbfile() schema.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">}</span>
        <span class="c1"># check to make sure the file exists</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">((</span><span class="n">Nwbfile</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Error adding </span><span class="si">{</span><span class="n">nwb_file_name</span><span class="si">}</span><span class="s2"> to lock file, not in Nwbfile() schema&quot;</span>

        <span class="n">lock_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NWB_LOCK_FILE&quot;</span><span class="p">),</span> <span class="s2">&quot;a+&quot;</span><span class="p">)</span>
        <span class="n">lock_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nwb_file_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lock_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">delete_files</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove the filepath entries for NWB files that are not in use.</span>

<span class="sd">        This does not delete the files themselves unless delete_files=True is specified</span>
<span class="sd">        Run this after deleting the Nwbfile() entries themselves.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">external</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">delete_external_files</span><span class="o">=</span><span class="n">delete_files</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.Nwbfile.insert_from_relative_file_name" class="doc doc-heading">
<code class="highlight language-python"><span class="n">insert_from_relative_file_name</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_nwbfile.Nwbfile.insert_from_relative_file_name" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Insert a new session from an existing NWB file.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The relative path to the NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">insert_from_relative_file_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Insert a new session from an existing NWB file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwb_file_name : str</span>
<span class="sd">        The relative path to the NWB file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nwb_file_abs_path</span> <span class="o">=</span> <span class="n">Nwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
        <span class="n">nwb_file_abs_path</span>
    <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;File does not exist: </span><span class="si">{</span><span class="n">nwb_file_abs_path</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_file_name</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_abs_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_file_abs_path</span>
    <span class="bp">cls</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.Nwbfile.get_abs_path" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_nwbfile.Nwbfile.get_abs_path" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Return the absolute path for a stored raw NWB file given just the file name.</p>
<p>The SPYGLASS_BASE_DIR environment variable must be set.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of an NWB file that has been inserted into the Nwbfile() schema.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>nwb_file_abspath</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The absolute path for the given file name.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the absolute path for a stored raw NWB file given just the file name.</span>

<span class="sd">    The SPYGLASS_BASE_DIR environment variable must be set.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwb_file_name : str</span>
<span class="sd">        The name of an NWB file that has been inserted into the Nwbfile() schema.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nwb_file_abspath : str</span>
<span class="sd">        The absolute path for the given file name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">base_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SPYGLASS_BASE_DIR&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">),</span> <span class="s2">&quot;You must set SPYGLASS_BASE_DIR or provide the base_dir argument&quot;</span>

    <span class="n">nwb_file_abspath</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;raw&quot;</span> <span class="o">/</span> <span class="n">nwb_file_name</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">nwb_file_abspath</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.Nwbfile.add_to_lock" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_to_lock</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_nwbfile.Nwbfile.add_to_lock" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add the specified NWB file to the file with the list of NWB files to be locked.</p>
<p>The NWB_LOCK_FILE environment variable must be set.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of an NWB file that has been inserted into the Nwbfile() schema.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">add_to_lock</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add the specified NWB file to the file with the list of NWB files to be locked.</span>

<span class="sd">    The NWB_LOCK_FILE environment variable must be set.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwb_file_name : str</span>
<span class="sd">        The name of an NWB file that has been inserted into the Nwbfile() schema.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">}</span>
    <span class="c1"># check to make sure the file exists</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">((</span><span class="n">Nwbfile</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Error adding </span><span class="si">{</span><span class="n">nwb_file_name</span><span class="si">}</span><span class="s2"> to lock file, not in Nwbfile() schema&quot;</span>

    <span class="n">lock_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NWB_LOCK_FILE&quot;</span><span class="p">),</span> <span class="s2">&quot;a+&quot;</span><span class="p">)</span>
    <span class="n">lock_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nwb_file_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">lock_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.Nwbfile.cleanup" class="doc doc-heading">
<code class="highlight language-python"><span class="n">cleanup</span><span class="p">(</span><span class="n">delete_files</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_nwbfile.Nwbfile.cleanup" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Remove the filepath entries for NWB files that are not in use.</p>
<p>This does not delete the files themselves unless delete_files=True is specified
Run this after deleting the Nwbfile() entries themselves.</p>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">delete_files</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove the filepath entries for NWB files that are not in use.</span>

<span class="sd">    This does not delete the files themselves unless delete_files=True is specified</span>
<span class="sd">    Run this after deleting the Nwbfile() entries themselves.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">external</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">delete_external_files</span><span class="o">=</span><span class="n">delete_files</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-function">



<h2 id="src.spyglass.common.common_ephys.fetch_nwb" class="doc doc-heading">
<code class="highlight language-python"><span class="n">fetch_nwb</span><span class="p">(</span><span class="n">query_expression</span><span class="p">,</span> <span class="n">nwb_master</span><span class="p">,</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_ephys.fetch_nwb" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Get an NWB object from the given DataJoint query.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>query_expression</code></td>
          <td>
                <code>query</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A DataJoint query expression (e.g., join, restrict) or a table to call fetch on.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nwb_master</code></td>
          <td>
                <code>tuple</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Tuple (table, attr) to get the NWB filepath from.
i.e. absolute path to NWB file can be obtained by looking up attr column of table
table is usually Nwbfile or AnalysisNwbfile;
attr is usually 'nwb_file_abs_path' or 'analysis_file_abs_path'</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>*attrs</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Attributes from normal DataJoint fetch call.</p>
            </div>
          </td>
          <td>
                <code>()</code>
          </td>
        </tr>
        <tr>
          <td><code>**kwargs</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Keyword arguments from normal DataJoint fetch call.</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>nwb_objects</code></td>          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of dicts containing fetch results and NWB objects.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/utils/dj_helper_fn.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">fetch_nwb</span><span class="p">(</span><span class="n">query_expression</span><span class="p">,</span> <span class="n">nwb_master</span><span class="p">,</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get an NWB object from the given DataJoint query.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    query_expression : query</span>
<span class="sd">        A DataJoint query expression (e.g., join, restrict) or a table to call fetch on.</span>
<span class="sd">    nwb_master : tuple</span>
<span class="sd">        Tuple (table, attr) to get the NWB filepath from.</span>
<span class="sd">        i.e. absolute path to NWB file can be obtained by looking up attr column of table</span>
<span class="sd">        table is usually Nwbfile or AnalysisNwbfile;</span>
<span class="sd">        attr is usually &#39;nwb_file_abs_path&#39; or &#39;analysis_file_abs_path&#39;</span>
<span class="sd">    *attrs : list</span>
<span class="sd">        Attributes from normal DataJoint fetch call.</span>
<span class="sd">    **kwargs : dict</span>
<span class="sd">        Keyword arguments from normal DataJoint fetch call.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nwb_objects : list</span>
<span class="sd">        List of dicts containing fetch results and NWB objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;as_dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># force return as dictionary</span>
    <span class="n">tbl</span><span class="p">,</span> <span class="n">attr_name</span> <span class="o">=</span> <span class="n">nwb_master</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">query_expression</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span>

    <span class="c1"># get the list of analysis or nwb files</span>
    <span class="n">file_name_str</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;analysis_file_name&quot;</span> <span class="k">if</span> <span class="s2">&quot;analysis&quot;</span> <span class="ow">in</span> <span class="n">nwb_master</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;nwb_file_name&quot;</span>
    <span class="p">)</span>
    <span class="c1"># TODO: avoid this import?</span>
    <span class="kn">from</span> <span class="nn">..common.common_nwbfile</span> <span class="kn">import</span> <span class="n">AnalysisNwbfile</span><span class="p">,</span> <span class="n">Nwbfile</span>

    <span class="n">file_path_fn</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span>
        <span class="k">if</span> <span class="s2">&quot;analysis&quot;</span> <span class="ow">in</span> <span class="n">nwb_master</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span> <span class="n">Nwbfile</span><span class="o">.</span><span class="n">get_abs_path</span>
    <span class="p">)</span>

    <span class="c1"># TODO: check that the query_expression restricts tbl - CBroz</span>
    <span class="n">nwb_files</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">query_expression</span> <span class="o">*</span> <span class="n">tbl</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">nwb2load_filepath</span><span class="o">=</span><span class="n">attr_name</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">file_name_str</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">nwb_files</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path_fn</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="c1"># retrieve the file from kachery. This also opens the file and stores the file object</span>
            <span class="n">get_nwb_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="n">rec_dicts</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">query_expression</span> <span class="o">*</span> <span class="n">tbl</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">nwb2load_filepath</span><span class="o">=</span><span class="n">attr_name</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="s2">&quot;nwb2load_filepath&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">rec_dicts</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;object_id&quot;</span> <span class="ow">in</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">rec_dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">rec_dicts</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rec_dict</span> <span class="ow">in</span> <span class="n">rec_dicts</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">get_nwb_file</span><span class="p">(</span><span class="n">rec_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nwb2load_filepath&quot;</span><span class="p">))</span>
        <span class="c1"># for each attr that contains substring &#39;object_id&#39;, store key-value: attr name to NWB object</span>
        <span class="c1"># remove &#39;_object_id&#39; from attr name</span>
        <span class="n">nwb_objs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">id_attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_object_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span> <span class="n">_get_nwb_object</span><span class="p">(</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">objects</span><span class="p">,</span> <span class="n">rec_dict</span><span class="p">[</span><span class="n">id_attr</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">id_attr</span> <span class="ow">in</span> <span class="n">attrs</span>
            <span class="k">if</span> <span class="s2">&quot;object_id&quot;</span> <span class="ow">in</span> <span class="n">id_attr</span> <span class="ow">and</span> <span class="n">rec_dict</span><span class="p">[</span><span class="n">id_attr</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>
        <span class="p">}</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="o">**</span><span class="n">rec_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">nwb_objs</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h2 id="src.spyglass.common.common_ephys.get_config" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_config</span><span class="p">(</span><span class="n">nwb_file_path</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_ephys.get_config" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Return a dictionary of config settings for the given NWB file.
If the file does not exist, return an empty dict.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwb_file_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Absolute path to the NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>Returns</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>d</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary of configuration settings loaded from the corresponding YAML file</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/utils/nwb_helper_fn.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="n">nwb_file_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a dictionary of config settings for the given NWB file.</span>
<span class="sd">    If the file does not exist, return an empty dict.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwb_file_path : str</span>
<span class="sd">        Absolute path to the NWB file.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    d : dict</span>
<span class="sd">        Dictionary of configuration settings loaded from the corresponding YAML file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nwb_file_path</span> <span class="ow">in</span> <span class="n">__configs</span><span class="p">:</span>  <span class="c1"># load from cache if exists</span>
        <span class="k">return</span> <span class="n">__configs</span><span class="p">[</span><span class="n">nwb_file_path</span><span class="p">]</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">nwb_file_path</span><span class="p">)</span>
    <span class="c1"># NOTE use p.stem[:-1] to remove the underscore that was added to the file</span>
    <span class="n">config_path</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stem</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_spyglass_config.yaml&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No config found at file path </span><span class="si">{</span><span class="n">config_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

    <span class="c1"># TODO write a JSON schema for the yaml file and validate the yaml file</span>
    <span class="n">__configs</span><span class="p">[</span><span class="n">nwb_file_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>  <span class="c1"># store in cache</span>
    <span class="k">return</span> <span class="n">d</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.common.common_ephys.Electrode" class="doc doc-heading">
        <code>Electrode</code>


<a href="#src.spyglass.common.common_ephys.Electrode" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Imported">Imported</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/common/common_ephys.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">Electrode</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Imported</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; ElectrodeGroup</span>
<span class="s2">    electrode_id: int                      # the unique number for this electrode</span>
<span class="s2">    ---</span>
<span class="s2">    -&gt; [nullable] Probe.Electrode</span>
<span class="s2">    -&gt; BrainRegion</span>
<span class="s2">    name = &quot;&quot;: varchar(200)                 # unique label for each contact</span>
<span class="s2">    original_reference_electrode = -1: int  # the configured reference electrode for this electrode</span>
<span class="s2">    x = NULL: float                         # the x coordinate of the electrode position in the brain</span>
<span class="s2">    y = NULL: float                         # the y coordinate of the electrode position in the brain</span>
<span class="s2">    z = NULL: float                         # the z coordinate of the electrode position in the brain</span>
<span class="s2">    filtering: varchar(2000)                # description of the signal filtering</span>
<span class="s2">    impedance = NULL: float                 # electrode impedance</span>
<span class="s2">    bad_channel = &quot;False&quot;: enum(&quot;True&quot;, &quot;False&quot;)  # if electrode is &quot;good&quot; or &quot;bad&quot; as observed during recording</span>
<span class="s2">    x_warped = NULL: float                  # x coordinate of electrode position warped to common template brain</span>
<span class="s2">    y_warped = NULL: float                  # y coordinate of electrode position warped to common template brain</span>
<span class="s2">    z_warped = NULL: float                  # z coordinate of electrode position warped to common template brain</span>
<span class="s2">    contacts: varchar(200)                  # label of electrode contacts used for a bipolar signal - current workaround</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">nwb_file_name</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span>
        <span class="n">nwb_file_abspath</span> <span class="o">=</span> <span class="n">Nwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">get_nwb_file</span><span class="p">(</span><span class="n">nwb_file_abspath</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="n">nwb_file_abspath</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;Electrode&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">electrode_config_dicts</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">electrode_dict</span><span class="p">[</span><span class="s2">&quot;electrode_id&quot;</span><span class="p">]:</span> <span class="n">electrode_dict</span>
                <span class="k">for</span> <span class="n">electrode_dict</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Electrode&quot;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">electrode_config_dicts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">electrodes</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">electrodes</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">elect_id</span><span class="p">,</span> <span class="n">elect_data</span> <span class="ow">in</span> <span class="n">electrodes</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;electrode_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_id</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">elect_id</span><span class="p">)</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;electrode_group_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">group_name</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;region_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BrainRegion</span><span class="o">.</span><span class="n">fetch_add</span><span class="p">(</span>
                <span class="n">region_name</span><span class="o">=</span><span class="n">elect_data</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">location</span>
            <span class="p">)</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">x</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">y</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">z</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;x_warped&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;y_warped&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;z_warped&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;contacts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;filtering&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">filtering</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;impedance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;imp&quot;</span><span class="p">)</span>

            <span class="c1"># rough check of whether the electrodes table was created by rec_to_nwb and has</span>
            <span class="c1"># the appropriate custom columns used by rec_to_nwb</span>
            <span class="c1"># TODO this could be better resolved by making an extension for the electrodes table</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">elect_data</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">ndx_franklab_novela</span><span class="o">.</span><span class="n">Probe</span><span class="p">)</span>
                <span class="ow">and</span> <span class="s2">&quot;probe_shank&quot;</span> <span class="ow">in</span> <span class="n">elect_data</span>
                <span class="ow">and</span> <span class="s2">&quot;probe_electrode&quot;</span> <span class="ow">in</span> <span class="n">elect_data</span>
                <span class="ow">and</span> <span class="s2">&quot;bad_channel&quot;</span> <span class="ow">in</span> <span class="n">elect_data</span>
                <span class="ow">and</span> <span class="s2">&quot;ref_elect_id&quot;</span> <span class="ow">in</span> <span class="n">elect_data</span>
            <span class="p">):</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;probe_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">probe_type</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;probe_shank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">probe_shank</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;probe_electrode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">probe_electrode</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;bad_channel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;True&quot;</span> <span class="k">if</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">bad_channel</span> <span class="k">else</span> <span class="s2">&quot;False&quot;</span>
                <span class="p">)</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;original_reference_electrode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">ref_elect_id</span>

            <span class="c1"># override with information from the config YAML based on primary key (electrode id)</span>
            <span class="k">if</span> <span class="n">elect_id</span> <span class="ow">in</span> <span class="n">electrode_config_dicts</span><span class="p">:</span>
                <span class="c1"># check whether the Probe.Electrode being referenced exists</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">Electrode</span> <span class="o">&amp;</span> <span class="n">electrode_config_dicts</span><span class="p">[</span><span class="n">elect_id</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;No Probe.Electrode exists that matches the data: </span><span class="si">{</span><span class="n">electrode_config_dicts</span><span class="p">[</span><span class="n">elect_id</span><span class="p">]</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;The config YAML for Electrode with electrode_id </span><span class="si">{</span><span class="n">elect_id</span><span class="si">}</span><span class="s2"> will be ignored.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">electrode_config_dicts</span><span class="p">[</span><span class="n">elect_id</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create or update Electrode entries from what is specified in the config YAML file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nwb_file_name : str</span>
<span class="sd">            The name of the NWB file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nwb_file_abspath</span> <span class="o">=</span> <span class="n">Nwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">get_nwb_file</span><span class="p">(</span><span class="n">nwb_file_abspath</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="n">nwb_file_abspath</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;Electrode&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># map electrode id to dictionary of electrode information from config YAML</span>
        <span class="n">electrode_dicts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">electrode_dict</span><span class="p">[</span><span class="s2">&quot;electrode_id&quot;</span><span class="p">]:</span> <span class="n">electrode_dict</span>
            <span class="k">for</span> <span class="n">electrode_dict</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Electrode&quot;</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="n">electrodes</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">electrodes</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">nwbfile_elect_id</span><span class="p">,</span> <span class="n">elect_data</span> <span class="ow">in</span> <span class="n">electrodes</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">nwbfile_elect_id</span> <span class="ow">in</span> <span class="n">electrode_dicts</span><span class="p">:</span>
                <span class="c1"># use the information in the electrodes table to start and then add (or overwrite) values from the</span>
                <span class="c1"># config YAML</span>
                <span class="n">key</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_file_name</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nwbfile_elect_id</span><span class="p">)</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;electrode_group_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">group_name</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;region_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BrainRegion</span><span class="o">.</span><span class="n">fetch_add</span><span class="p">(</span>
                    <span class="n">region_name</span><span class="o">=</span><span class="n">elect_data</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">location</span>
                <span class="p">)</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">x</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">y</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">z</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;x_warped&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;y_warped&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;z_warped&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;contacts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;filtering&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">filtering</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;impedance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;imp&quot;</span><span class="p">)</span>
                <span class="n">key</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">electrode_dicts</span><span class="p">[</span><span class="n">nwbfile_elect_id</span><span class="p">])</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">Electrode</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;electrode_id&quot;</span><span class="p">:</span> <span class="n">nwbfile_elect_id</span><span class="p">}</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">update1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated Electrode with ID </span><span class="si">{</span><span class="n">nwbfile_elect_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
                        <span class="n">key</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_direct_insert</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inserted Electrode with ID </span><span class="si">{</span><span class="n">nwbfile_elect_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Electrode ID </span><span class="si">{</span><span class="n">nwbfile_elect_id</span><span class="si">}</span><span class="s2"> exists in the NWB file but has no corresponding &quot;</span>
                    <span class="s2">&quot;config YAML entry.&quot;</span>
                <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_ephys.Electrode.create_from_config" class="doc doc-heading">
<code class="highlight language-python"><span class="n">create_from_config</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_ephys.Electrode.create_from_config" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Create or update Electrode entries from what is specified in the config YAML file.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_ephys.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">create_from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create or update Electrode entries from what is specified in the config YAML file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwb_file_name : str</span>
<span class="sd">        The name of the NWB file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nwb_file_abspath</span> <span class="o">=</span> <span class="n">Nwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
    <span class="n">nwbf</span> <span class="o">=</span> <span class="n">get_nwb_file</span><span class="p">(</span><span class="n">nwb_file_abspath</span><span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="n">nwb_file_abspath</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;Electrode&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># map electrode id to dictionary of electrode information from config YAML</span>
    <span class="n">electrode_dicts</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">electrode_dict</span><span class="p">[</span><span class="s2">&quot;electrode_id&quot;</span><span class="p">]:</span> <span class="n">electrode_dict</span>
        <span class="k">for</span> <span class="n">electrode_dict</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Electrode&quot;</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="n">electrodes</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">electrodes</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">nwbfile_elect_id</span><span class="p">,</span> <span class="n">elect_data</span> <span class="ow">in</span> <span class="n">electrodes</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">nwbfile_elect_id</span> <span class="ow">in</span> <span class="n">electrode_dicts</span><span class="p">:</span>
            <span class="c1"># use the information in the electrodes table to start and then add (or overwrite) values from the</span>
            <span class="c1"># config YAML</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_file_name</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nwbfile_elect_id</span><span class="p">)</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;electrode_group_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">group_name</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;region_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BrainRegion</span><span class="o">.</span><span class="n">fetch_add</span><span class="p">(</span>
                <span class="n">region_name</span><span class="o">=</span><span class="n">elect_data</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">location</span>
            <span class="p">)</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">x</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">y</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">z</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;x_warped&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;y_warped&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;z_warped&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;contacts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;filtering&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">filtering</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;impedance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elect_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;imp&quot;</span><span class="p">)</span>
            <span class="n">key</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">electrode_dicts</span><span class="p">[</span><span class="n">nwbfile_elect_id</span><span class="p">])</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">Electrode</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;electrode_id&quot;</span><span class="p">:</span> <span class="n">nwbfile_elect_id</span><span class="p">}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">update1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated Electrode with ID </span><span class="si">{</span><span class="n">nwbfile_elect_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_direct_insert</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inserted Electrode with ID </span><span class="si">{</span><span class="n">nwbfile_elect_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Electrode ID </span><span class="si">{</span><span class="n">nwbfile_elect_id</span><span class="si">}</span><span class="s2"> exists in the NWB file but has no corresponding &quot;</span>
                <span class="s2">&quot;config YAML entry.&quot;</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-function">



<h2 id="src.spyglass.common.common_ephys.get_data_interface" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_data_interface</span><span class="p">(</span><span class="n">nwbfile</span><span class="p">,</span> <span class="n">data_interface_name</span><span class="p">,</span> <span class="n">data_interface_class</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_ephys.get_data_interface" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Search for a specified NWBDataInterface or DynamicTable in the processing modules of an NWB file.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwbfile</code></td>
          <td>
                <code>pynwb.<span title="pynwb.NWBFile">NWBFile</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The NWB file object to search in.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>data_interface_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the NWBDataInterface or DynamicTable to search for.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>data_interface_class</code></td>
          <td>
                <code>type</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The class (or superclass) to search for. This argument helps to prevent accessing an object with the same
name but the incorrect type. Default: no restriction.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Warns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>UserWarning</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If multiple NWBDataInterface and DynamicTable objects with the matching name are found.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>data_interface</code></td>          <td>
                <code>NWBDataInterface</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The data interface object with the given name, or None if not found.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/utils/nwb_helper_fn.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_data_interface</span><span class="p">(</span><span class="n">nwbfile</span><span class="p">,</span> <span class="n">data_interface_name</span><span class="p">,</span> <span class="n">data_interface_class</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Search for a specified NWBDataInterface or DynamicTable in the processing modules of an NWB file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwbfile : pynwb.NWBFile</span>
<span class="sd">        The NWB file object to search in.</span>
<span class="sd">    data_interface_name : str</span>
<span class="sd">        The name of the NWBDataInterface or DynamicTable to search for.</span>
<span class="sd">    data_interface_class : type, optional</span>
<span class="sd">        The class (or superclass) to search for. This argument helps to prevent accessing an object with the same</span>
<span class="sd">        name but the incorrect type. Default: no restriction.</span>

<span class="sd">    Warns</span>
<span class="sd">    -----</span>
<span class="sd">    UserWarning</span>
<span class="sd">        If multiple NWBDataInterface and DynamicTable objects with the matching name are found.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    data_interface : NWBDataInterface</span>
<span class="sd">        The data interface object with the given name, or None if not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">nwbfile</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">data_interfaces</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data_interface_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_interface_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">match</span><span class="p">,</span> <span class="n">data_interface_class</span>
            <span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Multiple data interfaces with name &#39;</span><span class="si">{</span><span class="n">data_interface_name</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;found in NWBFile with identifier </span><span class="si">{</span><span class="n">nwbfile</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s2">. Using the first one found. &quot;</span>
            <span class="s2">&quot;Use the data_interface_class argument to restrict the search.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.common.common_ephys.AnalysisNwbfile" class="doc doc-heading">
        <code>AnalysisNwbfile</code>


<a href="#src.spyglass.common.common_ephys.AnalysisNwbfile" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Manual">Manual</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">AnalysisNwbfile</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # Table for holding the NWB files that contain results of analysis, such as spike sorting.</span>
<span class="s2">    analysis_file_name: varchar(255)               # name of the file</span>
<span class="s2">    ---</span>
<span class="s2">    -&gt; Nwbfile                                     # name of the parent NWB file. Used for naming and metadata copy</span>
<span class="s2">    analysis_file_abs_path: filepath@analysis      # the full path to the file</span>
<span class="s2">    analysis_file_description = &quot;&quot;: varchar(2000)  # an optional description of this analysis</span>
<span class="s2">    analysis_parameters = NULL: blob               # additional relevant parameters. Currently used only for analyses</span>
<span class="s2">                                                   # that span multiple NWB files</span>
<span class="s2">    INDEX (analysis_file_abs_path)</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="c1"># NOTE the INDEX above is implicit from filepath@... above but needs to be explicit</span>
    <span class="c1"># so that alter() can work</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open the NWB file, create a copy, write the copy to disk and return the name of the new file.</span>

<span class="sd">        Note that this does NOT add the file to the schema; that needs to be done after data are written to it.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nwb_file_name : str</span>
<span class="sd">            The name of an NWB file to be copied.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the new NWB file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nwb_file_abspath</span> <span class="o">=</span> <span class="n">Nwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">nwb_file_abspath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="c1"># pop off the unnecessary elements to save space</span>
            <span class="n">nwb_fields</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">fields</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">nwb_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NWB_KEEP_FIELDS</span><span class="p">:</span>
                    <span class="n">nwb_object</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">nwbf</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">,</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">LabelledDict</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nwb_object</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">nwb_object</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>

            <span class="n">analysis_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_new_file_name</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
            <span class="c1"># write the new file</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing new NWB file </span><span class="si">{</span><span class="n">analysis_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">analysis_file_abs_path</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
                <span class="n">analysis_file_name</span>
            <span class="p">)</span>
            <span class="c1"># export the new NWB file</span>
            <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
                <span class="n">path</span><span class="o">=</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">manager</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">export_io</span><span class="p">:</span>
                <span class="n">export_io</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">)</span>

        <span class="c1"># change the permissions to only allow owner to write</span>
        <span class="n">permissions</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IROTH</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">permissions</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">analysis_file_name</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__get_new_file_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
        <span class="c1"># each file ends with a random string of 10 digits, so we generate that string and redo if by some miracle</span>
        <span class="c1"># it&#39;s already there</span>
        <span class="n">file_in_table</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">file_in_table</span><span class="p">:</span>
            <span class="n">analysis_file_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;.nwb&quot;</span>
            <span class="p">)</span>
            <span class="n">file_in_table</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span> <span class="o">&amp;</span> <span class="p">{</span>
                <span class="s2">&quot;analysis_file_name&quot;</span><span class="p">:</span> <span class="n">analysis_file_name</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">analysis_file_name</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__get_analysis_file_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># strip off everything after and including the final underscore and return the result</span>
        <span class="k">return</span> <span class="n">analysis_file_name</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">analysis_file_name</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a copy of an analysis NWB file.</span>

<span class="sd">        Note that this does NOT add the file to the schema; that needs to be done after data are written to it.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nwb_file_name : str</span>
<span class="sd">            The name of the analysis NWB file to be copied.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the new NWB file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nwb_file_abspath</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">nwb_file_abspath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="c1"># get the current number of analysis files related to this nwb file</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">}</span>
            <span class="n">original_nwb_file_name</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">analysis_file_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__get_new_file_name</span><span class="p">(</span><span class="n">original_nwb_file_name</span><span class="p">)</span>
            <span class="c1"># write the new file</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing new NWB file </span><span class="si">{</span><span class="n">analysis_file_name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">analysis_file_abs_path</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
                <span class="n">analysis_file_name</span>
            <span class="p">)</span>
            <span class="c1"># export the new NWB file</span>
            <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
                <span class="n">path</span><span class="o">=</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">manager</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">export_io</span><span class="p">:</span>
                <span class="n">export_io</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">analysis_file_name</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the specified file to AnalysisNWBfile table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nwb_file_name : str</span>
<span class="sd">            The name of the parent NWB file.</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the analysis NWB file that was created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_file_name</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_file_name</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_abs_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
            <span class="n">analysis_file_name</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_abs_path</span><span class="p">(</span><span class="n">analysis_nwb_file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the absolute path for a stored analysis NWB file given just the file name.</span>

<span class="sd">        The SPYGLASS_BASE_DIR environment variable must be set.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analysis_nwb_file_name : str</span>
<span class="sd">            The name of the NWB file that has been inserted into the AnalysisNwbfile() schema</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        analysis_nwb_file_abspath : str</span>
<span class="sd">            The absolute path for the given file name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SPYGLASS_BASE_DIR&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;You must set SPYGLASS_BASE_DIR environment variable.&quot;</span>

        <span class="c1"># see if the file exists and is stored in the base analysis dir</span>
        <span class="n">test_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;analysis&quot;</span> <span class="o">/</span> <span class="n">analysis_nwb_file_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">test_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">test_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use the new path</span>
            <span class="n">analysis_file_base_path</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">base_dir</span>
                <span class="o">/</span> <span class="s2">&quot;analysis&quot;</span>
                <span class="o">/</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">__get_analysis_file_dir</span><span class="p">(</span>
                    <span class="n">analysis_nwb_file_name</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis_file_base_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">analysis_file_base_path</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">analysis_file_base_path</span> <span class="o">/</span> <span class="n">analysis_nwb_file_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_nwb_object</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">nwb_object</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;pandas_table&quot;</span>
    <span class="p">):</span>
        <span class="c1"># TODO: change to add_object with checks for object type and a name parameter, which should be specified if</span>
        <span class="c1"># it is not an NWB container</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add an NWB object to the analysis file in the scratch area and returns the NWB object ID</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the analysis NWB file.</span>
<span class="sd">        nwb_object : pynwb.core.NWBDataInterface</span>
<span class="sd">            The NWB object created by PyNWB.</span>
<span class="sd">        table_name : str (optional, defaults to &#39;pandas_table&#39;)</span>
<span class="sd">            The name of the DynamicTable made from a dataframe.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        nwb_object_id : str</span>
<span class="sd">            The NWB object ID of the added object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
            <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">dt_object</span> <span class="o">=</span> <span class="n">DynamicTable</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">nwb_object</span>
                <span class="p">)</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span><span class="n">dt_object</span><span class="p">)</span>
                <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">dt_object</span><span class="o">.</span><span class="n">object_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">)</span>
                <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">nwb_object</span><span class="o">.</span><span class="n">object_id</span>

    <span class="k">def</span> <span class="nf">add_units</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">analysis_file_name</span><span class="p">,</span>
        <span class="n">units</span><span class="p">,</span>
        <span class="n">units_valid_times</span><span class="p">,</span>
        <span class="n">units_sort_interval</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">units_waveforms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add units to analysis NWB file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the analysis NWB file.</span>
<span class="sd">        units : dict</span>
<span class="sd">            keys are unit ids, values are spike times</span>
<span class="sd">        units_valid_times : dict</span>
<span class="sd">            Dictionary of units and valid times with unit ids as keys.</span>
<span class="sd">        units_sort_interval : dict</span>
<span class="sd">            Dictionary of units and sort_interval with unit ids as keys.</span>
<span class="sd">        units_waveforms : dict, optional</span>
<span class="sd">            Dictionary of unit waveforms with unit ids as keys.</span>
<span class="sd">        metrics : dict, optional</span>
<span class="sd">            Cluster metrics.</span>
<span class="sd">        labels : dict, optional</span>
<span class="sd">            Curation labels for clusters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        units_object_id, waveforms_object_id : str, str</span>
<span class="sd">            The NWB object id of the Units object and the object id of the waveforms object (&#39;&#39; if None)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
            <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">sort_intervals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="c1"># Add spike times and valid time range for the sort</span>
                <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span>
                        <span class="n">spike_times</span><span class="o">=</span><span class="n">units</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span>
                        <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
                        <span class="c1"># waveform_mean = units_templates[id],</span>
                        <span class="n">obs_intervals</span><span class="o">=</span><span class="n">units_valid_times</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="n">sort_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">units_sort_interval</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span>
                <span class="c1"># Add a column for the sort interval (subset of valid time)</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sort_interval&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;the interval used for spike sorting&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">sort_intervals</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># If metrics were specified, add one column per metric</span>
                <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]:</span>
                            <span class="n">unit_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                            <span class="n">metric_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                            <span class="p">)</span>
                            <span class="c1"># sort by unit_ids and apply that sorting to values to ensure that things go in the right order</span>
                            <span class="n">metric_values</span> <span class="o">=</span> <span class="n">metric_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">unit_ids</span><span class="p">)]</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding metric </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">metric_values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                                <span class="n">name</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
                                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> metric&quot;</span><span class="p">,</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">metric_values</span><span class="p">,</span>
                            <span class="p">)</span>
                <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">unit_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                    <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">unit_ids</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                            <span class="n">labels</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">label_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                    <span class="n">label_values</span> <span class="o">=</span> <span class="n">label_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">unit_ids</span><span class="p">)]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;label given during curation&quot;</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">label_values</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="c1"># If the waveforms were specified, add them as a dataframe to scratch</span>
                <span class="n">waveforms_object_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">units_waveforms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">waveforms_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                        <span class="n">units_waveforms</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span>
                    <span class="p">)</span>
                    <span class="n">waveforms_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;waveforms&quot;</span><span class="p">]</span>
                    <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span>
                        <span class="n">waveforms_df</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;units_waveforms&quot;</span><span class="p">,</span>
                        <span class="n">notes</span><span class="o">=</span><span class="s2">&quot;spike waveforms for each unit&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">waveforms_object_id</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">scratch</span><span class="p">[</span>
                        <span class="s2">&quot;units_waveforms&quot;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">object_id</span>

                <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">object_id</span><span class="p">,</span> <span class="n">waveforms_object_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">add_units_waveforms</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">analysis_file_name</span><span class="p">,</span>
        <span class="n">waveform_extractor</span><span class="p">:</span> <span class="n">si</span><span class="o">.</span><span class="n">WaveformExtractor</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add units to analysis NWB file along with the waveforms</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the analysis NWB file.</span>
<span class="sd">        waveform_extractor : si.WaveformExtractor object</span>
<span class="sd">        metrics : dict, optional</span>
<span class="sd">            Cluster metrics.</span>
<span class="sd">        labels : dict, optional</span>
<span class="sd">            Curation labels for clusters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        units_object_id : str</span>
<span class="sd">            The NWB object id of the Units object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
            <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">waveform_extractor</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_ids</span><span class="p">():</span>
                <span class="c1"># (spikes, samples, channels)</span>
                <span class="n">waveforms</span> <span class="o">=</span> <span class="n">waveform_extractor</span><span class="o">.</span><span class="n">get_waveforms</span><span class="p">(</span><span class="n">unit_id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
                <span class="c1"># (channels, spikes, samples)</span>
                <span class="n">waveforms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">waveforms</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span>
                    <span class="n">spike_times</span><span class="o">=</span><span class="n">waveform_extractor</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_spike_train</span><span class="p">(</span>
                        <span class="n">unit_id</span><span class="o">=</span><span class="nb">id</span>
                    <span class="p">),</span>
                    <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
                    <span class="n">electrodes</span><span class="o">=</span><span class="n">waveform_extractor</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">(),</span>
                    <span class="n">waveforms</span><span class="o">=</span><span class="n">waveforms</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># The following is a rough sketch of AnalysisNwbfile().add_waveforms</span>
            <span class="c1"># analysis_file_name = AnalysisNwbfile().create(key[&#39;nwb_file_name&#39;])</span>
            <span class="c1"># or</span>
            <span class="c1"># nwbfile = pynwb.NWBFile(...)</span>
            <span class="c1"># (channels, spikes, samples)</span>
            <span class="c1"># wfs = [</span>
            <span class="c1">#         [     # elec 1</span>
            <span class="c1">#             [1, 2, 3],  # spike 1, [sample 1, sample 2, sample 3]</span>
            <span class="c1">#             [1, 2, 3],  # spike 2</span>
            <span class="c1">#             [1, 2, 3],  # spike 3</span>
            <span class="c1">#             [1, 2, 3]   # spike 4</span>
            <span class="c1">#         ], [  # elec 2</span>
            <span class="c1">#             [1, 2, 3],  # spike 1</span>
            <span class="c1">#             [1, 2, 3],  # spike 2</span>
            <span class="c1">#             [1, 2, 3],  # spike 3</span>
            <span class="c1">#             [1, 2, 3]   # spike 4</span>
            <span class="c1">#         ], [  # elec 3</span>
            <span class="c1">#             [1, 2, 3],  # spike 1</span>
            <span class="c1">#             [1, 2, 3],  # spike 2</span>
            <span class="c1">#             [1, 2, 3],  # spike 3</span>
            <span class="c1">#             [1, 2, 3]   # spike 4</span>
            <span class="c1">#         ]</span>
            <span class="c1"># ]</span>
            <span class="c1"># elecs = ... # DynamicTableRegion referring to three electrodes (rows) of the electrodes table</span>
            <span class="c1"># nwbfile.add_unit(spike_times=[1, 2, 3], electrodes=elecs, waveforms=wfs)</span>

            <span class="c1"># If metrics were specified, add one column per metric</span>
            <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding metric </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">metric_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">metric_data</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                    <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">metric_data</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;label given during curation&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">object_id</span>

    <span class="k">def</span> <span class="nf">add_units_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add units to analysis NWB file along with the waveforms</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the analysis NWB file.</span>
<span class="sd">        metrics : dict, optional</span>
<span class="sd">            Cluster metrics.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        units_object_id : str</span>
<span class="sd">            The NWB object id of the Units object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metric_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">unit_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
            <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">unit_ids</span><span class="p">:</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding metric </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">metric_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">metric_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">metric_data</span>
                <span class="p">)</span>

            <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">object_id</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_electrode_indices</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given an analysis NWB file name, returns the indices of the specified electrode_ids.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the analysis NWB file.</span>
<span class="sd">        electrode_ids : numpy array or list</span>
<span class="sd">            Array or list of electrode IDs.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        electrode_indices : numpy array</span>
<span class="sd">            Array of indices in the electrodes table for the given electrode IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">get_nwb_file</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">get_electrode_indices</span><span class="p">(</span><span class="n">nwbf</span><span class="o">.</span><span class="n">electrodes</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">delete_files</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove the filepath entries for NWB files that are not in use.</span>

<span class="sd">        Does not delete the files themselves unless delete_files=True is specified.</span>
<span class="sd">        Run this after deleting the Nwbfile() entries themselves.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        delete_files : bool, optional</span>
<span class="sd">            Whether the original files should be deleted (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">external</span><span class="p">[</span><span class="s2">&quot;analysis&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">delete_external_files</span><span class="o">=</span><span class="n">delete_files</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">nightly_cleanup</span><span class="p">():</span>
        <span class="n">child_tables</span> <span class="o">=</span> <span class="n">get_child_tables</span><span class="p">(</span><span class="n">AnalysisNwbfile</span><span class="p">)</span>
        <span class="p">(</span><span class="n">AnalysisNwbfile</span> <span class="o">-</span> <span class="n">child_tables</span><span class="p">)</span><span class="o">.</span><span class="n">delete_quick</span><span class="p">()</span>

        <span class="c1"># a separate external files clean up required - this is to be done</span>
        <span class="c1"># during times when no other transactions are in progress.</span>
        <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.create" class="doc doc-heading">
<code class="highlight language-python"><span class="n">create</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.create" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Open the NWB file, create a copy, write the copy to disk and return the name of the new file.</p>
<p>Note that this does NOT add the file to the schema; that needs to be done after data are written to it.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of an NWB file to be copied.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>analysis_file_name</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the new NWB file.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Open the NWB file, create a copy, write the copy to disk and return the name of the new file.</span>

<span class="sd">    Note that this does NOT add the file to the schema; that needs to be done after data are written to it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwb_file_name : str</span>
<span class="sd">        The name of an NWB file to be copied.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the new NWB file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nwb_file_abspath</span> <span class="o">=</span> <span class="n">Nwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="n">nwb_file_abspath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1"># pop off the unnecessary elements to save space</span>
        <span class="n">nwb_fields</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">fields</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">nwb_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NWB_KEEP_FIELDS</span><span class="p">:</span>
                <span class="n">nwb_object</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">nwbf</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">,</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">LabelledDict</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nwb_object</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">nwb_object</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>

        <span class="n">analysis_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_new_file_name</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
        <span class="c1"># write the new file</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing new NWB file </span><span class="si">{</span><span class="n">analysis_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">analysis_file_abs_path</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
            <span class="n">analysis_file_name</span>
        <span class="p">)</span>
        <span class="c1"># export the new NWB file</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">manager</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">export_io</span><span class="p">:</span>
            <span class="n">export_io</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">)</span>

    <span class="c1"># change the permissions to only allow owner to write</span>
    <span class="n">permissions</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IROTH</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">permissions</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">analysis_file_name</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.copy" class="doc doc-heading">
<code class="highlight language-python"><span class="n">copy</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.copy" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Make a copy of an analysis NWB file.</p>
<p>Note that this does NOT add the file to the schema; that needs to be done after data are written to it.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file to be copied.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>analysis_file_name</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the new NWB file.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make a copy of an analysis NWB file.</span>

<span class="sd">    Note that this does NOT add the file to the schema; that needs to be done after data are written to it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwb_file_name : str</span>
<span class="sd">        The name of the analysis NWB file to be copied.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the new NWB file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nwb_file_abspath</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="n">nwb_file_abspath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1"># get the current number of analysis files related to this nwb file</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">}</span>
        <span class="n">original_nwb_file_name</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">analysis_file_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__get_new_file_name</span><span class="p">(</span><span class="n">original_nwb_file_name</span><span class="p">)</span>
        <span class="c1"># write the new file</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing new NWB file </span><span class="si">{</span><span class="n">analysis_file_name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">analysis_file_abs_path</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
            <span class="n">analysis_file_name</span>
        <span class="p">)</span>
        <span class="c1"># export the new NWB file</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">manager</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">export_io</span><span class="p">:</span>
            <span class="n">export_io</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">analysis_file_name</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.add" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add the specified file to AnalysisNWBfile table.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the parent NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>analysis_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file that was created.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add the specified file to AnalysisNWBfile table.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwb_file_name : str</span>
<span class="sd">        The name of the parent NWB file.</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the analysis NWB file that was created.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_file_name</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_file_name</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_abs_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
        <span class="n">analysis_file_name</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.get_abs_path" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_nwb_file_name</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.get_abs_path" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Return the absolute path for a stored analysis NWB file given just the file name.</p>
<p>The SPYGLASS_BASE_DIR environment variable must be set.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>analysis_nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the NWB file that has been inserted into the AnalysisNwbfile() schema</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>analysis_nwb_file_abspath</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The absolute path for the given file name.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">get_abs_path</span><span class="p">(</span><span class="n">analysis_nwb_file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the absolute path for a stored analysis NWB file given just the file name.</span>

<span class="sd">    The SPYGLASS_BASE_DIR environment variable must be set.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analysis_nwb_file_name : str</span>
<span class="sd">        The name of the NWB file that has been inserted into the AnalysisNwbfile() schema</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    analysis_nwb_file_abspath : str</span>
<span class="sd">        The absolute path for the given file name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">base_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SPYGLASS_BASE_DIR&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">),</span> <span class="s2">&quot;You must set SPYGLASS_BASE_DIR environment variable.&quot;</span>

    <span class="c1"># see if the file exists and is stored in the base analysis dir</span>
    <span class="n">test_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;analysis&quot;</span> <span class="o">/</span> <span class="n">analysis_nwb_file_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">test_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test_path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># use the new path</span>
        <span class="n">analysis_file_base_path</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">base_dir</span>
            <span class="o">/</span> <span class="s2">&quot;analysis&quot;</span>
            <span class="o">/</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">__get_analysis_file_dir</span><span class="p">(</span>
                <span class="n">analysis_nwb_file_name</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis_file_base_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">analysis_file_base_path</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">analysis_file_base_path</span> <span class="o">/</span> <span class="n">analysis_nwb_file_name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_nwb_object" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_nwb_object</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">nwb_object</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;pandas_table&#39;</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_nwb_object" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add an NWB object to the analysis file in the scratch area and returns the NWB object ID</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>analysis_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nwb_object</code></td>
          <td>
                <code>pynwb.<span title="pynwb.core">core</span>.<span title="pynwb.core.NWBDataInterface">NWBDataInterface</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The NWB object created by PyNWB.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>table_name</code></td>
          <td>
                <code>str (optional, defaults to &#39;pandas_table&#39;)</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the DynamicTable made from a dataframe.</p>
            </div>
          </td>
          <td>
                <code>&#39;pandas_table&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>nwb_object_id</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The NWB object ID of the added object.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_nwb_object</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">nwb_object</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;pandas_table&quot;</span>
<span class="p">):</span>
    <span class="c1"># TODO: change to add_object with checks for object type and a name parameter, which should be specified if</span>
    <span class="c1"># it is not an NWB container</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add an NWB object to the analysis file in the scratch area and returns the NWB object ID</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the analysis NWB file.</span>
<span class="sd">    nwb_object : pynwb.core.NWBDataInterface</span>
<span class="sd">        The NWB object created by PyNWB.</span>
<span class="sd">    table_name : str (optional, defaults to &#39;pandas_table&#39;)</span>
<span class="sd">        The name of the DynamicTable made from a dataframe.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nwb_object_id : str</span>
<span class="sd">        The NWB object ID of the added object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
        <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">dt_object</span> <span class="o">=</span> <span class="n">DynamicTable</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">nwb_object</span>
            <span class="p">)</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span><span class="n">dt_object</span><span class="p">)</span>
            <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dt_object</span><span class="o">.</span><span class="n">object_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">)</span>
            <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nwb_object</span><span class="o">.</span><span class="n">object_id</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_units</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">units_valid_times</span><span class="p">,</span> <span class="n">units_sort_interval</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units_waveforms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add units to analysis NWB file</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>analysis_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>units</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>keys are unit ids, values are spike times</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>units_valid_times</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary of units and valid times with unit ids as keys.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>units_sort_interval</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary of units and sort_interval with unit ids as keys.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>units_waveforms</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary of unit waveforms with unit ids as keys.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>metrics</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Cluster metrics.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>labels</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Curation labels for clusters</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>units_object_id, waveforms_object_id : str, str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The NWB object id of the Units object and the object id of the waveforms object ('' if None)</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_units</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">analysis_file_name</span><span class="p">,</span>
    <span class="n">units</span><span class="p">,</span>
    <span class="n">units_valid_times</span><span class="p">,</span>
    <span class="n">units_sort_interval</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">units_waveforms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add units to analysis NWB file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the analysis NWB file.</span>
<span class="sd">    units : dict</span>
<span class="sd">        keys are unit ids, values are spike times</span>
<span class="sd">    units_valid_times : dict</span>
<span class="sd">        Dictionary of units and valid times with unit ids as keys.</span>
<span class="sd">    units_sort_interval : dict</span>
<span class="sd">        Dictionary of units and sort_interval with unit ids as keys.</span>
<span class="sd">    units_waveforms : dict, optional</span>
<span class="sd">        Dictionary of unit waveforms with unit ids as keys.</span>
<span class="sd">    metrics : dict, optional</span>
<span class="sd">        Cluster metrics.</span>
<span class="sd">    labels : dict, optional</span>
<span class="sd">        Curation labels for clusters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    units_object_id, waveforms_object_id : str, str</span>
<span class="sd">        The NWB object id of the Units object and the object id of the waveforms object (&#39;&#39; if None)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
        <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">sort_intervals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="c1"># Add spike times and valid time range for the sort</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span>
                    <span class="n">spike_times</span><span class="o">=</span><span class="n">units</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span>
                    <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
                    <span class="c1"># waveform_mean = units_templates[id],</span>
                    <span class="n">obs_intervals</span><span class="o">=</span><span class="n">units_valid_times</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">sort_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">units_sort_interval</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span>
            <span class="c1"># Add a column for the sort interval (subset of valid time)</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sort_interval&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;the interval used for spike sorting&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">sort_intervals</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># If metrics were specified, add one column per metric</span>
            <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]:</span>
                        <span class="n">unit_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                        <span class="n">metric_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                            <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                        <span class="p">)</span>
                        <span class="c1"># sort by unit_ids and apply that sorting to values to ensure that things go in the right order</span>
                        <span class="n">metric_values</span> <span class="o">=</span> <span class="n">metric_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">unit_ids</span><span class="p">)]</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding metric </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">metric_values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
                            <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> metric&quot;</span><span class="p">,</span>
                            <span class="n">data</span><span class="o">=</span><span class="n">metric_values</span><span class="p">,</span>
                        <span class="p">)</span>
            <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">unit_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">unit_ids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                        <span class="n">labels</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">label_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                <span class="n">label_values</span> <span class="o">=</span> <span class="n">label_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">unit_ids</span><span class="p">)]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;label given during curation&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">label_values</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># If the waveforms were specified, add them as a dataframe to scratch</span>
            <span class="n">waveforms_object_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">units_waveforms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">waveforms_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                    <span class="n">units_waveforms</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span>
                <span class="p">)</span>
                <span class="n">waveforms_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;waveforms&quot;</span><span class="p">]</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span>
                    <span class="n">waveforms_df</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;units_waveforms&quot;</span><span class="p">,</span>
                    <span class="n">notes</span><span class="o">=</span><span class="s2">&quot;spike waveforms for each unit&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">waveforms_object_id</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">scratch</span><span class="p">[</span>
                    <span class="s2">&quot;units_waveforms&quot;</span>
                <span class="p">]</span><span class="o">.</span><span class="n">object_id</span>

            <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">object_id</span><span class="p">,</span> <span class="n">waveforms_object_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units_waveforms" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_units_waveforms</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">waveform_extractor</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units_waveforms" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add units to analysis NWB file along with the waveforms</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>analysis_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>waveform_extractor</code></td>
          <td>
                <code>si.WaveformExtractor object</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>metrics</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Cluster metrics.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>labels</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Curation labels for clusters</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>units_object_id</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The NWB object id of the Units object</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_units_waveforms</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">analysis_file_name</span><span class="p">,</span>
    <span class="n">waveform_extractor</span><span class="p">:</span> <span class="n">si</span><span class="o">.</span><span class="n">WaveformExtractor</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add units to analysis NWB file along with the waveforms</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the analysis NWB file.</span>
<span class="sd">    waveform_extractor : si.WaveformExtractor object</span>
<span class="sd">    metrics : dict, optional</span>
<span class="sd">        Cluster metrics.</span>
<span class="sd">    labels : dict, optional</span>
<span class="sd">        Curation labels for clusters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    units_object_id : str</span>
<span class="sd">        The NWB object id of the Units object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
        <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">waveform_extractor</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_ids</span><span class="p">():</span>
            <span class="c1"># (spikes, samples, channels)</span>
            <span class="n">waveforms</span> <span class="o">=</span> <span class="n">waveform_extractor</span><span class="o">.</span><span class="n">get_waveforms</span><span class="p">(</span><span class="n">unit_id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
            <span class="c1"># (channels, spikes, samples)</span>
            <span class="n">waveforms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">waveforms</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span>
                <span class="n">spike_times</span><span class="o">=</span><span class="n">waveform_extractor</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_spike_train</span><span class="p">(</span>
                    <span class="n">unit_id</span><span class="o">=</span><span class="nb">id</span>
                <span class="p">),</span>
                <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
                <span class="n">electrodes</span><span class="o">=</span><span class="n">waveform_extractor</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">(),</span>
                <span class="n">waveforms</span><span class="o">=</span><span class="n">waveforms</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># The following is a rough sketch of AnalysisNwbfile().add_waveforms</span>
        <span class="c1"># analysis_file_name = AnalysisNwbfile().create(key[&#39;nwb_file_name&#39;])</span>
        <span class="c1"># or</span>
        <span class="c1"># nwbfile = pynwb.NWBFile(...)</span>
        <span class="c1"># (channels, spikes, samples)</span>
        <span class="c1"># wfs = [</span>
        <span class="c1">#         [     # elec 1</span>
        <span class="c1">#             [1, 2, 3],  # spike 1, [sample 1, sample 2, sample 3]</span>
        <span class="c1">#             [1, 2, 3],  # spike 2</span>
        <span class="c1">#             [1, 2, 3],  # spike 3</span>
        <span class="c1">#             [1, 2, 3]   # spike 4</span>
        <span class="c1">#         ], [  # elec 2</span>
        <span class="c1">#             [1, 2, 3],  # spike 1</span>
        <span class="c1">#             [1, 2, 3],  # spike 2</span>
        <span class="c1">#             [1, 2, 3],  # spike 3</span>
        <span class="c1">#             [1, 2, 3]   # spike 4</span>
        <span class="c1">#         ], [  # elec 3</span>
        <span class="c1">#             [1, 2, 3],  # spike 1</span>
        <span class="c1">#             [1, 2, 3],  # spike 2</span>
        <span class="c1">#             [1, 2, 3],  # spike 3</span>
        <span class="c1">#             [1, 2, 3]   # spike 4</span>
        <span class="c1">#         ]</span>
        <span class="c1"># ]</span>
        <span class="c1"># elecs = ... # DynamicTableRegion referring to three electrodes (rows) of the electrodes table</span>
        <span class="c1"># nwbfile.add_unit(spike_times=[1, 2, 3], electrodes=elecs, waveforms=wfs)</span>

        <span class="c1"># If metrics were specified, add one column per metric</span>
        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding metric </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">metric_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">metric_data</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">metric_data</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;label given during curation&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">object_id</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units_metrics" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_units_metrics</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units_metrics" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add units to analysis NWB file along with the waveforms</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>analysis_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>metrics</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Cluster metrics.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>units_object_id</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The NWB object id of the Units object</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_units_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add units to analysis NWB file along with the waveforms</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the analysis NWB file.</span>
<span class="sd">    metrics : dict, optional</span>
<span class="sd">        Cluster metrics.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    units_object_id : str</span>
<span class="sd">        The NWB object id of the Units object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metric_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">unit_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
        <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">unit_ids</span><span class="p">:</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding metric </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">metric_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">metric_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">metric_data</span>
            <span class="p">)</span>

        <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">object_id</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.get_electrode_indices" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_electrode_indices</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.get_electrode_indices" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Given an analysis NWB file name, returns the indices of the specified electrode_ids.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>analysis_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>electrode_ids</code></td>
          <td>
                <code>numpy array or list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Array or list of electrode IDs.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>electrode_indices</code></td>          <td>
                <code>numpy array</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Array of indices in the electrodes table for the given electrode IDs.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">get_electrode_indices</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given an analysis NWB file name, returns the indices of the specified electrode_ids.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the analysis NWB file.</span>
<span class="sd">    electrode_ids : numpy array or list</span>
<span class="sd">        Array or list of electrode IDs.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    electrode_indices : numpy array</span>
<span class="sd">        Array of indices in the electrodes table for the given electrode IDs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nwbf</span> <span class="o">=</span> <span class="n">get_nwb_file</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">get_electrode_indices</span><span class="p">(</span><span class="n">nwbf</span><span class="o">.</span><span class="n">electrodes</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.cleanup" class="doc doc-heading">
<code class="highlight language-python"><span class="n">cleanup</span><span class="p">(</span><span class="n">delete_files</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.cleanup" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Remove the filepath entries for NWB files that are not in use.</p>
<p>Does not delete the files themselves unless delete_files=True is specified.
Run this after deleting the Nwbfile() entries themselves.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>delete_files</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Whether the original files should be deleted (default False).</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">delete_files</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove the filepath entries for NWB files that are not in use.</span>

<span class="sd">    Does not delete the files themselves unless delete_files=True is specified.</span>
<span class="sd">    Run this after deleting the Nwbfile() entries themselves.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    delete_files : bool, optional</span>
<span class="sd">        Whether the original files should be deleted (default False).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">external</span><span class="p">[</span><span class="s2">&quot;analysis&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">delete_external_files</span><span class="o">=</span><span class="n">delete_files</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-function">



<h2 id="src.spyglass.common.common_ephys.interval_list_contains_ind" class="doc doc-heading">
<code class="highlight language-python"><span class="n">interval_list_contains_ind</span><span class="p">(</span><span class="n">interval_list</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_ephys.interval_list_contains_ind" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Find indices of a list of timestamps that are contained in an interval list.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>interval_list</code></td>
          <td>
                <code>array_like</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Each element is (start time, stop time), i.e. an interval. Unit is seconds.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>timestamps</code></td>
          <td>
                <code>array_like</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_interval.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">interval_list_contains_ind</span><span class="p">(</span><span class="n">interval_list</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find indices of a list of timestamps that are contained in an interval list.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    interval_list : array_like</span>
<span class="sd">        Each element is (start time, stop time), i.e. an interval. Unit is seconds.</span>
<span class="sd">    timestamps : array_like</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">interval_list</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">timestamps</span> <span class="o">&gt;=</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">timestamps</span> <span class="o">&lt;=</span> <span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h2 id="src.spyglass.common.common_ephys.estimate_sampling_rate" class="doc doc-heading">
<code class="highlight language-python"><span class="n">estimate_sampling_rate</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_ephys.estimate_sampling_rate" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Estimate the sampling rate given a list of timestamps.</p>
<p>Assumes that the most common temporal differences between timestamps approximate the sampling rate. Note that this
can fail for very high sampling rates and irregular timestamps.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>timestamps</code></td>
          <td>
                <code>numpy.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>1D numpy array of timestamp values.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>multiplier</code></td>
          <td>
                <code>float or int</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>estimated_rate</code></td>          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The estimated sampling rate.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/utils/nwb_helper_fn.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">estimate_sampling_rate</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Estimate the sampling rate given a list of timestamps.</span>

<span class="sd">    Assumes that the most common temporal differences between timestamps approximate the sampling rate. Note that this</span>
<span class="sd">    can fail for very high sampling rates and irregular timestamps.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    timestamps : numpy.ndarray</span>
<span class="sd">        1D numpy array of timestamp values.</span>
<span class="sd">    multiplier : float or int</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    estimated_rate : float</span>
<span class="sd">        The estimated sampling rate.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># approach:</span>
    <span class="c1"># 1. use a box car smoother and a histogram to get the modal value</span>
    <span class="c1"># 2. identify adjacent samples as those that have a time difference &lt; the multiplier * the modal value</span>
    <span class="c1"># 3. average the time differences between adjacent samples</span>
    <span class="n">sample_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">timestamps</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_diff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Only </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_diff</span><span class="p">)</span><span class="si">}</span><span class="s2"> timestamps are valid. Check the data.&quot;</span>
        <span class="p">)</span>
    <span class="n">nsmooth</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">smoother</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nsmooth</span><span class="p">)</span> <span class="o">/</span> <span class="n">nsmooth</span>
    <span class="n">smooth_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">sample_diff</span><span class="p">,</span> <span class="n">smoother</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>

    <span class="c1"># we histogram with 100 bins out to 3 * mean, which should be fine for any reasonable number of samples</span>
    <span class="n">hist</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
        <span class="n">smooth_diff</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smooth_diff</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">hist</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">hist</span><span class="p">))]</span>

    <span class="n">adjacent</span> <span class="o">=</span> <span class="n">sample_diff</span> <span class="o">&lt;</span> <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">multiplier</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sample_diff</span><span class="p">[</span><span class="n">adjacent</span><span class="p">]))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h2 id="src.spyglass.common.common_ephys.get_valid_intervals" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_valid_intervals</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="p">,</span> <span class="n">gap_proportion</span><span class="p">,</span> <span class="n">min_valid_len</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_ephys.get_valid_intervals" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Finds the set of all valid intervals in a list of timestamps.
Valid interval: (start time, stop time) during which there are
no gaps (i.e. missing samples).</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>timestamps</code></td>
          <td>
                <code>numpy.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>1D numpy array of timestamp values.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>sampling_rate</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Sampling rate of the data.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>gap_proportion</code></td>
          <td>
                <code>float, greater than 1; unit: samples</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Threshold for detecting a gap;
i.e. if the difference (in samples) between
consecutive timestamps exceeds gap_proportion,
it is considered a gap</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>min_valid_len</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Length of smallest valid interval.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>valid_times</code></td>          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Array of start and stop times of shape (N, 2) for valid data.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/utils/nwb_helper_fn.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_valid_intervals</span><span class="p">(</span>
    <span class="n">timestamps</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="p">,</span> <span class="n">gap_proportion</span><span class="p">,</span> <span class="n">min_valid_len</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Finds the set of all valid intervals in a list of timestamps.</span>
<span class="sd">    Valid interval: (start time, stop time) during which there are</span>
<span class="sd">    no gaps (i.e. missing samples).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    timestamps : numpy.ndarray</span>
<span class="sd">        1D numpy array of timestamp values.</span>
<span class="sd">    sampling_rate : float</span>
<span class="sd">        Sampling rate of the data.</span>
<span class="sd">    gap_proportion : float, greater than 1; unit: samples</span>
<span class="sd">        Threshold for detecting a gap;</span>
<span class="sd">        i.e. if the difference (in samples) between</span>
<span class="sd">        consecutive timestamps exceeds gap_proportion,</span>
<span class="sd">        it is considered a gap</span>
<span class="sd">    min_valid_len : float</span>
<span class="sd">        Length of smallest valid interval.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    valid_times : np.ndarray</span>
<span class="sd">        Array of start and stop times of shape (N, 2) for valid data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">eps</span> <span class="o">=</span> <span class="mf">0.0000001</span>

    <span class="c1"># get rid of NaN elements</span>
    <span class="n">timestamps</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)]</span>
    <span class="c1"># find gaps</span>
    <span class="n">gap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sampling_rate</span> <span class="o">*</span> <span class="n">gap_proportion</span>

    <span class="c1"># all true entries of gap represent gaps. Get the times bounding these intervals.</span>
    <span class="n">gapind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gap</span><span class="p">))</span>
    <span class="c1"># The end of each valid interval are the indices of the gaps and the final value</span>
    <span class="n">valid_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gapind</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># the beginning of the gaps are the first element and gapind+1</span>
    <span class="n">valid_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">gapind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">valid_start</span><span class="p">,</span> <span class="n">valid_end</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="n">valid_times</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span>
    <span class="c1"># adjust the times to deal with single valid samples</span>
    <span class="n">valid_times</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_times</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">eps</span>
    <span class="n">valid_times</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_times</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">eps</span>

    <span class="n">valid_intervals</span> <span class="o">=</span> <span class="p">(</span><span class="n">valid_times</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">valid_times</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">min_valid_len</span>

    <span class="k">return</span> <span class="n">valid_times</span><span class="p">[</span><span class="n">valid_intervals</span><span class="p">,</span> <span class="p">:]</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h2 id="src.spyglass.common.common_ephys.interval_list_intersect" class="doc doc-heading">
<code class="highlight language-python"><span class="n">interval_list_intersect</span><span class="p">(</span><span class="n">interval_list1</span><span class="p">,</span> <span class="n">interval_list2</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_ephys.interval_list_intersect" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Finds the intersections between two interval lists</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>interval_list1</code></td>
          <td>
                <code>np.array, (N,2) where N = number of intervals</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>interval_list2</code></td>
          <td>
                <code>np.array, (N,2) where N = number of intervals</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>min_length</code></td>
          <td>
                <code>float, optional.</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Minimum length of intervals to include, default 0</p>
            </div>
          </td>
          <td>
                <code>0</code>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Each interval is (start time, stop time)</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>interval_list</code></td>          <td>
                <code><span title="numpy">np</span>.<span title="numpy.array">array</span>, N, 2</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_interval.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">interval_list_intersect</span><span class="p">(</span><span class="n">interval_list1</span><span class="p">,</span> <span class="n">interval_list2</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Finds the intersections between two interval lists</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    interval_list1 : np.array, (N,2) where N = number of intervals</span>
<span class="sd">    interval_list2 : np.array, (N,2) where N = number of intervals</span>
<span class="sd">    min_length : float, optional.</span>
<span class="sd">        Minimum length of intervals to include, default 0</span>

<span class="sd">    Each interval is (start time, stop time)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    interval_list: np.array, (N,2)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># first, consolidate interval lists to disjoint intervals by sorting and applying union</span>
    <span class="k">if</span> <span class="n">interval_list1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">interval_list1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">interval_list1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">interval_list1</span> <span class="o">=</span> <span class="n">interval_list1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">interval_list1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])]</span>
        <span class="n">interval_list1</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">_union_concat</span><span class="p">,</span> <span class="n">interval_list1</span><span class="p">)</span>
        <span class="c1"># the following check is needed in the case where the interval list is a single element (behavior of reduce)</span>
        <span class="k">if</span> <span class="n">interval_list1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">interval_list1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">interval_list1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">interval_list2</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">interval_list2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">interval_list2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">interval_list2</span> <span class="o">=</span> <span class="n">interval_list2</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">interval_list2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])]</span>
        <span class="n">interval_list2</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">_union_concat</span><span class="p">,</span> <span class="n">interval_list2</span><span class="p">)</span>
        <span class="c1"># the following check is needed in the case where the interval list is a single element (behavior of reduce)</span>
        <span class="k">if</span> <span class="n">interval_list2</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">interval_list2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">interval_list2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># then do pairwise comparison and collect intersections</span>
    <span class="n">intersecting_intervals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">interval2</span> <span class="ow">in</span> <span class="n">interval_list2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">interval1</span> <span class="ow">in</span> <span class="n">interval_list1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_intersection</span><span class="p">(</span><span class="n">interval2</span><span class="p">,</span> <span class="n">interval1</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">intersecting_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">_intersection</span><span class="p">(</span><span class="n">interval1</span><span class="p">,</span> <span class="n">interval2</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="c1"># if no intersection, then return an empty list</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">intersecting_intervals</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">intersecting_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">intersecting_intervals</span><span class="p">)</span>
        <span class="n">intersecting_intervals</span> <span class="o">=</span> <span class="n">intersecting_intervals</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">intersecting_intervals</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">intervals_by_length</span><span class="p">(</span>
            <span class="n">intersecting_intervals</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="n">min_length</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h2 id="src.spyglass.common.common_ephys.get_electrode_indices" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_electrode_indices</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_ephys.get_electrode_indices" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Given an NWB file or electrical series object, return the indices of the specified electrode_ids.</p>
<p>If an ElectricalSeries is given, then the indices returned are relative to the selected rows in
ElectricalSeries.electrodes. For example, if electricalseries.electrodes = [5], and row index 5 of
nwbfile.electrodes has ID 10, then calling get_electrode_indices(electricalseries, 10) will return 0, the
index of the matching electrode in electricalseries.electrodes.</p>
<p>Indices for electrode_ids that are not in the electrical series are returned as np.nan</p>
<p>If an NWBFile is given, then the row indices with the matching IDs in the file's electrodes table are returned.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwb_object</code></td>
          <td>
                <code>pynwb.NWBFile or pynwb.ecephys.ElectricalSeries</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The NWB file object or NWB electrical series object.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>electrode_ids</code></td>
          <td>
                <code>np.ndarray or list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Array or list of electrode IDs.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>electrode_indices</code></td>          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Array of indices of the specified electrode IDs.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/utils/nwb_helper_fn.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_electrode_indices</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given an NWB file or electrical series object, return the indices of the specified electrode_ids.</span>

<span class="sd">    If an ElectricalSeries is given, then the indices returned are relative to the selected rows in</span>
<span class="sd">    ElectricalSeries.electrodes. For example, if electricalseries.electrodes = [5], and row index 5 of</span>
<span class="sd">    nwbfile.electrodes has ID 10, then calling get_electrode_indices(electricalseries, 10) will return 0, the</span>
<span class="sd">    index of the matching electrode in electricalseries.electrodes.</span>

<span class="sd">    Indices for electrode_ids that are not in the electrical series are returned as np.nan</span>

<span class="sd">    If an NWBFile is given, then the row indices with the matching IDs in the file&#39;s electrodes table are returned.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwb_object : pynwb.NWBFile or pynwb.ecephys.ElectricalSeries</span>
<span class="sd">        The NWB file object or NWB electrical series object.</span>
<span class="sd">    electrode_ids : np.ndarray or list</span>
<span class="sd">        Array or list of electrode IDs.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    electrode_indices : list</span>
<span class="sd">        Array of indices of the specified electrode IDs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">,</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">ecephys</span><span class="o">.</span><span class="n">ElectricalSeries</span><span class="p">):</span>
        <span class="c1"># electrodes is a DynamicTableRegion which may contain a subset of the rows in NWBFile.electrodes</span>
        <span class="c1"># match against only the subset of electrodes referenced by this ElectricalSeries</span>
        <span class="n">electrode_table_indices</span> <span class="o">=</span> <span class="n">nwb_object</span><span class="o">.</span><span class="n">electrodes</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span>
        <span class="n">selected_elect_ids</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">nwb_object</span><span class="o">.</span><span class="n">electrodes</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">electrode_table_indices</span>
        <span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">,</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBFile</span><span class="p">):</span>
        <span class="c1"># electrodes is a DynamicTable that contains all electrodes</span>
        <span class="n">selected_elect_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nwb_object</span><span class="o">.</span><span class="n">electrodes</span><span class="o">.</span><span class="n">id</span><span class="p">[:])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;nwb_object must be of type ElectricalSeries or NWBFile&quot;</span>
        <span class="p">)</span>

    <span class="c1"># for each electrode_id, find its index in selected_elect_ids and return that if it&#39;s there and invalid_electrode_index if not.</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">selected_elect_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">elect_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">elect_id</span> <span class="ow">in</span> <span class="n">selected_elect_ids</span>
        <span class="k">else</span> <span class="n">invalid_electrode_index</span>
        <span class="k">for</span> <span class="n">elect_id</span> <span class="ow">in</span> <span class="n">electrode_ids</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.common.common_ephys.LFPSelection" class="doc doc-heading">
        <code>LFPSelection</code>


<a href="#src.spyglass.common.common_ephys.LFPSelection" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Manual">Manual</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/common/common_ephys.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">LFPSelection</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">     -&gt; Session</span>
<span class="s2">     &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">LFPElectrode</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        -&gt; LFPSelection</span>
<span class="s2">        -&gt; Electrode</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">set_lfp_electrodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">,</span> <span class="n">electrode_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes all electrodes for the specified nwb file and then adds back the electrodes in the list</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nwb_file_name : str</span>
<span class="sd">            The name of the nwb file for the desired session</span>
<span class="sd">        electrode_list : list</span>
<span class="sd">            list of electrodes to be used for LFP</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># remove the session and then recreate the session and Electrode list</span>
        <span class="p">(</span><span class="n">LFPSelection</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">})</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="c1"># check to see if the user allowed the deletion</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">((</span><span class="n">LFPSelection</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">})</span><span class="o">.</span><span class="n">fetch</span><span class="p">())</span>
            <span class="o">==</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="n">LFPSelection</span><span class="p">()</span><span class="o">.</span><span class="n">insert1</span><span class="p">({</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">})</span>

            <span class="c1"># TODO: do this in a better way</span>
            <span class="n">all_electrodes</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">Electrode</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">as_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">primary_key</span> <span class="o">=</span> <span class="n">Electrode</span><span class="o">.</span><span class="n">primary_key</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">all_electrodes</span><span class="p">:</span>
                <span class="c1"># create a dictionary so we can insert new elects</span>
                <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s2">&quot;electrode_id&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">electrode_list</span><span class="p">:</span>
                    <span class="n">lfpelectdict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">primary_key</span>
                    <span class="p">}</span>
                    <span class="n">LFPSelection</span><span class="p">()</span><span class="o">.</span><span class="n">LFPElectrode</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
                        <span class="n">lfpelectdict</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_ephys.LFPSelection.set_lfp_electrodes" class="doc doc-heading">
<code class="highlight language-python"><span class="n">set_lfp_electrodes</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">,</span> <span class="n">electrode_list</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_ephys.LFPSelection.set_lfp_electrodes" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Removes all electrodes for the specified nwb file and then adds back the electrodes in the list</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the nwb file for the desired session</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>electrode_list</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>list of electrodes to be used for LFP</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_ephys.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">set_lfp_electrodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">,</span> <span class="n">electrode_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Removes all electrodes for the specified nwb file and then adds back the electrodes in the list</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwb_file_name : str</span>
<span class="sd">        The name of the nwb file for the desired session</span>
<span class="sd">    electrode_list : list</span>
<span class="sd">        list of electrodes to be used for LFP</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># remove the session and then recreate the session and Electrode list</span>
    <span class="p">(</span><span class="n">LFPSelection</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">})</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="c1"># check to see if the user allowed the deletion</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">((</span><span class="n">LFPSelection</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">})</span><span class="o">.</span><span class="n">fetch</span><span class="p">())</span>
        <span class="o">==</span> <span class="mi">0</span>
    <span class="p">):</span>
        <span class="n">LFPSelection</span><span class="p">()</span><span class="o">.</span><span class="n">insert1</span><span class="p">({</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">})</span>

        <span class="c1"># TODO: do this in a better way</span>
        <span class="n">all_electrodes</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Electrode</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">as_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">primary_key</span> <span class="o">=</span> <span class="n">Electrode</span><span class="o">.</span><span class="n">primary_key</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">all_electrodes</span><span class="p">:</span>
            <span class="c1"># create a dictionary so we can insert new elects</span>
            <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s2">&quot;electrode_id&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">electrode_list</span><span class="p">:</span>
                <span class="n">lfpelectdict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">primary_key</span>
                <span class="p">}</span>
                <span class="n">LFPSelection</span><span class="p">()</span><span class="o">.</span><span class="n">LFPElectrode</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
                    <span class="n">lfpelectdict</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.common.common_ephys.Probe" class="doc doc-heading">
        <code>Probe</code>


<a href="#src.spyglass.common.common_ephys.Probe" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Manual">Manual</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/common/common_device.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">Probe</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # A configuration of a ProbeType. For most probe types, there is only one configuration, and that configuration</span>
<span class="s2">    # should always be used. For Neuropixels probes, the specific channel map (which electrodes are used,</span>
<span class="s2">    # where are they, and in what order) can differ between users and sessions, and each configuration should have a</span>
<span class="s2">    # different ProbeType.</span>
<span class="s2">    probe_id: varchar(80)     # a unique ID for this probe and dynamic configuration</span>
<span class="s2">    ---</span>
<span class="s2">    -&gt; ProbeType              # the type of probe, selected from a controlled list of probe types</span>
<span class="s2">    -&gt; [nullable] DataAcquisitionDevice  # the data acquisition device used with this Probe</span>
<span class="s2">    contact_side_numbering: enum(&quot;True&quot;, &quot;False&quot;)  # if True, then electrode contacts are facing you when numbering them</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Shank</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        -&gt; Probe</span>
<span class="s2">        probe_shank: int              # shank number within probe. should be unique within a Probe</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Electrode</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        -&gt; Probe.Shank</span>
<span class="s2">        probe_electrode: int          # electrode ID that is output from the data acquisition system</span>
<span class="s2">                                      # probe_electrode should be unique within a Probe</span>
<span class="s2">        ---</span>
<span class="s2">        contact_size = NULL: float    # (um) contact size</span>
<span class="s2">        rel_x = NULL: float           # (um) x coordinate of the electrode within the probe</span>
<span class="s2">        rel_y = NULL: float           # (um) y coordinate of the electrode within the probe</span>
<span class="s2">        rel_z = NULL: float           # (um) z coordinate of the electrode within the probe</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">insert_from_nwbfile</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Insert probe devices from an NWB file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nwbf : pynwb.NWBFile</span>
<span class="sd">            The source NWB file object.</span>
<span class="sd">        config : dict</span>
<span class="sd">            Dictionary read from a user-defined YAML file containing values to replace in the NWB file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        device_name_list : list</span>
<span class="sd">            List of probe device types found in the NWB file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_probes_types</span><span class="p">,</span> <span class="n">ndx_probes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_all_probe_names</span><span class="p">(</span><span class="n">nwbf</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">probe_type</span> <span class="ow">in</span> <span class="n">all_probes_types</span><span class="p">:</span>
            <span class="n">new_probe_type_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">new_probe_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">shank_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">elect_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">num_shanks</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">probe_type</span> <span class="ow">in</span> <span class="n">ndx_probes</span><span class="p">:</span>
                <span class="c1"># read probe properties into new_probe_dict from PyNWB extension probe object</span>
                <span class="n">nwb_probe_obj</span> <span class="o">=</span> <span class="n">ndx_probes</span><span class="p">[</span><span class="n">probe_type</span><span class="p">]</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">__read_ndx_probe_data</span><span class="p">(</span>
                    <span class="n">nwb_probe_obj</span><span class="p">,</span>
                    <span class="n">new_probe_type_dict</span><span class="p">,</span>
                    <span class="n">new_probe_dict</span><span class="p">,</span>
                    <span class="n">shank_dict</span><span class="p">,</span>
                    <span class="n">elect_dict</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># check that number of shanks is consistent</span>
            <span class="n">num_shanks</span> <span class="o">=</span> <span class="n">new_probe_type_dict</span><span class="p">[</span><span class="s2">&quot;num_shanks&quot;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">num_shanks</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">num_shanks</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">shank_dict</span>
            <span class="p">),</span> <span class="s2">&quot;`num_shanks` is not equal to the number of shanks.&quot;</span>

            <span class="c1"># if probe id already exists, do not overwrite anything or create new Shanks and Electrodes</span>
            <span class="c1"># TODO test whether the Shanks and Electrodes in the NWB file match the ones in the database</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">Probe</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;probe_id&quot;</span><span class="p">:</span> <span class="n">new_probe_dict</span><span class="p">[</span><span class="s2">&quot;probe_id&quot;</span><span class="p">]}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Probe ID &#39;</span><span class="si">{</span><span class="n">new_probe_dict</span><span class="p">[</span><span class="s1">&#39;probe_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; already exists in the database. Spyglass will use &quot;</span>
                    <span class="s2">&quot;that and not create a new Probe, Shanks, or Electrodes.&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="bp">cls</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">new_probe_dict</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">shank</span> <span class="ow">in</span> <span class="n">shank_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">Shank</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">shank</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">electrode</span> <span class="ow">in</span> <span class="n">elect_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">Electrode</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">electrode</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">all_probes_types</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inserted probes </span><span class="si">{</span><span class="n">all_probes_types</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No conforming probe metadata found.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_probes_types</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_all_probe_names</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list of all device names in the NWB file, after appending and overwriting by the config file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nwbf : pynwb.NWBFile</span>
<span class="sd">            The source NWB file object.</span>
<span class="sd">        config : dict</span>
<span class="sd">            Dictionary read from a user-defined YAML file containing values to replace in the NWB file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        device_name_list : list</span>
<span class="sd">            List of data acquisition object names found in the NWB file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># make a dict mapping probe type to PyNWB object for all devices in the NWB file that are</span>
        <span class="c1"># of type ndx_franklab_novela.Probe and thus have the required metadata</span>
        <span class="n">ndx_probes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">device_obj</span><span class="o">.</span><span class="n">probe_type</span><span class="p">:</span> <span class="n">device_obj</span>
            <span class="k">for</span> <span class="n">device_obj</span> <span class="ow">in</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device_obj</span><span class="p">,</span> <span class="n">ndx_franklab_novela</span><span class="o">.</span><span class="n">Probe</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># make a dict mapping probe type to dict of device metadata from the config YAML if exists</span>
        <span class="k">if</span> <span class="s2">&quot;Probe&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">config_probes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">probe_dict</span><span class="p">[</span><span class="s2">&quot;probe_type&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">probe_dict</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Probe&quot;</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config_probes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="c1"># get all the probe types from the NWB file plus the config YAML</span>
        <span class="n">all_probes_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ndx_probes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">config_probes</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">all_probes_types</span><span class="p">,</span> <span class="n">ndx_probes</span><span class="p">,</span> <span class="n">config_probes</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__read_ndx_probe_data</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">nwb_probe_obj</span><span class="p">:</span> <span class="n">ndx_franklab_novela</span><span class="o">.</span><span class="n">Probe</span><span class="p">,</span>
        <span class="n">new_probe_type_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">new_probe_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">shank_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">elect_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># construct dictionary of values to add to ProbeType</span>
        <span class="n">new_probe_type_dict</span><span class="p">[</span><span class="s2">&quot;manufacturer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">nwb_probe_obj</span><span class="p">,</span> <span class="s2">&quot;manufacturer&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">new_probe_type_dict</span><span class="p">[</span><span class="s2">&quot;probe_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_probe_obj</span><span class="o">.</span><span class="n">probe_type</span>
        <span class="n">new_probe_type_dict</span><span class="p">[</span>
            <span class="s2">&quot;probe_description&quot;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">nwb_probe_obj</span><span class="o">.</span><span class="n">probe_description</span>
        <span class="n">new_probe_type_dict</span><span class="p">[</span><span class="s2">&quot;num_shanks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nwb_probe_obj</span><span class="o">.</span><span class="n">shanks</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">_add_probe_type</span><span class="p">(</span><span class="n">new_probe_type_dict</span><span class="p">)</span>

        <span class="n">new_probe_dict</span><span class="p">[</span><span class="s2">&quot;probe_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_probe_obj</span><span class="o">.</span><span class="n">probe_type</span>
        <span class="n">new_probe_dict</span><span class="p">[</span><span class="s2">&quot;probe_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_probe_obj</span><span class="o">.</span><span class="n">probe_type</span>
        <span class="n">new_probe_dict</span><span class="p">[</span><span class="s2">&quot;contact_side_numbering&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;True&quot;</span> <span class="k">if</span> <span class="n">nwb_probe_obj</span><span class="o">.</span><span class="n">contact_side_numbering</span> <span class="k">else</span> <span class="s2">&quot;False&quot;</span>
        <span class="p">)</span>

        <span class="c1"># go through the shanks and add each one to the Shank table</span>
        <span class="k">for</span> <span class="n">shank</span> <span class="ow">in</span> <span class="n">nwb_probe_obj</span><span class="o">.</span><span class="n">shanks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">shank_dict</span><span class="p">[</span><span class="n">shank</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">shank_dict</span><span class="p">[</span><span class="n">shank</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;probe_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_probe_dict</span><span class="p">[</span><span class="s2">&quot;probe_type&quot;</span><span class="p">]</span>
            <span class="n">shank_dict</span><span class="p">[</span><span class="n">shank</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;probe_shank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">shank</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># go through the electrodes and add each one to the Electrode table</span>
            <span class="k">for</span> <span class="n">electrode</span> <span class="ow">in</span> <span class="n">shank</span><span class="o">.</span><span class="n">shanks_electrodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="c1"># the next line will need to be fixed if we have different sized contacts on a shank</span>
                <span class="n">elect_dict</span><span class="p">[</span><span class="n">electrode</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">elect_dict</span><span class="p">[</span><span class="n">electrode</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;probe_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_probe_dict</span><span class="p">[</span>
                    <span class="s2">&quot;probe_type&quot;</span>
                <span class="p">]</span>
                <span class="n">elect_dict</span><span class="p">[</span><span class="n">electrode</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;probe_shank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shank_dict</span><span class="p">[</span>
                    <span class="n">shank</span><span class="o">.</span><span class="n">name</span>
                <span class="p">][</span><span class="s2">&quot;probe_shank&quot;</span><span class="p">]</span>
                <span class="n">elect_dict</span><span class="p">[</span><span class="n">electrode</span><span class="o">.</span><span class="n">name</span><span class="p">][</span>
                    <span class="s2">&quot;contact_size&quot;</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">nwb_probe_obj</span><span class="o">.</span><span class="n">contact_size</span>
                <span class="n">elect_dict</span><span class="p">[</span><span class="n">electrode</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;probe_electrode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="n">electrode</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
                <span class="n">elect_dict</span><span class="p">[</span><span class="n">electrode</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;rel_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">electrode</span><span class="o">.</span><span class="n">rel_x</span>
                <span class="n">elect_dict</span><span class="p">[</span><span class="n">electrode</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;rel_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">electrode</span><span class="o">.</span><span class="n">rel_y</span>
                <span class="n">elect_dict</span><span class="p">[</span><span class="n">electrode</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;rel_z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">electrode</span><span class="o">.</span><span class="n">rel_z</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_add_probe_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">new_probe_type_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check the probe type value against the values in the database.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_probe_type_dict : dict</span>
<span class="sd">            Dictionary of probe type properties. See ProbeType for keys.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        PopulateException</span>
<span class="sd">            If user chooses not to add a probe type to the database when prompted.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        probe_type : str</span>
<span class="sd">            The probe type value that was added to the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">probe_type</span> <span class="o">=</span> <span class="n">new_probe_type_dict</span><span class="p">[</span><span class="s2">&quot;probe_type&quot;</span><span class="p">]</span>
        <span class="n">all_values</span> <span class="o">=</span> <span class="n">ProbeType</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;probe_type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">probe_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_values</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Probe type &#39;</span><span class="si">{</span><span class="n">probe_type</span><span class="si">}</span><span class="s2">&#39; was not found in the database. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;The current values are: </span><span class="si">{</span><span class="n">all_values</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;Please ensure that the probe type you want to add does not already &quot;</span>
                <span class="s2">&quot;exist in the database under a different name or spelling. &quot;</span>
                <span class="s2">&quot;If you want to use an existing name in the database, &quot;</span>
                <span class="s2">&quot;please change the corresponding Probe object in the NWB file. &quot;</span>
                <span class="s2">&quot;Entering &#39;N&#39; will raise an exception.&quot;</span>
            <span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Do you want to add probe type &#39;</span><span class="si">{</span><span class="n">probe_type</span><span class="si">}</span><span class="s2">&#39; to the database? (y/N)&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">]:</span>
                <span class="n">ProbeType</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">new_probe_type_dict</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">raise</span> <span class="n">PopulateException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;User chose not to add probe type &#39;</span><span class="si">{</span><span class="n">probe_type</span><span class="si">}</span><span class="s2">&#39; to the database.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># effectively else (entry exists)</span>
        <span class="c1"># check whether the values provided match the values stored in the database</span>
        <span class="n">db_dict</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProbeType</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;probe_type&quot;</span><span class="p">:</span> <span class="n">probe_type</span><span class="p">})</span><span class="o">.</span><span class="n">fetch1</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">db_dict</span> <span class="o">!=</span> <span class="n">new_probe_type_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PopulateException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Probe type properties of PyNWB Probe object with name &#39;</span><span class="si">{</span><span class="n">probe_type</span><span class="si">}</span><span class="s2">&#39;: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_probe_type_dict</span><span class="si">}</span><span class="s2"> do not match properties of the corresponding database entry: </span><span class="si">{</span><span class="n">db_dict</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">probe_type</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_from_nwbfile</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">nwb_file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">nwb_device_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">probe_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">probe_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">contact_side_numbering</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a Probe entry and corresponding part table entries using the data in the NWB file.</span>

<span class="sd">        This method will parse the electrodes in the electrodes table, electrode groups (as shanks), and devices</span>
<span class="sd">        (as probes) in the NWB file, but only ones that are associated with the device that matches the given</span>
<span class="sd">        `nwb_device_name`.</span>

<span class="sd">        Note that this code assumes the relatively standard convention where the NWB device corresponds to a Probe,</span>
<span class="sd">        the NWB electrode group corresponds to a Shank, and the NWB electrode corresponds to an Electrode.</span>

<span class="sd">        Example usage:</span>
<span class="sd">        ```</span>
<span class="sd">        sgc.Probe.create_from_nwbfile(</span>
<span class="sd">            nwbfile=nwb_file_name,</span>
<span class="sd">            nwb_device_name=&quot;Device&quot;,</span>
<span class="sd">            probe_id=&quot;Neuropixels 1.0 Giocomo Lab Configuration&quot;,</span>
<span class="sd">            probe_type=&quot;Neuropixels 1.0&quot;,</span>
<span class="sd">            contact_side_numbering=True</span>
<span class="sd">        )</span>
<span class="sd">        ```</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nwb_file_name : str</span>
<span class="sd">            The name of the NWB file.</span>
<span class="sd">        nwb_device_name : str</span>
<span class="sd">            The name of the PyNWB Device object that represents the probe to read in the NWB file.</span>
<span class="sd">        probe_id : str</span>
<span class="sd">            A unique ID for the probe and its configuration, to be used as the primary key for the new Probe entry.</span>
<span class="sd">        probe_type : str</span>
<span class="sd">            The existing ProbeType entry that represents the type of probe being created. It must exist.</span>
<span class="sd">        contact_side_numbering : bool</span>
<span class="sd">            Whether the electrode contacts are facing you when numbering them. Stored in the new Probe entry.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.common_nwbfile</span> <span class="kn">import</span> <span class="n">Nwbfile</span>

        <span class="n">nwb_file_path</span> <span class="o">=</span> <span class="n">Nwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
        <span class="n">nwbfile</span> <span class="o">=</span> <span class="n">get_nwb_file</span><span class="p">(</span><span class="n">nwb_file_path</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">ProbeType</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;probe_type&quot;</span><span class="p">:</span> <span class="n">probe_type</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No ProbeType found with probe_type &#39;</span><span class="si">{</span><span class="n">probe_type</span><span class="si">}</span><span class="s2">&#39;. Aborting.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">new_probe_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">shank_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">elect_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">new_probe_dict</span><span class="p">[</span><span class="s2">&quot;probe_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_id</span>
        <span class="n">new_probe_dict</span><span class="p">[</span><span class="s2">&quot;probe_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_type</span>
        <span class="n">new_probe_dict</span><span class="p">[</span><span class="s2">&quot;contact_side_numbering&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;True&quot;</span> <span class="k">if</span> <span class="n">contact_side_numbering</span> <span class="k">else</span> <span class="s2">&quot;False&quot;</span>
        <span class="p">)</span>

        <span class="c1"># iterate through the electrodes table in the NWB file</span>
        <span class="c1"># and use the group column (ElectrodeGroup) to create shanks</span>
        <span class="c1"># and use the device attribute of each ElectrodeGroup to create a probe</span>
        <span class="n">created_shanks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># map device name to shank_index (int)</span>
        <span class="n">device_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">elec_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nwbfile</span><span class="o">.</span><span class="n">electrodes</span><span class="p">)):</span>
            <span class="n">electrode_group</span> <span class="o">=</span> <span class="n">nwbfile</span><span class="o">.</span><span class="n">electrodes</span><span class="p">[</span><span class="n">elec_index</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">]</span>
            <span class="n">eg_device_name</span> <span class="o">=</span> <span class="n">electrode_group</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">name</span>

            <span class="c1"># only look at electrodes where the associated device is the one specified</span>
            <span class="k">if</span> <span class="n">eg_device_name</span> <span class="o">==</span> <span class="n">nwb_device_name</span><span class="p">:</span>
                <span class="n">device_found</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># if a Shank has not yet been created from the electrode group, then create it</span>
                <span class="k">if</span> <span class="n">electrode_group</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">created_shanks</span><span class="p">:</span>
                    <span class="n">shank_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">created_shanks</span><span class="p">)</span>
                    <span class="n">created_shanks</span><span class="p">[</span><span class="n">electrode_group</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">shank_index</span>

                    <span class="c1"># build the dictionary of Probe.Shank data</span>
                    <span class="n">shank_dict</span><span class="p">[</span><span class="n">shank_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">shank_dict</span><span class="p">[</span><span class="n">shank_index</span><span class="p">][</span><span class="s2">&quot;probe_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_probe_dict</span><span class="p">[</span>
                        <span class="s2">&quot;probe_id&quot;</span>
                    <span class="p">]</span>
                    <span class="n">shank_dict</span><span class="p">[</span><span class="n">shank_index</span><span class="p">][</span><span class="s2">&quot;probe_shank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shank_index</span>

                <span class="c1"># get the probe shank index associated with this Electrode</span>
                <span class="n">probe_shank</span> <span class="o">=</span> <span class="n">created_shanks</span><span class="p">[</span><span class="n">electrode_group</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

                <span class="c1"># build the dictionary of Probe.Electrode data</span>
                <span class="n">elect_dict</span><span class="p">[</span><span class="n">elec_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">elect_dict</span><span class="p">[</span><span class="n">elec_index</span><span class="p">][</span><span class="s2">&quot;probe_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_probe_dict</span><span class="p">[</span><span class="s2">&quot;probe_id&quot;</span><span class="p">]</span>
                <span class="n">elect_dict</span><span class="p">[</span><span class="n">elec_index</span><span class="p">][</span><span class="s2">&quot;probe_shank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_shank</span>
                <span class="n">elect_dict</span><span class="p">[</span><span class="n">elec_index</span><span class="p">][</span><span class="s2">&quot;probe_electrode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elec_index</span>
                <span class="k">if</span> <span class="s2">&quot;rel_x&quot;</span> <span class="ow">in</span> <span class="n">nwbfile</span><span class="o">.</span><span class="n">electrodes</span><span class="p">[</span><span class="n">elec_index</span><span class="p">]:</span>
                    <span class="n">elect_dict</span><span class="p">[</span><span class="n">elec_index</span><span class="p">][</span><span class="s2">&quot;rel_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwbfile</span><span class="o">.</span><span class="n">electrodes</span><span class="p">[</span>
                        <span class="n">elec_index</span><span class="p">,</span> <span class="s2">&quot;rel_x&quot;</span>
                    <span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;rel_y&quot;</span> <span class="ow">in</span> <span class="n">nwbfile</span><span class="o">.</span><span class="n">electrodes</span><span class="p">[</span><span class="n">elec_index</span><span class="p">]:</span>
                    <span class="n">elect_dict</span><span class="p">[</span><span class="n">elec_index</span><span class="p">][</span><span class="s2">&quot;rel_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwbfile</span><span class="o">.</span><span class="n">electrodes</span><span class="p">[</span>
                        <span class="n">elec_index</span><span class="p">,</span> <span class="s2">&quot;rel_y&quot;</span>
                    <span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;rel_z&quot;</span> <span class="ow">in</span> <span class="n">nwbfile</span><span class="o">.</span><span class="n">electrodes</span><span class="p">[</span><span class="n">elec_index</span><span class="p">]:</span>
                    <span class="n">elect_dict</span><span class="p">[</span><span class="n">elec_index</span><span class="p">][</span><span class="s2">&quot;rel_z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwbfile</span><span class="o">.</span><span class="n">electrodes</span><span class="p">[</span>
                        <span class="n">elec_index</span><span class="p">,</span> <span class="s2">&quot;rel_z&quot;</span>
                    <span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">device_found</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No electrodes in the NWB file were associated with a device named &#39;</span><span class="si">{</span><span class="n">nwb_device_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># insert the Probe, then the Shank parts, and then the Electrode parts</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">new_probe_dict</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">shank</span> <span class="ow">in</span> <span class="n">shank_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">Shank</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">shank</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">electrode</span> <span class="ow">in</span> <span class="n">elect_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">Electrode</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">electrode</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_device.Probe.insert_from_nwbfile" class="doc doc-heading">
<code class="highlight language-python"><span class="n">insert_from_nwbfile</span><span class="p">(</span><span class="n">nwbf</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_device.Probe.insert_from_nwbfile" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Insert probe devices from an NWB file.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwbf</code></td>
          <td>
                <code>pynwb.<span title="pynwb.NWBFile">NWBFile</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The source NWB file object.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>config</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary read from a user-defined YAML file containing values to replace in the NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>device_name_list</code></td>          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of probe device types found in the NWB file.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_device.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">insert_from_nwbfile</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Insert probe devices from an NWB file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwbf : pynwb.NWBFile</span>
<span class="sd">        The source NWB file object.</span>
<span class="sd">    config : dict</span>
<span class="sd">        Dictionary read from a user-defined YAML file containing values to replace in the NWB file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    device_name_list : list</span>
<span class="sd">        List of probe device types found in the NWB file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_probes_types</span><span class="p">,</span> <span class="n">ndx_probes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_all_probe_names</span><span class="p">(</span><span class="n">nwbf</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">probe_type</span> <span class="ow">in</span> <span class="n">all_probes_types</span><span class="p">:</span>
        <span class="n">new_probe_type_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">new_probe_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">shank_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">elect_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">num_shanks</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">probe_type</span> <span class="ow">in</span> <span class="n">ndx_probes</span><span class="p">:</span>
            <span class="c1"># read probe properties into new_probe_dict from PyNWB extension probe object</span>
            <span class="n">nwb_probe_obj</span> <span class="o">=</span> <span class="n">ndx_probes</span><span class="p">[</span><span class="n">probe_type</span><span class="p">]</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">__read_ndx_probe_data</span><span class="p">(</span>
                <span class="n">nwb_probe_obj</span><span class="p">,</span>
                <span class="n">new_probe_type_dict</span><span class="p">,</span>
                <span class="n">new_probe_dict</span><span class="p">,</span>
                <span class="n">shank_dict</span><span class="p">,</span>
                <span class="n">elect_dict</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># check that number of shanks is consistent</span>
        <span class="n">num_shanks</span> <span class="o">=</span> <span class="n">new_probe_type_dict</span><span class="p">[</span><span class="s2">&quot;num_shanks&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">num_shanks</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">num_shanks</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">shank_dict</span>
        <span class="p">),</span> <span class="s2">&quot;`num_shanks` is not equal to the number of shanks.&quot;</span>

        <span class="c1"># if probe id already exists, do not overwrite anything or create new Shanks and Electrodes</span>
        <span class="c1"># TODO test whether the Shanks and Electrodes in the NWB file match the ones in the database</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Probe</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;probe_id&quot;</span><span class="p">:</span> <span class="n">new_probe_dict</span><span class="p">[</span><span class="s2">&quot;probe_id&quot;</span><span class="p">]}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Probe ID &#39;</span><span class="si">{</span><span class="n">new_probe_dict</span><span class="p">[</span><span class="s1">&#39;probe_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; already exists in the database. Spyglass will use &quot;</span>
                <span class="s2">&quot;that and not create a new Probe, Shanks, or Electrodes.&quot;</span>
            <span class="p">)</span>
            <span class="k">continue</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">new_probe_dict</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">shank</span> <span class="ow">in</span> <span class="n">shank_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">Shank</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">shank</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">electrode</span> <span class="ow">in</span> <span class="n">elect_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">Electrode</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">electrode</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">all_probes_types</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inserted probes </span><span class="si">{</span><span class="n">all_probes_types</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No conforming probe metadata found.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">all_probes_types</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_device.Probe.get_all_probe_names" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_all_probe_names</span><span class="p">(</span><span class="n">nwbf</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_device.Probe.get_all_probe_names" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Get a list of all device names in the NWB file, after appending and overwriting by the config file.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwbf</code></td>
          <td>
                <code>pynwb.<span title="pynwb.NWBFile">NWBFile</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The source NWB file object.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>config</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary read from a user-defined YAML file containing values to replace in the NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>device_name_list</code></td>          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of data acquisition object names found in the NWB file.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_device.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">get_all_probe_names</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a list of all device names in the NWB file, after appending and overwriting by the config file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwbf : pynwb.NWBFile</span>
<span class="sd">        The source NWB file object.</span>
<span class="sd">    config : dict</span>
<span class="sd">        Dictionary read from a user-defined YAML file containing values to replace in the NWB file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    device_name_list : list</span>
<span class="sd">        List of data acquisition object names found in the NWB file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># make a dict mapping probe type to PyNWB object for all devices in the NWB file that are</span>
    <span class="c1"># of type ndx_franklab_novela.Probe and thus have the required metadata</span>
    <span class="n">ndx_probes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">device_obj</span><span class="o">.</span><span class="n">probe_type</span><span class="p">:</span> <span class="n">device_obj</span>
        <span class="k">for</span> <span class="n">device_obj</span> <span class="ow">in</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device_obj</span><span class="p">,</span> <span class="n">ndx_franklab_novela</span><span class="o">.</span><span class="n">Probe</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># make a dict mapping probe type to dict of device metadata from the config YAML if exists</span>
    <span class="k">if</span> <span class="s2">&quot;Probe&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">config_probes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">probe_dict</span><span class="p">[</span><span class="s2">&quot;probe_type&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">probe_dict</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Probe&quot;</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">config_probes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="c1"># get all the probe types from the NWB file plus the config YAML</span>
    <span class="n">all_probes_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ndx_probes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">config_probes</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">all_probes_types</span><span class="p">,</span> <span class="n">ndx_probes</span><span class="p">,</span> <span class="n">config_probes</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_device.Probe.create_from_nwbfile" class="doc doc-heading">
<code class="highlight language-python"><span class="n">create_from_nwbfile</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">,</span> <span class="n">nwb_device_name</span><span class="p">,</span> <span class="n">probe_id</span><span class="p">,</span> <span class="n">probe_type</span><span class="p">,</span> <span class="n">contact_side_numbering</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_device.Probe.create_from_nwbfile" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Create a Probe entry and corresponding part table entries using the data in the NWB file.</p>
<p>This method will parse the electrodes in the electrodes table, electrode groups (as shanks), and devices
(as probes) in the NWB file, but only ones that are associated with the device that matches the given
<code>nwb_device_name</code>.</p>
<p>Note that this code assumes the relatively standard convention where the NWB device corresponds to a Probe,
the NWB electrode group corresponds to a Shank, and the NWB electrode corresponds to an Electrode.</p>
<p>Example usage:</p>
<pre><code>sgc.Probe.create_from_nwbfile(
    nwbfile=nwb_file_name,
    nwb_device_name=&quot;Device&quot;,
    probe_id=&quot;Neuropixels 1.0 Giocomo Lab Configuration&quot;,
    probe_type=&quot;Neuropixels 1.0&quot;,
    contact_side_numbering=True
)
</code></pre>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nwb_device_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the PyNWB Device object that represents the probe to read in the NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>probe_id</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A unique ID for the probe and its configuration, to be used as the primary key for the new Probe entry.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>probe_type</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The existing ProbeType entry that represents the type of probe being created. It must exist.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>contact_side_numbering</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Whether the electrode contacts are facing you when numbering them. Stored in the new Probe entry.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_device.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">create_from_nwbfile</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">nwb_file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">nwb_device_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">probe_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">probe_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">contact_side_numbering</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a Probe entry and corresponding part table entries using the data in the NWB file.</span>

<span class="sd">    This method will parse the electrodes in the electrodes table, electrode groups (as shanks), and devices</span>
<span class="sd">    (as probes) in the NWB file, but only ones that are associated with the device that matches the given</span>
<span class="sd">    `nwb_device_name`.</span>

<span class="sd">    Note that this code assumes the relatively standard convention where the NWB device corresponds to a Probe,</span>
<span class="sd">    the NWB electrode group corresponds to a Shank, and the NWB electrode corresponds to an Electrode.</span>

<span class="sd">    Example usage:</span>
<span class="sd">    ```</span>
<span class="sd">    sgc.Probe.create_from_nwbfile(</span>
<span class="sd">        nwbfile=nwb_file_name,</span>
<span class="sd">        nwb_device_name=&quot;Device&quot;,</span>
<span class="sd">        probe_id=&quot;Neuropixels 1.0 Giocomo Lab Configuration&quot;,</span>
<span class="sd">        probe_type=&quot;Neuropixels 1.0&quot;,</span>
<span class="sd">        contact_side_numbering=True</span>
<span class="sd">    )</span>
<span class="sd">    ```</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwb_file_name : str</span>
<span class="sd">        The name of the NWB file.</span>
<span class="sd">    nwb_device_name : str</span>
<span class="sd">        The name of the PyNWB Device object that represents the probe to read in the NWB file.</span>
<span class="sd">    probe_id : str</span>
<span class="sd">        A unique ID for the probe and its configuration, to be used as the primary key for the new Probe entry.</span>
<span class="sd">    probe_type : str</span>
<span class="sd">        The existing ProbeType entry that represents the type of probe being created. It must exist.</span>
<span class="sd">    contact_side_numbering : bool</span>
<span class="sd">        Whether the electrode contacts are facing you when numbering them. Stored in the new Probe entry.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">.common_nwbfile</span> <span class="kn">import</span> <span class="n">Nwbfile</span>

    <span class="n">nwb_file_path</span> <span class="o">=</span> <span class="n">Nwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
    <span class="n">nwbfile</span> <span class="o">=</span> <span class="n">get_nwb_file</span><span class="p">(</span><span class="n">nwb_file_path</span><span class="p">)</span>

    <span class="n">query</span> <span class="o">=</span> <span class="n">ProbeType</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;probe_type&quot;</span><span class="p">:</span> <span class="n">probe_type</span><span class="p">}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No ProbeType found with probe_type &#39;</span><span class="si">{</span><span class="n">probe_type</span><span class="si">}</span><span class="s2">&#39;. Aborting.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span>

    <span class="n">new_probe_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">shank_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">elect_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="n">new_probe_dict</span><span class="p">[</span><span class="s2">&quot;probe_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_id</span>
    <span class="n">new_probe_dict</span><span class="p">[</span><span class="s2">&quot;probe_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_type</span>
    <span class="n">new_probe_dict</span><span class="p">[</span><span class="s2">&quot;contact_side_numbering&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;True&quot;</span> <span class="k">if</span> <span class="n">contact_side_numbering</span> <span class="k">else</span> <span class="s2">&quot;False&quot;</span>
    <span class="p">)</span>

    <span class="c1"># iterate through the electrodes table in the NWB file</span>
    <span class="c1"># and use the group column (ElectrodeGroup) to create shanks</span>
    <span class="c1"># and use the device attribute of each ElectrodeGroup to create a probe</span>
    <span class="n">created_shanks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># map device name to shank_index (int)</span>
    <span class="n">device_found</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">elec_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nwbfile</span><span class="o">.</span><span class="n">electrodes</span><span class="p">)):</span>
        <span class="n">electrode_group</span> <span class="o">=</span> <span class="n">nwbfile</span><span class="o">.</span><span class="n">electrodes</span><span class="p">[</span><span class="n">elec_index</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">]</span>
        <span class="n">eg_device_name</span> <span class="o">=</span> <span class="n">electrode_group</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># only look at electrodes where the associated device is the one specified</span>
        <span class="k">if</span> <span class="n">eg_device_name</span> <span class="o">==</span> <span class="n">nwb_device_name</span><span class="p">:</span>
            <span class="n">device_found</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># if a Shank has not yet been created from the electrode group, then create it</span>
            <span class="k">if</span> <span class="n">electrode_group</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">created_shanks</span><span class="p">:</span>
                <span class="n">shank_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">created_shanks</span><span class="p">)</span>
                <span class="n">created_shanks</span><span class="p">[</span><span class="n">electrode_group</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">shank_index</span>

                <span class="c1"># build the dictionary of Probe.Shank data</span>
                <span class="n">shank_dict</span><span class="p">[</span><span class="n">shank_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">shank_dict</span><span class="p">[</span><span class="n">shank_index</span><span class="p">][</span><span class="s2">&quot;probe_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_probe_dict</span><span class="p">[</span>
                    <span class="s2">&quot;probe_id&quot;</span>
                <span class="p">]</span>
                <span class="n">shank_dict</span><span class="p">[</span><span class="n">shank_index</span><span class="p">][</span><span class="s2">&quot;probe_shank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shank_index</span>

            <span class="c1"># get the probe shank index associated with this Electrode</span>
            <span class="n">probe_shank</span> <span class="o">=</span> <span class="n">created_shanks</span><span class="p">[</span><span class="n">electrode_group</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

            <span class="c1"># build the dictionary of Probe.Electrode data</span>
            <span class="n">elect_dict</span><span class="p">[</span><span class="n">elec_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">elect_dict</span><span class="p">[</span><span class="n">elec_index</span><span class="p">][</span><span class="s2">&quot;probe_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_probe_dict</span><span class="p">[</span><span class="s2">&quot;probe_id&quot;</span><span class="p">]</span>
            <span class="n">elect_dict</span><span class="p">[</span><span class="n">elec_index</span><span class="p">][</span><span class="s2">&quot;probe_shank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_shank</span>
            <span class="n">elect_dict</span><span class="p">[</span><span class="n">elec_index</span><span class="p">][</span><span class="s2">&quot;probe_electrode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elec_index</span>
            <span class="k">if</span> <span class="s2">&quot;rel_x&quot;</span> <span class="ow">in</span> <span class="n">nwbfile</span><span class="o">.</span><span class="n">electrodes</span><span class="p">[</span><span class="n">elec_index</span><span class="p">]:</span>
                <span class="n">elect_dict</span><span class="p">[</span><span class="n">elec_index</span><span class="p">][</span><span class="s2">&quot;rel_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwbfile</span><span class="o">.</span><span class="n">electrodes</span><span class="p">[</span>
                    <span class="n">elec_index</span><span class="p">,</span> <span class="s2">&quot;rel_x&quot;</span>
                <span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;rel_y&quot;</span> <span class="ow">in</span> <span class="n">nwbfile</span><span class="o">.</span><span class="n">electrodes</span><span class="p">[</span><span class="n">elec_index</span><span class="p">]:</span>
                <span class="n">elect_dict</span><span class="p">[</span><span class="n">elec_index</span><span class="p">][</span><span class="s2">&quot;rel_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwbfile</span><span class="o">.</span><span class="n">electrodes</span><span class="p">[</span>
                    <span class="n">elec_index</span><span class="p">,</span> <span class="s2">&quot;rel_y&quot;</span>
                <span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;rel_z&quot;</span> <span class="ow">in</span> <span class="n">nwbfile</span><span class="o">.</span><span class="n">electrodes</span><span class="p">[</span><span class="n">elec_index</span><span class="p">]:</span>
                <span class="n">elect_dict</span><span class="p">[</span><span class="n">elec_index</span><span class="p">][</span><span class="s2">&quot;rel_z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwbfile</span><span class="o">.</span><span class="n">electrodes</span><span class="p">[</span>
                    <span class="n">elec_index</span><span class="p">,</span> <span class="s2">&quot;rel_z&quot;</span>
                <span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">device_found</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No electrodes in the NWB file were associated with a device named &#39;</span><span class="si">{</span><span class="n">nwb_device_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># insert the Probe, then the Shank parts, and then the Electrode parts</span>
    <span class="bp">cls</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">new_probe_dict</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">shank</span> <span class="ow">in</span> <span class="n">shank_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">Shank</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">shank</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">electrode</span> <span class="ow">in</span> <span class="n">elect_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">Electrode</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">electrode</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-function">



<h2 id="src.spyglass.common.common_ephys.interval_list_censor" class="doc doc-heading">
<code class="highlight language-python"><span class="n">interval_list_censor</span><span class="p">(</span><span class="n">interval_list</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_ephys.interval_list_censor" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>returns a new interval list that starts and ends at the first and last timestamp</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>interval_list</code></td>
          <td>
                <code>numpy array of intervals [start, stop]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>interval list from IntervalList valid times</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>timestamps</code></td>
          <td>
                <code>numpy array or list</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>interval_list (numpy array of intervals [start, stop])</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_interval.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">interval_list_censor</span><span class="p">(</span><span class="n">interval_list</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;returns a new interval list that starts and ends at the first and last timestamp</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    interval_list : numpy array of intervals [start, stop]</span>
<span class="sd">        interval list from IntervalList valid times</span>
<span class="sd">    timestamps : numpy array or list</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    interval_list (numpy array of intervals [start, stop])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># check that all timestamps are in the interval list</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">interval_list_contains_ind</span><span class="p">(</span><span class="n">interval_list</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
        <span class="n">timestamps</span>
    <span class="p">),</span> <span class="s2">&quot;interval_list must contain all timestamps&quot;</span>

    <span class="n">timestamps_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="n">timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">timestamps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]])</span>
    <span class="k">return</span> <span class="n">interval_list_intersect</span><span class="p">(</span><span class="n">interval_list</span><span class="p">,</span> <span class="n">timestamps_interval</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.common.common_ephys.LFPBandSelection" class="doc doc-heading">
        <code>LFPBandSelection</code>


<a href="#src.spyglass.common.common_ephys.LFPBandSelection" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Manual">Manual</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/common/common_ephys.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">LFPBandSelection</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; LFP</span>
<span class="s2">    -&gt; FirFilterParameters                   # the filter to use for the data</span>
<span class="s2">    -&gt; IntervalList.proj(target_interval_list_name=&#39;interval_list_name&#39;)  # the original set of times to be filtered</span>
<span class="s2">    lfp_band_sampling_rate: int    # the sampling rate for this band</span>
<span class="s2">    ---</span>
<span class="s2">    min_interval_len = 1: float  # the minimum length of a valid interval to filter</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">LFPBandElectrode</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        -&gt; LFPBandSelection</span>
<span class="s2">        -&gt; LFPSelection.LFPElectrode  # the LFP electrode to be filtered</span>
<span class="s2">        reference_elect_id = -1: int  # the reference electrode to use; -1 for no reference</span>
<span class="s2">        ---</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">set_lfp_band_electrodes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">nwb_file_name</span><span class="p">,</span>
        <span class="n">electrode_list</span><span class="p">,</span>
        <span class="n">filter_name</span><span class="p">,</span>
        <span class="n">interval_list_name</span><span class="p">,</span>
        <span class="n">reference_electrode_list</span><span class="p">,</span>
        <span class="n">lfp_band_sampling_rate</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds an entry for each electrode in the electrode_list with the specified filter, interval_list, and</span>
<span class="sd">        reference electrode.</span>
<span class="sd">        Also removes any entries that have the same filter, interval list and reference electrode but are not</span>
<span class="sd">        in the electrode_list.</span>
<span class="sd">        :param nwb_file_name: string - the name of the nwb file for the desired session</span>
<span class="sd">        :param electrode_list: list of LFP electrodes to be filtered</span>
<span class="sd">        :param filter_name: the name of the filter (from the FirFilterParameters schema)</span>
<span class="sd">        :param interval_name: the name of the interval list (from the IntervalList schema)</span>
<span class="sd">        :param reference_electrode_list: A single electrode id corresponding to the reference to use for all</span>
<span class="sd">        electrodes or a list with one element per entry in the electrode_list</span>
<span class="sd">        :param lfp_band_sampling_rate: The output sampling rate to be used for the filtered data; must be an</span>
<span class="sd">        integer divisor of the LFP sampling rate</span>
<span class="sd">        :return: none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Error checks on parameters</span>
        <span class="c1"># electrode_list</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">LFPSelection</span><span class="p">()</span><span class="o">.</span><span class="n">LFPElectrode</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">}</span>
        <span class="n">available_electrodes</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;electrode_id&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">electrode_list</span><span class="p">,</span> <span class="n">available_electrodes</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;All elements in electrode_list must be valid electrode_ids in the LFPSelection table&quot;</span>
            <span class="p">)</span>
        <span class="c1"># sampling rate</span>
        <span class="n">lfp_sampling_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">LFP</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">})</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;lfp_sampling_rate&quot;</span>
        <span class="p">)</span>
        <span class="n">decimation</span> <span class="o">=</span> <span class="n">lfp_sampling_rate</span> <span class="o">//</span> <span class="n">lfp_band_sampling_rate</span>
        <span class="k">if</span> <span class="n">lfp_sampling_rate</span> <span class="o">//</span> <span class="n">decimation</span> <span class="o">!=</span> <span class="n">lfp_band_sampling_rate</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;lfp_band_sampling rate </span><span class="si">{</span><span class="n">lfp_band_sampling_rate</span><span class="si">}</span><span class="s2"> is not an integer divisor of lfp &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;samping rate </span><span class="si">{</span><span class="n">lfp_sampling_rate</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># filter</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">FirFilterParameters</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">{</span>
            <span class="s2">&quot;filter_name&quot;</span><span class="p">:</span> <span class="n">filter_name</span><span class="p">,</span>
            <span class="s2">&quot;filter_sampling_rate&quot;</span><span class="p">:</span> <span class="n">lfp_sampling_rate</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;filter </span><span class="si">{</span><span class="n">filter_name</span><span class="si">}</span><span class="s2">, sampling rate </span><span class="si">{</span><span class="n">lfp_sampling_rate</span><span class="si">}</span><span class="s2"> is not in the FirFilterParameters table&quot;</span>
            <span class="p">)</span>
        <span class="c1"># interval_list</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">IntervalList</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">{</span>
            <span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">,</span>
            <span class="s2">&quot;interval_name&quot;</span><span class="p">:</span> <span class="n">interval_list_name</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;interval list </span><span class="si">{</span><span class="n">interval_list_name</span><span class="si">}</span><span class="s2"> is not in the IntervalList table; the list must be &quot;</span>
                <span class="s2">&quot;added before this function is called&quot;</span>
            <span class="p">)</span>
        <span class="c1"># reference_electrode_list</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reference_electrode_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">reference_electrode_list</span>
        <span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">electrode_list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;reference_electrode_list must contain either 1 or len(electrode_list) elements&quot;</span>
            <span class="p">)</span>
        <span class="c1"># add a -1 element to the list to allow for the no reference option</span>
        <span class="n">available_electrodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">available_electrodes</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">reference_electrode_list</span><span class="p">,</span> <span class="n">available_electrodes</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;All elements in reference_electrode_list must be valid electrode_ids in the LFPSelection &quot;</span>
                <span class="s2">&quot;table&quot;</span>
            <span class="p">)</span>

        <span class="c1"># make a list of all the references</span>
        <span class="n">ref_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">electrode_list</span><span class="p">),))</span>
        <span class="n">ref_list</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">reference_electrode_list</span>

        <span class="n">key</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_file_name</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;filter_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_name</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;filter_sampling_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lfp_sampling_rate</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;target_interval_list_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interval_list_name</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;lfp_band_sampling_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lfp_sampling_rate</span> <span class="o">//</span> <span class="n">decimation</span>
        <span class="c1"># insert an entry into the main LFPBandSelectionTable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># get all of the current entries and delete any that are not in the list</span>
        <span class="n">elect_id</span><span class="p">,</span> <span class="n">ref_id</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LFPBandElectrode</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
            <span class="s2">&quot;electrode_id&quot;</span><span class="p">,</span> <span class="s2">&quot;reference_elect_id&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">elect_id</span><span class="p">,</span> <span class="n">ref_id</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">electrode_list</span> <span class="o">==</span> <span class="n">e</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ref_list</span> <span class="o">==</span> <span class="n">r</span><span class="p">))[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;electrode_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;reference_elect_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LFPBandElectrode</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="c1"># iterate through all of the new elements and add them</span>
        <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">electrode_list</span><span class="p">,</span> <span class="n">ref_list</span><span class="p">):</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;electrode_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">Electrode</span> <span class="o">&amp;</span> <span class="p">{</span>
                <span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">,</span>
                <span class="s2">&quot;electrode_id&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;electrode_group_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;electrode_group_name&quot;</span><span class="p">)</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;reference_elect_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LFPBandElectrode</span><span class="p">()</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_ephys.LFPBandSelection.set_lfp_band_electrodes" class="doc doc-heading">
<code class="highlight language-python"><span class="n">set_lfp_band_electrodes</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">,</span> <span class="n">electrode_list</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">,</span> <span class="n">interval_list_name</span><span class="p">,</span> <span class="n">reference_electrode_list</span><span class="p">,</span> <span class="n">lfp_band_sampling_rate</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_ephys.LFPBandSelection.set_lfp_band_electrodes" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Adds an entry for each electrode in the electrode_list with the specified filter, interval_list, and
reference electrode.
Also removes any entries that have the same filter, interval list and reference electrode but are not
in the electrode_list.
:param nwb_file_name: string - the name of the nwb file for the desired session
:param electrode_list: list of LFP electrodes to be filtered
:param filter_name: the name of the filter (from the FirFilterParameters schema)
:param interval_name: the name of the interval list (from the IntervalList schema)
:param reference_electrode_list: A single electrode id corresponding to the reference to use for all
electrodes or a list with one element per entry in the electrode_list
:param lfp_band_sampling_rate: The output sampling rate to be used for the filtered data; must be an
integer divisor of the LFP sampling rate
:return: none</p>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_ephys.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">set_lfp_band_electrodes</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">nwb_file_name</span><span class="p">,</span>
    <span class="n">electrode_list</span><span class="p">,</span>
    <span class="n">filter_name</span><span class="p">,</span>
    <span class="n">interval_list_name</span><span class="p">,</span>
    <span class="n">reference_electrode_list</span><span class="p">,</span>
    <span class="n">lfp_band_sampling_rate</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds an entry for each electrode in the electrode_list with the specified filter, interval_list, and</span>
<span class="sd">    reference electrode.</span>
<span class="sd">    Also removes any entries that have the same filter, interval list and reference electrode but are not</span>
<span class="sd">    in the electrode_list.</span>
<span class="sd">    :param nwb_file_name: string - the name of the nwb file for the desired session</span>
<span class="sd">    :param electrode_list: list of LFP electrodes to be filtered</span>
<span class="sd">    :param filter_name: the name of the filter (from the FirFilterParameters schema)</span>
<span class="sd">    :param interval_name: the name of the interval list (from the IntervalList schema)</span>
<span class="sd">    :param reference_electrode_list: A single electrode id corresponding to the reference to use for all</span>
<span class="sd">    electrodes or a list with one element per entry in the electrode_list</span>
<span class="sd">    :param lfp_band_sampling_rate: The output sampling rate to be used for the filtered data; must be an</span>
<span class="sd">    integer divisor of the LFP sampling rate</span>
<span class="sd">    :return: none</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Error checks on parameters</span>
    <span class="c1"># electrode_list</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">LFPSelection</span><span class="p">()</span><span class="o">.</span><span class="n">LFPElectrode</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">}</span>
    <span class="n">available_electrodes</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;electrode_id&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">electrode_list</span><span class="p">,</span> <span class="n">available_electrodes</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;All elements in electrode_list must be valid electrode_ids in the LFPSelection table&quot;</span>
        <span class="p">)</span>
    <span class="c1"># sampling rate</span>
    <span class="n">lfp_sampling_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">LFP</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">})</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
        <span class="s2">&quot;lfp_sampling_rate&quot;</span>
    <span class="p">)</span>
    <span class="n">decimation</span> <span class="o">=</span> <span class="n">lfp_sampling_rate</span> <span class="o">//</span> <span class="n">lfp_band_sampling_rate</span>
    <span class="k">if</span> <span class="n">lfp_sampling_rate</span> <span class="o">//</span> <span class="n">decimation</span> <span class="o">!=</span> <span class="n">lfp_band_sampling_rate</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;lfp_band_sampling rate </span><span class="si">{</span><span class="n">lfp_band_sampling_rate</span><span class="si">}</span><span class="s2"> is not an integer divisor of lfp &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;samping rate </span><span class="si">{</span><span class="n">lfp_sampling_rate</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="c1"># filter</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">FirFilterParameters</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">{</span>
        <span class="s2">&quot;filter_name&quot;</span><span class="p">:</span> <span class="n">filter_name</span><span class="p">,</span>
        <span class="s2">&quot;filter_sampling_rate&quot;</span><span class="p">:</span> <span class="n">lfp_sampling_rate</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;filter </span><span class="si">{</span><span class="n">filter_name</span><span class="si">}</span><span class="s2">, sampling rate </span><span class="si">{</span><span class="n">lfp_sampling_rate</span><span class="si">}</span><span class="s2"> is not in the FirFilterParameters table&quot;</span>
        <span class="p">)</span>
    <span class="c1"># interval_list</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">IntervalList</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">{</span>
        <span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">,</span>
        <span class="s2">&quot;interval_name&quot;</span><span class="p">:</span> <span class="n">interval_list_name</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;interval list </span><span class="si">{</span><span class="n">interval_list_name</span><span class="si">}</span><span class="s2"> is not in the IntervalList table; the list must be &quot;</span>
            <span class="s2">&quot;added before this function is called&quot;</span>
        <span class="p">)</span>
    <span class="c1"># reference_electrode_list</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reference_electrode_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span>
        <span class="n">reference_electrode_list</span>
    <span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">electrode_list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;reference_electrode_list must contain either 1 or len(electrode_list) elements&quot;</span>
        <span class="p">)</span>
    <span class="c1"># add a -1 element to the list to allow for the no reference option</span>
    <span class="n">available_electrodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">available_electrodes</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">reference_electrode_list</span><span class="p">,</span> <span class="n">available_electrodes</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;All elements in reference_electrode_list must be valid electrode_ids in the LFPSelection &quot;</span>
            <span class="s2">&quot;table&quot;</span>
        <span class="p">)</span>

    <span class="c1"># make a list of all the references</span>
    <span class="n">ref_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">electrode_list</span><span class="p">),))</span>
    <span class="n">ref_list</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">reference_electrode_list</span>

    <span class="n">key</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_file_name</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;filter_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_name</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;filter_sampling_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lfp_sampling_rate</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;target_interval_list_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interval_list_name</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;lfp_band_sampling_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lfp_sampling_rate</span> <span class="o">//</span> <span class="n">decimation</span>
    <span class="c1"># insert an entry into the main LFPBandSelectionTable</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># get all of the current entries and delete any that are not in the list</span>
    <span class="n">elect_id</span><span class="p">,</span> <span class="n">ref_id</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LFPBandElectrode</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
        <span class="s2">&quot;electrode_id&quot;</span><span class="p">,</span> <span class="s2">&quot;reference_elect_id&quot;</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">elect_id</span><span class="p">,</span> <span class="n">ref_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">electrode_list</span> <span class="o">==</span> <span class="n">e</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ref_list</span> <span class="o">==</span> <span class="n">r</span><span class="p">))[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;electrode_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;reference_elect_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LFPBandElectrode</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="c1"># iterate through all of the new elements and add them</span>
    <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">electrode_list</span><span class="p">,</span> <span class="n">ref_list</span><span class="p">):</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;electrode_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Electrode</span> <span class="o">&amp;</span> <span class="p">{</span>
            <span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">,</span>
            <span class="s2">&quot;electrode_id&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;electrode_group_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;electrode_group_name&quot;</span><span class="p">)</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;reference_elect_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LFPBandElectrode</span><span class="p">()</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>




  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../common_dio/" class="md-footer__link md-footer__link--prev" aria-label="Previous: common_dio.py" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                common_dio.py
              </div>
            </div>
          </a>
        
        
          
          <a href="../common_filter/" class="md-footer__link md-footer__link--next" aria-label="Next: common_filter.py" rel="next">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                common_filter.py
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright (c) 2020-present Loren Frank
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/LorenFrankLab/spyglass" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/spyglass-neuro/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6zM286.2 404c11.1 0 20.1 9.1 20.1 20.3 0 11.3-9 20.4-20.1 20.4-11 0-20.1-9.2-20.1-20.4.1-11.3 9.1-20.3 20.1-20.3zM167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4zm-6.7-142.6c-11.1 0-20.1-9.1-20.1-20.3.1-11.3 9-20.4 20.1-20.4 11 0 20.1 9.2 20.1 20.4s-9 20.3-20.1 20.3z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../../../..", "features": ["toc.integrate", "navigation.sections", "navigation.expand", "navigation.top", "navigation.instant", "navigation.tracking", "navigation.top", "search.suggest", "search.share", "navigation.footer"], "search": "../../../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.b425cdc4.min.js"></script>
      
    
  </body>
</html>