
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Spyglass Documentation">
      
      
        <meta name="author" content="CBroz1">
      
      
        <link rel="canonical" href="https://lorenfranklab.github.io/spyglass/latest/api/src/spyglass/position/v1/position_dlc_cohort/">
      
      
        <link rel="prev" href="../position_dlc_centroid/">
      
      
        <link rel="next" href="../position_dlc_model/">
      
      <link rel="icon" href="../../../../../../images/Spyglass.svg">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.17">
    
    
      
        <title>position_dlc_cohort.py - Spyglass</title>
      
    
    
      <link rel="stylesheet" href="../../../../../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../../../../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="auto" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#src.spyglass.position.v1.position_dlc_cohort" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../../.." title="Spyglass" class="md-header__button md-logo" aria-label="Spyglass" data-md-component="logo">
      
  <img src="../../../../../../images/FrankLab.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Spyglass
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              position_dlc_cohort.py
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="auto" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: slate)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/LorenFrankLab/spyglass" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../../.." title="Spyglass" class="md-nav__button md-logo" aria-label="Spyglass" data-md-component="logo">
      
  <img src="../../../../../../images/FrankLab.png" alt="logo">

    </a>
    Spyglass
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/LorenFrankLab/spyglass" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../installation/" class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../installation/local/" class="md-nav__link">
        Local
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../installation/production/" class="md-nav__link">
        Productions
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../notebooks/00_intro/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../notebooks/01_spikesorting/" class="md-nav__link">
        Spike Sorting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../notebooks/02_curation/" class="md-nav__link">
        Curation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../notebooks/03_lfp/" class="md-nav__link">
        LFP
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_5" >
      
      
      
        <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
          Position
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_5">
          <span class="md-nav__icon md-icon"></span>
          Position
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../notebooks/4_position_info/" class="md-nav__link">
        Information
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../notebooks/04_Trodes_position/" class="md-nav__link">
        Pipeline
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../notebooks/05_DLC_from_scratch/" class="md-nav__link">
        From Scratch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../notebooks/06_DLC_from_dir/" class="md-nav__link">
        From Pre-Trained
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../notebooks/07_linearization/" class="md-nav__link">
        Linearization Pipeline
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../notebooks/08_Extract_Mark_indicators/" class="md-nav__link">
        Mark Indicators
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../notebooks/09_Decoding_with_GPUs_on_the_GPU_cluster/" class="md-nav__link">
        GPU
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../notebooks/10_1D_Clusterless_Decoding/" class="md-nav__link">
        1D Clusterless Decoding
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../notebooks/11_2D_Clusterless_Decoding/" class="md-nav__link">
        2D Clusterless Decoding
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../notebooks/12_Ripple_Detection/" class="md-nav__link">
        Ripple Detection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../notebooks/docker_mysql_tutorial/" class="md-nav__link">
        Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../notebooks/Spyglass_kachery_setup/" class="md-nav__link">
        Spyglass Kachery Setup
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          API Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          API Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
          src
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          src
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_1" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1" id="__nav_4_1_1_label" tabindex="0">
          spyglass
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_1_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4_1_1">
          <span class="md-nav__icon md-icon"></span>
          spyglass
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../_version/" class="md-nav__link">
        _version.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_2" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_2" id="__nav_4_1_1_2_label" tabindex="0">
          cli
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_2">
          <span class="md-nav__icon md-icon"></span>
          cli
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../cli/cli/" class="md-nav__link">
        cli.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_3" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_3" id="__nav_4_1_1_3_label" tabindex="0">
          common
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_3">
          <span class="md-nav__icon md-icon"></span>
          common
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/common_backup/" class="md-nav__link">
        common_backup.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/common_behav/" class="md-nav__link">
        common_behav.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/common_device/" class="md-nav__link">
        common_device.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/common_dio/" class="md-nav__link">
        common_dio.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/common_ephys/" class="md-nav__link">
        common_ephys.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/common_filter/" class="md-nav__link">
        common_filter.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/common_interval/" class="md-nav__link">
        common_interval.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/common_lab/" class="md-nav__link">
        common_lab.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/common_nwbfile/" class="md-nav__link">
        common_nwbfile.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/common_position/" class="md-nav__link">
        common_position.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/common_region/" class="md-nav__link">
        common_region.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/common_ripple/" class="md-nav__link">
        common_ripple.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/common_sensors/" class="md-nav__link">
        common_sensors.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/common_session/" class="md-nav__link">
        common_session.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/common_subject/" class="md-nav__link">
        common_subject.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/common_task/" class="md-nav__link">
        common_task.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/errors/" class="md-nav__link">
        errors.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/populate_all_common/" class="md-nav__link">
        populate_all_common.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_3_19" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_3_19" id="__nav_4_1_1_3_19_label" tabindex="0">
          prepopulate
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_4_1_1_3_19_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_3_19">
          <span class="md-nav__icon md-icon"></span>
          prepopulate
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/prepopulate/prepopulate/" class="md-nav__link">
        prepopulate.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../common/signal_processing/" class="md-nav__link">
        signal_processing.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_4" id="__nav_4_1_1_4_label" tabindex="0">
          data_import
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_4">
          <span class="md-nav__icon md-icon"></span>
          data_import
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../data_import/insert_sessions/" class="md-nav__link">
        insert_sessions.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../data_import/storage_dirs/" class="md-nav__link">
        storage_dirs.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_5" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_5" id="__nav_4_1_1_5_label" tabindex="0">
          decoding
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_5">
          <span class="md-nav__icon md-icon"></span>
          decoding
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../decoding/clusterless/" class="md-nav__link">
        clusterless.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../decoding/core/" class="md-nav__link">
        core.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../decoding/dj_decoder_conversion/" class="md-nav__link">
        dj_decoder_conversion.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../decoding/sorted_spikes/" class="md-nav__link">
        sorted_spikes.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../decoding/visualization/" class="md-nav__link">
        visualization.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../decoding/visualization_1D_view/" class="md-nav__link">
        visualization_1D_view.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../decoding/visualization_2D_view/" class="md-nav__link">
        visualization_2D_view.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_6" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_6" id="__nav_4_1_1_6_label" tabindex="0">
          figurl_views
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_6">
          <span class="md-nav__icon md-icon"></span>
          figurl_views
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../figurl_views/SpikeSortingRecordingView/" class="md-nav__link">
        SpikeSortingRecordingView.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../figurl_views/SpikeSortingView/" class="md-nav__link">
        SpikeSortingView.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../figurl_views/prepare_spikesortingview_data/" class="md-nav__link">
        prepare_spikesortingview_data.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_7" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_7" id="__nav_4_1_1_7_label" tabindex="0">
          lfp
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_7">
          <span class="md-nav__icon md-icon"></span>
          lfp
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lfp/lfp_merge/" class="md-nav__link">
        lfp_merge.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_7_2" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_7_2" id="__nav_4_1_1_7_2_label" tabindex="0">
          v1
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_4_1_1_7_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_7_2">
          <span class="md-nav__icon md-icon"></span>
          v1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lfp/v1/lfp/" class="md-nav__link">
        lfp.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lfp/v1/lfp_artifact/" class="md-nav__link">
        lfp_artifact.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lfp/v1/lfp_artifact_MAD_detection/" class="md-nav__link">
        lfp_artifact_MAD_detection.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lfp/v1/lfp_artifact_difference_detection/" class="md-nav__link">
        lfp_artifact_difference_detection.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_8" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_8" id="__nav_4_1_1_8_label" tabindex="0">
          lfp_band
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_8">
          <span class="md-nav__icon md-icon"></span>
          lfp_band
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lfp_band/lfp_band_merge/" class="md-nav__link">
        lfp_band_merge.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_8_2" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_8_2" id="__nav_4_1_1_8_2_label" tabindex="0">
          v1
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_4_1_1_8_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_8_2">
          <span class="md-nav__icon md-icon"></span>
          v1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lfp_band/v1/lfp_band/" class="md-nav__link">
        lfp_band.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_9" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_9" id="__nav_4_1_1_9_label" tabindex="0">
          lock
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_9">
          <span class="md-nav__icon md-icon"></span>
          lock
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lock/file_lock/" class="md-nav__link">
        file_lock.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_1_10" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_10" id="__nav_4_1_1_10_label" tabindex="0">
          position
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_10_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4_1_1_10">
          <span class="md-nav__icon md-icon"></span>
          position
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position_merge/" class="md-nav__link">
        position_merge.py
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_1_10_2" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_10_2" id="__nav_4_1_1_10_2_label" tabindex="0">
          v1
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_4_1_1_10_2_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4_1_1_10_2">
          <span class="md-nav__icon md-icon"></span>
          v1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dlc_decorators/" class="md-nav__link">
        dlc_decorators.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dlc_reader/" class="md-nav__link">
        dlc_reader.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dlc_utils/" class="md-nav__link">
        dlc_utils.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../position_dlc_centroid/" class="md-nav__link">
        position_dlc_centroid.py
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          position_dlc_cohort.py
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        position_dlc_cohort.py
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.position.v1.position_dlc_cohort" class="md-nav__link">
    src.spyglass.position.v1.position_dlc_cohort
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.position.v1.position_dlc_cohort.DLCSmoothInterpCohortSelection" class="md-nav__link">
    DLCSmoothInterpCohortSelection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.position.v1.position_dlc_cohort.DLCSmoothInterpCohort" class="md-nav__link">
    DLCSmoothInterpCohort
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.position.v1.position_dlc_cohort.fetch_nwb" class="md-nav__link">
    fetch_nwb()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.position.v1.position_dlc_cohort.DLCPoseEstimation" class="md-nav__link">
    DLCPoseEstimation
  </a>
  
    <nav class="md-nav" aria-label="DLCPoseEstimation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.position.v1.position_dlc_pose_estimation.DLCPoseEstimation.make" class="md-nav__link">
    make()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.position.v1.position_dlc_cohort.AnalysisNwbfile" class="md-nav__link">
    AnalysisNwbfile
  </a>
  
    <nav class="md-nav" aria-label="AnalysisNwbfile">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.create" class="md-nav__link">
    create()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.copy" class="md-nav__link">
    copy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add" class="md-nav__link">
    add()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.get_abs_path" class="md-nav__link">
    get_abs_path()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_nwb_object" class="md-nav__link">
    add_nwb_object()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units" class="md-nav__link">
    add_units()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units_waveforms" class="md-nav__link">
    add_units_waveforms()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units_metrics" class="md-nav__link">
    add_units_metrics()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.get_electrode_indices" class="md-nav__link">
    get_electrode_indices()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.cleanup" class="md-nav__link">
    cleanup()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.position.v1.position_dlc_cohort.DLCSmoothInterp" class="md-nav__link">
    DLCSmoothInterp
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../position_dlc_model/" class="md-nav__link">
        position_dlc_model.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../position_dlc_orient/" class="md-nav__link">
        position_dlc_orient.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../position_dlc_pose_estimation/" class="md-nav__link">
        position_dlc_pose_estimation.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../position_dlc_position/" class="md-nav__link">
        position_dlc_position.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../position_dlc_project/" class="md-nav__link">
        position_dlc_project.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../position_dlc_selection/" class="md-nav__link">
        position_dlc_selection.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../position_dlc_training/" class="md-nav__link">
        position_dlc_training.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../position_trodes_position/" class="md-nav__link">
        position_trodes_position.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../settings/" class="md-nav__link">
        settings.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_12" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_12" id="__nav_4_1_1_12_label" tabindex="0">
          sharing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_12_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_12">
          <span class="md-nav__icon md-icon"></span>
          sharing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sharing/sharing_kachery/" class="md-nav__link">
        sharing_kachery.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_13" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_13" id="__nav_4_1_1_13_label" tabindex="0">
          spikesorting
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_13_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_13">
          <span class="md-nav__icon md-icon"></span>
          spikesorting
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../spikesorting/curation_figurl/" class="md-nav__link">
        curation_figurl.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../spikesorting/merged_sorting_extractor/" class="md-nav__link">
        merged_sorting_extractor.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../spikesorting/sortingview/" class="md-nav__link">
        sortingview.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../spikesorting/sortingview_helper_fn/" class="md-nav__link">
        sortingview_helper_fn.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../spikesorting/spikesorting_artifact/" class="md-nav__link">
        spikesorting_artifact.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../spikesorting/spikesorting_curation/" class="md-nav__link">
        spikesorting_curation.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../spikesorting/spikesorting_recording/" class="md-nav__link">
        spikesorting_recording.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../spikesorting/spikesorting_sorting/" class="md-nav__link">
        spikesorting_sorting.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_14" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_14" id="__nav_4_1_1_14_label" tabindex="0">
          utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_14_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_14">
          <span class="md-nav__icon md-icon"></span>
          utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../utils/dj_helper_fn/" class="md-nav__link">
        dj_helper_fn.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../utils/dj_merge_tables/" class="md-nav__link">
        dj_merge_tables.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../utils/nwb_helper_fn/" class="md-nav__link">
        nwb_helper_fn.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../contribute/" class="md-nav__link">
        How to Contribute
      </a>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Miscellaneous
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Miscellaneous
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../misc/figurl_views/" class="md-nav__link">
        FigURL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../misc/session_groups/" class="md-nav__link">
        Session Groups
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../misc/insert_data/" class="md-nav__link">
        Insert Data
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../CHANGELOG/" class="md-nav__link">
        Change Log
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../LICENSE/" class="md-nav__link">
        Copyright
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>position_dlc_cohort.py</h1>

<div class="doc doc-object doc-module">


<a id="src.spyglass.position.v1.position_dlc_cohort"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">







<div class="doc doc-object doc-class">



<h2 id="src.spyglass.position.v1.position_dlc_cohort.DLCSmoothInterpCohortSelection" class="doc doc-heading">
        <code>DLCSmoothInterpCohortSelection</code>


<a href="#src.spyglass.position.v1.position_dlc_cohort.DLCSmoothInterpCohortSelection" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Manual">Manual</span></code></p>

  
      <p>Table to specify which combination of bodyparts from DLCSmoothInterp
get combined into a cohort</p>


        <details class="quote">
          <summary>Source code in <code>src/spyglass/position/v1/position_dlc_cohort.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">DLCSmoothInterpCohortSelection</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Table to specify which combination of bodyparts from DLCSmoothInterp</span>
<span class="sd">    get combined into a cohort</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    dlc_si_cohort_selection_name : varchar(120)</span>
<span class="s2">    -&gt; DLCPoseEstimation</span>
<span class="s2">    ---</span>
<span class="s2">    bodyparts_params_dict   : blob      # Dict with bodypart as key and desired dlc_si_params_name as value</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">





  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.position.v1.position_dlc_cohort.DLCSmoothInterpCohort" class="doc doc-heading">
        <code>DLCSmoothInterpCohort</code>


<a href="#src.spyglass.position.v1.position_dlc_cohort.DLCSmoothInterpCohort" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Computed">Computed</span></code></p>

  
      <p>Table to combine multiple bodyparts from DLCSmoothInterp
to enable centroid/orientation calculations</p>


        <details class="quote">
          <summary>Source code in <code>src/spyglass/position/v1/position_dlc_cohort.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">DLCSmoothInterpCohort</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Computed</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Table to combine multiple bodyparts from DLCSmoothInterp</span>
<span class="sd">    to enable centroid/orientation calculations</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Need to ensure that nwb_file_name/epoch/interval list name endure as primary keys</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; DLCSmoothInterpCohortSelection</span>
<span class="s2">    ---</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">BodyPart</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        -&gt; DLCSmoothInterpCohort</span>
<span class="s2">        -&gt; DLCSmoothInterp</span>
<span class="s2">        ---</span>
<span class="s2">        -&gt; AnalysisNwbfile</span>
<span class="s2">        dlc_smooth_interp_position_object_id : varchar(80)</span>
<span class="s2">        dlc_smooth_interp_info_object_id : varchar(80)</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">fetch_nwb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fetch_nwb</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="p">(</span><span class="n">AnalysisNwbfile</span><span class="p">,</span> <span class="s2">&quot;analysis_file_abs_path&quot;</span><span class="p">),</span>
                <span class="o">*</span><span class="n">attrs</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">fetch1_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">nwb_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_nwb</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                    <span class="n">nwb_data</span><span class="p">[</span><span class="s2">&quot;dlc_smooth_interp_position&quot;</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">get_spatial_series</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">timestamps</span>
                <span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">COLUMNS</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;video_frame_ind&quot;</span><span class="p">,</span>
                <span class="s2">&quot;x&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                            <span class="n">nwb_data</span><span class="p">[</span><span class="s2">&quot;dlc_smooth_interp_info&quot;</span><span class="p">]</span>
                            <span class="o">.</span><span class="n">time_series</span><span class="p">[</span><span class="s2">&quot;video_frame_ind&quot;</span><span class="p">]</span>
                            <span class="o">.</span><span class="n">data</span><span class="p">,</span>
                            <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                            <span class="n">nwb_data</span><span class="p">[</span><span class="s2">&quot;dlc_smooth_interp_position&quot;</span><span class="p">]</span>
                            <span class="o">.</span><span class="n">get_spatial_series</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">data</span>
                        <span class="p">),</span>
                    <span class="p">),</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">columns</span><span class="o">=</span><span class="n">COLUMNS</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.dlc_utils</span> <span class="kn">import</span> <span class="n">OutputLogger</span><span class="p">,</span> <span class="n">infer_output_dir</span>

        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">infer_output_dir</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">makedir</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">OutputLogger</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s1">&#39;nwb_file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s1">&#39;dlc_model_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_log&quot;</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">/log.log&quot;</span><span class="p">,</span>
            <span class="n">print_console</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-----------------------&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Bodypart Cohort&quot;</span><span class="p">)</span>
            <span class="c1"># from Jen Guidera</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">cohort_selection</span> <span class="o">=</span> <span class="p">(</span><span class="n">DLCSmoothInterpCohortSelection</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">()</span>
            <span class="n">table_entries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">bodyparts_params_dict</span> <span class="o">=</span> <span class="n">cohort_selection</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
                <span class="s2">&quot;bodyparts_params_dict&quot;</span>
            <span class="p">)</span>
            <span class="n">temp_key</span> <span class="o">=</span> <span class="n">cohort_selection</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">bodypart</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">bodyparts_params_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">temp_key</span><span class="p">[</span><span class="s2">&quot;bodypart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bodypart</span>
                <span class="n">temp_key</span><span class="p">[</span><span class="s2">&quot;dlc_si_params_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span>
                <span class="n">table_entries</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">DLCSmoothInterp</span> <span class="o">&amp;</span> <span class="n">temp_key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">())</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">table_entries</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">bodyparts_params_dict</span>
            <span class="p">),</span> <span class="s2">&quot;more entries found in DLCSmoothInterp than specified in bodyparts_params_dict&quot;</span>
            <span class="n">table_column_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">table_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">table_entry</span> <span class="ow">in</span> <span class="n">table_entries</span><span class="p">:</span>
                <span class="n">entry_key</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="o">**</span><span class="p">{</span>
                        <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">table_column_names</span><span class="p">,</span> <span class="n">table_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="p">},</span>
                    <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">DLCSmoothInterpCohort</span><span class="o">.</span><span class="n">BodyPart</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
                    <span class="n">entry_key</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Inserted entry into DLCSmoothInterpCohort&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">





  </div>

  </div>

</div>






<div class="doc doc-object doc-function">



<h2 id="src.spyglass.position.v1.position_dlc_cohort.fetch_nwb" class="doc doc-heading">
<code class="highlight language-python"><span class="n">fetch_nwb</span><span class="p">(</span><span class="n">query_expression</span><span class="p">,</span> <span class="n">nwb_master</span><span class="p">,</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#src.spyglass.position.v1.position_dlc_cohort.fetch_nwb" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Get an NWB object from the given DataJoint query.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>query_expression</code></td>
          <td>
                <code>query</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A DataJoint query expression (e.g., join, restrict) or a table to call fetch on.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nwb_master</code></td>
          <td>
                <code>tuple</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Tuple (table, attr) to get the NWB filepath from.
i.e. absolute path to NWB file can be obtained by looking up attr column of table
table is usually Nwbfile or AnalysisNwbfile;
attr is usually 'nwb_file_abs_path' or 'analysis_file_abs_path'</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>*attrs</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Attributes from normal DataJoint fetch call.</p>
            </div>
          </td>
          <td>
                <code>()</code>
          </td>
        </tr>
        <tr>
          <td><code>**kwargs</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Keyword arguments from normal DataJoint fetch call.</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>nwb_objects</code></td>          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of dicts containing fetch results and NWB objects.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/utils/dj_helper_fn.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">fetch_nwb</span><span class="p">(</span><span class="n">query_expression</span><span class="p">,</span> <span class="n">nwb_master</span><span class="p">,</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get an NWB object from the given DataJoint query.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    query_expression : query</span>
<span class="sd">        A DataJoint query expression (e.g., join, restrict) or a table to call fetch on.</span>
<span class="sd">    nwb_master : tuple</span>
<span class="sd">        Tuple (table, attr) to get the NWB filepath from.</span>
<span class="sd">        i.e. absolute path to NWB file can be obtained by looking up attr column of table</span>
<span class="sd">        table is usually Nwbfile or AnalysisNwbfile;</span>
<span class="sd">        attr is usually &#39;nwb_file_abs_path&#39; or &#39;analysis_file_abs_path&#39;</span>
<span class="sd">    *attrs : list</span>
<span class="sd">        Attributes from normal DataJoint fetch call.</span>
<span class="sd">    **kwargs : dict</span>
<span class="sd">        Keyword arguments from normal DataJoint fetch call.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nwb_objects : list</span>
<span class="sd">        List of dicts containing fetch results and NWB objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;as_dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># force return as dictionary</span>
    <span class="n">tbl</span><span class="p">,</span> <span class="n">attr_name</span> <span class="o">=</span> <span class="n">nwb_master</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">query_expression</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span>

    <span class="c1"># get the list of analysis or nwb files</span>
    <span class="n">file_name_str</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;analysis_file_name&quot;</span> <span class="k">if</span> <span class="s2">&quot;analysis&quot;</span> <span class="ow">in</span> <span class="n">nwb_master</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;nwb_file_name&quot;</span>
    <span class="p">)</span>
    <span class="c1"># TODO: avoid this import?</span>
    <span class="kn">from</span> <span class="nn">..common.common_nwbfile</span> <span class="kn">import</span> <span class="n">AnalysisNwbfile</span><span class="p">,</span> <span class="n">Nwbfile</span>

    <span class="n">file_path_fn</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span>
        <span class="k">if</span> <span class="s2">&quot;analysis&quot;</span> <span class="ow">in</span> <span class="n">nwb_master</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span> <span class="n">Nwbfile</span><span class="o">.</span><span class="n">get_abs_path</span>
    <span class="p">)</span>

    <span class="c1"># TODO: check that the query_expression restricts tbl - CBroz</span>
    <span class="n">nwb_files</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">query_expression</span> <span class="o">*</span> <span class="n">tbl</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">nwb2load_filepath</span><span class="o">=</span><span class="n">attr_name</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">file_name_str</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">nwb_files</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path_fn</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="c1"># retrieve the file from kachery. This also opens the file and stores the file object</span>
            <span class="n">get_nwb_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="n">rec_dicts</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">query_expression</span> <span class="o">*</span> <span class="n">tbl</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">nwb2load_filepath</span><span class="o">=</span><span class="n">attr_name</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="s2">&quot;nwb2load_filepath&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">rec_dicts</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;object_id&quot;</span> <span class="ow">in</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">rec_dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">rec_dicts</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rec_dict</span> <span class="ow">in</span> <span class="n">rec_dicts</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">get_nwb_file</span><span class="p">(</span><span class="n">rec_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nwb2load_filepath&quot;</span><span class="p">))</span>
        <span class="c1"># for each attr that contains substring &#39;object_id&#39;, store key-value: attr name to NWB object</span>
        <span class="c1"># remove &#39;_object_id&#39; from attr name</span>
        <span class="n">nwb_objs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">id_attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_object_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span> <span class="n">_get_nwb_object</span><span class="p">(</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">objects</span><span class="p">,</span> <span class="n">rec_dict</span><span class="p">[</span><span class="n">id_attr</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">id_attr</span> <span class="ow">in</span> <span class="n">attrs</span>
            <span class="k">if</span> <span class="s2">&quot;object_id&quot;</span> <span class="ow">in</span> <span class="n">id_attr</span> <span class="ow">and</span> <span class="n">rec_dict</span><span class="p">[</span><span class="n">id_attr</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>
        <span class="p">}</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="o">**</span><span class="n">rec_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">nwb_objs</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.position.v1.position_dlc_cohort.DLCPoseEstimation" class="doc doc-heading">
        <code>DLCPoseEstimation</code>


<a href="#src.spyglass.position.v1.position_dlc_cohort.DLCPoseEstimation" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Computed">Computed</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/position/v1/position_dlc_pose_estimation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">DLCPoseEstimation</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Computed</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; DLCPoseEstimationSelection</span>
<span class="s2">    ---</span>
<span class="s2">    pose_estimation_time: datetime  # time of generation of this set of DLC results</span>
<span class="s2">    meters_per_pixel : double       # conversion of meters per pixel for analyzed video</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">BodyPart</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; # uses DeepLabCut h5 output for body part position</span>
<span class="s2">        -&gt; DLCPoseEstimation</span>
<span class="s2">        -&gt; DLCModel.BodyPart</span>
<span class="s2">        ---</span>
<span class="s2">        -&gt; AnalysisNwbfile</span>
<span class="s2">        dlc_pose_estimation_position_object_id : varchar(80)</span>
<span class="s2">        dlc_pose_estimation_likelihood_object_id : varchar(80)</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">fetch_nwb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fetch_nwb</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="p">(</span><span class="n">AnalysisNwbfile</span><span class="p">,</span> <span class="s2">&quot;analysis_file_abs_path&quot;</span><span class="p">),</span>
                <span class="o">*</span><span class="n">attrs</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">fetch1_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">nwb_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_nwb</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                    <span class="n">nwb_data</span><span class="p">[</span><span class="s2">&quot;dlc_pose_estimation_position&quot;</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">get_spatial_series</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">timestamps</span>
                <span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">COLUMNS</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;video_frame_ind&quot;</span><span class="p">,</span>
                <span class="s2">&quot;x&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y&quot;</span><span class="p">,</span>
                <span class="s2">&quot;likelihood&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                            <span class="n">nwb_data</span><span class="p">[</span><span class="s2">&quot;dlc_pose_estimation_likelihood&quot;</span><span class="p">]</span>
                            <span class="o">.</span><span class="n">time_series</span><span class="p">[</span><span class="s2">&quot;video_frame_ind&quot;</span><span class="p">]</span>
                            <span class="o">.</span><span class="n">data</span><span class="p">,</span>
                            <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                            <span class="n">nwb_data</span><span class="p">[</span><span class="s2">&quot;dlc_pose_estimation_position&quot;</span><span class="p">]</span>
                            <span class="o">.</span><span class="n">get_spatial_series</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">data</span>
                        <span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                            <span class="n">nwb_data</span><span class="p">[</span><span class="s2">&quot;dlc_pose_estimation_likelihood&quot;</span><span class="p">]</span>
                            <span class="o">.</span><span class="n">time_series</span><span class="p">[</span><span class="s2">&quot;likelihood&quot;</span><span class="p">]</span>
                            <span class="o">.</span><span class="n">data</span>
                        <span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                    <span class="p">),</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">columns</span><span class="o">=</span><span class="n">COLUMNS</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;.populate() method will launch training for each PoseEstimationTask&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">dlc_reader</span>
        <span class="kn">from</span> <span class="nn">.dlc_utils</span> <span class="kn">import</span> <span class="n">get_video_path</span>

        <span class="n">METERS_PER_CM</span> <span class="o">=</span> <span class="mf">0.01</span>

        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">infer_output_dir</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">makedir</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">OutputLogger</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s1">&#39;nwb_file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s1">&#39;dlc_model_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_log&quot;</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">/log.log&quot;</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;----------------------&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pose Estimation&quot;</span><span class="p">)</span>
            <span class="c1"># ID model and directories</span>
            <span class="n">dlc_model</span> <span class="o">=</span> <span class="p">(</span><span class="n">DLCModel</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">()</span>
            <span class="n">bodyparts</span> <span class="o">=</span> <span class="p">(</span><span class="n">DLCModel</span><span class="o">.</span><span class="n">BodyPart</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;bodypart&quot;</span><span class="p">)</span>
            <span class="n">task_mode</span><span class="p">,</span> <span class="n">analyze_video_params</span><span class="p">,</span> <span class="n">video_path</span><span class="p">,</span> <span class="n">output_dir</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">DLCPoseEstimationSelection</span> <span class="o">&amp;</span> <span class="n">key</span>
            <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
                <span class="s2">&quot;task_mode&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pose_estimation_params&quot;</span><span class="p">,</span>
                <span class="s2">&quot;video_path&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pose_estimation_output_dir&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">analyze_video_params</span> <span class="o">=</span> <span class="n">analyze_video_params</span> <span class="ow">or</span> <span class="p">{}</span>

            <span class="n">project_path</span> <span class="o">=</span> <span class="n">dlc_model</span><span class="p">[</span><span class="s2">&quot;project_path&quot;</span><span class="p">]</span>

            <span class="c1"># Trigger PoseEstimation</span>
            <span class="k">if</span> <span class="n">task_mode</span> <span class="o">==</span> <span class="s2">&quot;trigger&quot;</span><span class="p">:</span>
                <span class="n">dlc_reader</span><span class="o">.</span><span class="n">do_pose_estimation</span><span class="p">(</span>
                    <span class="n">video_path</span><span class="p">,</span>
                    <span class="n">dlc_model</span><span class="p">,</span>
                    <span class="n">project_path</span><span class="p">,</span>
                    <span class="n">output_dir</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">analyze_video_params</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">dlc_result</span> <span class="o">=</span> <span class="n">dlc_reader</span><span class="o">.</span><span class="n">PoseEstimation</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
            <span class="n">creation_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
                <span class="n">dlc_result</span><span class="o">.</span><span class="n">creation_time</span>
            <span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;getting raw position&quot;</span><span class="p">)</span>
            <span class="n">interval_list_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;pos </span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> valid times&quot;</span>
            <span class="n">spatial_series</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">RawPosition</span><span class="p">()</span>
                <span class="o">&amp;</span> <span class="p">{</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;interval_list_name&quot;</span><span class="p">:</span> <span class="n">interval_list_name</span><span class="p">}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">fetch_nwb</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;raw_position&quot;</span><span class="p">]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">video_time</span> <span class="o">=</span> <span class="n">get_video_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">pos_time</span> <span class="o">=</span> <span class="n">spatial_series</span><span class="o">.</span><span class="n">timestamps</span>
            <span class="c1"># TODO: should get timestamps from VideoFile, but need the video_frame_ind from RawPosition,</span>
            <span class="c1"># which also has timestamps</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;meters_per_pixel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spatial_series</span><span class="o">.</span><span class="n">conversion</span>

            <span class="c1"># Insert entry into DLCPoseEstimation</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Inserting </span><span class="si">%s</span><span class="s2">, epoch </span><span class="si">%02d</span><span class="s2"> into DLCPoseEsimation&quot;</span><span class="p">,</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">],</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">({</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;pose_estimation_time&quot;</span><span class="p">:</span> <span class="n">creation_time</span><span class="p">})</span>
            <span class="n">meters_per_pixel</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;meters_per_pixel&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;meters_per_pixel&quot;</span><span class="p">]</span>
            <span class="n">body_parts</span> <span class="o">=</span> <span class="n">dlc_result</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">body_parts_df</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># Insert dlc pose estimation into analysis NWB file for each body part.</span>
            <span class="k">for</span> <span class="n">body_part</span> <span class="ow">in</span> <span class="n">bodyparts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">body_part</span> <span class="ow">in</span> <span class="n">body_parts</span><span class="p">:</span>
                    <span class="n">body_parts_df</span><span class="p">[</span><span class="n">body_part</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="n">c</span><span class="p">:</span> <span class="n">dlc_result</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">body_part</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">dlc_result</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">body_part</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span>
            <span class="k">for</span> <span class="n">body_part</span><span class="p">,</span> <span class="n">part_df</span> <span class="ow">in</span> <span class="n">body_parts_df</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;converting to cm&quot;</span><span class="p">)</span>
                <span class="n">part_df</span> <span class="o">=</span> <span class="n">convert_to_cm</span><span class="p">(</span><span class="n">part_df</span><span class="p">,</span> <span class="n">meters_per_pixel</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;adding timestamps to DataFrame&quot;</span><span class="p">)</span>
                <span class="n">part_df</span> <span class="o">=</span> <span class="n">add_timestamps</span><span class="p">(</span>
                    <span class="n">part_df</span><span class="p">,</span> <span class="n">pos_time</span><span class="o">=</span><span class="n">pos_time</span><span class="p">,</span> <span class="n">video_time</span><span class="o">=</span><span class="n">video_time</span>
                <span class="p">)</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;bodypart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body_part</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">position</span> <span class="o">=</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">Position</span><span class="p">()</span>
                <span class="n">likelihood</span> <span class="o">=</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">BehavioralTimeSeries</span><span class="p">()</span>
                <span class="n">position</span><span class="o">.</span><span class="n">create_spatial_series</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
                    <span class="n">timestamps</span><span class="o">=</span><span class="n">part_df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                    <span class="n">conversion</span><span class="o">=</span><span class="n">METERS_PER_CM</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">part_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                    <span class="n">reference_frame</span><span class="o">=</span><span class="n">spatial_series</span><span class="o">.</span><span class="n">reference_frame</span><span class="p">,</span>
                    <span class="n">comments</span><span class="o">=</span><span class="n">spatial_series</span><span class="o">.</span><span class="n">comments</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;x_position, y_position&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">likelihood</span><span class="o">.</span><span class="n">create_timeseries</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;likelihood&quot;</span><span class="p">,</span>
                    <span class="n">timestamps</span><span class="o">=</span><span class="n">part_df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">part_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[</span><span class="s2">&quot;likelihood&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                    <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;likelihood&quot;</span><span class="p">,</span>
                    <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;no comments&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;likelihood&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">likelihood</span><span class="o">.</span><span class="n">create_timeseries</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;video_frame_ind&quot;</span><span class="p">,</span>
                    <span class="n">timestamps</span><span class="o">=</span><span class="n">part_df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">part_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[</span><span class="s2">&quot;video_frame_ind&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                    <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span>
                    <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;no comments&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;video_frame_ind&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">nwb_analysis_file</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="p">()</span>
                <span class="n">key</span><span class="p">[</span>
                    <span class="s2">&quot;dlc_pose_estimation_position_object_id&quot;</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">nwb_analysis_file</span><span class="o">.</span><span class="n">add_nwb_object</span><span class="p">(</span>
                    <span class="n">analysis_file_name</span><span class="o">=</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">],</span>
                    <span class="n">nwb_object</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">key</span><span class="p">[</span>
                    <span class="s2">&quot;dlc_pose_estimation_likelihood_object_id&quot;</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">nwb_analysis_file</span><span class="o">.</span><span class="n">add_nwb_object</span><span class="p">(</span>
                    <span class="n">analysis_file_name</span><span class="o">=</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">],</span>
                    <span class="n">nwb_object</span><span class="o">=</span><span class="n">likelihood</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">nwb_analysis_file</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="n">nwb_file_name</span><span class="o">=</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">],</span>
                    <span class="n">analysis_file_name</span><span class="o">=</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">BodyPart</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fetch_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BodyPart</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;KEY&quot;</span><span class="p">)</span>
        <span class="n">nwb_data_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;bodypart&quot;</span><span class="p">]:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BodyPart</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">entry</span><span class="p">)</span><span class="o">.</span><span class="n">fetch_nwb</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span>
        <span class="p">}</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                <span class="n">nwb_data_dict</span><span class="p">[</span><span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;bodypart&quot;</span><span class="p">]][</span>
                    <span class="s2">&quot;dlc_pose_estimation_position&quot;</span>
                <span class="p">]</span>
                <span class="o">.</span><span class="n">get_spatial_series</span><span class="p">()</span>
                <span class="o">.</span><span class="n">timestamps</span>
            <span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">COLUMNS</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;video_frame_ind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;x&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="s2">&quot;likelihood&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;bodypart&quot;</span><span class="p">]:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                                <span class="n">nwb_data_dict</span><span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;bodypart&quot;</span><span class="p">]][</span>
                                    <span class="s2">&quot;dlc_pose_estimation_likelihood&quot;</span>
                                <span class="p">]</span>
                                <span class="o">.</span><span class="n">time_series</span><span class="p">[</span><span class="s2">&quot;video_frame_ind&quot;</span><span class="p">]</span>
                                <span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                            <span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                                <span class="n">nwb_data_dict</span><span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;bodypart&quot;</span><span class="p">]][</span>
                                    <span class="s2">&quot;dlc_pose_estimation_position&quot;</span>
                                <span class="p">]</span>
                                <span class="o">.</span><span class="n">get_spatial_series</span><span class="p">()</span>
                                <span class="o">.</span><span class="n">data</span>
                            <span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                                <span class="n">nwb_data_dict</span><span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;bodypart&quot;</span><span class="p">]][</span>
                                    <span class="s2">&quot;dlc_pose_estimation_likelihood&quot;</span>
                                <span class="p">]</span>
                                <span class="o">.</span><span class="n">time_series</span><span class="p">[</span><span class="s2">&quot;likelihood&quot;</span><span class="p">]</span>
                                <span class="o">.</span><span class="n">data</span>
                            <span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                        <span class="p">),</span>
                        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">columns</span><span class="o">=</span><span class="n">COLUMNS</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span>
            <span class="p">},</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.position.v1.position_dlc_pose_estimation.DLCPoseEstimation.make" class="doc doc-heading">
<code class="highlight language-python"><span class="n">make</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

<a href="#src.spyglass.position.v1.position_dlc_pose_estimation.DLCPoseEstimation.make" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>.populate() method will launch training for each PoseEstimationTask</p>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/position/v1/position_dlc_pose_estimation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;.populate() method will launch training for each PoseEstimationTask&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">dlc_reader</span>
    <span class="kn">from</span> <span class="nn">.dlc_utils</span> <span class="kn">import</span> <span class="n">get_video_path</span>

    <span class="n">METERS_PER_CM</span> <span class="o">=</span> <span class="mf">0.01</span>

    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">infer_output_dir</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">makedir</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">OutputLogger</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s1">&#39;nwb_file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s1">&#39;dlc_model_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_log&quot;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">/log.log&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">logger</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;----------------------&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pose Estimation&quot;</span><span class="p">)</span>
        <span class="c1"># ID model and directories</span>
        <span class="n">dlc_model</span> <span class="o">=</span> <span class="p">(</span><span class="n">DLCModel</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">()</span>
        <span class="n">bodyparts</span> <span class="o">=</span> <span class="p">(</span><span class="n">DLCModel</span><span class="o">.</span><span class="n">BodyPart</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;bodypart&quot;</span><span class="p">)</span>
        <span class="n">task_mode</span><span class="p">,</span> <span class="n">analyze_video_params</span><span class="p">,</span> <span class="n">video_path</span><span class="p">,</span> <span class="n">output_dir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">DLCPoseEstimationSelection</span> <span class="o">&amp;</span> <span class="n">key</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;task_mode&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pose_estimation_params&quot;</span><span class="p">,</span>
            <span class="s2">&quot;video_path&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pose_estimation_output_dir&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">analyze_video_params</span> <span class="o">=</span> <span class="n">analyze_video_params</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="n">project_path</span> <span class="o">=</span> <span class="n">dlc_model</span><span class="p">[</span><span class="s2">&quot;project_path&quot;</span><span class="p">]</span>

        <span class="c1"># Trigger PoseEstimation</span>
        <span class="k">if</span> <span class="n">task_mode</span> <span class="o">==</span> <span class="s2">&quot;trigger&quot;</span><span class="p">:</span>
            <span class="n">dlc_reader</span><span class="o">.</span><span class="n">do_pose_estimation</span><span class="p">(</span>
                <span class="n">video_path</span><span class="p">,</span>
                <span class="n">dlc_model</span><span class="p">,</span>
                <span class="n">project_path</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="p">,</span>
                <span class="o">**</span><span class="n">analyze_video_params</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">dlc_result</span> <span class="o">=</span> <span class="n">dlc_reader</span><span class="o">.</span><span class="n">PoseEstimation</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="n">creation_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
            <span class="n">dlc_result</span><span class="o">.</span><span class="n">creation_time</span>
        <span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;getting raw position&quot;</span><span class="p">)</span>
        <span class="n">interval_list_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;pos </span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> valid times&quot;</span>
        <span class="n">spatial_series</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">RawPosition</span><span class="p">()</span>
            <span class="o">&amp;</span> <span class="p">{</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;interval_list_name&quot;</span><span class="p">:</span> <span class="n">interval_list_name</span><span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetch_nwb</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;raw_position&quot;</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">video_time</span> <span class="o">=</span> <span class="n">get_video_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">pos_time</span> <span class="o">=</span> <span class="n">spatial_series</span><span class="o">.</span><span class="n">timestamps</span>
        <span class="c1"># TODO: should get timestamps from VideoFile, but need the video_frame_ind from RawPosition,</span>
        <span class="c1"># which also has timestamps</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;meters_per_pixel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spatial_series</span><span class="o">.</span><span class="n">conversion</span>

        <span class="c1"># Insert entry into DLCPoseEstimation</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Inserting </span><span class="si">%s</span><span class="s2">, epoch </span><span class="si">%02d</span><span class="s2"> into DLCPoseEsimation&quot;</span><span class="p">,</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">],</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">({</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;pose_estimation_time&quot;</span><span class="p">:</span> <span class="n">creation_time</span><span class="p">})</span>
        <span class="n">meters_per_pixel</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;meters_per_pixel&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;meters_per_pixel&quot;</span><span class="p">]</span>
        <span class="n">body_parts</span> <span class="o">=</span> <span class="n">dlc_result</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">body_parts_df</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Insert dlc pose estimation into analysis NWB file for each body part.</span>
        <span class="k">for</span> <span class="n">body_part</span> <span class="ow">in</span> <span class="n">bodyparts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">body_part</span> <span class="ow">in</span> <span class="n">body_parts</span><span class="p">:</span>
                <span class="n">body_parts_df</span><span class="p">[</span><span class="n">body_part</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="n">c</span><span class="p">:</span> <span class="n">dlc_result</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">body_part</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">dlc_result</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">body_part</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
                    <span class="p">}</span>
                <span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span>
        <span class="k">for</span> <span class="n">body_part</span><span class="p">,</span> <span class="n">part_df</span> <span class="ow">in</span> <span class="n">body_parts_df</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;converting to cm&quot;</span><span class="p">)</span>
            <span class="n">part_df</span> <span class="o">=</span> <span class="n">convert_to_cm</span><span class="p">(</span><span class="n">part_df</span><span class="p">,</span> <span class="n">meters_per_pixel</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;adding timestamps to DataFrame&quot;</span><span class="p">)</span>
            <span class="n">part_df</span> <span class="o">=</span> <span class="n">add_timestamps</span><span class="p">(</span>
                <span class="n">part_df</span><span class="p">,</span> <span class="n">pos_time</span><span class="o">=</span><span class="n">pos_time</span><span class="p">,</span> <span class="n">video_time</span><span class="o">=</span><span class="n">video_time</span>
            <span class="p">)</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;bodypart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body_part</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">Position</span><span class="p">()</span>
            <span class="n">likelihood</span> <span class="o">=</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">BehavioralTimeSeries</span><span class="p">()</span>
            <span class="n">position</span><span class="o">.</span><span class="n">create_spatial_series</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
                <span class="n">timestamps</span><span class="o">=</span><span class="n">part_df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                <span class="n">conversion</span><span class="o">=</span><span class="n">METERS_PER_CM</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">part_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                <span class="n">reference_frame</span><span class="o">=</span><span class="n">spatial_series</span><span class="o">.</span><span class="n">reference_frame</span><span class="p">,</span>
                <span class="n">comments</span><span class="o">=</span><span class="n">spatial_series</span><span class="o">.</span><span class="n">comments</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;x_position, y_position&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">likelihood</span><span class="o">.</span><span class="n">create_timeseries</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;likelihood&quot;</span><span class="p">,</span>
                <span class="n">timestamps</span><span class="o">=</span><span class="n">part_df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                <span class="n">data</span><span class="o">=</span><span class="n">part_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[</span><span class="s2">&quot;likelihood&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;likelihood&quot;</span><span class="p">,</span>
                <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;no comments&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;likelihood&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">likelihood</span><span class="o">.</span><span class="n">create_timeseries</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;video_frame_ind&quot;</span><span class="p">,</span>
                <span class="n">timestamps</span><span class="o">=</span><span class="n">part_df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                <span class="n">data</span><span class="o">=</span><span class="n">part_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[</span><span class="s2">&quot;video_frame_ind&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span>
                <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;no comments&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;video_frame_ind&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">nwb_analysis_file</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="p">()</span>
            <span class="n">key</span><span class="p">[</span>
                <span class="s2">&quot;dlc_pose_estimation_position_object_id&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">nwb_analysis_file</span><span class="o">.</span><span class="n">add_nwb_object</span><span class="p">(</span>
                <span class="n">analysis_file_name</span><span class="o">=</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">],</span>
                <span class="n">nwb_object</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">key</span><span class="p">[</span>
                <span class="s2">&quot;dlc_pose_estimation_likelihood_object_id&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">nwb_analysis_file</span><span class="o">.</span><span class="n">add_nwb_object</span><span class="p">(</span>
                <span class="n">analysis_file_name</span><span class="o">=</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">],</span>
                <span class="n">nwb_object</span><span class="o">=</span><span class="n">likelihood</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">nwb_analysis_file</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">nwb_file_name</span><span class="o">=</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">],</span>
                <span class="n">analysis_file_name</span><span class="o">=</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BodyPart</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.position.v1.position_dlc_cohort.AnalysisNwbfile" class="doc doc-heading">
        <code>AnalysisNwbfile</code>


<a href="#src.spyglass.position.v1.position_dlc_cohort.AnalysisNwbfile" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Manual">Manual</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">AnalysisNwbfile</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # Table for holding the NWB files that contain results of analysis, such as spike sorting.</span>
<span class="s2">    analysis_file_name: varchar(255)               # name of the file</span>
<span class="s2">    ---</span>
<span class="s2">    -&gt; Nwbfile                                     # name of the parent NWB file. Used for naming and metadata copy</span>
<span class="s2">    analysis_file_abs_path: filepath@analysis      # the full path to the file</span>
<span class="s2">    analysis_file_description = &quot;&quot;: varchar(2000)  # an optional description of this analysis</span>
<span class="s2">    analysis_parameters = NULL: blob               # additional relevant parameters. Currently used only for analyses</span>
<span class="s2">                                                   # that span multiple NWB files</span>
<span class="s2">    INDEX (analysis_file_abs_path)</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="c1"># NOTE the INDEX above is implicit from filepath@... above but needs to be explicit</span>
    <span class="c1"># so that alter() can work</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open the NWB file, create a copy, write the copy to disk and return the name of the new file.</span>

<span class="sd">        Note that this does NOT add the file to the schema; that needs to be done after data are written to it.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nwb_file_name : str</span>
<span class="sd">            The name of an NWB file to be copied.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the new NWB file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nwb_file_abspath</span> <span class="o">=</span> <span class="n">Nwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">nwb_file_abspath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="c1"># pop off the unnecessary elements to save space</span>
            <span class="n">nwb_fields</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">fields</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">nwb_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NWB_KEEP_FIELDS</span><span class="p">:</span>
                    <span class="n">nwb_object</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">nwbf</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">,</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">LabelledDict</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nwb_object</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">nwb_object</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>

            <span class="n">analysis_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_new_file_name</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
            <span class="c1"># write the new file</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing new NWB file </span><span class="si">{</span><span class="n">analysis_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">analysis_file_abs_path</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
                <span class="n">analysis_file_name</span>
            <span class="p">)</span>
            <span class="c1"># export the new NWB file</span>
            <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
                <span class="n">path</span><span class="o">=</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">manager</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">export_io</span><span class="p">:</span>
                <span class="n">export_io</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">)</span>

        <span class="c1"># change the permissions to only allow owner to write</span>
        <span class="n">permissions</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IROTH</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">permissions</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">analysis_file_name</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__get_new_file_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
        <span class="c1"># each file ends with a random string of 10 digits, so we generate that string and redo if by some miracle</span>
        <span class="c1"># it&#39;s already there</span>
        <span class="n">file_in_table</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">file_in_table</span><span class="p">:</span>
            <span class="n">analysis_file_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;.nwb&quot;</span>
            <span class="p">)</span>
            <span class="n">file_in_table</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span> <span class="o">&amp;</span> <span class="p">{</span>
                <span class="s2">&quot;analysis_file_name&quot;</span><span class="p">:</span> <span class="n">analysis_file_name</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">analysis_file_name</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__get_analysis_file_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># strip off everything after and including the final underscore and return the result</span>
        <span class="k">return</span> <span class="n">analysis_file_name</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">analysis_file_name</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a copy of an analysis NWB file.</span>

<span class="sd">        Note that this does NOT add the file to the schema; that needs to be done after data are written to it.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nwb_file_name : str</span>
<span class="sd">            The name of the analysis NWB file to be copied.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the new NWB file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nwb_file_abspath</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">nwb_file_abspath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="c1"># get the current number of analysis files related to this nwb file</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">}</span>
            <span class="n">original_nwb_file_name</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">analysis_file_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__get_new_file_name</span><span class="p">(</span><span class="n">original_nwb_file_name</span><span class="p">)</span>
            <span class="c1"># write the new file</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing new NWB file </span><span class="si">{</span><span class="n">analysis_file_name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">analysis_file_abs_path</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
                <span class="n">analysis_file_name</span>
            <span class="p">)</span>
            <span class="c1"># export the new NWB file</span>
            <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
                <span class="n">path</span><span class="o">=</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">manager</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">export_io</span><span class="p">:</span>
                <span class="n">export_io</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">analysis_file_name</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the specified file to AnalysisNWBfile table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nwb_file_name : str</span>
<span class="sd">            The name of the parent NWB file.</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the analysis NWB file that was created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_file_name</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_file_name</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_abs_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
            <span class="n">analysis_file_name</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_abs_path</span><span class="p">(</span><span class="n">analysis_nwb_file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the absolute path for a stored analysis NWB file given just the file name.</span>

<span class="sd">        The SPYGLASS_BASE_DIR environment variable must be set.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analysis_nwb_file_name : str</span>
<span class="sd">            The name of the NWB file that has been inserted into the AnalysisNwbfile() schema</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        analysis_nwb_file_abspath : str</span>
<span class="sd">            The absolute path for the given file name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SPYGLASS_BASE_DIR&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;You must set SPYGLASS_BASE_DIR environment variable.&quot;</span>

        <span class="c1"># see if the file exists and is stored in the base analysis dir</span>
        <span class="n">test_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;analysis&quot;</span> <span class="o">/</span> <span class="n">analysis_nwb_file_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">test_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">test_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use the new path</span>
            <span class="n">analysis_file_base_path</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">base_dir</span>
                <span class="o">/</span> <span class="s2">&quot;analysis&quot;</span>
                <span class="o">/</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">__get_analysis_file_dir</span><span class="p">(</span>
                    <span class="n">analysis_nwb_file_name</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis_file_base_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">analysis_file_base_path</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">analysis_file_base_path</span> <span class="o">/</span> <span class="n">analysis_nwb_file_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_nwb_object</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">nwb_object</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;pandas_table&quot;</span>
    <span class="p">):</span>
        <span class="c1"># TODO: change to add_object with checks for object type and a name parameter, which should be specified if</span>
        <span class="c1"># it is not an NWB container</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add an NWB object to the analysis file in the scratch area and returns the NWB object ID</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the analysis NWB file.</span>
<span class="sd">        nwb_object : pynwb.core.NWBDataInterface</span>
<span class="sd">            The NWB object created by PyNWB.</span>
<span class="sd">        table_name : str (optional, defaults to &#39;pandas_table&#39;)</span>
<span class="sd">            The name of the DynamicTable made from a dataframe.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        nwb_object_id : str</span>
<span class="sd">            The NWB object ID of the added object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
            <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">dt_object</span> <span class="o">=</span> <span class="n">DynamicTable</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">nwb_object</span>
                <span class="p">)</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span><span class="n">dt_object</span><span class="p">)</span>
                <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">dt_object</span><span class="o">.</span><span class="n">object_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">)</span>
                <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">nwb_object</span><span class="o">.</span><span class="n">object_id</span>

    <span class="k">def</span> <span class="nf">add_units</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">analysis_file_name</span><span class="p">,</span>
        <span class="n">units</span><span class="p">,</span>
        <span class="n">units_valid_times</span><span class="p">,</span>
        <span class="n">units_sort_interval</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">units_waveforms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add units to analysis NWB file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the analysis NWB file.</span>
<span class="sd">        units : dict</span>
<span class="sd">            keys are unit ids, values are spike times</span>
<span class="sd">        units_valid_times : dict</span>
<span class="sd">            Dictionary of units and valid times with unit ids as keys.</span>
<span class="sd">        units_sort_interval : dict</span>
<span class="sd">            Dictionary of units and sort_interval with unit ids as keys.</span>
<span class="sd">        units_waveforms : dict, optional</span>
<span class="sd">            Dictionary of unit waveforms with unit ids as keys.</span>
<span class="sd">        metrics : dict, optional</span>
<span class="sd">            Cluster metrics.</span>
<span class="sd">        labels : dict, optional</span>
<span class="sd">            Curation labels for clusters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        units_object_id, waveforms_object_id : str, str</span>
<span class="sd">            The NWB object id of the Units object and the object id of the waveforms object (&#39;&#39; if None)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
            <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">sort_intervals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="c1"># Add spike times and valid time range for the sort</span>
                <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span>
                        <span class="n">spike_times</span><span class="o">=</span><span class="n">units</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span>
                        <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
                        <span class="c1"># waveform_mean = units_templates[id],</span>
                        <span class="n">obs_intervals</span><span class="o">=</span><span class="n">units_valid_times</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="n">sort_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">units_sort_interval</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span>
                <span class="c1"># Add a column for the sort interval (subset of valid time)</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sort_interval&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;the interval used for spike sorting&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">sort_intervals</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># If metrics were specified, add one column per metric</span>
                <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]:</span>
                            <span class="n">unit_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                            <span class="n">metric_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                            <span class="p">)</span>
                            <span class="c1"># sort by unit_ids and apply that sorting to values to ensure that things go in the right order</span>
                            <span class="n">metric_values</span> <span class="o">=</span> <span class="n">metric_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">unit_ids</span><span class="p">)]</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding metric </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">metric_values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                                <span class="n">name</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
                                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> metric&quot;</span><span class="p">,</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">metric_values</span><span class="p">,</span>
                            <span class="p">)</span>
                <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">unit_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                    <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">unit_ids</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                            <span class="n">labels</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">label_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                    <span class="n">label_values</span> <span class="o">=</span> <span class="n">label_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">unit_ids</span><span class="p">)]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;label given during curation&quot;</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">label_values</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="c1"># If the waveforms were specified, add them as a dataframe to scratch</span>
                <span class="n">waveforms_object_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">units_waveforms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">waveforms_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                        <span class="n">units_waveforms</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span>
                    <span class="p">)</span>
                    <span class="n">waveforms_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;waveforms&quot;</span><span class="p">]</span>
                    <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span>
                        <span class="n">waveforms_df</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;units_waveforms&quot;</span><span class="p">,</span>
                        <span class="n">notes</span><span class="o">=</span><span class="s2">&quot;spike waveforms for each unit&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">waveforms_object_id</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">scratch</span><span class="p">[</span>
                        <span class="s2">&quot;units_waveforms&quot;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">object_id</span>

                <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">object_id</span><span class="p">,</span> <span class="n">waveforms_object_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">add_units_waveforms</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">analysis_file_name</span><span class="p">,</span>
        <span class="n">waveform_extractor</span><span class="p">:</span> <span class="n">si</span><span class="o">.</span><span class="n">WaveformExtractor</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add units to analysis NWB file along with the waveforms</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the analysis NWB file.</span>
<span class="sd">        waveform_extractor : si.WaveformExtractor object</span>
<span class="sd">        metrics : dict, optional</span>
<span class="sd">            Cluster metrics.</span>
<span class="sd">        labels : dict, optional</span>
<span class="sd">            Curation labels for clusters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        units_object_id : str</span>
<span class="sd">            The NWB object id of the Units object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
            <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">waveform_extractor</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_ids</span><span class="p">():</span>
                <span class="c1"># (spikes, samples, channels)</span>
                <span class="n">waveforms</span> <span class="o">=</span> <span class="n">waveform_extractor</span><span class="o">.</span><span class="n">get_waveforms</span><span class="p">(</span><span class="n">unit_id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
                <span class="c1"># (channels, spikes, samples)</span>
                <span class="n">waveforms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">waveforms</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span>
                    <span class="n">spike_times</span><span class="o">=</span><span class="n">waveform_extractor</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_spike_train</span><span class="p">(</span>
                        <span class="n">unit_id</span><span class="o">=</span><span class="nb">id</span>
                    <span class="p">),</span>
                    <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
                    <span class="n">electrodes</span><span class="o">=</span><span class="n">waveform_extractor</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">(),</span>
                    <span class="n">waveforms</span><span class="o">=</span><span class="n">waveforms</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># The following is a rough sketch of AnalysisNwbfile().add_waveforms</span>
            <span class="c1"># analysis_file_name = AnalysisNwbfile().create(key[&#39;nwb_file_name&#39;])</span>
            <span class="c1"># or</span>
            <span class="c1"># nwbfile = pynwb.NWBFile(...)</span>
            <span class="c1"># (channels, spikes, samples)</span>
            <span class="c1"># wfs = [</span>
            <span class="c1">#         [     # elec 1</span>
            <span class="c1">#             [1, 2, 3],  # spike 1, [sample 1, sample 2, sample 3]</span>
            <span class="c1">#             [1, 2, 3],  # spike 2</span>
            <span class="c1">#             [1, 2, 3],  # spike 3</span>
            <span class="c1">#             [1, 2, 3]   # spike 4</span>
            <span class="c1">#         ], [  # elec 2</span>
            <span class="c1">#             [1, 2, 3],  # spike 1</span>
            <span class="c1">#             [1, 2, 3],  # spike 2</span>
            <span class="c1">#             [1, 2, 3],  # spike 3</span>
            <span class="c1">#             [1, 2, 3]   # spike 4</span>
            <span class="c1">#         ], [  # elec 3</span>
            <span class="c1">#             [1, 2, 3],  # spike 1</span>
            <span class="c1">#             [1, 2, 3],  # spike 2</span>
            <span class="c1">#             [1, 2, 3],  # spike 3</span>
            <span class="c1">#             [1, 2, 3]   # spike 4</span>
            <span class="c1">#         ]</span>
            <span class="c1"># ]</span>
            <span class="c1"># elecs = ... # DynamicTableRegion referring to three electrodes (rows) of the electrodes table</span>
            <span class="c1"># nwbfile.add_unit(spike_times=[1, 2, 3], electrodes=elecs, waveforms=wfs)</span>

            <span class="c1"># If metrics were specified, add one column per metric</span>
            <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding metric </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">metric_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">metric_data</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                    <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">metric_data</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;label given during curation&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">object_id</span>

    <span class="k">def</span> <span class="nf">add_units_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add units to analysis NWB file along with the waveforms</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the analysis NWB file.</span>
<span class="sd">        metrics : dict, optional</span>
<span class="sd">            Cluster metrics.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        units_object_id : str</span>
<span class="sd">            The NWB object id of the Units object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metric_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">unit_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
            <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">unit_ids</span><span class="p">:</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding metric </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">metric_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">metric_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">metric_data</span>
                <span class="p">)</span>

            <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">object_id</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_electrode_indices</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given an analysis NWB file name, returns the indices of the specified electrode_ids.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the analysis NWB file.</span>
<span class="sd">        electrode_ids : numpy array or list</span>
<span class="sd">            Array or list of electrode IDs.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        electrode_indices : numpy array</span>
<span class="sd">            Array of indices in the electrodes table for the given electrode IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">get_nwb_file</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">get_electrode_indices</span><span class="p">(</span><span class="n">nwbf</span><span class="o">.</span><span class="n">electrodes</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">delete_files</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove the filepath entries for NWB files that are not in use.</span>

<span class="sd">        Does not delete the files themselves unless delete_files=True is specified.</span>
<span class="sd">        Run this after deleting the Nwbfile() entries themselves.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        delete_files : bool, optional</span>
<span class="sd">            Whether the original files should be deleted (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">external</span><span class="p">[</span><span class="s2">&quot;analysis&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">delete_external_files</span><span class="o">=</span><span class="n">delete_files</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">nightly_cleanup</span><span class="p">():</span>
        <span class="n">child_tables</span> <span class="o">=</span> <span class="n">get_child_tables</span><span class="p">(</span><span class="n">AnalysisNwbfile</span><span class="p">)</span>
        <span class="p">(</span><span class="n">AnalysisNwbfile</span> <span class="o">-</span> <span class="n">child_tables</span><span class="p">)</span><span class="o">.</span><span class="n">delete_quick</span><span class="p">()</span>

        <span class="c1"># a separate external files clean up required - this is to be done</span>
        <span class="c1"># during times when no other transactions are in progress.</span>
        <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.create" class="doc doc-heading">
<code class="highlight language-python"><span class="n">create</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.create" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Open the NWB file, create a copy, write the copy to disk and return the name of the new file.</p>
<p>Note that this does NOT add the file to the schema; that needs to be done after data are written to it.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of an NWB file to be copied.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>analysis_file_name</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the new NWB file.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Open the NWB file, create a copy, write the copy to disk and return the name of the new file.</span>

<span class="sd">    Note that this does NOT add the file to the schema; that needs to be done after data are written to it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwb_file_name : str</span>
<span class="sd">        The name of an NWB file to be copied.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the new NWB file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nwb_file_abspath</span> <span class="o">=</span> <span class="n">Nwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="n">nwb_file_abspath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1"># pop off the unnecessary elements to save space</span>
        <span class="n">nwb_fields</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">fields</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">nwb_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NWB_KEEP_FIELDS</span><span class="p">:</span>
                <span class="n">nwb_object</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">nwbf</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">,</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">LabelledDict</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nwb_object</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">nwb_object</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>

        <span class="n">analysis_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_new_file_name</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
        <span class="c1"># write the new file</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing new NWB file </span><span class="si">{</span><span class="n">analysis_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">analysis_file_abs_path</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
            <span class="n">analysis_file_name</span>
        <span class="p">)</span>
        <span class="c1"># export the new NWB file</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">manager</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">export_io</span><span class="p">:</span>
            <span class="n">export_io</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">)</span>

    <span class="c1"># change the permissions to only allow owner to write</span>
    <span class="n">permissions</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IROTH</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">permissions</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">analysis_file_name</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.copy" class="doc doc-heading">
<code class="highlight language-python"><span class="n">copy</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.copy" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Make a copy of an analysis NWB file.</p>
<p>Note that this does NOT add the file to the schema; that needs to be done after data are written to it.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file to be copied.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>analysis_file_name</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the new NWB file.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make a copy of an analysis NWB file.</span>

<span class="sd">    Note that this does NOT add the file to the schema; that needs to be done after data are written to it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwb_file_name : str</span>
<span class="sd">        The name of the analysis NWB file to be copied.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the new NWB file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nwb_file_abspath</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="n">nwb_file_abspath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1"># get the current number of analysis files related to this nwb file</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">}</span>
        <span class="n">original_nwb_file_name</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">analysis_file_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__get_new_file_name</span><span class="p">(</span><span class="n">original_nwb_file_name</span><span class="p">)</span>
        <span class="c1"># write the new file</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing new NWB file </span><span class="si">{</span><span class="n">analysis_file_name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">analysis_file_abs_path</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
            <span class="n">analysis_file_name</span>
        <span class="p">)</span>
        <span class="c1"># export the new NWB file</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">manager</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">export_io</span><span class="p">:</span>
            <span class="n">export_io</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">analysis_file_name</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.add" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add the specified file to AnalysisNWBfile table.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the parent NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>analysis_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file that was created.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add the specified file to AnalysisNWBfile table.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwb_file_name : str</span>
<span class="sd">        The name of the parent NWB file.</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the analysis NWB file that was created.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_file_name</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_file_name</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_abs_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
        <span class="n">analysis_file_name</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.get_abs_path" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_nwb_file_name</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.get_abs_path" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Return the absolute path for a stored analysis NWB file given just the file name.</p>
<p>The SPYGLASS_BASE_DIR environment variable must be set.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>analysis_nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the NWB file that has been inserted into the AnalysisNwbfile() schema</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>analysis_nwb_file_abspath</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The absolute path for the given file name.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">get_abs_path</span><span class="p">(</span><span class="n">analysis_nwb_file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the absolute path for a stored analysis NWB file given just the file name.</span>

<span class="sd">    The SPYGLASS_BASE_DIR environment variable must be set.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analysis_nwb_file_name : str</span>
<span class="sd">        The name of the NWB file that has been inserted into the AnalysisNwbfile() schema</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    analysis_nwb_file_abspath : str</span>
<span class="sd">        The absolute path for the given file name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">base_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SPYGLASS_BASE_DIR&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">),</span> <span class="s2">&quot;You must set SPYGLASS_BASE_DIR environment variable.&quot;</span>

    <span class="c1"># see if the file exists and is stored in the base analysis dir</span>
    <span class="n">test_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;analysis&quot;</span> <span class="o">/</span> <span class="n">analysis_nwb_file_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">test_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test_path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># use the new path</span>
        <span class="n">analysis_file_base_path</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">base_dir</span>
            <span class="o">/</span> <span class="s2">&quot;analysis&quot;</span>
            <span class="o">/</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">__get_analysis_file_dir</span><span class="p">(</span>
                <span class="n">analysis_nwb_file_name</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis_file_base_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">analysis_file_base_path</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">analysis_file_base_path</span> <span class="o">/</span> <span class="n">analysis_nwb_file_name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_nwb_object" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_nwb_object</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">nwb_object</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;pandas_table&#39;</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_nwb_object" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add an NWB object to the analysis file in the scratch area and returns the NWB object ID</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>analysis_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nwb_object</code></td>
          <td>
                <code>pynwb.<span title="pynwb.core">core</span>.<span title="pynwb.core.NWBDataInterface">NWBDataInterface</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The NWB object created by PyNWB.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>table_name</code></td>
          <td>
                <code>str (optional, defaults to &#39;pandas_table&#39;)</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the DynamicTable made from a dataframe.</p>
            </div>
          </td>
          <td>
                <code>&#39;pandas_table&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>nwb_object_id</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The NWB object ID of the added object.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_nwb_object</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">nwb_object</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;pandas_table&quot;</span>
<span class="p">):</span>
    <span class="c1"># TODO: change to add_object with checks for object type and a name parameter, which should be specified if</span>
    <span class="c1"># it is not an NWB container</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add an NWB object to the analysis file in the scratch area and returns the NWB object ID</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the analysis NWB file.</span>
<span class="sd">    nwb_object : pynwb.core.NWBDataInterface</span>
<span class="sd">        The NWB object created by PyNWB.</span>
<span class="sd">    table_name : str (optional, defaults to &#39;pandas_table&#39;)</span>
<span class="sd">        The name of the DynamicTable made from a dataframe.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nwb_object_id : str</span>
<span class="sd">        The NWB object ID of the added object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
        <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">dt_object</span> <span class="o">=</span> <span class="n">DynamicTable</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">nwb_object</span>
            <span class="p">)</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span><span class="n">dt_object</span><span class="p">)</span>
            <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dt_object</span><span class="o">.</span><span class="n">object_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">)</span>
            <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nwb_object</span><span class="o">.</span><span class="n">object_id</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_units</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">units_valid_times</span><span class="p">,</span> <span class="n">units_sort_interval</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units_waveforms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add units to analysis NWB file</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>analysis_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>units</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>keys are unit ids, values are spike times</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>units_valid_times</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary of units and valid times with unit ids as keys.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>units_sort_interval</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary of units and sort_interval with unit ids as keys.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>units_waveforms</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary of unit waveforms with unit ids as keys.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>metrics</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Cluster metrics.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>labels</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Curation labels for clusters</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>units_object_id, waveforms_object_id : str, str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The NWB object id of the Units object and the object id of the waveforms object ('' if None)</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_units</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">analysis_file_name</span><span class="p">,</span>
    <span class="n">units</span><span class="p">,</span>
    <span class="n">units_valid_times</span><span class="p">,</span>
    <span class="n">units_sort_interval</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">units_waveforms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add units to analysis NWB file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the analysis NWB file.</span>
<span class="sd">    units : dict</span>
<span class="sd">        keys are unit ids, values are spike times</span>
<span class="sd">    units_valid_times : dict</span>
<span class="sd">        Dictionary of units and valid times with unit ids as keys.</span>
<span class="sd">    units_sort_interval : dict</span>
<span class="sd">        Dictionary of units and sort_interval with unit ids as keys.</span>
<span class="sd">    units_waveforms : dict, optional</span>
<span class="sd">        Dictionary of unit waveforms with unit ids as keys.</span>
<span class="sd">    metrics : dict, optional</span>
<span class="sd">        Cluster metrics.</span>
<span class="sd">    labels : dict, optional</span>
<span class="sd">        Curation labels for clusters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    units_object_id, waveforms_object_id : str, str</span>
<span class="sd">        The NWB object id of the Units object and the object id of the waveforms object (&#39;&#39; if None)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
        <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">sort_intervals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="c1"># Add spike times and valid time range for the sort</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span>
                    <span class="n">spike_times</span><span class="o">=</span><span class="n">units</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span>
                    <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
                    <span class="c1"># waveform_mean = units_templates[id],</span>
                    <span class="n">obs_intervals</span><span class="o">=</span><span class="n">units_valid_times</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">sort_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">units_sort_interval</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span>
            <span class="c1"># Add a column for the sort interval (subset of valid time)</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sort_interval&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;the interval used for spike sorting&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">sort_intervals</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># If metrics were specified, add one column per metric</span>
            <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]:</span>
                        <span class="n">unit_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                        <span class="n">metric_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                            <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                        <span class="p">)</span>
                        <span class="c1"># sort by unit_ids and apply that sorting to values to ensure that things go in the right order</span>
                        <span class="n">metric_values</span> <span class="o">=</span> <span class="n">metric_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">unit_ids</span><span class="p">)]</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding metric </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">metric_values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
                            <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> metric&quot;</span><span class="p">,</span>
                            <span class="n">data</span><span class="o">=</span><span class="n">metric_values</span><span class="p">,</span>
                        <span class="p">)</span>
            <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">unit_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">unit_ids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                        <span class="n">labels</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">label_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                <span class="n">label_values</span> <span class="o">=</span> <span class="n">label_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">unit_ids</span><span class="p">)]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;label given during curation&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">label_values</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># If the waveforms were specified, add them as a dataframe to scratch</span>
            <span class="n">waveforms_object_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">units_waveforms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">waveforms_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                    <span class="n">units_waveforms</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span>
                <span class="p">)</span>
                <span class="n">waveforms_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;waveforms&quot;</span><span class="p">]</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span>
                    <span class="n">waveforms_df</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;units_waveforms&quot;</span><span class="p">,</span>
                    <span class="n">notes</span><span class="o">=</span><span class="s2">&quot;spike waveforms for each unit&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">waveforms_object_id</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">scratch</span><span class="p">[</span>
                    <span class="s2">&quot;units_waveforms&quot;</span>
                <span class="p">]</span><span class="o">.</span><span class="n">object_id</span>

            <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">object_id</span><span class="p">,</span> <span class="n">waveforms_object_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units_waveforms" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_units_waveforms</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">waveform_extractor</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units_waveforms" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add units to analysis NWB file along with the waveforms</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>analysis_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>waveform_extractor</code></td>
          <td>
                <code>si.WaveformExtractor object</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>metrics</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Cluster metrics.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>labels</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Curation labels for clusters</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>units_object_id</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The NWB object id of the Units object</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_units_waveforms</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">analysis_file_name</span><span class="p">,</span>
    <span class="n">waveform_extractor</span><span class="p">:</span> <span class="n">si</span><span class="o">.</span><span class="n">WaveformExtractor</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add units to analysis NWB file along with the waveforms</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the analysis NWB file.</span>
<span class="sd">    waveform_extractor : si.WaveformExtractor object</span>
<span class="sd">    metrics : dict, optional</span>
<span class="sd">        Cluster metrics.</span>
<span class="sd">    labels : dict, optional</span>
<span class="sd">        Curation labels for clusters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    units_object_id : str</span>
<span class="sd">        The NWB object id of the Units object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
        <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">waveform_extractor</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_ids</span><span class="p">():</span>
            <span class="c1"># (spikes, samples, channels)</span>
            <span class="n">waveforms</span> <span class="o">=</span> <span class="n">waveform_extractor</span><span class="o">.</span><span class="n">get_waveforms</span><span class="p">(</span><span class="n">unit_id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
            <span class="c1"># (channels, spikes, samples)</span>
            <span class="n">waveforms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">waveforms</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span>
                <span class="n">spike_times</span><span class="o">=</span><span class="n">waveform_extractor</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_spike_train</span><span class="p">(</span>
                    <span class="n">unit_id</span><span class="o">=</span><span class="nb">id</span>
                <span class="p">),</span>
                <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
                <span class="n">electrodes</span><span class="o">=</span><span class="n">waveform_extractor</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">(),</span>
                <span class="n">waveforms</span><span class="o">=</span><span class="n">waveforms</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># The following is a rough sketch of AnalysisNwbfile().add_waveforms</span>
        <span class="c1"># analysis_file_name = AnalysisNwbfile().create(key[&#39;nwb_file_name&#39;])</span>
        <span class="c1"># or</span>
        <span class="c1"># nwbfile = pynwb.NWBFile(...)</span>
        <span class="c1"># (channels, spikes, samples)</span>
        <span class="c1"># wfs = [</span>
        <span class="c1">#         [     # elec 1</span>
        <span class="c1">#             [1, 2, 3],  # spike 1, [sample 1, sample 2, sample 3]</span>
        <span class="c1">#             [1, 2, 3],  # spike 2</span>
        <span class="c1">#             [1, 2, 3],  # spike 3</span>
        <span class="c1">#             [1, 2, 3]   # spike 4</span>
        <span class="c1">#         ], [  # elec 2</span>
        <span class="c1">#             [1, 2, 3],  # spike 1</span>
        <span class="c1">#             [1, 2, 3],  # spike 2</span>
        <span class="c1">#             [1, 2, 3],  # spike 3</span>
        <span class="c1">#             [1, 2, 3]   # spike 4</span>
        <span class="c1">#         ], [  # elec 3</span>
        <span class="c1">#             [1, 2, 3],  # spike 1</span>
        <span class="c1">#             [1, 2, 3],  # spike 2</span>
        <span class="c1">#             [1, 2, 3],  # spike 3</span>
        <span class="c1">#             [1, 2, 3]   # spike 4</span>
        <span class="c1">#         ]</span>
        <span class="c1"># ]</span>
        <span class="c1"># elecs = ... # DynamicTableRegion referring to three electrodes (rows) of the electrodes table</span>
        <span class="c1"># nwbfile.add_unit(spike_times=[1, 2, 3], electrodes=elecs, waveforms=wfs)</span>

        <span class="c1"># If metrics were specified, add one column per metric</span>
        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding metric </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">metric_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">metric_data</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">metric_data</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;label given during curation&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">object_id</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units_metrics" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_units_metrics</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units_metrics" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add units to analysis NWB file along with the waveforms</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>analysis_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>metrics</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Cluster metrics.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>units_object_id</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The NWB object id of the Units object</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_units_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add units to analysis NWB file along with the waveforms</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the analysis NWB file.</span>
<span class="sd">    metrics : dict, optional</span>
<span class="sd">        Cluster metrics.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    units_object_id : str</span>
<span class="sd">        The NWB object id of the Units object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metric_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">unit_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
        <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">unit_ids</span><span class="p">:</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding metric </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">metric_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">metric_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">metric_data</span>
            <span class="p">)</span>

        <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">object_id</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.get_electrode_indices" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_electrode_indices</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.get_electrode_indices" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Given an analysis NWB file name, returns the indices of the specified electrode_ids.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>analysis_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>electrode_ids</code></td>
          <td>
                <code>numpy array or list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Array or list of electrode IDs.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>electrode_indices</code></td>          <td>
                <code>numpy array</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Array of indices in the electrodes table for the given electrode IDs.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">get_electrode_indices</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given an analysis NWB file name, returns the indices of the specified electrode_ids.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the analysis NWB file.</span>
<span class="sd">    electrode_ids : numpy array or list</span>
<span class="sd">        Array or list of electrode IDs.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    electrode_indices : numpy array</span>
<span class="sd">        Array of indices in the electrodes table for the given electrode IDs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nwbf</span> <span class="o">=</span> <span class="n">get_nwb_file</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">get_electrode_indices</span><span class="p">(</span><span class="n">nwbf</span><span class="o">.</span><span class="n">electrodes</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.cleanup" class="doc doc-heading">
<code class="highlight language-python"><span class="n">cleanup</span><span class="p">(</span><span class="n">delete_files</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.cleanup" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Remove the filepath entries for NWB files that are not in use.</p>
<p>Does not delete the files themselves unless delete_files=True is specified.
Run this after deleting the Nwbfile() entries themselves.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>delete_files</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Whether the original files should be deleted (default False).</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">delete_files</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove the filepath entries for NWB files that are not in use.</span>

<span class="sd">    Does not delete the files themselves unless delete_files=True is specified.</span>
<span class="sd">    Run this after deleting the Nwbfile() entries themselves.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    delete_files : bool, optional</span>
<span class="sd">        Whether the original files should be deleted (default False).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">external</span><span class="p">[</span><span class="s2">&quot;analysis&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">delete_external_files</span><span class="o">=</span><span class="n">delete_files</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.position.v1.position_dlc_cohort.DLCSmoothInterp" class="doc doc-heading">
        <code>DLCSmoothInterp</code>


<a href="#src.spyglass.position.v1.position_dlc_cohort.DLCSmoothInterp" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Computed">Computed</span></code></p>

  
      <p>Interpolates across low likelihood periods and smooths the position
Can take a few minutes.</p>


        <details class="quote">
          <summary>Source code in <code>src/spyglass/position/v1/position_dlc_position.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">DLCSmoothInterp</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Computed</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interpolates across low likelihood periods and smooths the position</span>
<span class="sd">    Can take a few minutes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; DLCSmoothInterpSelection</span>
<span class="s2">    ---</span>
<span class="s2">    -&gt; AnalysisNwbfile</span>
<span class="s2">    dlc_smooth_interp_position_object_id : varchar(80)</span>
<span class="s2">    dlc_smooth_interp_info_object_id : varchar(80)</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.dlc_utils</span> <span class="kn">import</span> <span class="n">OutputLogger</span><span class="p">,</span> <span class="n">infer_output_dir</span>

        <span class="n">METERS_PER_CM</span> <span class="o">=</span> <span class="mf">0.01</span>

        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">infer_output_dir</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">makedir</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">OutputLogger</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s1">&#39;nwb_file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s1">&#39;dlc_model_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_log&quot;</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">/log.log&quot;</span><span class="p">,</span>
            <span class="n">print_console</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-----------------------&quot;</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span>
            <span class="c1"># Get labels to smooth from Parameters table</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">DLCSmoothInterpParams</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">)</span>
            <span class="c1"># Get DLC output dataframe</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;fetching Pose Estimation Dataframe&quot;</span><span class="p">)</span>
            <span class="n">dlc_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">DLCPoseEstimation</span><span class="o">.</span><span class="n">BodyPart</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1_dataframe</span><span class="p">()</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dlc_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()))</span>
            <span class="n">sampling_rate</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">dt</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Identifying indices to NaN&quot;</span><span class="p">)</span>
            <span class="n">df_w_nans</span><span class="p">,</span> <span class="n">bad_inds</span> <span class="o">=</span> <span class="n">nan_inds</span><span class="p">(</span>
                <span class="n">dlc_df</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;max_cm_between_pts&quot;</span><span class="p">],</span>
                <span class="n">likelihood_thresh</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;likelihood_thresh&quot;</span><span class="p">),</span>
                <span class="n">inds_to_span</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;num_inds_to_span&quot;</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="n">nan_spans</span> <span class="o">=</span> <span class="n">get_span_start_stop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bad_inds</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;interpolate&quot;</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;interpolating across low likelihood times&quot;</span><span class="p">)</span>
                <span class="n">interp_df</span> <span class="o">=</span> <span class="n">interp_pos</span><span class="p">(</span>
                    <span class="n">df_w_nans</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">nan_spans</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;interp_params&quot;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">interp_df</span> <span class="o">=</span> <span class="n">df_w_nans</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;skipping interpolation&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;smooth&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s2">&quot;smoothing_duration&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;smoothing_params&quot;</span><span class="p">]:</span>
                    <span class="n">smoothing_duration</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;smoothing_params&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
                        <span class="s2">&quot;smoothing_duration&quot;</span>
                    <span class="p">)</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dlc_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()))</span>
                <span class="n">sampling_rate</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">dt</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;smoothing position&quot;</span><span class="p">)</span>
                <span class="n">smooth_func</span> <span class="o">=</span> <span class="n">_key_to_smooth_func_dict</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;smoothing_params&quot;</span><span class="p">][</span><span class="s2">&quot;smooth_method&quot;</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Smoothing using method: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;smoothing_params&quot;</span><span class="p">][</span><span class="s2">&quot;smooth_method&quot;</span><span class="p">]),</span>
                <span class="p">)</span>
                <span class="n">smooth_df</span> <span class="o">=</span> <span class="n">smooth_func</span><span class="p">(</span>
                    <span class="n">interp_df</span><span class="p">,</span>
                    <span class="n">smoothing_duration</span><span class="o">=</span><span class="n">smoothing_duration</span><span class="p">,</span>
                    <span class="n">sampling_rate</span><span class="o">=</span><span class="n">sampling_rate</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;smoothing_params&quot;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">smooth_df</span> <span class="o">=</span> <span class="n">interp_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;skipping smoothing&quot;</span><span class="p">)</span>
            <span class="n">final_df</span> <span class="o">=</span> <span class="n">smooth_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;likelihood&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">final_df</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">position_nwb_data</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">DLCPoseEstimation</span><span class="o">.</span><span class="n">BodyPart</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span>
                <span class="o">.</span><span class="n">fetch_nwb</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;dlc_pose_estimation_position&quot;</span><span class="p">]</span>
                <span class="o">.</span><span class="n">get_spatial_series</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># Add dataframe to AnalysisNwbfile</span>
            <span class="n">nwb_analysis_file</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="p">()</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">Position</span><span class="p">()</span>
            <span class="n">video_frame_ind</span> <span class="o">=</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">BehavioralTimeSeries</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating NWB objects&quot;</span><span class="p">)</span>
            <span class="n">position</span><span class="o">.</span><span class="n">create_spatial_series</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
                <span class="n">timestamps</span><span class="o">=</span><span class="n">final_df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                <span class="n">conversion</span><span class="o">=</span><span class="n">METERS_PER_CM</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">final_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                <span class="n">reference_frame</span><span class="o">=</span><span class="n">position_nwb_data</span><span class="o">.</span><span class="n">reference_frame</span><span class="p">,</span>
                <span class="n">comments</span><span class="o">=</span><span class="n">position_nwb_data</span><span class="o">.</span><span class="n">comments</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;x_position, y_position&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">video_frame_ind</span><span class="o">.</span><span class="n">create_timeseries</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;video_frame_ind&quot;</span><span class="p">,</span>
                <span class="n">timestamps</span><span class="o">=</span><span class="n">final_df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                <span class="n">data</span><span class="o">=</span><span class="n">final_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[</span><span class="s2">&quot;video_frame_ind&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span>
                <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;no comments&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;video_frame_ind&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">key</span><span class="p">[</span>
                <span class="s2">&quot;dlc_smooth_interp_position_object_id&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">nwb_analysis_file</span><span class="o">.</span><span class="n">add_nwb_object</span><span class="p">(</span>
                <span class="n">analysis_file_name</span><span class="o">=</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">],</span>
                <span class="n">nwb_object</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">key</span><span class="p">[</span>
                <span class="s2">&quot;dlc_smooth_interp_info_object_id&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">nwb_analysis_file</span><span class="o">.</span><span class="n">add_nwb_object</span><span class="p">(</span>
                <span class="n">analysis_file_name</span><span class="o">=</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">],</span>
                <span class="n">nwb_object</span><span class="o">=</span><span class="n">video_frame_ind</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">nwb_analysis_file</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">nwb_file_name</span><span class="o">=</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">],</span>
                <span class="n">analysis_file_name</span><span class="o">=</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;inserted entry into DLCSmoothInterp&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fetch_nwb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fetch_nwb</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">AnalysisNwbfile</span><span class="p">,</span> <span class="s2">&quot;analysis_file_abs_path&quot;</span><span class="p">),</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">fetch1_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nwb_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_nwb</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                <span class="n">nwb_data</span><span class="p">[</span><span class="s2">&quot;dlc_smooth_interp_position&quot;</span><span class="p">]</span>
                <span class="o">.</span><span class="n">get_spatial_series</span><span class="p">()</span>
                <span class="o">.</span><span class="n">timestamps</span>
            <span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">COLUMNS</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;video_frame_ind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;x&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                        <span class="n">nwb_data</span><span class="p">[</span><span class="s2">&quot;dlc_smooth_interp_info&quot;</span><span class="p">]</span>
                        <span class="o">.</span><span class="n">time_series</span><span class="p">[</span><span class="s2">&quot;video_frame_ind&quot;</span><span class="p">]</span>
                        <span class="o">.</span><span class="n">data</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                    <span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                        <span class="n">nwb_data</span><span class="p">[</span><span class="s2">&quot;dlc_smooth_interp_position&quot;</span><span class="p">]</span>
                        <span class="o">.</span><span class="n">get_spatial_series</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">data</span>
                    <span class="p">),</span>
                <span class="p">),</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">COLUMNS</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">





  </div>

  </div>

</div>




  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../position_dlc_centroid/" class="md-footer__link md-footer__link--prev" aria-label="Previous: position_dlc_centroid.py" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                position_dlc_centroid.py
              </div>
            </div>
          </a>
        
        
          
          <a href="../position_dlc_model/" class="md-footer__link md-footer__link--next" aria-label="Next: position_dlc_model.py" rel="next">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                position_dlc_model.py
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright (c) 2020-present Loren Frank
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/LorenFrankLab/spyglass" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/spyglass-neuro/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6zM286.2 404c11.1 0 20.1 9.1 20.1 20.3 0 11.3-9 20.4-20.1 20.4-11 0-20.1-9.2-20.1-20.4.1-11.3 9.1-20.3 20.1-20.3zM167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4zm-6.7-142.6c-11.1 0-20.1-9.1-20.1-20.3.1-11.3 9-20.4 20.1-20.4 11 0 20.1 9.2 20.1 20.4s-9 20.3-20.1 20.3z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../../../../..", "features": ["toc.integrate", "navigation.sections", "navigation.expand", "navigation.top", "navigation.instant", "navigation.tracking", "navigation.top", "search.suggest", "search.share", "navigation.footer"], "search": "../../../../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../../../../assets/javascripts/bundle.b425cdc4.min.js"></script>
      
    
  </body>
</html>