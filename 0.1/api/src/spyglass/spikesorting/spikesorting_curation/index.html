
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Spyglass Documentation">
      
      
        <meta name="author" content="CBroz1">
      
      
        <link rel="canonical" href="https://lorenfranklab.github.io/spyglass/latest/api/src/spyglass/spikesorting/spikesorting_curation/">
      
      
        <link rel="prev" href="../spikesorting_artifact/">
      
      
        <link rel="next" href="../spikesorting_recording/">
      
      <link rel="icon" href="../../../../../images/Spyglass.svg">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.17">
    
    
      
        <title>spikesorting_curation.py - Spyglass</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="auto" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#src.spyglass.spikesorting.spikesorting_curation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="Spyglass" class="md-header__button md-logo" aria-label="Spyglass" data-md-component="logo">
      
  <img src="../../../../../images/FrankLab.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Spyglass
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              spikesorting_curation.py
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="auto" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: slate)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/LorenFrankLab/spyglass" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Spyglass" class="md-nav__button md-logo" aria-label="Spyglass" data-md-component="logo">
      
  <img src="../../../../../images/FrankLab.png" alt="logo">

    </a>
    Spyglass
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/LorenFrankLab/spyglass" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../installation/" class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../installation/local/" class="md-nav__link">
        Local
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../installation/production/" class="md-nav__link">
        Productions
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/00_intro/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/01_spikesorting/" class="md-nav__link">
        Spike Sorting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/02_curation/" class="md-nav__link">
        Curation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/03_lfp/" class="md-nav__link">
        LFP
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_5" >
      
      
      
        <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
          Position
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_5">
          <span class="md-nav__icon md-icon"></span>
          Position
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/4_position_info/" class="md-nav__link">
        Information
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/04_Trodes_position/" class="md-nav__link">
        Pipeline
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/05_DLC_from_scratch/" class="md-nav__link">
        From Scratch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/06_DLC_from_dir/" class="md-nav__link">
        From Pre-Trained
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/07_linearization/" class="md-nav__link">
        Linearization Pipeline
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/08_Extract_Mark_indicators/" class="md-nav__link">
        Mark Indicators
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/09_Decoding_with_GPUs_on_the_GPU_cluster/" class="md-nav__link">
        GPU
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/10_1D_Clusterless_Decoding/" class="md-nav__link">
        1D Clusterless Decoding
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/11_2D_Clusterless_Decoding/" class="md-nav__link">
        2D Clusterless Decoding
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/12_Ripple_Detection/" class="md-nav__link">
        Ripple Detection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/docker_mysql_tutorial/" class="md-nav__link">
        Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../notebooks/Spyglass_kachery_setup/" class="md-nav__link">
        Spyglass Kachery Setup
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          API Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          API Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
          src
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          src
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_1" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1" id="__nav_4_1_1_label" tabindex="0">
          spyglass
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_1_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4_1_1">
          <span class="md-nav__icon md-icon"></span>
          spyglass
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_version/" class="md-nav__link">
        _version.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_2" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_2" id="__nav_4_1_1_2_label" tabindex="0">
          cli
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_2">
          <span class="md-nav__icon md-icon"></span>
          cli
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/cli/" class="md-nav__link">
        cli.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_3" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_3" id="__nav_4_1_1_3_label" tabindex="0">
          common
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_3">
          <span class="md-nav__icon md-icon"></span>
          common
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/common_backup/" class="md-nav__link">
        common_backup.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/common_behav/" class="md-nav__link">
        common_behav.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/common_device/" class="md-nav__link">
        common_device.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/common_dio/" class="md-nav__link">
        common_dio.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/common_ephys/" class="md-nav__link">
        common_ephys.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/common_filter/" class="md-nav__link">
        common_filter.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/common_interval/" class="md-nav__link">
        common_interval.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/common_lab/" class="md-nav__link">
        common_lab.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/common_nwbfile/" class="md-nav__link">
        common_nwbfile.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/common_position/" class="md-nav__link">
        common_position.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/common_region/" class="md-nav__link">
        common_region.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/common_ripple/" class="md-nav__link">
        common_ripple.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/common_sensors/" class="md-nav__link">
        common_sensors.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/common_session/" class="md-nav__link">
        common_session.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/common_subject/" class="md-nav__link">
        common_subject.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/common_task/" class="md-nav__link">
        common_task.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/errors/" class="md-nav__link">
        errors.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/populate_all_common/" class="md-nav__link">
        populate_all_common.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_3_19" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_3_19" id="__nav_4_1_1_3_19_label" tabindex="0">
          prepopulate
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_4_1_1_3_19_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_3_19">
          <span class="md-nav__icon md-icon"></span>
          prepopulate
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/prepopulate/prepopulate/" class="md-nav__link">
        prepopulate.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/signal_processing/" class="md-nav__link">
        signal_processing.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_4" id="__nav_4_1_1_4_label" tabindex="0">
          data_import
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_4">
          <span class="md-nav__icon md-icon"></span>
          data_import
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../data_import/insert_sessions/" class="md-nav__link">
        insert_sessions.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../data_import/storage_dirs/" class="md-nav__link">
        storage_dirs.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_5" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_5" id="__nav_4_1_1_5_label" tabindex="0">
          decoding
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_5">
          <span class="md-nav__icon md-icon"></span>
          decoding
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../decoding/clusterless/" class="md-nav__link">
        clusterless.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../decoding/core/" class="md-nav__link">
        core.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../decoding/dj_decoder_conversion/" class="md-nav__link">
        dj_decoder_conversion.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../decoding/sorted_spikes/" class="md-nav__link">
        sorted_spikes.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../decoding/visualization/" class="md-nav__link">
        visualization.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../decoding/visualization_1D_view/" class="md-nav__link">
        visualization_1D_view.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../decoding/visualization_2D_view/" class="md-nav__link">
        visualization_2D_view.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_6" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_6" id="__nav_4_1_1_6_label" tabindex="0">
          figurl_views
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_6">
          <span class="md-nav__icon md-icon"></span>
          figurl_views
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../figurl_views/SpikeSortingRecordingView/" class="md-nav__link">
        SpikeSortingRecordingView.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../figurl_views/SpikeSortingView/" class="md-nav__link">
        SpikeSortingView.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../figurl_views/prepare_spikesortingview_data/" class="md-nav__link">
        prepare_spikesortingview_data.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_7" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_7" id="__nav_4_1_1_7_label" tabindex="0">
          lfp
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_7">
          <span class="md-nav__icon md-icon"></span>
          lfp
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lfp/lfp_merge/" class="md-nav__link">
        lfp_merge.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_7_2" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_7_2" id="__nav_4_1_1_7_2_label" tabindex="0">
          v1
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_4_1_1_7_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_7_2">
          <span class="md-nav__icon md-icon"></span>
          v1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lfp/v1/lfp/" class="md-nav__link">
        lfp.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lfp/v1/lfp_artifact/" class="md-nav__link">
        lfp_artifact.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lfp/v1/lfp_artifact_MAD_detection/" class="md-nav__link">
        lfp_artifact_MAD_detection.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lfp/v1/lfp_artifact_difference_detection/" class="md-nav__link">
        lfp_artifact_difference_detection.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_8" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_8" id="__nav_4_1_1_8_label" tabindex="0">
          lfp_band
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_8">
          <span class="md-nav__icon md-icon"></span>
          lfp_band
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lfp_band/lfp_band_merge/" class="md-nav__link">
        lfp_band_merge.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_8_2" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_8_2" id="__nav_4_1_1_8_2_label" tabindex="0">
          v1
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_4_1_1_8_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_8_2">
          <span class="md-nav__icon md-icon"></span>
          v1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lfp_band/v1/lfp_band/" class="md-nav__link">
        lfp_band.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_9" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_9" id="__nav_4_1_1_9_label" tabindex="0">
          lock
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_9">
          <span class="md-nav__icon md-icon"></span>
          lock
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lock/file_lock/" class="md-nav__link">
        file_lock.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_10" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_10" id="__nav_4_1_1_10_label" tabindex="0">
          position
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_10">
          <span class="md-nav__icon md-icon"></span>
          position
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/position_merge/" class="md-nav__link">
        position_merge.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_10_2" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_10_2" id="__nav_4_1_1_10_2_label" tabindex="0">
          v1
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_4_1_1_10_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_10_2">
          <span class="md-nav__icon md-icon"></span>
          v1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/dlc_decorators/" class="md-nav__link">
        dlc_decorators.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/dlc_reader/" class="md-nav__link">
        dlc_reader.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/dlc_utils/" class="md-nav__link">
        dlc_utils.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_dlc_centroid/" class="md-nav__link">
        position_dlc_centroid.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_dlc_cohort/" class="md-nav__link">
        position_dlc_cohort.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_dlc_model/" class="md-nav__link">
        position_dlc_model.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_dlc_orient/" class="md-nav__link">
        position_dlc_orient.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_dlc_pose_estimation/" class="md-nav__link">
        position_dlc_pose_estimation.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_dlc_position/" class="md-nav__link">
        position_dlc_position.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_dlc_project/" class="md-nav__link">
        position_dlc_project.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_dlc_selection/" class="md-nav__link">
        position_dlc_selection.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_dlc_training/" class="md-nav__link">
        position_dlc_training.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../position/v1/position_trodes_position/" class="md-nav__link">
        position_trodes_position.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../settings/" class="md-nav__link">
        settings.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_12" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_12" id="__nav_4_1_1_12_label" tabindex="0">
          sharing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_12_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_12">
          <span class="md-nav__icon md-icon"></span>
          sharing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../sharing/sharing_kachery/" class="md-nav__link">
        sharing_kachery.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_1_13" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_13" id="__nav_4_1_1_13_label" tabindex="0">
          spikesorting
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_13_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4_1_1_13">
          <span class="md-nav__icon md-icon"></span>
          spikesorting
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../curation_figurl/" class="md-nav__link">
        curation_figurl.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../merged_sorting_extractor/" class="md-nav__link">
        merged_sorting_extractor.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sortingview/" class="md-nav__link">
        sortingview.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sortingview_helper_fn/" class="md-nav__link">
        sortingview_helper_fn.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spikesorting_artifact/" class="md-nav__link">
        spikesorting_artifact.py
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          spikesorting_curation.py
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        spikesorting_curation.py
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation" class="md-nav__link">
    src.spyglass.spikesorting.spikesorting_curation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.IntervalList" class="md-nav__link">
    IntervalList
  </a>
  
    <nav class="md-nav" aria-label="IntervalList">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_interval.IntervalList.insert_from_nwbfile" class="md-nav__link">
    insert_from_nwbfile()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.Curation" class="md-nav__link">
    Curation
  </a>
  
    <nav class="md-nav" aria-label="Curation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.Curation.insert_curation" class="md-nav__link">
    insert_curation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.Curation.get_recording" class="md-nav__link">
    get_recording()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.Curation.get_curated_sorting" class="md-nav__link">
    get_curated_sorting()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.Curation.save_sorting_nwb" class="md-nav__link">
    save_sorting_nwb()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.fetch_nwb" class="md-nav__link">
    fetch_nwb()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.SpikeSorting" class="md-nav__link">
    SpikeSorting
  </a>
  
    <nav class="md-nav" aria-label="SpikeSorting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_sorting.SpikeSorting.make" class="md-nav__link">
    make()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_sorting.SpikeSorting.delete" class="md-nav__link">
    delete()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_sorting.SpikeSorting.nightly_cleanup" class="md-nav__link">
    nightly_cleanup()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.AnalysisNwbfile" class="md-nav__link">
    AnalysisNwbfile
  </a>
  
    <nav class="md-nav" aria-label="AnalysisNwbfile">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.create" class="md-nav__link">
    create()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.copy" class="md-nav__link">
    copy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add" class="md-nav__link">
    add()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.get_abs_path" class="md-nav__link">
    get_abs_path()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_nwb_object" class="md-nav__link">
    add_nwb_object()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units" class="md-nav__link">
    add_units()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units_waveforms" class="md-nav__link">
    add_units_waveforms()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units_metrics" class="md-nav__link">
    add_units_metrics()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.get_electrode_indices" class="md-nav__link">
    get_electrode_indices()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.cleanup" class="md-nav__link">
    cleanup()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.Waveforms" class="md-nav__link">
    Waveforms
  </a>
  
    <nav class="md-nav" aria-label="Waveforms">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.Waveforms.load_waveforms" class="md-nav__link">
    load_waveforms()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.SpikeSortingRecording" class="md-nav__link">
    SpikeSortingRecording
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.MetricParameters" class="md-nav__link">
    MetricParameters
  </a>
  
    <nav class="md-nav" aria-label="MetricParameters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.MetricParameters.get_metric_default_params" class="md-nav__link">
    get_metric_default_params()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.AutomaticCuration" class="md-nav__link">
    AutomaticCuration
  </a>
  
    <nav class="md-nav" aria-label="AutomaticCuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.AutomaticCuration.get_merge_groups" class="md-nav__link">
    get_merge_groups()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.AutomaticCuration.get_labels" class="md-nav__link">
    get_labels()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.CuratedSpikeSorting" class="md-nav__link">
    CuratedSpikeSorting
  </a>
  
    <nav class="md-nav" aria-label="CuratedSpikeSorting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.CuratedSpikeSorting.metrics_fields" class="md-nav__link">
    metrics_fields()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.UnitInclusionParameters" class="md-nav__link">
    UnitInclusionParameters
  </a>
  
    <nav class="md-nav" aria-label="UnitInclusionParameters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.spyglass.spikesorting.spikesorting_curation.UnitInclusionParameters.get_included_units" class="md-nav__link">
    get_included_units()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spikesorting_recording/" class="md-nav__link">
        spikesorting_recording.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spikesorting_sorting/" class="md-nav__link">
        spikesorting_sorting.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1_1_14" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1_1_14" id="__nav_4_1_1_14_label" tabindex="0">
          utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_14_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_1_14">
          <span class="md-nav__icon md-icon"></span>
          utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/dj_helper_fn/" class="md-nav__link">
        dj_helper_fn.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/dj_merge_tables/" class="md-nav__link">
        dj_merge_tables.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/nwb_helper_fn/" class="md-nav__link">
        nwb_helper_fn.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../../contribute/" class="md-nav__link">
        How to Contribute
      </a>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Miscellaneous
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Miscellaneous
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/figurl_views/" class="md-nav__link">
        FigURL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/session_groups/" class="md-nav__link">
        Session Groups
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/insert_data/" class="md-nav__link">
        Insert Data
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../../CHANGELOG/" class="md-nav__link">
        Change Log
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../../LICENSE/" class="md-nav__link">
        Copyright
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>spikesorting_curation.py</h1>

<div class="doc doc-object doc-module">


<a id="src.spyglass.spikesorting.spikesorting_curation"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">







<div class="doc doc-object doc-class">



<h2 id="src.spyglass.spikesorting.spikesorting_curation.IntervalList" class="doc doc-heading">
        <code>IntervalList</code>


<a href="#src.spyglass.spikesorting.spikesorting_curation.IntervalList" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Manual">Manual</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/common/common_interval.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">IntervalList</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # Time intervals used for analysis</span>
<span class="s2">    -&gt; Session</span>
<span class="s2">    interval_list_name: varchar(200)  # descriptive name of this interval list</span>
<span class="s2">    ---</span>
<span class="s2">    valid_times: longblob  # numpy array with start and end times for each interval</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">insert_from_nwbfile</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add each entry in the NWB file epochs table to the IntervalList table.</span>

<span class="sd">        The interval list name for each epoch is set to the first tag for the epoch.</span>
<span class="sd">        If the epoch has no tags, then &#39;interval_x&#39; will be used as the interval list name, where x is the index</span>
<span class="sd">        (0-indexed) of the epoch in the epochs table.</span>
<span class="sd">        The start time and stop time of the epoch are stored in the valid_times field as a numpy array of</span>
<span class="sd">        [start time, stop time] for each epoch.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nwbf : pynwb.NWBFile</span>
<span class="sd">            The source NWB file object.</span>
<span class="sd">        nwb_file_name : str</span>
<span class="sd">            The file name of the NWB file, used as a primary key to the Session table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">epochs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No epochs found in NWB file.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">epochs</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">epochs</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">epoch_index</span><span class="p">,</span> <span class="n">epoch_data</span> <span class="ow">in</span> <span class="n">epochs</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">epoch_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">epoch_dict</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_file_name</span>
            <span class="k">if</span> <span class="n">epoch_data</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">epoch_dict</span><span class="p">[</span><span class="s2">&quot;interval_list_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_data</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epoch_dict</span><span class="p">[</span><span class="s2">&quot;interval_list_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;interval_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="n">epoch_index</span>
                <span class="p">)</span>
            <span class="n">epoch_dict</span><span class="p">[</span><span class="s2">&quot;valid_times&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">epoch_data</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">epoch_data</span><span class="o">.</span><span class="n">stop_time</span><span class="p">]]</span>
            <span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">epoch_dict</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">)):</span>
        <span class="n">interval_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">interval_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">interval_list</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">valid_times</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="p">[</span><span class="n">interval_count</span><span class="p">,</span> <span class="n">interval_count</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">interval</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">interval_count</span><span class="p">,</span> <span class="n">interval_count</span><span class="p">],</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">interval_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">interval_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">interval_list</span><span class="o">.</span><span class="n">interval_list_name</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [s]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_epoch_pos_raw_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">)):</span>
        <span class="n">interval_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="n">raw_data_valid_times</span> <span class="o">=</span> <span class="n">interval_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">interval_list</span><span class="o">.</span><span class="n">interval_list_name</span> <span class="o">==</span> <span class="s2">&quot;raw data valid times&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">valid_times</span>
        <span class="n">interval_y</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">raw_data_valid_times</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="p">[</span><span class="n">interval_y</span><span class="p">,</span> <span class="n">interval_y</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="p">[</span><span class="n">interval_y</span><span class="p">,</span> <span class="n">interval_y</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">epoch_valid_times</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">interval_list</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;interval_list_name&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;^[0-9]&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="o">.</span><span class="n">valid_times</span>
        <span class="p">)</span>
        <span class="n">interval_y</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">valid_times</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">epoch_valid_times</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">epoch_valid_times</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">valid_times</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="p">[</span><span class="n">interval_y</span><span class="p">,</span> <span class="n">interval_y</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">interval</span><span class="p">,</span> <span class="p">[</span><span class="n">interval_y</span><span class="p">,</span> <span class="n">interval_y</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">interval</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">interval_y</span><span class="p">,</span>
                    <span class="n">epoch</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">pos_valid_times</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">interval_list</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;interval_list_name&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;^pos \d+ valid times$&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="o">.</span><span class="n">valid_times</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">index</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">index</span><span class="p">])</span>
        <span class="n">interval_y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">valid_times</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pos_valid_times</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pos_valid_times</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">valid_times</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="p">[</span><span class="n">interval_y</span><span class="p">,</span> <span class="n">interval_y</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">interval</span><span class="p">,</span> <span class="p">[</span><span class="n">interval_y</span><span class="p">,</span> <span class="n">interval_y</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">interval</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">interval_y</span><span class="p">,</span>
                    <span class="n">epoch</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; valid times&quot;</span><span class="p">),</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">2.25</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;pos valid times&quot;</span><span class="p">,</span> <span class="s2">&quot;raw data valid times&quot;</span><span class="p">,</span> <span class="s2">&quot;epoch&quot;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [s]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_interval.IntervalList.insert_from_nwbfile" class="doc doc-heading">
<code class="highlight language-python"><span class="n">insert_from_nwbfile</span><span class="p">(</span><span class="n">nwbf</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_interval.IntervalList.insert_from_nwbfile" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add each entry in the NWB file epochs table to the IntervalList table.</p>
<p>The interval list name for each epoch is set to the first tag for the epoch.
If the epoch has no tags, then 'interval_x' will be used as the interval list name, where x is the index
(0-indexed) of the epoch in the epochs table.
The start time and stop time of the epoch are stored in the valid_times field as a numpy array of
[start time, stop time] for each epoch.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwbf</code></td>
          <td>
                <code>pynwb.<span title="pynwb.NWBFile">NWBFile</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The source NWB file object.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The file name of the NWB file, used as a primary key to the Session table.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_interval.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">insert_from_nwbfile</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add each entry in the NWB file epochs table to the IntervalList table.</span>

<span class="sd">    The interval list name for each epoch is set to the first tag for the epoch.</span>
<span class="sd">    If the epoch has no tags, then &#39;interval_x&#39; will be used as the interval list name, where x is the index</span>
<span class="sd">    (0-indexed) of the epoch in the epochs table.</span>
<span class="sd">    The start time and stop time of the epoch are stored in the valid_times field as a numpy array of</span>
<span class="sd">    [start time, stop time] for each epoch.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwbf : pynwb.NWBFile</span>
<span class="sd">        The source NWB file object.</span>
<span class="sd">    nwb_file_name : str</span>
<span class="sd">        The file name of the NWB file, used as a primary key to the Session table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">epochs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No epochs found in NWB file.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">epochs</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">epoch_index</span><span class="p">,</span> <span class="n">epoch_data</span> <span class="ow">in</span> <span class="n">epochs</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">epoch_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">epoch_dict</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_file_name</span>
        <span class="k">if</span> <span class="n">epoch_data</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">epoch_dict</span><span class="p">[</span><span class="s2">&quot;interval_list_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_data</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">epoch_dict</span><span class="p">[</span><span class="s2">&quot;interval_list_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;interval_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">epoch_index</span>
            <span class="p">)</span>
        <span class="n">epoch_dict</span><span class="p">[</span><span class="s2">&quot;valid_times&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">epoch_data</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">epoch_data</span><span class="o">.</span><span class="n">stop_time</span><span class="p">]]</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">epoch_dict</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.spikesorting.spikesorting_curation.Curation" class="doc doc-heading">
        <code>Curation</code>


<a href="#src.spyglass.spikesorting.spikesorting_curation.Curation" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Manual">Manual</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">Curation</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # Stores each spike sorting; similar to IntervalList</span>
<span class="s2">    curation_id: int # a number corresponding to the index of this curation</span>
<span class="s2">    -&gt; SpikeSorting</span>
<span class="s2">    ---</span>
<span class="s2">    parent_curation_id=-1: int</span>
<span class="s2">    curation_labels: blob # a dictionary of labels for the units</span>
<span class="s2">    merge_groups: blob # a list of merge groups for the units</span>
<span class="s2">    quality_metrics: blob # a list of quality metrics for the units (if available)</span>
<span class="s2">    description=&#39;&#39;: varchar(1000) #optional description for this curated sort</span>
<span class="s2">    time_of_creation: int   # in Unix time, to the nearest second</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">insert_curation</span><span class="p">(</span>
        <span class="n">sorting_key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">parent_curation_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">merge_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a SpikeSorting key and the parent_sorting_id (and optional</span>
<span class="sd">        arguments) insert an entry into Curation.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sorting_key : dict</span>
<span class="sd">            The key for the original SpikeSorting</span>
<span class="sd">        parent_curation_id : int, optional</span>
<span class="sd">            The id of the parent sorting</span>
<span class="sd">        labels : dict or None, optional</span>
<span class="sd">        merge_groups : dict or None, optional</span>
<span class="sd">        metrics : dict or None, optional</span>
<span class="sd">            Computed metrics for sorting</span>
<span class="sd">        description : str, optional</span>
<span class="sd">            text description of this sort</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        curation_key : dict</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">parent_curation_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># check to see if this sorting with a parent of -1 has already been inserted and if so, warn the user</span>
            <span class="n">inserted_curation</span> <span class="o">=</span> <span class="p">(</span><span class="n">Curation</span> <span class="o">&amp;</span> <span class="n">sorting_key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;KEY&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inserted_curation</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="ne">Warning</span><span class="p">(</span>
                    <span class="s2">&quot;Sorting has already been inserted, returning key to previously&quot;</span>
                    <span class="s2">&quot;inserted curation&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">inserted_curation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">merge_groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">merge_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># generate a unique number for this curation</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">Curation</span> <span class="o">&amp;</span> <span class="n">sorting_key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;curation_id&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">curation_id</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">curation_id</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># convert unit_ids in labels to integers for labels from sortingview.</span>
        <span class="n">new_labels</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">unit_id</span><span class="p">):</span> <span class="n">labels</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">unit_id</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">}</span>

        <span class="n">sorting_key</span><span class="p">[</span><span class="s2">&quot;curation_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curation_id</span>
        <span class="n">sorting_key</span><span class="p">[</span><span class="s2">&quot;parent_curation_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_curation_id</span>
        <span class="n">sorting_key</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>
        <span class="n">sorting_key</span><span class="p">[</span><span class="s2">&quot;curation_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_labels</span>
        <span class="n">sorting_key</span><span class="p">[</span><span class="s2">&quot;merge_groups&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merge_groups</span>
        <span class="n">sorting_key</span><span class="p">[</span><span class="s2">&quot;quality_metrics&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span>
        <span class="n">sorting_key</span><span class="p">[</span><span class="s2">&quot;time_of_creation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

        <span class="c1"># mike: added skip duplicates</span>
        <span class="n">Curation</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">sorting_key</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># get the primary key for this curation</span>
        <span class="n">c_key</span> <span class="o">=</span> <span class="n">Curation</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;KEY&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">curation_key</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">:</span> <span class="n">sorting_key</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">c_key</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">curation_key</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_recording</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the recording extractor for the recording related to this curation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : dict</span>
<span class="sd">            SpikeSortingRecording key</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        recording_extractor : spike interface recording extractor</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">recording_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">SpikeSortingRecording</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;recording_path&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">si</span><span class="o">.</span><span class="n">load_extractor</span><span class="p">(</span><span class="n">recording_path</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_curated_sorting</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the sorting extractor related to this curation,</span>
<span class="sd">        with merges applied.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : dict</span>
<span class="sd">            Curation key</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sorting_extractor: spike interface sorting extractor</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sorting_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">SpikeSorting</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;sorting_path&quot;</span><span class="p">)</span>
        <span class="n">sorting</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">load_extractor</span><span class="p">(</span><span class="n">sorting_path</span><span class="p">)</span>
        <span class="n">merge_groups</span> <span class="o">=</span> <span class="p">(</span><span class="n">Curation</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;merge_groups&quot;</span><span class="p">)</span>
        <span class="c1"># TODO: write code to get merged sorting extractor</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">merge_groups</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MergedSortingExtractor</span><span class="p">(</span>
                <span class="n">parent_sorting</span><span class="o">=</span><span class="n">sorting</span><span class="p">,</span> <span class="n">merge_groups</span><span class="o">=</span><span class="n">merge_groups</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sorting</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">save_sorting_nwb</span><span class="p">(</span>
        <span class="n">key</span><span class="p">,</span>
        <span class="n">sorting</span><span class="p">,</span>
        <span class="n">timestamps</span><span class="p">,</span>
        <span class="n">sort_interval_list_name</span><span class="p">,</span>
        <span class="n">sort_interval</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">unit_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store a sorting in a new AnalysisNwbfile</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : dict</span>
<span class="sd">            key to SpikeSorting table</span>
<span class="sd">        sorting : si.Sorting</span>
<span class="sd">            sorting</span>
<span class="sd">        timestamps : array_like</span>
<span class="sd">            Time stamps of the sorted recoridng;</span>
<span class="sd">            used to convert the spike timings from index to real time</span>
<span class="sd">        sort_interval_list_name : str</span>
<span class="sd">            name of sort interval</span>
<span class="sd">        sort_interval : list</span>
<span class="sd">            interval for start and end of sort</span>
<span class="sd">        labels : dict, optional</span>
<span class="sd">            curation labels, by default None</span>
<span class="sd">        metrics : dict, optional</span>
<span class="sd">            quality metrics, by default None</span>
<span class="sd">        unit_ids : list, optional</span>
<span class="sd">            IDs of units whose spiketrains to save, by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">        units_object_id : str</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sort_interval_valid_times</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">IntervalList</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;interval_list_name&quot;</span><span class="p">:</span> <span class="n">sort_interval_list_name</span><span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;valid_times&quot;</span><span class="p">)</span>

        <span class="n">units</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">units_valid_times</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">units_sort_interval</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">unit_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">unit_ids</span> <span class="o">=</span> <span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_ids</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">unit_id</span> <span class="ow">in</span> <span class="n">unit_ids</span><span class="p">:</span>
            <span class="n">spike_times_in_samples</span> <span class="o">=</span> <span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_spike_train</span><span class="p">(</span>
                <span class="n">unit_id</span><span class="o">=</span><span class="n">unit_id</span>
            <span class="p">)</span>
            <span class="n">units</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">spike_times_in_samples</span><span class="p">]</span>
            <span class="n">units_valid_times</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">sort_interval_valid_times</span>
            <span class="n">units_sort_interval</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sort_interval</span><span class="p">]</span>

        <span class="n">analysis_file_name</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">])</span>
        <span class="n">object_ids</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="p">()</span><span class="o">.</span><span class="n">add_units</span><span class="p">(</span>
            <span class="n">analysis_file_name</span><span class="p">,</span>
            <span class="n">units</span><span class="p">,</span>
            <span class="n">units_valid_times</span><span class="p">,</span>
            <span class="n">units_sort_interval</span><span class="p">,</span>
            <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">AnalysisNwbfile</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">],</span> <span class="n">analysis_file_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">object_ids</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Sorting contains no units.&quot;</span>
                <span class="s2">&quot;Created an empty analysis nwb file anyway.&quot;</span>
            <span class="p">)</span>
            <span class="n">units_object_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">units_object_id</span> <span class="o">=</span> <span class="n">object_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">units_object_id</span>

    <span class="k">def</span> <span class="nf">fetch_nwb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fetch_nwb</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">AnalysisNwbfile</span><span class="p">,</span> <span class="s2">&quot;analysis_file_abs_path&quot;</span><span class="p">),</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.spikesorting.spikesorting_curation.Curation.insert_curation" class="doc doc-heading">
<code class="highlight language-python"><span class="n">insert_curation</span><span class="p">(</span><span class="n">sorting_key</span><span class="p">,</span> <span class="n">parent_curation_id</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">merge_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#src.spyglass.spikesorting.spikesorting_curation.Curation.insert_curation" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Given a SpikeSorting key and the parent_sorting_id (and optional
arguments) insert an entry into Curation.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>sorting_key</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The key for the original SpikeSorting</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>parent_curation_id</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The id of the parent sorting</p>
            </div>
          </td>
          <td>
                <code>-1</code>
          </td>
        </tr>
        <tr>
          <td><code>labels</code></td>
          <td>
                <code>dict or None</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>merge_groups</code></td>
          <td>
                <code>dict or None</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>metrics</code></td>
          <td>
                <code>dict or None</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Computed metrics for sorting</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>description</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>text description of this sort</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>curation_key</code></td>          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">insert_curation</span><span class="p">(</span>
    <span class="n">sorting_key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">parent_curation_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">merge_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a SpikeSorting key and the parent_sorting_id (and optional</span>
<span class="sd">    arguments) insert an entry into Curation.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sorting_key : dict</span>
<span class="sd">        The key for the original SpikeSorting</span>
<span class="sd">    parent_curation_id : int, optional</span>
<span class="sd">        The id of the parent sorting</span>
<span class="sd">    labels : dict or None, optional</span>
<span class="sd">    merge_groups : dict or None, optional</span>
<span class="sd">    metrics : dict or None, optional</span>
<span class="sd">        Computed metrics for sorting</span>
<span class="sd">    description : str, optional</span>
<span class="sd">        text description of this sort</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    curation_key : dict</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">parent_curation_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="c1"># check to see if this sorting with a parent of -1 has already been inserted and if so, warn the user</span>
        <span class="n">inserted_curation</span> <span class="o">=</span> <span class="p">(</span><span class="n">Curation</span> <span class="o">&amp;</span> <span class="n">sorting_key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;KEY&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inserted_curation</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="ne">Warning</span><span class="p">(</span>
                <span class="s2">&quot;Sorting has already been inserted, returning key to previously&quot;</span>
                <span class="s2">&quot;inserted curation&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">inserted_curation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">merge_groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">merge_groups</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># generate a unique number for this curation</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">Curation</span> <span class="o">&amp;</span> <span class="n">sorting_key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;curation_id&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">curation_id</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">curation_id</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># convert unit_ids in labels to integers for labels from sortingview.</span>
    <span class="n">new_labels</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">unit_id</span><span class="p">):</span> <span class="n">labels</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">unit_id</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">}</span>

    <span class="n">sorting_key</span><span class="p">[</span><span class="s2">&quot;curation_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curation_id</span>
    <span class="n">sorting_key</span><span class="p">[</span><span class="s2">&quot;parent_curation_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_curation_id</span>
    <span class="n">sorting_key</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>
    <span class="n">sorting_key</span><span class="p">[</span><span class="s2">&quot;curation_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_labels</span>
    <span class="n">sorting_key</span><span class="p">[</span><span class="s2">&quot;merge_groups&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merge_groups</span>
    <span class="n">sorting_key</span><span class="p">[</span><span class="s2">&quot;quality_metrics&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span>
    <span class="n">sorting_key</span><span class="p">[</span><span class="s2">&quot;time_of_creation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

    <span class="c1"># mike: added skip duplicates</span>
    <span class="n">Curation</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">sorting_key</span><span class="p">,</span> <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># get the primary key for this curation</span>
    <span class="n">c_key</span> <span class="o">=</span> <span class="n">Curation</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;KEY&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">curation_key</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">:</span> <span class="n">sorting_key</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">c_key</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">curation_key</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.spikesorting.spikesorting_curation.Curation.get_recording" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_recording</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#src.spyglass.spikesorting.spikesorting_curation.Curation.get_recording" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Returns the recording extractor for the recording related to this curation</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>key</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>SpikeSortingRecording key</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>recording_extractor</code></td>          <td>
                <code>spike interface recording extractor</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">get_recording</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the recording extractor for the recording related to this curation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key : dict</span>
<span class="sd">        SpikeSortingRecording key</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    recording_extractor : spike interface recording extractor</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">recording_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">SpikeSortingRecording</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;recording_path&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">si</span><span class="o">.</span><span class="n">load_extractor</span><span class="p">(</span><span class="n">recording_path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.spikesorting.spikesorting_curation.Curation.get_curated_sorting" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_curated_sorting</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#src.spyglass.spikesorting.spikesorting_curation.Curation.get_curated_sorting" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Returns the sorting extractor related to this curation,
with merges applied.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>key</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Curation key</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>sorting_extractor</code></td>          <td>
                <code>spike interface sorting extractor</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">get_curated_sorting</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the sorting extractor related to this curation,</span>
<span class="sd">    with merges applied.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key : dict</span>
<span class="sd">        Curation key</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sorting_extractor: spike interface sorting extractor</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sorting_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">SpikeSorting</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;sorting_path&quot;</span><span class="p">)</span>
    <span class="n">sorting</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">load_extractor</span><span class="p">(</span><span class="n">sorting_path</span><span class="p">)</span>
    <span class="n">merge_groups</span> <span class="o">=</span> <span class="p">(</span><span class="n">Curation</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;merge_groups&quot;</span><span class="p">)</span>
    <span class="c1"># TODO: write code to get merged sorting extractor</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">merge_groups</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MergedSortingExtractor</span><span class="p">(</span>
            <span class="n">parent_sorting</span><span class="o">=</span><span class="n">sorting</span><span class="p">,</span> <span class="n">merge_groups</span><span class="o">=</span><span class="n">merge_groups</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sorting</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.spikesorting.spikesorting_curation.Curation.save_sorting_nwb" class="doc doc-heading">
<code class="highlight language-python"><span class="n">save_sorting_nwb</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">sorting</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">sort_interval_list_name</span><span class="p">,</span> <span class="n">sort_interval</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unit_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#src.spyglass.spikesorting.spikesorting_curation.Curation.save_sorting_nwb" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Store a sorting in a new AnalysisNwbfile</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>key</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>key to SpikeSorting table</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>sorting</code></td>
          <td>
                <code><span title="spikeinterface">si</span>.<span title="spikeinterface.Sorting">Sorting</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>sorting</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>timestamps</code></td>
          <td>
                <code>array_like</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Time stamps of the sorted recoridng;
used to convert the spike timings from index to real time</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>sort_interval_list_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of sort interval</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>sort_interval</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>interval for start and end of sort</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>labels</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>curation labels, by default None</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>metrics</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>quality metrics, by default None</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>unit_ids</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>IDs of units whose spiketrains to save, by default None</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>analysis_file_name</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
        </tr>
        <tr>
<td><code>units_object_id</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">save_sorting_nwb</span><span class="p">(</span>
    <span class="n">key</span><span class="p">,</span>
    <span class="n">sorting</span><span class="p">,</span>
    <span class="n">timestamps</span><span class="p">,</span>
    <span class="n">sort_interval_list_name</span><span class="p">,</span>
    <span class="n">sort_interval</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">unit_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store a sorting in a new AnalysisNwbfile</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key : dict</span>
<span class="sd">        key to SpikeSorting table</span>
<span class="sd">    sorting : si.Sorting</span>
<span class="sd">        sorting</span>
<span class="sd">    timestamps : array_like</span>
<span class="sd">        Time stamps of the sorted recoridng;</span>
<span class="sd">        used to convert the spike timings from index to real time</span>
<span class="sd">    sort_interval_list_name : str</span>
<span class="sd">        name of sort interval</span>
<span class="sd">    sort_interval : list</span>
<span class="sd">        interval for start and end of sort</span>
<span class="sd">    labels : dict, optional</span>
<span class="sd">        curation labels, by default None</span>
<span class="sd">    metrics : dict, optional</span>
<span class="sd">        quality metrics, by default None</span>
<span class="sd">    unit_ids : list, optional</span>
<span class="sd">        IDs of units whose spiketrains to save, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">    units_object_id : str</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sort_interval_valid_times</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">IntervalList</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;interval_list_name&quot;</span><span class="p">:</span> <span class="n">sort_interval_list_name</span><span class="p">}</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;valid_times&quot;</span><span class="p">)</span>

    <span class="n">units</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">units_valid_times</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">units_sort_interval</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">unit_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">unit_ids</span> <span class="o">=</span> <span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_ids</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">unit_id</span> <span class="ow">in</span> <span class="n">unit_ids</span><span class="p">:</span>
        <span class="n">spike_times_in_samples</span> <span class="o">=</span> <span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_spike_train</span><span class="p">(</span>
            <span class="n">unit_id</span><span class="o">=</span><span class="n">unit_id</span>
        <span class="p">)</span>
        <span class="n">units</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">spike_times_in_samples</span><span class="p">]</span>
        <span class="n">units_valid_times</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">sort_interval_valid_times</span>
        <span class="n">units_sort_interval</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sort_interval</span><span class="p">]</span>

    <span class="n">analysis_file_name</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">])</span>
    <span class="n">object_ids</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="p">()</span><span class="o">.</span><span class="n">add_units</span><span class="p">(</span>
        <span class="n">analysis_file_name</span><span class="p">,</span>
        <span class="n">units</span><span class="p">,</span>
        <span class="n">units_valid_times</span><span class="p">,</span>
        <span class="n">units_sort_interval</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">AnalysisNwbfile</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">],</span> <span class="n">analysis_file_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">object_ids</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Sorting contains no units.&quot;</span>
            <span class="s2">&quot;Created an empty analysis nwb file anyway.&quot;</span>
        <span class="p">)</span>
        <span class="n">units_object_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">units_object_id</span> <span class="o">=</span> <span class="n">object_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">units_object_id</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-function">



<h2 id="src.spyglass.spikesorting.spikesorting_curation.fetch_nwb" class="doc doc-heading">
<code class="highlight language-python"><span class="n">fetch_nwb</span><span class="p">(</span><span class="n">query_expression</span><span class="p">,</span> <span class="n">nwb_master</span><span class="p">,</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#src.spyglass.spikesorting.spikesorting_curation.fetch_nwb" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Get an NWB object from the given DataJoint query.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>query_expression</code></td>
          <td>
                <code>query</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A DataJoint query expression (e.g., join, restrict) or a table to call fetch on.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nwb_master</code></td>
          <td>
                <code>tuple</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Tuple (table, attr) to get the NWB filepath from.
i.e. absolute path to NWB file can be obtained by looking up attr column of table
table is usually Nwbfile or AnalysisNwbfile;
attr is usually 'nwb_file_abs_path' or 'analysis_file_abs_path'</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>*attrs</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Attributes from normal DataJoint fetch call.</p>
            </div>
          </td>
          <td>
                <code>()</code>
          </td>
        </tr>
        <tr>
          <td><code>**kwargs</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Keyword arguments from normal DataJoint fetch call.</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>nwb_objects</code></td>          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of dicts containing fetch results and NWB objects.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/utils/dj_helper_fn.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">fetch_nwb</span><span class="p">(</span><span class="n">query_expression</span><span class="p">,</span> <span class="n">nwb_master</span><span class="p">,</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get an NWB object from the given DataJoint query.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    query_expression : query</span>
<span class="sd">        A DataJoint query expression (e.g., join, restrict) or a table to call fetch on.</span>
<span class="sd">    nwb_master : tuple</span>
<span class="sd">        Tuple (table, attr) to get the NWB filepath from.</span>
<span class="sd">        i.e. absolute path to NWB file can be obtained by looking up attr column of table</span>
<span class="sd">        table is usually Nwbfile or AnalysisNwbfile;</span>
<span class="sd">        attr is usually &#39;nwb_file_abs_path&#39; or &#39;analysis_file_abs_path&#39;</span>
<span class="sd">    *attrs : list</span>
<span class="sd">        Attributes from normal DataJoint fetch call.</span>
<span class="sd">    **kwargs : dict</span>
<span class="sd">        Keyword arguments from normal DataJoint fetch call.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nwb_objects : list</span>
<span class="sd">        List of dicts containing fetch results and NWB objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;as_dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># force return as dictionary</span>
    <span class="n">tbl</span><span class="p">,</span> <span class="n">attr_name</span> <span class="o">=</span> <span class="n">nwb_master</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">query_expression</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span>

    <span class="c1"># get the list of analysis or nwb files</span>
    <span class="n">file_name_str</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;analysis_file_name&quot;</span> <span class="k">if</span> <span class="s2">&quot;analysis&quot;</span> <span class="ow">in</span> <span class="n">nwb_master</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;nwb_file_name&quot;</span>
    <span class="p">)</span>
    <span class="c1"># TODO: avoid this import?</span>
    <span class="kn">from</span> <span class="nn">..common.common_nwbfile</span> <span class="kn">import</span> <span class="n">AnalysisNwbfile</span><span class="p">,</span> <span class="n">Nwbfile</span>

    <span class="n">file_path_fn</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span>
        <span class="k">if</span> <span class="s2">&quot;analysis&quot;</span> <span class="ow">in</span> <span class="n">nwb_master</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span> <span class="n">Nwbfile</span><span class="o">.</span><span class="n">get_abs_path</span>
    <span class="p">)</span>

    <span class="c1"># TODO: check that the query_expression restricts tbl - CBroz</span>
    <span class="n">nwb_files</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">query_expression</span> <span class="o">*</span> <span class="n">tbl</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">nwb2load_filepath</span><span class="o">=</span><span class="n">attr_name</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">file_name_str</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">nwb_files</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path_fn</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="c1"># retrieve the file from kachery. This also opens the file and stores the file object</span>
            <span class="n">get_nwb_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="n">rec_dicts</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">query_expression</span> <span class="o">*</span> <span class="n">tbl</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">nwb2load_filepath</span><span class="o">=</span><span class="n">attr_name</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="s2">&quot;nwb2load_filepath&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">rec_dicts</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;object_id&quot;</span> <span class="ow">in</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">rec_dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">rec_dicts</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rec_dict</span> <span class="ow">in</span> <span class="n">rec_dicts</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">get_nwb_file</span><span class="p">(</span><span class="n">rec_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nwb2load_filepath&quot;</span><span class="p">))</span>
        <span class="c1"># for each attr that contains substring &#39;object_id&#39;, store key-value: attr name to NWB object</span>
        <span class="c1"># remove &#39;_object_id&#39; from attr name</span>
        <span class="n">nwb_objs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">id_attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_object_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span> <span class="n">_get_nwb_object</span><span class="p">(</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">objects</span><span class="p">,</span> <span class="n">rec_dict</span><span class="p">[</span><span class="n">id_attr</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">id_attr</span> <span class="ow">in</span> <span class="n">attrs</span>
            <span class="k">if</span> <span class="s2">&quot;object_id&quot;</span> <span class="ow">in</span> <span class="n">id_attr</span> <span class="ow">and</span> <span class="n">rec_dict</span><span class="p">[</span><span class="n">id_attr</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>
        <span class="p">}</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="o">**</span><span class="n">rec_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">nwb_objs</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.spikesorting.spikesorting_curation.SpikeSorting" class="doc doc-heading">
        <code>SpikeSorting</code>


<a href="#src.spyglass.spikesorting.spikesorting_curation.SpikeSorting" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Computed">Computed</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_sorting.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">SpikeSorting</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Computed</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; SpikeSortingSelection</span>
<span class="s2">    ---</span>
<span class="s2">    sorting_path: varchar(1000)</span>
<span class="s2">    time_of_sort: int   # in Unix time, to the nearest second</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runs spike sorting on the data and parameters specified by the</span>
<span class="sd">        SpikeSortingSelection table and inserts a new entry to SpikeSorting table.</span>

<span class="sd">        Specifically,</span>
<span class="sd">        1. Loads saved recording and runs the sort on it with spikeinterface</span>
<span class="sd">        2. Saves the sorting with spikeinterface</span>
<span class="sd">        3. Creates an analysis NWB file and saves the sorting there</span>
<span class="sd">           (this is redundant with 2; will change in the future)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">recording_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">SpikeSortingRecording</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;recording_path&quot;</span><span class="p">)</span>
        <span class="n">recording</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">load_extractor</span><span class="p">(</span><span class="n">recording_path</span><span class="p">)</span>

        <span class="c1"># first, get the timestamps</span>
        <span class="n">timestamps</span> <span class="o">=</span> <span class="n">SpikeSortingRecording</span><span class="o">.</span><span class="n">_get_recording_timestamps</span><span class="p">(</span><span class="n">recording</span><span class="p">)</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">recording</span><span class="o">.</span><span class="n">get_sampling_frequency</span><span class="p">()</span>
        <span class="c1"># then concatenate the recordings</span>
        <span class="c1"># Note: the timestamps are lost upon concatenation,</span>
        <span class="c1"># i.e. concat_recording.get_times() doesn&#39;t return true timestamps anymore.</span>
        <span class="c1"># but concat_recording.recoring_list[i].get_times() will return correct</span>
        <span class="c1"># timestamps for ith recording.</span>
        <span class="k">if</span> <span class="n">recording</span><span class="o">.</span><span class="n">get_num_segments</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">recording</span><span class="p">,</span> <span class="n">si</span><span class="o">.</span><span class="n">AppendSegmentRecording</span>
        <span class="p">):</span>
            <span class="n">recording</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">concatenate_recordings</span><span class="p">(</span><span class="n">recording</span><span class="o">.</span><span class="n">recording_list</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">recording</span><span class="o">.</span><span class="n">get_num_segments</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">recording</span><span class="p">,</span> <span class="n">si</span><span class="o">.</span><span class="n">BinaryRecordingExtractor</span>
        <span class="p">):</span>
            <span class="n">recording</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">concatenate_recordings</span><span class="p">([</span><span class="n">recording</span><span class="p">])</span>

        <span class="c1"># load artifact intervals</span>
        <span class="n">artifact_times</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ArtifactRemovedIntervalList</span>
            <span class="o">&amp;</span> <span class="p">{</span>
                <span class="s2">&quot;artifact_removed_interval_list_name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">[</span>
                    <span class="s2">&quot;artifact_removed_interval_list_name&quot;</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;artifact_times&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">artifact_times</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">artifact_times</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">artifact_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">artifact_times</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># convert artifact intervals to indices</span>
            <span class="n">list_triggers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">artifact_times</span><span class="p">:</span>
                <span class="n">list_triggers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">list_triggers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">list_triggers</span><span class="p">))]</span>
            <span class="n">recording</span> <span class="o">=</span> <span class="n">sip</span><span class="o">.</span><span class="n">remove_artifacts</span><span class="p">(</span>
                <span class="n">recording</span><span class="o">=</span><span class="n">recording</span><span class="p">,</span>
                <span class="n">list_triggers</span><span class="o">=</span><span class="n">list_triggers</span><span class="p">,</span>
                <span class="n">ms_before</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">ms_after</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;zeros&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running spike sorting on </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">sorter</span><span class="p">,</span> <span class="n">sorter_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">SpikeSorterParameters</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;sorter&quot;</span><span class="p">,</span> <span class="s2">&quot;sorter_params&quot;</span>
        <span class="p">)</span>

        <span class="n">sorter_temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">(</span>
            <span class="nb">dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SPYGLASS_TEMP_DIR&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># add tempdir option for mountainsort</span>
        <span class="n">sorter_params</span><span class="p">[</span><span class="s2">&quot;tempdir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sorter_temp_dir</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="n">sorter</span> <span class="o">==</span> <span class="s2">&quot;clusterless_thresholder&quot;</span><span class="p">:</span>
            <span class="c1"># need to remove tempdir and whiten from sorter_params</span>
            <span class="n">sorter_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tempdir&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">sorter_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;whiten&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># Detect peaks for clusterless decoding</span>
            <span class="n">detected_spikes</span> <span class="o">=</span> <span class="n">detect_peaks</span><span class="p">(</span><span class="n">recording</span><span class="p">,</span> <span class="o">**</span><span class="n">sorter_params</span><span class="p">)</span>
            <span class="n">sorting</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">NumpySorting</span><span class="o">.</span><span class="n">from_times_labels</span><span class="p">(</span>
                <span class="n">times_list</span><span class="o">=</span><span class="n">detected_spikes</span><span class="p">[</span><span class="s2">&quot;sample_ind&quot;</span><span class="p">],</span>
                <span class="n">labels_list</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">detected_spikes</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
                <span class="n">sampling_frequency</span><span class="o">=</span><span class="n">recording</span><span class="o">.</span><span class="n">get_sampling_frequency</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;whiten&quot;</span> <span class="ow">in</span> <span class="n">sorter_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">sorter_params</span><span class="p">[</span><span class="s2">&quot;whiten&quot;</span><span class="p">]:</span>
                    <span class="n">sorter_params</span><span class="p">[</span><span class="s2">&quot;whiten&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># set whiten to False</span>
            <span class="c1"># whiten recording separately; make sure dtype is float32</span>
            <span class="c1"># to avoid downstream error with svd</span>
            <span class="n">recording</span> <span class="o">=</span> <span class="n">sip</span><span class="o">.</span><span class="n">whiten</span><span class="p">(</span><span class="n">recording</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
            <span class="n">sorting</span> <span class="o">=</span> <span class="n">sis</span><span class="o">.</span><span class="n">run_sorter</span><span class="p">(</span>
                <span class="n">sorter</span><span class="p">,</span>
                <span class="n">recording</span><span class="p">,</span>
                <span class="n">output_folder</span><span class="o">=</span><span class="n">sorter_temp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">delete_output_folder</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="o">**</span><span class="n">sorter_params</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;time_of_sort&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving sorting results...&quot;</span><span class="p">)</span>
        <span class="n">sorting_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SPYGLASS_SORTING_DIR&quot;</span><span class="p">))</span>
        <span class="n">sorting_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sorting_name</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;sorting_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sorting_folder</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">sorting_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;sorting_path&quot;</span><span class="p">]):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;sorting_path&quot;</span><span class="p">])</span>
        <span class="n">sorting</span> <span class="o">=</span> <span class="n">sorting</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;sorting_path&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extends the delete method of base class to implement permission checking.</span>
<span class="sd">        Note that this is NOT a security feature, as anyone that has access to source code</span>
<span class="sd">        can disable it; it just makes it less likely to accidentally delete entries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_user_name</span> <span class="o">=</span> <span class="n">dj</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;database.user&quot;</span><span class="p">]</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
        <span class="n">permission_bool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),))</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Attempting to delete </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span><span class="si">}</span><span class="s2"> entries, checking permission...&quot;</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">entry_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)):</span>
            <span class="c1"># check the team name for the entry, then look up the members in that team,</span>
            <span class="c1"># then get their datajoint user names</span>
            <span class="n">team_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">SpikeSortingRecordingSelection</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">SpikeSortingRecordingSelection</span> <span class="o">&amp;</span> <span class="n">entries</span><span class="p">[</span><span class="n">entry_idx</span><span class="p">])</span><span class="o">.</span><span class="n">proj</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">()[</span><span class="s2">&quot;team_name&quot;</span><span class="p">]</span>
            <span class="n">lab_member_name_list</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">LabTeam</span><span class="o">.</span><span class="n">LabTeamMember</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;team_name&quot;</span><span class="p">:</span> <span class="n">team_name</span><span class="p">}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;lab_member_name&quot;</span><span class="p">)</span>
            <span class="n">datajoint_user_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">lab_member_name</span> <span class="ow">in</span> <span class="n">lab_member_name_list</span><span class="p">:</span>
                <span class="n">datajoint_user_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">LabMember</span><span class="o">.</span><span class="n">LabMemberInfo</span>
                        <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;lab_member_name&quot;</span><span class="p">:</span> <span class="n">lab_member_name</span><span class="p">}</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;datajoint_user_name&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">permission_bool</span><span class="p">[</span><span class="n">entry_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">current_user_name</span> <span class="ow">in</span> <span class="n">datajoint_user_names</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">permission_bool</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Permission to delete all specified entries granted.&quot;</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;You do not have permission to delete all specified&quot;</span>
                <span class="s2">&quot;entries. Not deleting anything.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">fetch_nwb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># return fetch_nwb(self, (AnalysisNwbfile, &#39;analysis_file_abs_path&#39;), *attrs, **kwargs)</span>

    <span class="k">def</span> <span class="nf">nightly_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up spike sorting directories that are not in the SpikeSorting table.</span>
<span class="sd">        This should be run after AnalysisNwbFile().nightly_cleanup()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get a list of the files in the spike sorting storage directory</span>
        <span class="n">dir_names</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SPYGLASS_SORTING_DIR&quot;</span><span class="p">]))[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># now retrieve a list of the currently used analysis nwb files</span>
        <span class="n">analysis_file_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">dir_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">dir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">analysis_file_names</span><span class="p">:</span>
                <span class="n">full_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SPYGLASS_SORTING_DIR&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="nb">dir</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;removing </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SPYGLASS_SORTING_DIR&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="nb">dir</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_sorting_name</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="n">recording_name</span> <span class="o">=</span> <span class="n">SpikeSortingRecording</span><span class="o">.</span><span class="n">_get_recording_name</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">sorting_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">recording_name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_spikesorting&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">sorting_name</span>

    <span class="c1"># TODO: write a function to import sorting done outside of dj</span>

    <span class="k">def</span> <span class="nf">_import_sorting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.spikesorting.spikesorting_sorting.SpikeSorting.make" class="doc doc-heading">
<code class="highlight language-python"><span class="n">make</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

<a href="#src.spyglass.spikesorting.spikesorting_sorting.SpikeSorting.make" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Runs spike sorting on the data and parameters specified by the
SpikeSortingSelection table and inserts a new entry to SpikeSorting table.</p>
<p>Specifically,
1. Loads saved recording and runs the sort on it with spikeinterface
2. Saves the sorting with spikeinterface
3. Creates an analysis NWB file and saves the sorting there
   (this is redundant with 2; will change in the future)</p>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_sorting.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Runs spike sorting on the data and parameters specified by the</span>
<span class="sd">    SpikeSortingSelection table and inserts a new entry to SpikeSorting table.</span>

<span class="sd">    Specifically,</span>
<span class="sd">    1. Loads saved recording and runs the sort on it with spikeinterface</span>
<span class="sd">    2. Saves the sorting with spikeinterface</span>
<span class="sd">    3. Creates an analysis NWB file and saves the sorting there</span>
<span class="sd">       (this is redundant with 2; will change in the future)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">recording_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">SpikeSortingRecording</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;recording_path&quot;</span><span class="p">)</span>
    <span class="n">recording</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">load_extractor</span><span class="p">(</span><span class="n">recording_path</span><span class="p">)</span>

    <span class="c1"># first, get the timestamps</span>
    <span class="n">timestamps</span> <span class="o">=</span> <span class="n">SpikeSortingRecording</span><span class="o">.</span><span class="n">_get_recording_timestamps</span><span class="p">(</span><span class="n">recording</span><span class="p">)</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">recording</span><span class="o">.</span><span class="n">get_sampling_frequency</span><span class="p">()</span>
    <span class="c1"># then concatenate the recordings</span>
    <span class="c1"># Note: the timestamps are lost upon concatenation,</span>
    <span class="c1"># i.e. concat_recording.get_times() doesn&#39;t return true timestamps anymore.</span>
    <span class="c1"># but concat_recording.recoring_list[i].get_times() will return correct</span>
    <span class="c1"># timestamps for ith recording.</span>
    <span class="k">if</span> <span class="n">recording</span><span class="o">.</span><span class="n">get_num_segments</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">recording</span><span class="p">,</span> <span class="n">si</span><span class="o">.</span><span class="n">AppendSegmentRecording</span>
    <span class="p">):</span>
        <span class="n">recording</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">concatenate_recordings</span><span class="p">(</span><span class="n">recording</span><span class="o">.</span><span class="n">recording_list</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">recording</span><span class="o">.</span><span class="n">get_num_segments</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">recording</span><span class="p">,</span> <span class="n">si</span><span class="o">.</span><span class="n">BinaryRecordingExtractor</span>
    <span class="p">):</span>
        <span class="n">recording</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">concatenate_recordings</span><span class="p">([</span><span class="n">recording</span><span class="p">])</span>

    <span class="c1"># load artifact intervals</span>
    <span class="n">artifact_times</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ArtifactRemovedIntervalList</span>
        <span class="o">&amp;</span> <span class="p">{</span>
            <span class="s2">&quot;artifact_removed_interval_list_name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">[</span>
                <span class="s2">&quot;artifact_removed_interval_list_name&quot;</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;artifact_times&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">artifact_times</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">artifact_times</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">artifact_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">artifact_times</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># convert artifact intervals to indices</span>
        <span class="n">list_triggers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">artifact_times</span><span class="p">:</span>
            <span class="n">list_triggers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">list_triggers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">list_triggers</span><span class="p">))]</span>
        <span class="n">recording</span> <span class="o">=</span> <span class="n">sip</span><span class="o">.</span><span class="n">remove_artifacts</span><span class="p">(</span>
            <span class="n">recording</span><span class="o">=</span><span class="n">recording</span><span class="p">,</span>
            <span class="n">list_triggers</span><span class="o">=</span><span class="n">list_triggers</span><span class="p">,</span>
            <span class="n">ms_before</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ms_after</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;zeros&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running spike sorting on </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">sorter</span><span class="p">,</span> <span class="n">sorter_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">SpikeSorterParameters</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
        <span class="s2">&quot;sorter&quot;</span><span class="p">,</span> <span class="s2">&quot;sorter_params&quot;</span>
    <span class="p">)</span>

    <span class="n">sorter_temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">(</span>
        <span class="nb">dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SPYGLASS_TEMP_DIR&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># add tempdir option for mountainsort</span>
    <span class="n">sorter_params</span><span class="p">[</span><span class="s2">&quot;tempdir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sorter_temp_dir</span><span class="o">.</span><span class="n">name</span>

    <span class="k">if</span> <span class="n">sorter</span> <span class="o">==</span> <span class="s2">&quot;clusterless_thresholder&quot;</span><span class="p">:</span>
        <span class="c1"># need to remove tempdir and whiten from sorter_params</span>
        <span class="n">sorter_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tempdir&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">sorter_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;whiten&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Detect peaks for clusterless decoding</span>
        <span class="n">detected_spikes</span> <span class="o">=</span> <span class="n">detect_peaks</span><span class="p">(</span><span class="n">recording</span><span class="p">,</span> <span class="o">**</span><span class="n">sorter_params</span><span class="p">)</span>
        <span class="n">sorting</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">NumpySorting</span><span class="o">.</span><span class="n">from_times_labels</span><span class="p">(</span>
            <span class="n">times_list</span><span class="o">=</span><span class="n">detected_spikes</span><span class="p">[</span><span class="s2">&quot;sample_ind&quot;</span><span class="p">],</span>
            <span class="n">labels_list</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">detected_spikes</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
            <span class="n">sampling_frequency</span><span class="o">=</span><span class="n">recording</span><span class="o">.</span><span class="n">get_sampling_frequency</span><span class="p">(),</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;whiten&quot;</span> <span class="ow">in</span> <span class="n">sorter_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sorter_params</span><span class="p">[</span><span class="s2">&quot;whiten&quot;</span><span class="p">]:</span>
                <span class="n">sorter_params</span><span class="p">[</span><span class="s2">&quot;whiten&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># set whiten to False</span>
        <span class="c1"># whiten recording separately; make sure dtype is float32</span>
        <span class="c1"># to avoid downstream error with svd</span>
        <span class="n">recording</span> <span class="o">=</span> <span class="n">sip</span><span class="o">.</span><span class="n">whiten</span><span class="p">(</span><span class="n">recording</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
        <span class="n">sorting</span> <span class="o">=</span> <span class="n">sis</span><span class="o">.</span><span class="n">run_sorter</span><span class="p">(</span>
            <span class="n">sorter</span><span class="p">,</span>
            <span class="n">recording</span><span class="p">,</span>
            <span class="n">output_folder</span><span class="o">=</span><span class="n">sorter_temp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">delete_output_folder</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">sorter_params</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;time_of_sort&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving sorting results...&quot;</span><span class="p">)</span>
    <span class="n">sorting_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SPYGLASS_SORTING_DIR&quot;</span><span class="p">))</span>
    <span class="n">sorting_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sorting_name</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;sorting_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sorting_folder</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">sorting_name</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;sorting_path&quot;</span><span class="p">]):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;sorting_path&quot;</span><span class="p">])</span>
    <span class="n">sorting</span> <span class="o">=</span> <span class="n">sorting</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;sorting_path&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.spikesorting.spikesorting_sorting.SpikeSorting.delete" class="doc doc-heading">
<code class="highlight language-python"><span class="n">delete</span><span class="p">()</span></code>

<a href="#src.spyglass.spikesorting.spikesorting_sorting.SpikeSorting.delete" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Extends the delete method of base class to implement permission checking.
Note that this is NOT a security feature, as anyone that has access to source code
can disable it; it just makes it less likely to accidentally delete entries.</p>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_sorting.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extends the delete method of base class to implement permission checking.</span>
<span class="sd">    Note that this is NOT a security feature, as anyone that has access to source code</span>
<span class="sd">    can disable it; it just makes it less likely to accidentally delete entries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_user_name</span> <span class="o">=</span> <span class="n">dj</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;database.user&quot;</span><span class="p">]</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
    <span class="n">permission_bool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),))</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Attempting to delete </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span><span class="si">}</span><span class="s2"> entries, checking permission...&quot;</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">entry_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)):</span>
        <span class="c1"># check the team name for the entry, then look up the members in that team,</span>
        <span class="c1"># then get their datajoint user names</span>
        <span class="n">team_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">SpikeSortingRecordingSelection</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">SpikeSortingRecordingSelection</span> <span class="o">&amp;</span> <span class="n">entries</span><span class="p">[</span><span class="n">entry_idx</span><span class="p">])</span><span class="o">.</span><span class="n">proj</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">()[</span><span class="s2">&quot;team_name&quot;</span><span class="p">]</span>
        <span class="n">lab_member_name_list</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">LabTeam</span><span class="o">.</span><span class="n">LabTeamMember</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;team_name&quot;</span><span class="p">:</span> <span class="n">team_name</span><span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;lab_member_name&quot;</span><span class="p">)</span>
        <span class="n">datajoint_user_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">lab_member_name</span> <span class="ow">in</span> <span class="n">lab_member_name_list</span><span class="p">:</span>
            <span class="n">datajoint_user_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">LabMember</span><span class="o">.</span><span class="n">LabMemberInfo</span>
                    <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;lab_member_name&quot;</span><span class="p">:</span> <span class="n">lab_member_name</span><span class="p">}</span>
                <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;datajoint_user_name&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">permission_bool</span><span class="p">[</span><span class="n">entry_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">current_user_name</span> <span class="ow">in</span> <span class="n">datajoint_user_names</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">permission_bool</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Permission to delete all specified entries granted.&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;You do not have permission to delete all specified&quot;</span>
            <span class="s2">&quot;entries. Not deleting anything.&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.spikesorting.spikesorting_sorting.SpikeSorting.nightly_cleanup" class="doc doc-heading">
<code class="highlight language-python"><span class="n">nightly_cleanup</span><span class="p">()</span></code>

<a href="#src.spyglass.spikesorting.spikesorting_sorting.SpikeSorting.nightly_cleanup" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Clean up spike sorting directories that are not in the SpikeSorting table.
This should be run after AnalysisNwbFile().nightly_cleanup()</p>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_sorting.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">nightly_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean up spike sorting directories that are not in the SpikeSorting table.</span>
<span class="sd">    This should be run after AnalysisNwbFile().nightly_cleanup()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get a list of the files in the spike sorting storage directory</span>
    <span class="n">dir_names</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SPYGLASS_SORTING_DIR&quot;</span><span class="p">]))[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># now retrieve a list of the currently used analysis nwb files</span>
    <span class="n">analysis_file_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">dir_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">dir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">analysis_file_names</span><span class="p">:</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SPYGLASS_SORTING_DIR&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="nb">dir</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;removing </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SPYGLASS_SORTING_DIR&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="nb">dir</span><span class="p">)</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.spikesorting.spikesorting_curation.AnalysisNwbfile" class="doc doc-heading">
        <code>AnalysisNwbfile</code>


<a href="#src.spyglass.spikesorting.spikesorting_curation.AnalysisNwbfile" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Manual">Manual</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">AnalysisNwbfile</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # Table for holding the NWB files that contain results of analysis, such as spike sorting.</span>
<span class="s2">    analysis_file_name: varchar(255)               # name of the file</span>
<span class="s2">    ---</span>
<span class="s2">    -&gt; Nwbfile                                     # name of the parent NWB file. Used for naming and metadata copy</span>
<span class="s2">    analysis_file_abs_path: filepath@analysis      # the full path to the file</span>
<span class="s2">    analysis_file_description = &quot;&quot;: varchar(2000)  # an optional description of this analysis</span>
<span class="s2">    analysis_parameters = NULL: blob               # additional relevant parameters. Currently used only for analyses</span>
<span class="s2">                                                   # that span multiple NWB files</span>
<span class="s2">    INDEX (analysis_file_abs_path)</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="c1"># NOTE the INDEX above is implicit from filepath@... above but needs to be explicit</span>
    <span class="c1"># so that alter() can work</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open the NWB file, create a copy, write the copy to disk and return the name of the new file.</span>

<span class="sd">        Note that this does NOT add the file to the schema; that needs to be done after data are written to it.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nwb_file_name : str</span>
<span class="sd">            The name of an NWB file to be copied.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the new NWB file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nwb_file_abspath</span> <span class="o">=</span> <span class="n">Nwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">nwb_file_abspath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="c1"># pop off the unnecessary elements to save space</span>
            <span class="n">nwb_fields</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">fields</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">nwb_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NWB_KEEP_FIELDS</span><span class="p">:</span>
                    <span class="n">nwb_object</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">nwbf</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">,</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">LabelledDict</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nwb_object</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">nwb_object</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>

            <span class="n">analysis_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_new_file_name</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
            <span class="c1"># write the new file</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing new NWB file </span><span class="si">{</span><span class="n">analysis_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">analysis_file_abs_path</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
                <span class="n">analysis_file_name</span>
            <span class="p">)</span>
            <span class="c1"># export the new NWB file</span>
            <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
                <span class="n">path</span><span class="o">=</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">manager</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">export_io</span><span class="p">:</span>
                <span class="n">export_io</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">)</span>

        <span class="c1"># change the permissions to only allow owner to write</span>
        <span class="n">permissions</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IROTH</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">permissions</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">analysis_file_name</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__get_new_file_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
        <span class="c1"># each file ends with a random string of 10 digits, so we generate that string and redo if by some miracle</span>
        <span class="c1"># it&#39;s already there</span>
        <span class="n">file_in_table</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">file_in_table</span><span class="p">:</span>
            <span class="n">analysis_file_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;.nwb&quot;</span>
            <span class="p">)</span>
            <span class="n">file_in_table</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span> <span class="o">&amp;</span> <span class="p">{</span>
                <span class="s2">&quot;analysis_file_name&quot;</span><span class="p">:</span> <span class="n">analysis_file_name</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">analysis_file_name</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__get_analysis_file_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># strip off everything after and including the final underscore and return the result</span>
        <span class="k">return</span> <span class="n">analysis_file_name</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">analysis_file_name</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a copy of an analysis NWB file.</span>

<span class="sd">        Note that this does NOT add the file to the schema; that needs to be done after data are written to it.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nwb_file_name : str</span>
<span class="sd">            The name of the analysis NWB file to be copied.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the new NWB file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nwb_file_abspath</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">nwb_file_abspath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="c1"># get the current number of analysis files related to this nwb file</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">}</span>
            <span class="n">original_nwb_file_name</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">analysis_file_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__get_new_file_name</span><span class="p">(</span><span class="n">original_nwb_file_name</span><span class="p">)</span>
            <span class="c1"># write the new file</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing new NWB file </span><span class="si">{</span><span class="n">analysis_file_name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">analysis_file_abs_path</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
                <span class="n">analysis_file_name</span>
            <span class="p">)</span>
            <span class="c1"># export the new NWB file</span>
            <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
                <span class="n">path</span><span class="o">=</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">manager</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">export_io</span><span class="p">:</span>
                <span class="n">export_io</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">analysis_file_name</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the specified file to AnalysisNWBfile table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nwb_file_name : str</span>
<span class="sd">            The name of the parent NWB file.</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the analysis NWB file that was created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_file_name</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_file_name</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_abs_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
            <span class="n">analysis_file_name</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_abs_path</span><span class="p">(</span><span class="n">analysis_nwb_file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the absolute path for a stored analysis NWB file given just the file name.</span>

<span class="sd">        The SPYGLASS_BASE_DIR environment variable must be set.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analysis_nwb_file_name : str</span>
<span class="sd">            The name of the NWB file that has been inserted into the AnalysisNwbfile() schema</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        analysis_nwb_file_abspath : str</span>
<span class="sd">            The absolute path for the given file name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SPYGLASS_BASE_DIR&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;You must set SPYGLASS_BASE_DIR environment variable.&quot;</span>

        <span class="c1"># see if the file exists and is stored in the base analysis dir</span>
        <span class="n">test_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;analysis&quot;</span> <span class="o">/</span> <span class="n">analysis_nwb_file_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">test_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">test_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use the new path</span>
            <span class="n">analysis_file_base_path</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">base_dir</span>
                <span class="o">/</span> <span class="s2">&quot;analysis&quot;</span>
                <span class="o">/</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">__get_analysis_file_dir</span><span class="p">(</span>
                    <span class="n">analysis_nwb_file_name</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis_file_base_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">analysis_file_base_path</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">analysis_file_base_path</span> <span class="o">/</span> <span class="n">analysis_nwb_file_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_nwb_object</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">nwb_object</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;pandas_table&quot;</span>
    <span class="p">):</span>
        <span class="c1"># TODO: change to add_object with checks for object type and a name parameter, which should be specified if</span>
        <span class="c1"># it is not an NWB container</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add an NWB object to the analysis file in the scratch area and returns the NWB object ID</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the analysis NWB file.</span>
<span class="sd">        nwb_object : pynwb.core.NWBDataInterface</span>
<span class="sd">            The NWB object created by PyNWB.</span>
<span class="sd">        table_name : str (optional, defaults to &#39;pandas_table&#39;)</span>
<span class="sd">            The name of the DynamicTable made from a dataframe.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        nwb_object_id : str</span>
<span class="sd">            The NWB object ID of the added object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
            <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">dt_object</span> <span class="o">=</span> <span class="n">DynamicTable</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">nwb_object</span>
                <span class="p">)</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span><span class="n">dt_object</span><span class="p">)</span>
                <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">dt_object</span><span class="o">.</span><span class="n">object_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">)</span>
                <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">nwb_object</span><span class="o">.</span><span class="n">object_id</span>

    <span class="k">def</span> <span class="nf">add_units</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">analysis_file_name</span><span class="p">,</span>
        <span class="n">units</span><span class="p">,</span>
        <span class="n">units_valid_times</span><span class="p">,</span>
        <span class="n">units_sort_interval</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">units_waveforms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add units to analysis NWB file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the analysis NWB file.</span>
<span class="sd">        units : dict</span>
<span class="sd">            keys are unit ids, values are spike times</span>
<span class="sd">        units_valid_times : dict</span>
<span class="sd">            Dictionary of units and valid times with unit ids as keys.</span>
<span class="sd">        units_sort_interval : dict</span>
<span class="sd">            Dictionary of units and sort_interval with unit ids as keys.</span>
<span class="sd">        units_waveforms : dict, optional</span>
<span class="sd">            Dictionary of unit waveforms with unit ids as keys.</span>
<span class="sd">        metrics : dict, optional</span>
<span class="sd">            Cluster metrics.</span>
<span class="sd">        labels : dict, optional</span>
<span class="sd">            Curation labels for clusters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        units_object_id, waveforms_object_id : str, str</span>
<span class="sd">            The NWB object id of the Units object and the object id of the waveforms object (&#39;&#39; if None)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
            <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">sort_intervals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="c1"># Add spike times and valid time range for the sort</span>
                <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span>
                        <span class="n">spike_times</span><span class="o">=</span><span class="n">units</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span>
                        <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
                        <span class="c1"># waveform_mean = units_templates[id],</span>
                        <span class="n">obs_intervals</span><span class="o">=</span><span class="n">units_valid_times</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="n">sort_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">units_sort_interval</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span>
                <span class="c1"># Add a column for the sort interval (subset of valid time)</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sort_interval&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;the interval used for spike sorting&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">sort_intervals</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># If metrics were specified, add one column per metric</span>
                <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]:</span>
                            <span class="n">unit_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                            <span class="n">metric_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                            <span class="p">)</span>
                            <span class="c1"># sort by unit_ids and apply that sorting to values to ensure that things go in the right order</span>
                            <span class="n">metric_values</span> <span class="o">=</span> <span class="n">metric_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">unit_ids</span><span class="p">)]</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding metric </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">metric_values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                                <span class="n">name</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
                                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> metric&quot;</span><span class="p">,</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">metric_values</span><span class="p">,</span>
                            <span class="p">)</span>
                <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">unit_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                    <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">unit_ids</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                            <span class="n">labels</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">label_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                    <span class="n">label_values</span> <span class="o">=</span> <span class="n">label_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">unit_ids</span><span class="p">)]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;label given during curation&quot;</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">label_values</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="c1"># If the waveforms were specified, add them as a dataframe to scratch</span>
                <span class="n">waveforms_object_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">units_waveforms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">waveforms_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                        <span class="n">units_waveforms</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span>
                    <span class="p">)</span>
                    <span class="n">waveforms_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;waveforms&quot;</span><span class="p">]</span>
                    <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span>
                        <span class="n">waveforms_df</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;units_waveforms&quot;</span><span class="p">,</span>
                        <span class="n">notes</span><span class="o">=</span><span class="s2">&quot;spike waveforms for each unit&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">waveforms_object_id</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">scratch</span><span class="p">[</span>
                        <span class="s2">&quot;units_waveforms&quot;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">object_id</span>

                <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">object_id</span><span class="p">,</span> <span class="n">waveforms_object_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">add_units_waveforms</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">analysis_file_name</span><span class="p">,</span>
        <span class="n">waveform_extractor</span><span class="p">:</span> <span class="n">si</span><span class="o">.</span><span class="n">WaveformExtractor</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add units to analysis NWB file along with the waveforms</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the analysis NWB file.</span>
<span class="sd">        waveform_extractor : si.WaveformExtractor object</span>
<span class="sd">        metrics : dict, optional</span>
<span class="sd">            Cluster metrics.</span>
<span class="sd">        labels : dict, optional</span>
<span class="sd">            Curation labels for clusters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        units_object_id : str</span>
<span class="sd">            The NWB object id of the Units object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
            <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">waveform_extractor</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_ids</span><span class="p">():</span>
                <span class="c1"># (spikes, samples, channels)</span>
                <span class="n">waveforms</span> <span class="o">=</span> <span class="n">waveform_extractor</span><span class="o">.</span><span class="n">get_waveforms</span><span class="p">(</span><span class="n">unit_id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
                <span class="c1"># (channels, spikes, samples)</span>
                <span class="n">waveforms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">waveforms</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span>
                    <span class="n">spike_times</span><span class="o">=</span><span class="n">waveform_extractor</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_spike_train</span><span class="p">(</span>
                        <span class="n">unit_id</span><span class="o">=</span><span class="nb">id</span>
                    <span class="p">),</span>
                    <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
                    <span class="n">electrodes</span><span class="o">=</span><span class="n">waveform_extractor</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">(),</span>
                    <span class="n">waveforms</span><span class="o">=</span><span class="n">waveforms</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># The following is a rough sketch of AnalysisNwbfile().add_waveforms</span>
            <span class="c1"># analysis_file_name = AnalysisNwbfile().create(key[&#39;nwb_file_name&#39;])</span>
            <span class="c1"># or</span>
            <span class="c1"># nwbfile = pynwb.NWBFile(...)</span>
            <span class="c1"># (channels, spikes, samples)</span>
            <span class="c1"># wfs = [</span>
            <span class="c1">#         [     # elec 1</span>
            <span class="c1">#             [1, 2, 3],  # spike 1, [sample 1, sample 2, sample 3]</span>
            <span class="c1">#             [1, 2, 3],  # spike 2</span>
            <span class="c1">#             [1, 2, 3],  # spike 3</span>
            <span class="c1">#             [1, 2, 3]   # spike 4</span>
            <span class="c1">#         ], [  # elec 2</span>
            <span class="c1">#             [1, 2, 3],  # spike 1</span>
            <span class="c1">#             [1, 2, 3],  # spike 2</span>
            <span class="c1">#             [1, 2, 3],  # spike 3</span>
            <span class="c1">#             [1, 2, 3]   # spike 4</span>
            <span class="c1">#         ], [  # elec 3</span>
            <span class="c1">#             [1, 2, 3],  # spike 1</span>
            <span class="c1">#             [1, 2, 3],  # spike 2</span>
            <span class="c1">#             [1, 2, 3],  # spike 3</span>
            <span class="c1">#             [1, 2, 3]   # spike 4</span>
            <span class="c1">#         ]</span>
            <span class="c1"># ]</span>
            <span class="c1"># elecs = ... # DynamicTableRegion referring to three electrodes (rows) of the electrodes table</span>
            <span class="c1"># nwbfile.add_unit(spike_times=[1, 2, 3], electrodes=elecs, waveforms=wfs)</span>

            <span class="c1"># If metrics were specified, add one column per metric</span>
            <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding metric </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">metric_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">metric_data</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                    <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">metric_data</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;label given during curation&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">object_id</span>

    <span class="k">def</span> <span class="nf">add_units_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add units to analysis NWB file along with the waveforms</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the analysis NWB file.</span>
<span class="sd">        metrics : dict, optional</span>
<span class="sd">            Cluster metrics.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        units_object_id : str</span>
<span class="sd">            The NWB object id of the Units object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metric_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">unit_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
            <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
            <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">unit_ids</span><span class="p">:</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding metric </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">metric_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">metric_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">metric_data</span>
                <span class="p">)</span>

            <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">object_id</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_electrode_indices</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given an analysis NWB file name, returns the indices of the specified electrode_ids.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analysis_file_name : str</span>
<span class="sd">            The name of the analysis NWB file.</span>
<span class="sd">        electrode_ids : numpy array or list</span>
<span class="sd">            Array or list of electrode IDs.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        electrode_indices : numpy array</span>
<span class="sd">            Array of indices in the electrodes table for the given electrode IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">get_nwb_file</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">get_electrode_indices</span><span class="p">(</span><span class="n">nwbf</span><span class="o">.</span><span class="n">electrodes</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">delete_files</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove the filepath entries for NWB files that are not in use.</span>

<span class="sd">        Does not delete the files themselves unless delete_files=True is specified.</span>
<span class="sd">        Run this after deleting the Nwbfile() entries themselves.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        delete_files : bool, optional</span>
<span class="sd">            Whether the original files should be deleted (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">external</span><span class="p">[</span><span class="s2">&quot;analysis&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">delete_external_files</span><span class="o">=</span><span class="n">delete_files</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">nightly_cleanup</span><span class="p">():</span>
        <span class="n">child_tables</span> <span class="o">=</span> <span class="n">get_child_tables</span><span class="p">(</span><span class="n">AnalysisNwbfile</span><span class="p">)</span>
        <span class="p">(</span><span class="n">AnalysisNwbfile</span> <span class="o">-</span> <span class="n">child_tables</span><span class="p">)</span><span class="o">.</span><span class="n">delete_quick</span><span class="p">()</span>

        <span class="c1"># a separate external files clean up required - this is to be done</span>
        <span class="c1"># during times when no other transactions are in progress.</span>
        <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.create" class="doc doc-heading">
<code class="highlight language-python"><span class="n">create</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.create" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Open the NWB file, create a copy, write the copy to disk and return the name of the new file.</p>
<p>Note that this does NOT add the file to the schema; that needs to be done after data are written to it.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of an NWB file to be copied.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>analysis_file_name</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the new NWB file.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Open the NWB file, create a copy, write the copy to disk and return the name of the new file.</span>

<span class="sd">    Note that this does NOT add the file to the schema; that needs to be done after data are written to it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwb_file_name : str</span>
<span class="sd">        The name of an NWB file to be copied.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the new NWB file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nwb_file_abspath</span> <span class="o">=</span> <span class="n">Nwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="n">nwb_file_abspath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1"># pop off the unnecessary elements to save space</span>
        <span class="n">nwb_fields</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">fields</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">nwb_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NWB_KEEP_FIELDS</span><span class="p">:</span>
                <span class="n">nwb_object</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">nwbf</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">,</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">LabelledDict</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nwb_object</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">nwb_object</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>

        <span class="n">analysis_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_new_file_name</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
        <span class="c1"># write the new file</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing new NWB file </span><span class="si">{</span><span class="n">analysis_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">analysis_file_abs_path</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
            <span class="n">analysis_file_name</span>
        <span class="p">)</span>
        <span class="c1"># export the new NWB file</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">manager</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">export_io</span><span class="p">:</span>
            <span class="n">export_io</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">)</span>

    <span class="c1"># change the permissions to only allow owner to write</span>
    <span class="n">permissions</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IROTH</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">permissions</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">analysis_file_name</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.copy" class="doc doc-heading">
<code class="highlight language-python"><span class="n">copy</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.copy" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Make a copy of an analysis NWB file.</p>
<p>Note that this does NOT add the file to the schema; that needs to be done after data are written to it.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file to be copied.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>analysis_file_name</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the new NWB file.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make a copy of an analysis NWB file.</span>

<span class="sd">    Note that this does NOT add the file to the schema; that needs to be done after data are written to it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwb_file_name : str</span>
<span class="sd">        The name of the analysis NWB file to be copied.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the new NWB file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nwb_file_abspath</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="n">nwb_file_abspath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1"># get the current number of analysis files related to this nwb file</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">:</span> <span class="n">nwb_file_name</span><span class="p">}</span>
        <span class="n">original_nwb_file_name</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">analysis_file_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__get_new_file_name</span><span class="p">(</span><span class="n">original_nwb_file_name</span><span class="p">)</span>
        <span class="c1"># write the new file</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing new NWB file </span><span class="si">{</span><span class="n">analysis_file_name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">analysis_file_abs_path</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
            <span class="n">analysis_file_name</span>
        <span class="p">)</span>
        <span class="c1"># export the new NWB file</span>
        <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">analysis_file_abs_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">manager</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">export_io</span><span class="p">:</span>
            <span class="n">export_io</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">nwbf</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">analysis_file_name</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.add" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add</span><span class="p">(</span><span class="n">nwb_file_name</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add the specified file to AnalysisNWBfile table.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the parent NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>analysis_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file that was created.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nwb_file_name</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add the specified file to AnalysisNWBfile table.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nwb_file_name : str</span>
<span class="sd">        The name of the parent NWB file.</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the analysis NWB file that was created.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwb_file_name</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_file_name</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_abs_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
        <span class="n">analysis_file_name</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.get_abs_path" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_nwb_file_name</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.get_abs_path" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Return the absolute path for a stored analysis NWB file given just the file name.</p>
<p>The SPYGLASS_BASE_DIR environment variable must be set.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>analysis_nwb_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the NWB file that has been inserted into the AnalysisNwbfile() schema</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>analysis_nwb_file_abspath</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The absolute path for the given file name.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">get_abs_path</span><span class="p">(</span><span class="n">analysis_nwb_file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the absolute path for a stored analysis NWB file given just the file name.</span>

<span class="sd">    The SPYGLASS_BASE_DIR environment variable must be set.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analysis_nwb_file_name : str</span>
<span class="sd">        The name of the NWB file that has been inserted into the AnalysisNwbfile() schema</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    analysis_nwb_file_abspath : str</span>
<span class="sd">        The absolute path for the given file name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">base_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SPYGLASS_BASE_DIR&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">),</span> <span class="s2">&quot;You must set SPYGLASS_BASE_DIR environment variable.&quot;</span>

    <span class="c1"># see if the file exists and is stored in the base analysis dir</span>
    <span class="n">test_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;analysis&quot;</span> <span class="o">/</span> <span class="n">analysis_nwb_file_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">test_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test_path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># use the new path</span>
        <span class="n">analysis_file_base_path</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">base_dir</span>
            <span class="o">/</span> <span class="s2">&quot;analysis&quot;</span>
            <span class="o">/</span> <span class="n">AnalysisNwbfile</span><span class="o">.</span><span class="n">__get_analysis_file_dir</span><span class="p">(</span>
                <span class="n">analysis_nwb_file_name</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis_file_base_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">analysis_file_base_path</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">analysis_file_base_path</span> <span class="o">/</span> <span class="n">analysis_nwb_file_name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_nwb_object" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_nwb_object</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">nwb_object</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;pandas_table&#39;</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_nwb_object" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add an NWB object to the analysis file in the scratch area and returns the NWB object ID</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>analysis_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nwb_object</code></td>
          <td>
                <code>pynwb.<span title="pynwb.core">core</span>.<span title="pynwb.core.NWBDataInterface">NWBDataInterface</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The NWB object created by PyNWB.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>table_name</code></td>
          <td>
                <code>str (optional, defaults to &#39;pandas_table&#39;)</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the DynamicTable made from a dataframe.</p>
            </div>
          </td>
          <td>
                <code>&#39;pandas_table&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>nwb_object_id</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The NWB object ID of the added object.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_nwb_object</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">nwb_object</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;pandas_table&quot;</span>
<span class="p">):</span>
    <span class="c1"># TODO: change to add_object with checks for object type and a name parameter, which should be specified if</span>
    <span class="c1"># it is not an NWB container</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add an NWB object to the analysis file in the scratch area and returns the NWB object ID</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the analysis NWB file.</span>
<span class="sd">    nwb_object : pynwb.core.NWBDataInterface</span>
<span class="sd">        The NWB object created by PyNWB.</span>
<span class="sd">    table_name : str (optional, defaults to &#39;pandas_table&#39;)</span>
<span class="sd">        The name of the DynamicTable made from a dataframe.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nwb_object_id : str</span>
<span class="sd">        The NWB object ID of the added object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
        <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">dt_object</span> <span class="o">=</span> <span class="n">DynamicTable</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">nwb_object</span>
            <span class="p">)</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span><span class="n">dt_object</span><span class="p">)</span>
            <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dt_object</span><span class="o">.</span><span class="n">object_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span><span class="n">nwb_object</span><span class="p">)</span>
            <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nwb_object</span><span class="o">.</span><span class="n">object_id</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_units</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">units_valid_times</span><span class="p">,</span> <span class="n">units_sort_interval</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units_waveforms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add units to analysis NWB file</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>analysis_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>units</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>keys are unit ids, values are spike times</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>units_valid_times</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary of units and valid times with unit ids as keys.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>units_sort_interval</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary of units and sort_interval with unit ids as keys.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>units_waveforms</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary of unit waveforms with unit ids as keys.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>metrics</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Cluster metrics.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>labels</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Curation labels for clusters</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>units_object_id, waveforms_object_id : str, str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The NWB object id of the Units object and the object id of the waveforms object ('' if None)</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_units</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">analysis_file_name</span><span class="p">,</span>
    <span class="n">units</span><span class="p">,</span>
    <span class="n">units_valid_times</span><span class="p">,</span>
    <span class="n">units_sort_interval</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">units_waveforms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add units to analysis NWB file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the analysis NWB file.</span>
<span class="sd">    units : dict</span>
<span class="sd">        keys are unit ids, values are spike times</span>
<span class="sd">    units_valid_times : dict</span>
<span class="sd">        Dictionary of units and valid times with unit ids as keys.</span>
<span class="sd">    units_sort_interval : dict</span>
<span class="sd">        Dictionary of units and sort_interval with unit ids as keys.</span>
<span class="sd">    units_waveforms : dict, optional</span>
<span class="sd">        Dictionary of unit waveforms with unit ids as keys.</span>
<span class="sd">    metrics : dict, optional</span>
<span class="sd">        Cluster metrics.</span>
<span class="sd">    labels : dict, optional</span>
<span class="sd">        Curation labels for clusters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    units_object_id, waveforms_object_id : str, str</span>
<span class="sd">        The NWB object id of the Units object and the object id of the waveforms object (&#39;&#39; if None)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
        <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">sort_intervals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="c1"># Add spike times and valid time range for the sort</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span>
                    <span class="n">spike_times</span><span class="o">=</span><span class="n">units</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span>
                    <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
                    <span class="c1"># waveform_mean = units_templates[id],</span>
                    <span class="n">obs_intervals</span><span class="o">=</span><span class="n">units_valid_times</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">sort_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">units_sort_interval</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span>
            <span class="c1"># Add a column for the sort interval (subset of valid time)</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sort_interval&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;the interval used for spike sorting&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">sort_intervals</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># If metrics were specified, add one column per metric</span>
            <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]:</span>
                        <span class="n">unit_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                        <span class="n">metric_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                            <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                        <span class="p">)</span>
                        <span class="c1"># sort by unit_ids and apply that sorting to values to ensure that things go in the right order</span>
                        <span class="n">metric_values</span> <span class="o">=</span> <span class="n">metric_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">unit_ids</span><span class="p">)]</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding metric </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">metric_values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
                            <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> metric&quot;</span><span class="p">,</span>
                            <span class="n">data</span><span class="o">=</span><span class="n">metric_values</span><span class="p">,</span>
                        <span class="p">)</span>
            <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">unit_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">unit_ids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                        <span class="n">labels</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">label_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                <span class="n">label_values</span> <span class="o">=</span> <span class="n">label_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">unit_ids</span><span class="p">)]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;label given during curation&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">label_values</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># If the waveforms were specified, add them as a dataframe to scratch</span>
            <span class="n">waveforms_object_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">units_waveforms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">waveforms_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                    <span class="n">units_waveforms</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span>
                <span class="p">)</span>
                <span class="n">waveforms_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;waveforms&quot;</span><span class="p">]</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_scratch</span><span class="p">(</span>
                    <span class="n">waveforms_df</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;units_waveforms&quot;</span><span class="p">,</span>
                    <span class="n">notes</span><span class="o">=</span><span class="s2">&quot;spike waveforms for each unit&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">waveforms_object_id</span> <span class="o">=</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">scratch</span><span class="p">[</span>
                    <span class="s2">&quot;units_waveforms&quot;</span>
                <span class="p">]</span><span class="o">.</span><span class="n">object_id</span>

            <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">object_id</span><span class="p">,</span> <span class="n">waveforms_object_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units_waveforms" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_units_waveforms</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">waveform_extractor</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units_waveforms" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add units to analysis NWB file along with the waveforms</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>analysis_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>waveform_extractor</code></td>
          <td>
                <code>si.WaveformExtractor object</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>metrics</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Cluster metrics.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>labels</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Curation labels for clusters</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>units_object_id</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The NWB object id of the Units object</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_units_waveforms</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">analysis_file_name</span><span class="p">,</span>
    <span class="n">waveform_extractor</span><span class="p">:</span> <span class="n">si</span><span class="o">.</span><span class="n">WaveformExtractor</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add units to analysis NWB file along with the waveforms</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the analysis NWB file.</span>
<span class="sd">    waveform_extractor : si.WaveformExtractor object</span>
<span class="sd">    metrics : dict, optional</span>
<span class="sd">        Cluster metrics.</span>
<span class="sd">    labels : dict, optional</span>
<span class="sd">        Curation labels for clusters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    units_object_id : str</span>
<span class="sd">        The NWB object id of the Units object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
        <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">waveform_extractor</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_ids</span><span class="p">():</span>
            <span class="c1"># (spikes, samples, channels)</span>
            <span class="n">waveforms</span> <span class="o">=</span> <span class="n">waveform_extractor</span><span class="o">.</span><span class="n">get_waveforms</span><span class="p">(</span><span class="n">unit_id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
            <span class="c1"># (channels, spikes, samples)</span>
            <span class="n">waveforms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">waveforms</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span>
                <span class="n">spike_times</span><span class="o">=</span><span class="n">waveform_extractor</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_spike_train</span><span class="p">(</span>
                    <span class="n">unit_id</span><span class="o">=</span><span class="nb">id</span>
                <span class="p">),</span>
                <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
                <span class="n">electrodes</span><span class="o">=</span><span class="n">waveform_extractor</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">(),</span>
                <span class="n">waveforms</span><span class="o">=</span><span class="n">waveforms</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># The following is a rough sketch of AnalysisNwbfile().add_waveforms</span>
        <span class="c1"># analysis_file_name = AnalysisNwbfile().create(key[&#39;nwb_file_name&#39;])</span>
        <span class="c1"># or</span>
        <span class="c1"># nwbfile = pynwb.NWBFile(...)</span>
        <span class="c1"># (channels, spikes, samples)</span>
        <span class="c1"># wfs = [</span>
        <span class="c1">#         [     # elec 1</span>
        <span class="c1">#             [1, 2, 3],  # spike 1, [sample 1, sample 2, sample 3]</span>
        <span class="c1">#             [1, 2, 3],  # spike 2</span>
        <span class="c1">#             [1, 2, 3],  # spike 3</span>
        <span class="c1">#             [1, 2, 3]   # spike 4</span>
        <span class="c1">#         ], [  # elec 2</span>
        <span class="c1">#             [1, 2, 3],  # spike 1</span>
        <span class="c1">#             [1, 2, 3],  # spike 2</span>
        <span class="c1">#             [1, 2, 3],  # spike 3</span>
        <span class="c1">#             [1, 2, 3]   # spike 4</span>
        <span class="c1">#         ], [  # elec 3</span>
        <span class="c1">#             [1, 2, 3],  # spike 1</span>
        <span class="c1">#             [1, 2, 3],  # spike 2</span>
        <span class="c1">#             [1, 2, 3],  # spike 3</span>
        <span class="c1">#             [1, 2, 3]   # spike 4</span>
        <span class="c1">#         ]</span>
        <span class="c1"># ]</span>
        <span class="c1"># elecs = ... # DynamicTableRegion referring to three electrodes (rows) of the electrodes table</span>
        <span class="c1"># nwbfile.add_unit(spike_times=[1, 2, 3], electrodes=elecs, waveforms=wfs)</span>

        <span class="c1"># If metrics were specified, add one column per metric</span>
        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding metric </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">metric_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">metric_data</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">metric_data</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;label given during curation&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">object_id</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units_metrics" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_units_metrics</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span></code>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.add_units_metrics" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add units to analysis NWB file along with the waveforms</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>analysis_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>metrics</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Cluster metrics.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>units_object_id</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The NWB object id of the Units object</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_units_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add units to analysis NWB file along with the waveforms</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the analysis NWB file.</span>
<span class="sd">    metrics : dict, optional</span>
<span class="sd">        Cluster metrics.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    units_object_id : str</span>
<span class="sd">        The NWB object id of the Units object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metric_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">unit_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">with</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">),</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
        <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
        <span class="n">nwbf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">unit_ids</span><span class="p">:</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding metric </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">metric_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">metric_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">nwbf</span><span class="o">.</span><span class="n">add_unit_column</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">metric_data</span>
            <span class="p">)</span>

        <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nwbf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nwbf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">object_id</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.get_electrode_indices" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_electrode_indices</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.get_electrode_indices" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Given an analysis NWB file name, returns the indices of the specified electrode_ids.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>analysis_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the analysis NWB file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>electrode_ids</code></td>
          <td>
                <code>numpy array or list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Array or list of electrode IDs.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>electrode_indices</code></td>          <td>
                <code>numpy array</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Array of indices in the electrodes table for the given electrode IDs.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">get_electrode_indices</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">analysis_file_name</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given an analysis NWB file name, returns the indices of the specified electrode_ids.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analysis_file_name : str</span>
<span class="sd">        The name of the analysis NWB file.</span>
<span class="sd">    electrode_ids : numpy array or list</span>
<span class="sd">        Array or list of electrode IDs.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    electrode_indices : numpy array</span>
<span class="sd">        Array of indices in the electrodes table for the given electrode IDs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nwbf</span> <span class="o">=</span> <span class="n">get_nwb_file</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">analysis_file_name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">get_electrode_indices</span><span class="p">(</span><span class="n">nwbf</span><span class="o">.</span><span class="n">electrodes</span><span class="p">,</span> <span class="n">electrode_ids</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.common.common_nwbfile.AnalysisNwbfile.cleanup" class="doc doc-heading">
<code class="highlight language-python"><span class="n">cleanup</span><span class="p">(</span><span class="n">delete_files</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#src.spyglass.common.common_nwbfile.AnalysisNwbfile.cleanup" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Remove the filepath entries for NWB files that are not in use.</p>
<p>Does not delete the files themselves unless delete_files=True is specified.
Run this after deleting the Nwbfile() entries themselves.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>delete_files</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Whether the original files should be deleted (default False).</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/common/common_nwbfile.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">delete_files</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove the filepath entries for NWB files that are not in use.</span>

<span class="sd">    Does not delete the files themselves unless delete_files=True is specified.</span>
<span class="sd">    Run this after deleting the Nwbfile() entries themselves.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    delete_files : bool, optional</span>
<span class="sd">        Whether the original files should be deleted (default False).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">external</span><span class="p">[</span><span class="s2">&quot;analysis&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">delete_external_files</span><span class="o">=</span><span class="n">delete_files</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.spikesorting.spikesorting_curation.Waveforms" class="doc doc-heading">
        <code>Waveforms</code>


<a href="#src.spyglass.spikesorting.spikesorting_curation.Waveforms" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Computed">Computed</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">Waveforms</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Computed</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; WaveformSelection</span>
<span class="s2">    ---</span>
<span class="s2">    waveform_extractor_path: varchar(400)</span>
<span class="s2">    -&gt; AnalysisNwbfile</span>
<span class="s2">    waveforms_object_id: varchar(40)   # Object ID for the waveforms in NWB file</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">recording</span> <span class="o">=</span> <span class="n">Curation</span><span class="o">.</span><span class="n">get_recording</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">recording</span><span class="o">.</span><span class="n">get_num_segments</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">recording</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">concatenate_recordings</span><span class="p">([</span><span class="n">recording</span><span class="p">])</span>

        <span class="n">sorting</span> <span class="o">=</span> <span class="n">Curation</span><span class="o">.</span><span class="n">get_curated_sorting</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting waveforms...&quot;</span><span class="p">)</span>
        <span class="n">waveform_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">WaveformParameters</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;waveform_params&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;whiten&quot;</span> <span class="ow">in</span> <span class="n">waveform_params</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">waveform_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;whiten&quot;</span><span class="p">):</span>
                <span class="n">recording</span> <span class="o">=</span> <span class="n">sip</span><span class="o">.</span><span class="n">whiten</span><span class="p">(</span><span class="n">recording</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>

        <span class="n">waveform_extractor_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_waveform_extractor_name</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;waveform_extractor_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SPYGLASS_WAVEFORMS_DIR&quot;</span><span class="p">])</span>
            <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">waveform_extractor_name</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;waveform_extractor_path&quot;</span><span class="p">]):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;waveform_extractor_path&quot;</span><span class="p">])</span>
        <span class="n">waveforms</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">extract_waveforms</span><span class="p">(</span>
            <span class="n">recording</span><span class="o">=</span><span class="n">recording</span><span class="p">,</span>
            <span class="n">sorting</span><span class="o">=</span><span class="n">sorting</span><span class="p">,</span>
            <span class="n">folder</span><span class="o">=</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;waveform_extractor_path&quot;</span><span class="p">],</span>
            <span class="o">**</span><span class="n">waveform_params</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">object_id</span> <span class="o">=</span> <span class="n">AnalysisNwbfile</span><span class="p">()</span><span class="o">.</span><span class="n">add_units_waveforms</span><span class="p">(</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">],</span> <span class="n">waveform_extractor</span><span class="o">=</span><span class="n">waveforms</span>
        <span class="p">)</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;waveforms_object_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">object_id</span>
        <span class="n">AnalysisNwbfile</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_waveforms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a spikeinterface waveform extractor specified by key</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : dict</span>
<span class="sd">            Could be an entry in Waveforms, or some other key that uniquely defines</span>
<span class="sd">            an entry in Waveforms</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        we : spikeinterface.WaveformExtractor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">we_path</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;waveform_extractor_path&quot;</span><span class="p">)</span>
        <span class="n">we</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">WaveformExtractor</span><span class="o">.</span><span class="n">load_from_folder</span><span class="p">(</span><span class="n">we_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">we</span>

    <span class="k">def</span> <span class="nf">fetch_nwb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="c1"># TODO: implement fetching waveforms from NWB</span>
        <span class="k">return</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_get_waveform_extractor_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">waveform_params_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">WaveformParameters</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;waveform_params_name&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s1">_&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;curation_id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">waveform_params_name</span><span class="si">}</span><span class="s1">_waveforms&#39;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.spikesorting.spikesorting_curation.Waveforms.load_waveforms" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_waveforms</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

<a href="#src.spyglass.spikesorting.spikesorting_curation.Waveforms.load_waveforms" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Returns a spikeinterface waveform extractor specified by key</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>key</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Could be an entry in Waveforms, or some other key that uniquely defines
an entry in Waveforms</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>we</code></td>          <td>
                <code>spikeinterface.<span title="spikeinterface.WaveformExtractor">WaveformExtractor</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_waveforms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a spikeinterface waveform extractor specified by key</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key : dict</span>
<span class="sd">        Could be an entry in Waveforms, or some other key that uniquely defines</span>
<span class="sd">        an entry in Waveforms</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    we : spikeinterface.WaveformExtractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">we_path</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;waveform_extractor_path&quot;</span><span class="p">)</span>
    <span class="n">we</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">WaveformExtractor</span><span class="o">.</span><span class="n">load_from_folder</span><span class="p">(</span><span class="n">we_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">we</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.spikesorting.spikesorting_curation.SpikeSortingRecording" class="doc doc-heading">
        <code>SpikeSortingRecording</code>


<a href="#src.spyglass.spikesorting.spikesorting_curation.SpikeSortingRecording" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Computed">Computed</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_recording.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">SpikeSortingRecording</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Computed</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; SpikeSortingRecordingSelection</span>
<span class="s2">    ---</span>
<span class="s2">    recording_path: varchar(1000)</span>
<span class="s2">    -&gt; IntervalList.proj(sort_interval_list_name=&#39;interval_list_name&#39;)</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">sort_interval_valid_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sort_interval_valid_times</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">recording</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filtered_recording</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">recording_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_recording_name</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="n">tmp_key</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">],</span>
            <span class="s2">&quot;interval_list_name&quot;</span><span class="p">:</span> <span class="n">recording_name</span><span class="p">,</span>
            <span class="s2">&quot;valid_times&quot;</span><span class="p">:</span> <span class="n">sort_interval_valid_times</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">IntervalList</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">tmp_key</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># store the list of valid times for the sort</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;sort_interval_list_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_key</span><span class="p">[</span><span class="s2">&quot;interval_list_name&quot;</span><span class="p">]</span>

        <span class="c1"># Path to files that will hold the recording extractors</span>
        <span class="n">recording_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SPYGLASS_RECORDING_DIR&quot;</span><span class="p">))</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;recording_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">recording_folder</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">recording_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;recording_path&quot;</span><span class="p">]):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;recording_path&quot;</span><span class="p">])</span>
        <span class="n">recording</span> <span class="o">=</span> <span class="n">recording</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
            <span class="n">folder</span><span class="o">=</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;recording_path&quot;</span><span class="p">],</span> <span class="n">chunk_duration</span><span class="o">=</span><span class="s2">&quot;10000ms&quot;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">8</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_recording_name</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="n">recording_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="o">+</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;sort_interval_name&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;sort_group_id&quot;</span><span class="p">])</span>
            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="o">+</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;preproc_params_name&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">recording_name</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_recording_timestamps</span><span class="p">(</span><span class="n">recording</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">recording</span><span class="o">.</span><span class="n">get_num_segments</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">frames_per_segment</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">recording</span><span class="o">.</span><span class="n">get_num_segments</span><span class="p">()):</span>
                <span class="n">frames_per_segment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">recording</span><span class="o">.</span><span class="n">get_num_frames</span><span class="p">(</span><span class="n">segment_index</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">cumsum_frames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">frames_per_segment</span><span class="p">)</span>
            <span class="n">total_frames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">frames_per_segment</span><span class="p">)</span>

            <span class="n">timestamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">total_frames</span><span class="p">,))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">recording</span><span class="o">.</span><span class="n">get_num_segments</span><span class="p">()):</span>
                <span class="n">timestamps</span><span class="p">[</span>
                    <span class="n">cumsum_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">:</span> <span class="n">cumsum_frames</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">recording</span><span class="o">.</span><span class="n">get_times</span><span class="p">(</span><span class="n">segment_index</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timestamps</span> <span class="o">=</span> <span class="n">recording</span><span class="o">.</span><span class="n">get_times</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">timestamps</span>

    <span class="k">def</span> <span class="nf">_get_sort_interval_valid_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Identifies the intersection between sort interval specified by the user</span>
<span class="sd">        and the valid times (times for which neural data exist)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key: dict</span>
<span class="sd">            specifies a (partially filled) entry of SpikeSorting table</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sort_interval_valid_times: ndarray of tuples</span>
<span class="sd">            (start, end) times for valid stretches of the sorting interval</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sort_interval</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">SortInterval</span>
            <span class="o">&amp;</span> <span class="p">{</span>
                <span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">],</span>
                <span class="s2">&quot;sort_interval_name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;sort_interval_name&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;sort_interval&quot;</span><span class="p">)</span>
        <span class="n">interval_list_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">SpikeSortingRecordingSelection</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;interval_list_name&quot;</span>
        <span class="p">)</span>
        <span class="n">valid_interval_times</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">IntervalList</span>
            <span class="o">&amp;</span> <span class="p">{</span>
                <span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">],</span>
                <span class="s2">&quot;interval_list_name&quot;</span><span class="p">:</span> <span class="n">interval_list_name</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;valid_times&quot;</span><span class="p">)</span>
        <span class="n">valid_sort_times</span> <span class="o">=</span> <span class="n">interval_list_intersect</span><span class="p">(</span>
            <span class="n">sort_interval</span><span class="p">,</span> <span class="n">valid_interval_times</span>
        <span class="p">)</span>
        <span class="c1"># Exclude intervals shorter than specified length</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">SpikeSortingPreprocessingParameters</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;preproc_params&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;min_segment_length&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">valid_sort_times</span> <span class="o">=</span> <span class="n">intervals_by_length</span><span class="p">(</span>
                <span class="n">valid_sort_times</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;min_segment_length&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">valid_sort_times</span>

    <span class="k">def</span> <span class="nf">_get_filtered_recording</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filters and references a recording</span>
<span class="sd">        * Loads the NWB file created during insertion as a spikeinterface Recording</span>
<span class="sd">        * Slices recording in time (interval) and space (channels);</span>
<span class="sd">          recording chunks from disjoint intervals are concatenated</span>
<span class="sd">        * Applies referencing and bandpass filtering</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key: dict,</span>
<span class="sd">            primary key of SpikeSortingRecording table</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        recording: si.Recording</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">nwb_file_abs_path</span> <span class="o">=</span> <span class="n">Nwbfile</span><span class="p">()</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">])</span>
        <span class="n">recording</span> <span class="o">=</span> <span class="n">se</span><span class="o">.</span><span class="n">read_nwb_recording</span><span class="p">(</span>
            <span class="n">nwb_file_abs_path</span><span class="p">,</span> <span class="n">load_time_vector</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="n">valid_sort_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sort_interval_valid_times</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="c1"># shape is (N, 2)</span>
        <span class="n">valid_sort_times_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">recording</span><span class="o">.</span><span class="n">get_times</span><span class="p">(),</span> <span class="n">interval</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">valid_sort_times</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># join intervals of indices that are adjacent</span>
        <span class="n">valid_sort_times_indices</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span>
            <span class="n">union_adjacent_index</span><span class="p">,</span> <span class="n">valid_sort_times_indices</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">valid_sort_times_indices</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">valid_sort_times_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span>
                <span class="n">valid_sort_times_indices</span><span class="p">,</span> <span class="mi">0</span>
            <span class="p">)</span>

        <span class="c1"># create an AppendRecording if there is more than one disjoint sort interval</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_sort_times_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">recordings_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">interval_indices</span> <span class="ow">in</span> <span class="n">valid_sort_times_indices</span><span class="p">:</span>
                <span class="n">recording_single</span> <span class="o">=</span> <span class="n">recording</span><span class="o">.</span><span class="n">frame_slice</span><span class="p">(</span>
                    <span class="n">start_frame</span><span class="o">=</span><span class="n">interval_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">end_frame</span><span class="o">=</span><span class="n">interval_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">recordings_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recording_single</span><span class="p">)</span>
            <span class="n">recording</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">append_recordings</span><span class="p">(</span><span class="n">recordings_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">recording</span> <span class="o">=</span> <span class="n">recording</span><span class="o">.</span><span class="n">frame_slice</span><span class="p">(</span>
                <span class="n">start_frame</span><span class="o">=</span><span class="n">valid_sort_times_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">end_frame</span><span class="o">=</span><span class="n">valid_sort_times_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="n">channel_ids</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">SortGroup</span><span class="o">.</span><span class="n">SortGroupElectrode</span>
            <span class="o">&amp;</span> <span class="p">{</span>
                <span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">],</span>
                <span class="s2">&quot;sort_group_id&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;sort_group_id&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;electrode_id&quot;</span><span class="p">)</span>
        <span class="n">ref_channel_id</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">SortGroup</span>
            <span class="o">&amp;</span> <span class="p">{</span>
                <span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">],</span>
                <span class="s2">&quot;sort_group_id&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;sort_group_id&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;sort_reference_electrode_id&quot;</span><span class="p">)</span>
        <span class="n">channel_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">channel_ids</span><span class="p">,</span> <span class="n">ref_channel_id</span><span class="p">)</span>

        <span class="c1"># include ref channel in first slice, then exclude it in second slice</span>
        <span class="k">if</span> <span class="n">ref_channel_id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">channel_ids_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel_ids</span><span class="p">,</span> <span class="n">ref_channel_id</span><span class="p">)</span>
            <span class="n">recording</span> <span class="o">=</span> <span class="n">recording</span><span class="o">.</span><span class="n">channel_slice</span><span class="p">(</span><span class="n">channel_ids</span><span class="o">=</span><span class="n">channel_ids_ref</span><span class="p">)</span>

            <span class="n">recording</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">common_reference</span><span class="p">(</span>
                <span class="n">recording</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="s2">&quot;single&quot;</span><span class="p">,</span> <span class="n">ref_channel_ids</span><span class="o">=</span><span class="n">ref_channel_id</span>
            <span class="p">)</span>
            <span class="n">recording</span> <span class="o">=</span> <span class="n">recording</span><span class="o">.</span><span class="n">channel_slice</span><span class="p">(</span><span class="n">channel_ids</span><span class="o">=</span><span class="n">channel_ids</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ref_channel_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">recording</span> <span class="o">=</span> <span class="n">recording</span><span class="o">.</span><span class="n">channel_slice</span><span class="p">(</span><span class="n">channel_ids</span><span class="o">=</span><span class="n">channel_ids</span><span class="p">)</span>
            <span class="n">recording</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">common_reference</span><span class="p">(</span>
                <span class="n">recording</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="s2">&quot;global&quot;</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s2">&quot;median&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid reference channel ID&quot;</span><span class="p">)</span>
        <span class="n">filter_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">SpikeSortingPreprocessingParameters</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;preproc_params&quot;</span>
        <span class="p">)</span>
        <span class="n">recording</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">bandpass_filter</span><span class="p">(</span>
            <span class="n">recording</span><span class="p">,</span>
            <span class="n">freq_min</span><span class="o">=</span><span class="n">filter_params</span><span class="p">[</span><span class="s2">&quot;frequency_min&quot;</span><span class="p">],</span>
            <span class="n">freq_max</span><span class="o">=</span><span class="n">filter_params</span><span class="p">[</span><span class="s2">&quot;frequency_max&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># if the sort group is a tetrode, change the channel location</span>
        <span class="c1"># note that this is a workaround that would be deprecated when spikeinterface uses 3D probe locations</span>
        <span class="n">probe_type</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">electrode_group</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">channel_id</span> <span class="ow">in</span> <span class="n">channel_ids</span><span class="p">:</span>
            <span class="n">probe_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">Electrode</span> <span class="o">*</span> <span class="n">Probe</span>
                    <span class="o">&amp;</span> <span class="p">{</span>
                        <span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;electrode_id&quot;</span><span class="p">:</span> <span class="n">channel_id</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;probe_type&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">electrode_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">Electrode</span>
                    <span class="o">&amp;</span> <span class="p">{</span>
                        <span class="s2">&quot;nwb_file_name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;nwb_file_name&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;electrode_id&quot;</span><span class="p">:</span> <span class="n">channel_id</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;electrode_group_name&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">all</span><span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="s2">&quot;tetrode_12.5&quot;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">probe_type</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">probe_type</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
            <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">eg</span> <span class="o">==</span> <span class="n">electrode_group</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">eg</span> <span class="ow">in</span> <span class="n">electrode_group</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">tetrode</span> <span class="o">=</span> <span class="n">pi</span><span class="o">.</span><span class="n">Probe</span><span class="p">(</span><span class="n">ndim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">position</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">12.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">12.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">12.5</span><span class="p">,</span> <span class="mf">12.5</span><span class="p">]]</span>
            <span class="n">tetrode</span><span class="o">.</span><span class="n">set_contacts</span><span class="p">(</span>
                <span class="n">position</span><span class="p">,</span> <span class="n">shapes</span><span class="o">=</span><span class="s2">&quot;circle&quot;</span><span class="p">,</span> <span class="n">shape_params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;radius&quot;</span><span class="p">:</span> <span class="mf">6.25</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">tetrode</span><span class="o">.</span><span class="n">set_contact_ids</span><span class="p">(</span><span class="n">channel_ids</span><span class="p">)</span>
            <span class="n">tetrode</span><span class="o">.</span><span class="n">set_device_channel_indices</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">recording</span> <span class="o">=</span> <span class="n">recording</span><span class="o">.</span><span class="n">set_probe</span><span class="p">(</span><span class="n">tetrode</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">recording</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">





  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.spikesorting.spikesorting_curation.MetricParameters" class="doc doc-heading">
        <code>MetricParameters</code>


<a href="#src.spyglass.spikesorting.spikesorting_curation.MetricParameters" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Manual">Manual</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">MetricParameters</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # Parameters for computing quality metrics of sorted units</span>
<span class="s2">    metric_params_name: varchar(200)</span>
<span class="s2">    ---</span>
<span class="s2">    metric_params: blob</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">metric_default_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;snr&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;peak_sign&quot;</span><span class="p">:</span> <span class="s2">&quot;neg&quot;</span><span class="p">,</span>
            <span class="s2">&quot;random_chunk_kwargs_dict&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_chunks_per_segment&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                <span class="s2">&quot;chunk_size&quot;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;isi_violation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;isi_threshold_ms&quot;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span> <span class="s2">&quot;min_isi_ms&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">},</span>
        <span class="s2">&quot;nn_isolation&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;max_spikes&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="s2">&quot;min_spikes&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s2">&quot;n_neighbors&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;n_components&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
            <span class="s2">&quot;radius_um&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;nn_noise_overlap&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;max_spikes&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="s2">&quot;min_spikes&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s2">&quot;n_neighbors&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;n_components&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
            <span class="s2">&quot;radius_um&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;peak_channel&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;peak_sign&quot;</span><span class="p">:</span> <span class="s2">&quot;neg&quot;</span><span class="p">},</span>
        <span class="s2">&quot;num_spikes&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="p">}</span>
    <span class="c1"># Example of peak_offset parameters &#39;peak_offset&#39;: {&#39;peak_sign&#39;: &#39;neg&#39;}</span>
    <span class="n">available_metrics</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;snr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;isi_violation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nn_isolation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nn_noise_overlap&quot;</span><span class="p">,</span>
        <span class="s2">&quot;peak_offset&quot;</span><span class="p">,</span>
        <span class="s2">&quot;peak_channel&quot;</span><span class="p">,</span>
        <span class="s2">&quot;num_spikes&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_metric_default_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="s2">&quot;Returns default params for the given metric&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_default_params</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">insert_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;franklab_default3&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_default_params</span><span class="p">],</span>
            <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_available_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">_metric_name_to_func</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_metrics</span><span class="p">:</span>
                <span class="n">metric_doc</span> <span class="o">=</span> <span class="n">_metric_name_to_func</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">metric_string</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{metric_name}</span><span class="s2"> : </span><span class="si">{metric_doc}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">metric_name</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">metric_doc</span><span class="o">=</span><span class="n">metric_doc</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">metric_string</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># TODO</span>
    <span class="k">def</span> <span class="nf">_validate_metrics_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks whether a row to be inserted contains only the available metrics&quot;&quot;&quot;</span>
        <span class="c1"># get available metrics list</span>
        <span class="c1"># get metric list from key</span>
        <span class="c1"># compare</span>
        <span class="k">return</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.spikesorting.spikesorting_curation.MetricParameters.get_metric_default_params" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_metric_default_params</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span></code>

<a href="#src.spyglass.spikesorting.spikesorting_curation.MetricParameters.get_metric_default_params" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Returns default params for the given metric</p>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_metric_default_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="s2">&quot;Returns default params for the given metric&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_default_params</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.spikesorting.spikesorting_curation.AutomaticCuration" class="doc doc-heading">
        <code>AutomaticCuration</code>


<a href="#src.spyglass.spikesorting.spikesorting_curation.AutomaticCuration" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Computed">Computed</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">AutomaticCuration</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Computed</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; AutomaticCurationSelection</span>
<span class="s2">    ---</span>
<span class="s2">    auto_curation_key: blob # the key to the curation inserted by make</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">metrics_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">QualityMetrics</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;quality_metrics_path&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metrics_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">quality_metrics</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># get the curation information and the curated sorting</span>
        <span class="n">parent_curation</span> <span class="o">=</span> <span class="p">(</span><span class="n">Curation</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">as_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">parent_merge_groups</span> <span class="o">=</span> <span class="n">parent_curation</span><span class="p">[</span><span class="s2">&quot;merge_groups&quot;</span><span class="p">]</span>
        <span class="n">parent_labels</span> <span class="o">=</span> <span class="n">parent_curation</span><span class="p">[</span><span class="s2">&quot;curation_labels&quot;</span><span class="p">]</span>
        <span class="n">parent_curation_id</span> <span class="o">=</span> <span class="n">parent_curation</span><span class="p">[</span><span class="s2">&quot;curation_id&quot;</span><span class="p">]</span>
        <span class="n">parent_sorting</span> <span class="o">=</span> <span class="n">Curation</span><span class="o">.</span><span class="n">get_curated_sorting</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="n">merge_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">AutomaticCurationParameters</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;merge_params&quot;</span>
        <span class="p">)</span>
        <span class="n">merge_groups</span><span class="p">,</span> <span class="n">units_merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_merge_groups</span><span class="p">(</span>
            <span class="n">parent_sorting</span><span class="p">,</span> <span class="n">parent_merge_groups</span><span class="p">,</span> <span class="n">quality_metrics</span><span class="p">,</span> <span class="n">merge_params</span>
        <span class="p">)</span>

        <span class="n">label_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">AutomaticCurationParameters</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;label_params&quot;</span>
        <span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_labels</span><span class="p">(</span>
            <span class="n">parent_sorting</span><span class="p">,</span> <span class="n">parent_labels</span><span class="p">,</span> <span class="n">quality_metrics</span><span class="p">,</span> <span class="n">label_params</span>
        <span class="p">)</span>

        <span class="c1"># keep the quality metrics only if no merging occurred.</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">quality_metrics</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">units_merged</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># insert this sorting into the CuratedSpikeSorting Table</span>
        <span class="c1"># first remove keys that aren&#39;t part of the Sorting (the primary key of curation)</span>
        <span class="n">c_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">SpikeSorting</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;KEY&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">curation_key</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">:</span> <span class="n">key</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">key</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">c_key</span><span class="p">}</span>
        <span class="n">key</span><span class="p">[</span><span class="s2">&quot;auto_curation_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Curation</span><span class="o">.</span><span class="n">insert_curation</span><span class="p">(</span>
            <span class="n">curation_key</span><span class="p">,</span>
            <span class="n">parent_curation_id</span><span class="o">=</span><span class="n">parent_curation_id</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">merge_groups</span><span class="o">=</span><span class="n">merge_groups</span><span class="p">,</span>
            <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;auto curated&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_merge_groups</span><span class="p">(</span>
        <span class="n">sorting</span><span class="p">,</span> <span class="n">parent_merge_groups</span><span class="p">,</span> <span class="n">quality_metrics</span><span class="p">,</span> <span class="n">merge_params</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Identifies units to be merged based on the quality_metrics and</span>
<span class="sd">        merge parameters and returns an updated list of merges for the curation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        sorting : spikeinterface.sorting</span>
<span class="sd">        parent_merge_groups : list</span>
<span class="sd">            Information about previous merges</span>
<span class="sd">        quality_metrics : list</span>
<span class="sd">        merge_params : dict</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        merge_groups : list of lists</span>
<span class="sd">        merge_occurred : bool</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># overview:</span>
        <span class="c1"># 1. Use quality metrics to determine merge groups for units</span>
        <span class="c1"># 2. Combine merge groups with current merge groups to produce union of merges</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">merge_params</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parent_merge_groups</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: use the metrics to identify clusters that should be merged</span>
            <span class="c1"># new_merges should then reflect those merges and the line below should be deleted.</span>
            <span class="n">new_merges</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># append these merges to the parent merge_groups</span>
            <span class="k">for</span> <span class="n">new_merge</span> <span class="ow">in</span> <span class="n">new_merges</span><span class="p">:</span>
                <span class="c1"># check to see if the first cluster listed is in a current merge group</span>
                <span class="k">for</span> <span class="n">previous_merge</span> <span class="ow">in</span> <span class="n">parent_merge_groups</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">new_merge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">previous_merge</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="c1"># add the additional units in new_merge to the identified merge group.</span>
                        <span class="n">previous_merge</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_merge</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="n">previous_merge</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># append this merge group to the list if no previous merge</span>
                    <span class="n">parent_merge_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_merge</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">parent_merge_groups</span><span class="o">.</span><span class="n">sort</span><span class="p">(),</span> <span class="kc">True</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_labels</span><span class="p">(</span><span class="n">sorting</span><span class="p">,</span> <span class="n">parent_labels</span><span class="p">,</span> <span class="n">quality_metrics</span><span class="p">,</span> <span class="n">label_params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dictionary of labels using quality_metrics and label</span>
<span class="sd">        parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        sorting : spikeinterface.sorting</span>
<span class="sd">        parent_labels : list</span>
<span class="sd">            Information about previous merges</span>
<span class="sd">        quality_metrics : list</span>
<span class="sd">        label_params : dict</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        parent_labels : list</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># overview:</span>
        <span class="c1"># 1. Use quality metrics to determine labels for units</span>
        <span class="c1"># 2. Append labels to current labels, checking for inconsistencies</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">label_params</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parent_labels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">label_params</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">quality_metrics</span><span class="p">:</span>
                    <span class="ne">Warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> not found in quality metrics; skipping&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">compare</span> <span class="o">=</span> <span class="n">_comparison_to_function</span><span class="p">[</span><span class="n">label_params</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

                    <span class="k">for</span> <span class="n">unit_id</span> <span class="ow">in</span> <span class="n">quality_metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="c1"># compare the quality metric to the threshold with the specified operator</span>
                        <span class="c1"># note that label_params[metric] is a three element list with a comparison operator as a string,</span>
                        <span class="c1"># the threshold value, and a list of labels to be applied if the comparison is true</span>
                        <span class="k">if</span> <span class="n">compare</span><span class="p">(</span>
                            <span class="n">quality_metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="n">unit_id</span><span class="p">],</span>
                            <span class="n">label_params</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                        <span class="p">):</span>
                            <span class="k">if</span> <span class="n">unit_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parent_labels</span><span class="p">:</span>
                                <span class="n">parent_labels</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_params</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                            <span class="c1"># check if the label is already there, and if not, add it</span>
                            <span class="k">elif</span> <span class="p">(</span>
                                <span class="n">label_params</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                                <span class="ow">not</span> <span class="ow">in</span> <span class="n">parent_labels</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span>
                            <span class="p">):</span>
                                <span class="n">parent_labels</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                                    <span class="n">label_params</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                                <span class="p">)</span>
            <span class="k">return</span> <span class="n">parent_labels</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.spikesorting.spikesorting_curation.AutomaticCuration.get_merge_groups" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_merge_groups</span><span class="p">(</span><span class="n">sorting</span><span class="p">,</span> <span class="n">parent_merge_groups</span><span class="p">,</span> <span class="n">quality_metrics</span><span class="p">,</span> <span class="n">merge_params</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#src.spyglass.spikesorting.spikesorting_curation.AutomaticCuration.get_merge_groups" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Identifies units to be merged based on the quality_metrics and
merge parameters and returns an updated list of merges for the curation.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>sorting</code></td>
          <td>
                <code>spikeinterface.<span title="spikeinterface.sorting">sorting</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>parent_merge_groups</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Information about previous merges</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>quality_metrics</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>merge_params</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>merge_groups</code></td>          <td>
                <code>list of lists</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
        </tr>
        <tr>
<td><code>merge_occurred</code></td>          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">get_merge_groups</span><span class="p">(</span>
    <span class="n">sorting</span><span class="p">,</span> <span class="n">parent_merge_groups</span><span class="p">,</span> <span class="n">quality_metrics</span><span class="p">,</span> <span class="n">merge_params</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identifies units to be merged based on the quality_metrics and</span>
<span class="sd">    merge parameters and returns an updated list of merges for the curation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    sorting : spikeinterface.sorting</span>
<span class="sd">    parent_merge_groups : list</span>
<span class="sd">        Information about previous merges</span>
<span class="sd">    quality_metrics : list</span>
<span class="sd">    merge_params : dict</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    merge_groups : list of lists</span>
<span class="sd">    merge_occurred : bool</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># overview:</span>
    <span class="c1"># 1. Use quality metrics to determine merge groups for units</span>
    <span class="c1"># 2. Combine merge groups with current merge groups to produce union of merges</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">merge_params</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">parent_merge_groups</span><span class="p">,</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># TODO: use the metrics to identify clusters that should be merged</span>
        <span class="c1"># new_merges should then reflect those merges and the line below should be deleted.</span>
        <span class="n">new_merges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># append these merges to the parent merge_groups</span>
        <span class="k">for</span> <span class="n">new_merge</span> <span class="ow">in</span> <span class="n">new_merges</span><span class="p">:</span>
            <span class="c1"># check to see if the first cluster listed is in a current merge group</span>
            <span class="k">for</span> <span class="n">previous_merge</span> <span class="ow">in</span> <span class="n">parent_merge_groups</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">new_merge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">previous_merge</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="c1"># add the additional units in new_merge to the identified merge group.</span>
                    <span class="n">previous_merge</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_merge</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="n">previous_merge</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># append this merge group to the list if no previous merge</span>
                <span class="n">parent_merge_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_merge</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parent_merge_groups</span><span class="o">.</span><span class="n">sort</span><span class="p">(),</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="src.spyglass.spikesorting.spikesorting_curation.AutomaticCuration.get_labels" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_labels</span><span class="p">(</span><span class="n">sorting</span><span class="p">,</span> <span class="n">parent_labels</span><span class="p">,</span> <span class="n">quality_metrics</span><span class="p">,</span> <span class="n">label_params</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#src.spyglass.spikesorting.spikesorting_curation.AutomaticCuration.get_labels" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Returns a dictionary of labels using quality_metrics and label
parameters.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>sorting</code></td>
          <td>
                <code>spikeinterface.<span title="spikeinterface.sorting">sorting</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>parent_labels</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Information about previous merges</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>quality_metrics</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>label_params</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>parent_labels</code></td>          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">get_labels</span><span class="p">(</span><span class="n">sorting</span><span class="p">,</span> <span class="n">parent_labels</span><span class="p">,</span> <span class="n">quality_metrics</span><span class="p">,</span> <span class="n">label_params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a dictionary of labels using quality_metrics and label</span>
<span class="sd">    parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    sorting : spikeinterface.sorting</span>
<span class="sd">    parent_labels : list</span>
<span class="sd">        Information about previous merges</span>
<span class="sd">    quality_metrics : list</span>
<span class="sd">    label_params : dict</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    parent_labels : list</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># overview:</span>
    <span class="c1"># 1. Use quality metrics to determine labels for units</span>
    <span class="c1"># 2. Append labels to current labels, checking for inconsistencies</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">label_params</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">parent_labels</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">label_params</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">quality_metrics</span><span class="p">:</span>
                <span class="ne">Warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> not found in quality metrics; skipping&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">compare</span> <span class="o">=</span> <span class="n">_comparison_to_function</span><span class="p">[</span><span class="n">label_params</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

                <span class="k">for</span> <span class="n">unit_id</span> <span class="ow">in</span> <span class="n">quality_metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="c1"># compare the quality metric to the threshold with the specified operator</span>
                    <span class="c1"># note that label_params[metric] is a three element list with a comparison operator as a string,</span>
                    <span class="c1"># the threshold value, and a list of labels to be applied if the comparison is true</span>
                    <span class="k">if</span> <span class="n">compare</span><span class="p">(</span>
                        <span class="n">quality_metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="n">unit_id</span><span class="p">],</span>
                        <span class="n">label_params</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                    <span class="p">):</span>
                        <span class="k">if</span> <span class="n">unit_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parent_labels</span><span class="p">:</span>
                            <span class="n">parent_labels</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_params</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                        <span class="c1"># check if the label is already there, and if not, add it</span>
                        <span class="k">elif</span> <span class="p">(</span>
                            <span class="n">label_params</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                            <span class="ow">not</span> <span class="ow">in</span> <span class="n">parent_labels</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span>
                        <span class="p">):</span>
                            <span class="n">parent_labels</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                                <span class="n">label_params</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                            <span class="p">)</span>
        <span class="k">return</span> <span class="n">parent_labels</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.spikesorting.spikesorting_curation.CuratedSpikeSorting" class="doc doc-heading">
        <code>CuratedSpikeSorting</code>


<a href="#src.spyglass.spikesorting.spikesorting_curation.CuratedSpikeSorting" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Computed">Computed</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span>
<span class="normal">984</span>
<span class="normal">985</span>
<span class="normal">986</span>
<span class="normal">987</span>
<span class="normal">988</span>
<span class="normal">989</span>
<span class="normal">990</span>
<span class="normal">991</span>
<span class="normal">992</span>
<span class="normal">993</span>
<span class="normal">994</span>
<span class="normal">995</span>
<span class="normal">996</span>
<span class="normal">997</span>
<span class="normal">998</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">CuratedSpikeSorting</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Computed</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; CuratedSpikeSortingSelection</span>
<span class="s2">    ---</span>
<span class="s2">    -&gt; AnalysisNwbfile</span>
<span class="s2">    units_object_id: varchar(40)</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Unit</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        # Table for holding sorted units</span>
<span class="s2">        -&gt; CuratedSpikeSorting</span>
<span class="s2">        unit_id: int   # ID for each unit</span>
<span class="s2">        ---</span>
<span class="s2">        label=&#39;&#39;: varchar(200)   # optional set of labels for each unit</span>
<span class="s2">        nn_noise_overlap=-1: float   # noise overlap metric for each unit</span>
<span class="s2">        nn_isolation=-1: float   # isolation score metric for each unit</span>
<span class="s2">        isi_violation=-1: float   # ISI violation score for each unit</span>
<span class="s2">        snr=0: float            # SNR for each unit</span>
<span class="s2">        firing_rate=-1: float   # firing rate</span>
<span class="s2">        num_spikes=-1: int   # total number of spikes</span>
<span class="s2">        peak_channel=null: int # channel of maximum amplitude for each unit</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">unit_labels_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;reject&quot;</span><span class="p">]</span>
        <span class="c1"># check that the Curation has metrics</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">(</span><span class="n">Curation</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;quality_metrics&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metrics</span> <span class="o">==</span> <span class="p">{}:</span>
            <span class="ne">Warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Metrics for Curation </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> should normally be calculated before insertion here&quot;</span>
            <span class="p">)</span>

        <span class="n">sorting</span> <span class="o">=</span> <span class="n">Curation</span><span class="o">.</span><span class="n">get_curated_sorting</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">unit_ids</span> <span class="o">=</span> <span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_ids</span><span class="p">()</span>
        <span class="c1"># Get the labels for the units, add only those units that do not have &#39;reject&#39; or &#39;noise&#39; labels</span>
        <span class="n">unit_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">Curation</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;curation_labels&quot;</span><span class="p">)</span>
        <span class="n">accepted_units</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">unit_id</span> <span class="ow">in</span> <span class="n">unit_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">unit_id</span> <span class="ow">in</span> <span class="n">unit_labels</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unit_labels_to_remove</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">unit_labels</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]))</span>
                    <span class="o">==</span> <span class="mi">0</span>
                <span class="p">):</span>
                    <span class="n">accepted_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">accepted_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit_id</span><span class="p">)</span>

        <span class="c1"># get the labels for the accepted units</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">unit_id</span> <span class="ow">in</span> <span class="n">accepted_units</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">unit_id</span> <span class="ow">in</span> <span class="n">unit_labels</span><span class="p">:</span>
                <span class="n">labels</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unit_labels</span><span class="p">[</span><span class="n">unit_id</span><span class="p">])</span>

        <span class="c1"># convert unit_ids in metrics to integers, including only accepted units.</span>
        <span class="c1">#  TODO: convert to int this somewhere else</span>
        <span class="n">final_metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">final_metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">unit_id</span><span class="p">):</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="n">unit_id</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">unit_id</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">unit_id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">accepted_units</span>
            <span class="p">}</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">accepted_units</span><span class="p">)</span><span class="si">}</span><span class="s2"> accepted units&quot;</span><span class="p">)</span>

        <span class="c1"># get the sorting and save it in the NWB file</span>
        <span class="n">sorting</span> <span class="o">=</span> <span class="n">Curation</span><span class="o">.</span><span class="n">get_curated_sorting</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">recording</span> <span class="o">=</span> <span class="n">Curation</span><span class="o">.</span><span class="n">get_recording</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="c1"># get the sort_interval and sorting interval list</span>
        <span class="n">sort_interval_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">SpikeSortingRecording</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;sort_interval_name&quot;</span>
        <span class="p">)</span>
        <span class="n">sort_interval</span> <span class="o">=</span> <span class="p">(</span><span class="n">SortInterval</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;sort_interval&quot;</span><span class="p">)</span>
        <span class="n">sort_interval_list_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">SpikeSorting</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;artifact_removed_interval_list_name&quot;</span>
        <span class="p">)</span>

        <span class="n">timestamps</span> <span class="o">=</span> <span class="n">SpikeSortingRecording</span><span class="o">.</span><span class="n">_get_recording_timestamps</span><span class="p">(</span><span class="n">recording</span><span class="p">)</span>

        <span class="p">(</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">],</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;units_object_id&quot;</span><span class="p">],</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">Curation</span><span class="p">()</span><span class="o">.</span><span class="n">save_sorting_nwb</span><span class="p">(</span>
            <span class="n">key</span><span class="p">,</span>
            <span class="n">sorting</span><span class="p">,</span>
            <span class="n">timestamps</span><span class="p">,</span>
            <span class="n">sort_interval_list_name</span><span class="p">,</span>
            <span class="n">sort_interval</span><span class="p">,</span>
            <span class="n">metrics</span><span class="o">=</span><span class="n">final_metrics</span><span class="p">,</span>
            <span class="n">unit_ids</span><span class="o">=</span><span class="n">accepted_units</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="c1"># now add the units</span>
        <span class="c1"># Remove the non primary key entries.</span>
        <span class="k">del</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;units_object_id&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;analysis_file_name&quot;</span><span class="p">]</span>

        <span class="n">metric_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_fields</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">unit_id</span> <span class="ow">in</span> <span class="n">accepted_units</span><span class="p">:</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;unit_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit_id</span>
            <span class="k">if</span> <span class="n">unit_id</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">metric_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">final_metrics</span><span class="p">:</span>
                    <span class="n">key</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_metrics</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">unit_id</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="ne">Warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;No metric named </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> in computed unit quality metrics; skipping&quot;</span>
                    <span class="p">)</span>
            <span class="n">CuratedSpikeSorting</span><span class="o">.</span><span class="n">Unit</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">metrics_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list of the metrics that are currently in the Units table.&quot;&quot;&quot;</span>
        <span class="n">unit_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Unit</span><span class="p">()</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span>
        <span class="n">unit_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">unit_info</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">unit_fields</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">unit_fields</span>

    <span class="k">def</span> <span class="nf">fetch_nwb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fetch_nwb</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">AnalysisNwbfile</span><span class="p">,</span> <span class="s2">&quot;analysis_file_abs_path&quot;</span><span class="p">),</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.spikesorting.spikesorting_curation.CuratedSpikeSorting.metrics_fields" class="doc doc-heading">
<code class="highlight language-python"><span class="n">metrics_fields</span><span class="p">()</span></code>

<a href="#src.spyglass.spikesorting.spikesorting_curation.CuratedSpikeSorting.metrics_fields" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Returns a list of the metrics that are currently in the Units table.</p>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">988</span>
<span class="normal">989</span>
<span class="normal">990</span>
<span class="normal">991</span>
<span class="normal">992</span>
<span class="normal">993</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">metrics_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a list of the metrics that are currently in the Units table.&quot;&quot;&quot;</span>
    <span class="n">unit_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Unit</span><span class="p">()</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span>
    <span class="n">unit_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">unit_info</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">unit_fields</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unit_fields</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="src.spyglass.spikesorting.spikesorting_curation.UnitInclusionParameters" class="doc doc-heading">
        <code>UnitInclusionParameters</code>


<a href="#src.spyglass.spikesorting.spikesorting_curation.UnitInclusionParameters" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Manual">Manual</span></code></p>



        <details class="quote">
          <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">UnitInclusionParameters</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    unit_inclusion_param_name: varchar(80) # the name of the list of thresholds for unit inclusion</span>
<span class="s2">    ---</span>
<span class="s2">    inclusion_param_dict: blob # the dictionary of inclusion / exclusion parameters</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">insert1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># check to see that the dictionary fits the specifications</span>
        <span class="c1"># The inclusion parameter dict has the following form:</span>
        <span class="c1"># param_dict[&#39;metric_name&#39;] = (operator, value)</span>
        <span class="c1">#    where operator is &#39;&lt;&#39;, &#39;&gt;&#39;, &lt;=&#39;, &#39;&gt;=&#39;, or &#39;==&#39; and value is the comparison (float) value to be used ()</span>
        <span class="c1"># param_dict[&#39;exclude_labels&#39;] = [list of labels to exclude]</span>
        <span class="n">pdict</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;inclusion_param_dict&quot;</span><span class="p">]</span>
        <span class="n">metrics_list</span> <span class="o">=</span> <span class="n">CuratedSpikeSorting</span><span class="p">()</span><span class="o">.</span><span class="n">metrics_fields</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pdict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metrics_list</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;exclude_labels&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;key </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> is not a valid element of the inclusion_param_dict&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">metrics_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pdict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_comparison_to_function</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;operator </span><span class="si">{</span><span class="n">pdict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> for metric </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> is not in the valid operators list: </span><span class="si">{</span><span class="n">_comparison_to_function</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;exclude_labels&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">pdict</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_labels</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;exclude label </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> is not in the valid_labels list: </span><span class="si">{</span><span class="n">valid_labels</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_included_units</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">curated_sorting_key</span><span class="p">,</span> <span class="n">unit_inclusion_param_name</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;given a reference to a set of curated sorting units and the name of a unit inclusion parameter list, returns</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        curated_sorting_key : dict</span>
<span class="sd">            key to select a set of curated sorting</span>
<span class="sd">        unit_inclusion_param_name : str</span>
<span class="sd">            name of a unit inclusion parameter entry</span>

<span class="sd">        Returns</span>
<span class="sd">        ------unit key</span>
<span class="sd">        dict</span>
<span class="sd">            key to select all of the included units</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">curated_sortings</span> <span class="o">=</span> <span class="p">(</span><span class="n">CuratedSpikeSorting</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">curated_sorting_key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
        <span class="n">inc_param_dict</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">UnitInclusionParameters</span>
            <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;unit_inclusion_param_name&quot;</span><span class="p">:</span> <span class="n">unit_inclusion_param_name</span><span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;inclusion_param_dict&quot;</span><span class="p">)</span>
        <span class="n">units</span> <span class="o">=</span> <span class="p">(</span><span class="n">CuratedSpikeSorting</span><span class="p">()</span><span class="o">.</span><span class="n">Unit</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">curated_sortings</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
        <span class="n">units_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">CuratedSpikeSorting</span><span class="p">()</span><span class="o">.</span><span class="n">Unit</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">curated_sortings</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
            <span class="s2">&quot;KEY&quot;</span>
        <span class="p">)</span>
        <span class="c1"># get a list of the metrics in the units table</span>
        <span class="n">metrics_list</span> <span class="o">=</span> <span class="n">CuratedSpikeSorting</span><span class="p">()</span><span class="o">.</span><span class="n">metrics_fields</span><span class="p">()</span>
        <span class="c1"># get the list of labels to exclude if there is one</span>
        <span class="k">if</span> <span class="s2">&quot;exclude_labels&quot;</span> <span class="ow">in</span> <span class="n">inc_param_dict</span><span class="p">:</span>
            <span class="n">exclude_labels</span> <span class="o">=</span> <span class="n">inc_param_dict</span><span class="p">[</span><span class="s2">&quot;exclude_labels&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">inc_param_dict</span><span class="p">[</span><span class="s2">&quot;exclude_labels&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exclude_labels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># create a list of the units to kepp.</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">inc_param_dict</span><span class="p">:</span>
            <span class="c1"># for all units, go through each metric, compare it to the value specified, and update the list to be kept</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">keep</span><span class="p">,</span>
                <span class="n">_comparison_to_function</span><span class="p">[</span><span class="n">inc_param_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="mi">0</span><span class="p">]](</span>
                    <span class="n">units</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">inc_param_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># now exclude by label if it is specified</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exclude_labels</span><span class="p">):</span>
            <span class="n">included_units</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">unit_ind</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">keep</span><span class="p">)):</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span><span class="n">unit_ind</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">exclude</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">exclude_labels</span><span class="p">:</span>
                        <span class="n">keep</span><span class="p">[</span><span class="n">unit_ind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
        <span class="c1"># return units that passed all of the tests</span>
        <span class="c1"># TODO: Make this more efficient</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">units_key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">keep</span><span class="p">))}</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="src.spyglass.spikesorting.spikesorting_curation.UnitInclusionParameters.get_included_units" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_included_units</span><span class="p">(</span><span class="n">curated_sorting_key</span><span class="p">,</span> <span class="n">unit_inclusion_param_name</span><span class="p">)</span></code>

<a href="#src.spyglass.spikesorting.spikesorting_curation.UnitInclusionParameters.get_included_units" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>given a reference to a set of curated sorting units and the name of a unit inclusion parameter list, returns</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>curated_sorting_key</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>key to select a set of curated sorting</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>unit_inclusion_param_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of a unit inclusion parameter entry</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns
------unit key
dict
    key to select all of the included units</p>

      <details class="quote">
        <summary>Source code in <code>src/spyglass/spikesorting/spikesorting_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_included_units</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">curated_sorting_key</span><span class="p">,</span> <span class="n">unit_inclusion_param_name</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;given a reference to a set of curated sorting units and the name of a unit inclusion parameter list, returns</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    curated_sorting_key : dict</span>
<span class="sd">        key to select a set of curated sorting</span>
<span class="sd">    unit_inclusion_param_name : str</span>
<span class="sd">        name of a unit inclusion parameter entry</span>

<span class="sd">    Returns</span>
<span class="sd">    ------unit key</span>
<span class="sd">    dict</span>
<span class="sd">        key to select all of the included units</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">curated_sortings</span> <span class="o">=</span> <span class="p">(</span><span class="n">CuratedSpikeSorting</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">curated_sorting_key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
    <span class="n">inc_param_dict</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">UnitInclusionParameters</span>
        <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;unit_inclusion_param_name&quot;</span><span class="p">:</span> <span class="n">unit_inclusion_param_name</span><span class="p">}</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;inclusion_param_dict&quot;</span><span class="p">)</span>
    <span class="n">units</span> <span class="o">=</span> <span class="p">(</span><span class="n">CuratedSpikeSorting</span><span class="p">()</span><span class="o">.</span><span class="n">Unit</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">curated_sortings</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
    <span class="n">units_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">CuratedSpikeSorting</span><span class="p">()</span><span class="o">.</span><span class="n">Unit</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">curated_sortings</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
        <span class="s2">&quot;KEY&quot;</span>
    <span class="p">)</span>
    <span class="c1"># get a list of the metrics in the units table</span>
    <span class="n">metrics_list</span> <span class="o">=</span> <span class="n">CuratedSpikeSorting</span><span class="p">()</span><span class="o">.</span><span class="n">metrics_fields</span><span class="p">()</span>
    <span class="c1"># get the list of labels to exclude if there is one</span>
    <span class="k">if</span> <span class="s2">&quot;exclude_labels&quot;</span> <span class="ow">in</span> <span class="n">inc_param_dict</span><span class="p">:</span>
        <span class="n">exclude_labels</span> <span class="o">=</span> <span class="n">inc_param_dict</span><span class="p">[</span><span class="s2">&quot;exclude_labels&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">inc_param_dict</span><span class="p">[</span><span class="s2">&quot;exclude_labels&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">exclude_labels</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># create a list of the units to kepp.</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">inc_param_dict</span><span class="p">:</span>
        <span class="c1"># for all units, go through each metric, compare it to the value specified, and update the list to be kept</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">keep</span><span class="p">,</span>
            <span class="n">_comparison_to_function</span><span class="p">[</span><span class="n">inc_param_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="mi">0</span><span class="p">]](</span>
                <span class="n">units</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">inc_param_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="c1"># now exclude by label if it is specified</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exclude_labels</span><span class="p">):</span>
        <span class="n">included_units</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">unit_ind</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">keep</span><span class="p">)):</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span><span class="n">unit_ind</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="n">exclude</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">exclude_labels</span><span class="p">:</span>
                    <span class="n">keep</span><span class="p">[</span><span class="n">unit_ind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
    <span class="c1"># return units that passed all of the tests</span>
    <span class="c1"># TODO: Make this more efficient</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">units_key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">keep</span><span class="p">))}</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>




  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../spikesorting_artifact/" class="md-footer__link md-footer__link--prev" aria-label="Previous: spikesorting_artifact.py" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                spikesorting_artifact.py
              </div>
            </div>
          </a>
        
        
          
          <a href="../spikesorting_recording/" class="md-footer__link md-footer__link--next" aria-label="Next: spikesorting_recording.py" rel="next">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                spikesorting_recording.py
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright (c) 2020-present Loren Frank
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/LorenFrankLab/spyglass" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/spyglass-neuro/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6zM286.2 404c11.1 0 20.1 9.1 20.1 20.3 0 11.3-9 20.4-20.1 20.4-11 0-20.1-9.2-20.1-20.4.1-11.3 9.1-20.3 20.1-20.3zM167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4zm-6.7-142.6c-11.1 0-20.1-9.1-20.1-20.3.1-11.3 9-20.4 20.1-20.4 11 0 20.1 9.2 20.1 20.4s-9 20.3-20.1 20.3z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../../../..", "features": ["toc.integrate", "navigation.sections", "navigation.expand", "navigation.top", "navigation.instant", "navigation.tracking", "navigation.top", "search.suggest", "search.share", "navigation.footer"], "search": "../../../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.b425cdc4.min.js"></script>
      
    
  </body>
</html>